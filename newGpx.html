<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="route.png" type="image/png">
    <title>[ë£¨ì‹œí¼í™] í™ë£¨íŠ¸</title>
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=hcuap73kdc"></script>
<script type="text/javascript" src="MarkerClustering.js"></script>



    <style>
        #map { width: 100%; height: calc(100vh - 260px); resize: both; }
        #controls { margin: 10px; }
        button { margin: 5px; padding: 10px; cursor: pointer; }

        /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #locationButton {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: white;
            border: 2px solid gray;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            text-align: center;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* ìœ„ì¹˜ ì¶”ì  ì¢…ë£Œ ë²„íŠ¼ */
        #stopTrackingButton {
            position: absolute;
            bottom: 15px;
            right: 70px;
            background-color: white;
            border: 2px solid gray;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <h1>[ë£¨ì‹œí¼í™] í™ë£¨íŠ¸(GPX)</h1>
    <div id="map"></div>
    <div id="controls">
        <button id="startPolyline">ê²½ë¡œ ê·¸ë¦¬ê¸°</button>
        <button id="completePolyline">ê²½ë¡œ ê·¸ë¦¬ê¸° ì™„ë£Œ</button>
        <button id="downloadGPX">GPX ë‹¤ìš´ë¡œë“œ</button>
        <button id="uploadGPX">GPX ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="gpxFileInput" style="display: none;" accept=".gpx">
        <button id="clearMap">ì´ˆê¸°í™”</button>
    </div>
    <div id="locationButton" title="í˜„ì¬ ìœ„ì¹˜">ğŸ“</div> <!-- âœ… í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
    <div id="stopTrackingButton" title="ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€">ğŸ›‘</div> <!-- âœ… ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€ ë²„íŠ¼ -->
    <span style="font-size: 14px; color: gray;">
        ë°±ìŠ¤í˜ì´ìŠ¤ : ì§ì „ ì·¨ì†Œ<br>
        ESC, ë§ˆìš°ìŠ¤ ìš°í´ë¦­, [ê²½ë¡œ ê·¸ë¦¬ê¸° ì™„ë£Œ] ë²„íŠ¼ í´ë¦­ : ê·¸ë¦¬ê¸° ì¢…ë£Œ<br>
        ëª¨ë°”ì¼ì—ì„œë„ ê²½ë¡œê·¸ë¦¬ê¸°, ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤
    </span>

    <script>
    let map; // âœ… ì „ì—­ ë³€ìˆ˜ ì„¤ì •
    let watchId = null; // âœ… ìœ„ì¹˜ ì¶”ì  ID ì €ì¥ (ìœ„ì¹˜ ì¶”ì  ì‹œì‘ ì‹œ ê°’ì´ ì„¤ì •ë¨)
    let locationCircle = null; // âœ… ë°˜ê²½ 500m ì› ê°ì²´ ì €ì¥
    let currentLocationMarker = null; // âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì €ì¥

window.onload = async function () {
    // âœ… ì§€ë„ ê°ì²´ ìƒì„± (ì „ì—­ ë³€ìˆ˜ ì„¤ì •)
    window.map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(37.484809, 127.057097), // ì´ˆê¸° ì¤‘ì‹¬ ì¢Œí‘œ
        zoom: 14
    });

    // âœ… ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    await loadApartments();

    // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸ ë§ˆì»¤ ì—…ë°ì´íŠ¸
    naver.maps.Event.addListener(window.map, "idle", function() {
        const bounds = window.map.getBounds();
        updateMarkers(bounds);
    });

    console.log("âœ… ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ.");
};

    // âœ… í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    document.getElementById("locationButton").addEventListener("click", () => {
        if (!window.map || !(window.map instanceof naver.maps.Map)) {
            console.error("ë„¤ì´ë²„ ì§€ë„ ê°ì²´ê°€ ì˜¬ë°”ë¥´ê²Œ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateUserLocation(position);
                    startTracking(); // âœ… ìœ„ì¹˜ ì¶”ì  ì‹œì‘
                },
                (error) => {
                    alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
                }
            );
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    });

    // âœ… ìœ„ì¹˜ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸ (watchPosition ì‚¬ìš©)
    function startTracking() {
        if (navigator.geolocation) {
            window.watchId = navigator.geolocation.watchPosition(
                (position) => {
                    updateUserLocation(position);
                },
                (error) => {
                    alert("ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                },
                { enableHighAccuracy: true }
            );
            console.log("ìœ„ì¹˜ ì¶”ì  ì‹œì‘ (watchId):", window.watchId);
        }
    }

    // âœ… ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€
    function stopTracking() {
        if (window.watchId !== null) {
            navigator.geolocation.clearWatch(window.watchId);
            console.log("ìœ„ì¹˜ ì¶”ì ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. watchId:", window.watchId);
            window.watchId = null;

            // âœ… ë§ˆì»¤ ë° ë°˜ê²½ ì›(circle) ì œê±°
            if (window.currentLocationMarker) {
                window.currentLocationMarker.setMap(null);
                window.currentLocationMarker = null;
            }
            if (window.locationCircle) {
                window.locationCircle.setMap(null);
                window.locationCircle = null;
            }
        } else {
            console.warn("ìœ„ì¹˜ ì¶”ì ì´ ì´ë¯¸ ì¤‘ì§€ëœ ìƒíƒœì…ë‹ˆë‹¤.");
        }
    }

    // âœ… "ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€" ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById("stopTrackingButton").addEventListener("click", stopTracking);

    // âœ… í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìœ„ì¹˜ ë³€ê²½ ì‹œ ì‹¤í–‰)
    function updateUserLocation(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const currentLocation = new naver.maps.LatLng(lat, lon);

        console.log("í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:", currentLocation);

        // âœ… ì§€ë„ ì¤‘ì‹¬ ì´ë™
        window.map.setCenter(currentLocation);
        window.map.setZoom(16);

        // âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
        if (window.currentLocationMarker) {
            window.currentLocationMarker.setMap(null);
        }

        // âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
        window.currentLocationMarker = new naver.maps.Marker({
            position: currentLocation,
            map: window.map,
            icon: {
                content: `<div style="width: 14px; height: 14px; background-color: red; border-radius: 50%; border: 3px solid white;"></div>`,
                anchor: new naver.maps.Point(7, 7)
            }
        });

    }
/*
    // âœ… ì§€ë„ í¬ê¸° ìë™ ì¡°ì •
    const mapElement = document.getElementById("map");

    function updateMapSize() {
        if (window.map) {
            mapElement.style.width = "100%";
            mapElement.style.height = `calc(100vh - 260px)`;
            window.map.refresh(); // âœ… ì§€ë„ í¬ê¸° ê°•ì œ ì—…ë°ì´íŠ¸
        }
    }

    new ResizeObserver(updateMapSize).observe(mapElement);
    window.addEventListener("resize", updateMapSize);
*/


let apartmentData = []; // âœ… ì „ì²´ ì•„íŒŒíŠ¸ ë°ì´í„° ì €ì¥
let apartmentMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ë§ˆì»¤ ì €ì¥
let markerCluster = null; // âœ… ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§ ê°ì²´

// âœ… 1. IndexedDBì— ë°ì´í„° ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸° (ë¡œì»¬ ìºì‹±)
async function getCachedApartments() {
    return new Promise((resolve) => {
        const request = indexedDB.open("ApartmentDB", 1);
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("apartments")) {
                db.createObjectStore("apartments", { keyPath: "id" });
            }
        };
        request.onsuccess = (event) => {
            const db = event.target.result;
            const transaction = db.transaction("apartments", "readonly");
            const store = transaction.objectStore("apartments");
            const getRequest = store.getAll();
            getRequest.onsuccess = () => resolve(getRequest.result);
            getRequest.onerror = () => resolve([]);
        };
        request.onerror = () => resolve([]);
    });
}

async function cacheApartments(data) {
    const request = indexedDB.open("ApartmentDB", 1);
    request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction("apartments", "readwrite");
        const store = transaction.objectStore("apartments");
        data.forEach((apartment, index) => {
            store.put({ id: index, ...apartment });
        });
    };
}

// âœ… 2. ì•„íŒŒíŠ¸ ë°ì´í„°ë¥¼ fetch()ë¡œ ê°€ì ¸ì˜¤ê¸°
async function loadApartments() {
    let cachedData = await getCachedApartments();
    if (cachedData.length > 0) {
        apartmentData = cachedData;
        console.log("âœ… ìºì‹œëœ ì•„íŒŒíŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ");
        return;
    }

    try {
        //const response = await fetch("https://your-github-username.github.io/data/apt.json"); // âœ… JSON íŒŒì¼ ì‚¬ìš©
		const response = await fetch("apt.json");
        const data = await response.json();
console.log(data);
        apartmentData = data.map((apt, index) => ({
            id: index,
            name: apt[0], // ì•„íŒŒíŠ¸ ì´ë¦„
            year: apt[1], // ê±´ì¶•ë…„ë„
            units: parseInt(apt[2], 10), // ì„¸ëŒ€ìˆ˜
            lat: parseFloat(apt[3]), // ìœ„ë„
            lng: parseFloat(apt[4]) // ê²½ë„
        }));

        // âœ… ë°ì´í„° ìºì‹±
        cacheApartments(apartmentData);
        console.log("âœ… ì•„íŒŒíŠ¸ ë°ì´í„° fetch ì™„ë£Œ");
    } catch (error) {
        console.error("âŒ ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }
}

// âœ… 3. ì§€ë„ ì´ë™í•  ë•Œë§ˆë‹¤ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸ë§Œ ë§ˆì»¤ë¡œ í‘œì‹œ
function updateMarkers(bounds) {
    // âœ… ê¸°ì¡´ ë§ˆì»¤ ì œê±°
console.log(bounds);
    apartmentMarkers.forEach(marker => marker.setMap(null));
    apartmentMarkers = [];

    // âœ… í˜„ì¬ ì§€ë„ ë²”ìœ„ì— ìˆëŠ” ì•„íŒŒíŠ¸ í•„í„°ë§
    let filteredApartments = apartmentData.filter(apartment => {
        return bounds.hasLatLng(new naver.maps.LatLng(apartment.lat, apartment.lng));
    });

    console.log("ğŸ“Œ í˜„ì¬ ì§€ë„ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸:", filteredApartments.length, "ê°œ");

    // âœ… ìƒˆë¡œìš´ ë§ˆì»¤ ì¶”ê°€
    filteredApartments.forEach(apartment => {
        const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(apartment.lat, apartment.lng),
            title: `${apartment.name} (${apartment.year}, ${apartment.units}ì„¸ëŒ€)`
        });
        apartmentMarkers.push(marker);
    });

  // âœ… ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§ ì ìš© (ì˜¬ë°”ë¥¸ ë°©ì‹)

console.log("ë„¤ì´ë²„ ì§€ë„ ê°ì²´:", window.naver.maps);
//console.log("MarkerClustering ê°ì²´:", naver.maps.visualization);

            if (markerCluster) {
                markerCluster.setMarkers(apartmentMarkers);
            } else {
                markerCluster = new MarkerClustering({
                    minClusterSize: 2,
                    maxZoom: 16,
                    map: window.map,
                    markers: apartmentMarkers
                });
            }
}


</script>

</body>
</html>
