<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>hongbuMemo DB ì´ˆê¸°í™”</title>
  <style>
    body { font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; margin: 16px; }
    .card { border: 1px solid #333; border-radius: 12px; padding: 14px; margin: 12px 0; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #555; background: #111; color: #fff; font-weight: 700; }
    button:disabled { opacity: .5; }
    label { display: flex; gap: 10px; align-items: center; margin: 6px 0; }
    pre { white-space: pre-wrap; word-break: break-word; background: #0b0b0b; color: #d7d7d7; padding: 12px; border-radius: 10px; border: 1px solid #333; }
    .warn { color: #ffb020; }
    .ok { color: #7CFF7C; }
    .err { color: #ff6b6b; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h2>hongbuMemo DB ì´ˆê¸°í™”(ì‚­ì œ) í˜ì´ì§€</h2>

  <div class="card">
    <div class="row">
      <button id="btnDelete">ğŸ§¨ hongbuMemo ì‚­ì œ</button>
      <button id="btnCheck">ğŸ” í˜„ì¬ ìƒíƒœ í™•ì¸</button>
      <button id="btnClearLog">ğŸ§¹ ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <div style="margin-top:10px;">
      <label><input type="checkbox" id="chkCaches" checked> Cache Storageë„ ê°™ì´ ì‚­ì œ (ê¶Œì¥)</label>
      <label><input type="checkbox" id="chkSW" checked> Service Worker ë“±ë¡ë„ í•´ì œ (ê¶Œì¥)</label>
    </div>

    <p class="warn" style="margin-top:10px;">
      âš ï¸ ì‚­ì œê°€ â€œblockedâ€ë¡œ ëœ¨ë©´: ë‹¤ë¥¸ íƒ­(í™ë¶€ í˜ì´ì§€ í¬í•¨)ì„ ì „ë¶€ ë‹«ê³ , ì´ í˜ì´ì§€ í•œ íƒ­ë§Œ ë‚¨ê¸´ ë’¤ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      iOSëŠ” ì—´ë ¤ìˆëŠ” ì—°ê²°ì´ ìˆìœ¼ë©´ IndexedDB ì‚­ì œê°€ ë§‰íˆëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.
    </p>
  </div>

  <div class="card">
    <h3>ë¡œê·¸</h3>
    <pre id="log"></pre>
  </div>

<script>
(() => {
  const DB_NAME = "hongbuMemo";

  const $log = document.getElementById("log");
  const $btnDelete = document.getElementById("btnDelete");
  const $btnCheck = document.getElementById("btnCheck");
  const $btnClearLog = document.getElementById("btnClearLog");
  const $chkCaches = document.getElementById("chkCaches");
  const $chkSW = document.getElementById("chkSW");

  function now() {
    const d = new Date();
    const pad = n => String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function log(msg, cls="") {
    const line = `[${now()}] ${msg}`;
    $log.textContent += (cls ? `${line}\n` : `${line}\n`);
    // ìƒ‰ì€ ê°„ë‹¨íˆ í…ìŠ¤íŠ¸ë¡œë§Œ, í•„ìš”í•˜ë©´ HTMLë¡œ ë°”ê¿”ë„ ë¨
    console.log(line);
  }

  function clearLog() { $log.textContent = ""; }

  async function listDBsIfPossible() {
    // iOS Safari/ChromeëŠ” indexedDB.databases() ë¯¸ì§€ì›ì¼ ìˆ˜ ìˆìŒ
    if (typeof indexedDB.databases !== "function") {
      log("â„¹ï¸ indexedDB.databases() ë¯¸ì§€ì› í™˜ê²½(iOSì¼ ìˆ˜ ìˆìŒ). DB ëª©ë¡ ì¡°íšŒ ìŠ¤í‚µ");
      return null;
    }
    try {
      const dbs = await indexedDB.databases();
      return dbs;
    } catch (e) {
      log(`â„¹ï¸ DB ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${e?.message || e}`);
      return null;
    }
  }

  async function checkStatus() {
    log("ğŸ” ìƒíƒœ í™•ì¸ ì‹œì‘");
    const dbs = await listDBsIfPossible();
    if (dbs) {
      const names = dbs.map(d => d.name).filter(Boolean);
      const has = names.includes(DB_NAME);
      log(`DB ëª©ë¡: ${names.length ? names.join(", ") : "(ë¹„ì–´ìˆìŒ)"}`);
      log(has ? `âœ… ${DB_NAME} ì¡´ì¬` : `âœ… ${DB_NAME} ì—†ìŒ(ë˜ëŠ” ëª©ë¡ì— ì•ˆ ëœ¸)`);
    }

    // ì‹¤ì œë¡œ ì—´ì–´ë³´ê¸° (ì—´ë¦¬ë©´ ì¡´ì¬ ê°€ëŠ¥ì„± ë†’ìŒ)
    await new Promise((resolve) => {
      const req = indexedDB.open(DB_NAME);
      let done = false;

      req.onupgradeneeded = () => {
        // ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì—¬ê¸°ë¡œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆìŒ(ìƒˆ DB ìƒì„±ë¨)
        // ì´ í˜ì´ì§€ëŠ” "ìƒì„±"ì´ ëª©ì ì´ ì•„ë‹ˆë¼ì„œ ë°”ë¡œ ì¤‘ë‹¨
        log(`âš ï¸ ${DB_NAME} ê°€ ì—†ì–´ì„œ ìƒˆë¡œ ìƒì„±ë˜ë ¤ í•¨(onupgradeneeded). ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.`);
        try { req.transaction.abort(); } catch (e) {}
      };

      req.onsuccess = () => {
        try {
          const db = req.result;
          log(`âœ… open ì„±ê³µ: name=${db.name}, version=${db.version}, stores=${Array.from(db.objectStoreNames).join(", ") || "(ì—†ìŒ)"}`);
          db.close();
        } catch (e) {
          log(`â„¹ï¸ open ì„±ê³µ í›„ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸: ${e?.message || e}`);
        }
        done = true;
        resolve();
      };

      req.onerror = () => {
        log(`âŒ open ì‹¤íŒ¨: ${req.error?.message || req.error}`);
        done = true;
        resolve();
      };

      // í˜¹ì‹œë‚˜ hang ë°©ì§€
      setTimeout(() => { if (!done) { log("â„¹ï¸ open ì‘ë‹µ ì§€ì—°(í™˜ê²½ ì´ìŠˆ ê°€ëŠ¥)"); resolve(); } }, 3000);
    });

    log("ğŸ” ìƒíƒœ í™•ì¸ ì™„ë£Œ");
  }

  async function deleteCaches() {
    if (!("caches" in window) || typeof caches.keys !== "function") {
      log("â„¹ï¸ Cache Storage ë¯¸ì§€ì›. ìŠ¤í‚µ");
      return;
    }
    const keys = await caches.keys();
    if (!keys.length) {
      log("âœ… Cache Storage: ì‚­ì œí•  ìºì‹œ ì—†ìŒ");
      return;
    }
    for (const k of keys) {
      const ok = await caches.delete(k);
      log(`${ok ? "âœ…" : "â„¹ï¸"} cache delete: ${k}`);
    }
  }

  async function unregisterServiceWorkers() {
    if (!("serviceWorker" in navigator) || typeof navigator.serviceWorker.getRegistrations !== "function") {
      log("â„¹ï¸ Service Worker ë¯¸ì§€ì›. ìŠ¤í‚µ");
      return;
    }
    const regs = await navigator.serviceWorker.getRegistrations();
    if (!regs.length) {
      log("âœ… Service Worker: ë“±ë¡ ì—†ìŒ");
      return;
    }
    for (const r of regs) {
      const ok = await r.unregister();
      log(`${ok ? "âœ…" : "â„¹ï¸"} SW unregister: ${r.scope}`);
    }
  }

  async function deleteDB() {
    $btnDelete.disabled = true;
    try {
      log(`ğŸ§¨ IndexedDB ì‚­ì œ ì‹œë„: ${DB_NAME}`);

      const result = await new Promise((resolve) => {
        const req = indexedDB.deleteDatabase(DB_NAME);

        req.onblocked = () => {
          log("âš ï¸ deleteDatabase BLOCKED: ë‹¤ë¥¸ íƒ­/ì°½ì—ì„œ DBë¥¼ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŒ. ëª¨ë“  í™ë¶€ íƒ­ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
        };

        req.onsuccess = () => resolve({ ok: true });
        req.onerror = () => resolve({ ok: false, err: req.error });
      });

      if (result.ok) {
        log(`âœ… DB ì‚­ì œ ì„±ê³µ: ${DB_NAME}`);
      } else {
        log(`âŒ DB ì‚­ì œ ì‹¤íŒ¨: ${result.err?.message || result.err}`);
      }

      if ($chkCaches.checked) {
        log("ğŸ§¹ Cache Storage ì‚­ì œ ì‹œì‘");
        await deleteCaches();
        log("ğŸ§¹ Cache Storage ì‚­ì œ ì™„ë£Œ");
      }

      if ($chkSW.checked) {
        log("ğŸ§¹ Service Worker í•´ì œ ì‹œì‘");
        await unregisterServiceWorkers();
        log("ğŸ§¹ Service Worker í•´ì œ ì™„ë£Œ");
      }

      log("âœ… ì „ì²´ ì‘ì—… ì™„ë£Œ. ì´ì œ í™ë¶€ í˜ì´ì§€ë¡œ ëŒì•„ê°€ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ìƒˆ DBë¡œ ì¬ìƒì„±ë©ë‹ˆë‹¤.");
    } catch (e) {
      log(`âŒ ì˜ˆì™¸: ${e?.message || e}`);
    } finally {
      $btnDelete.disabled = false;
    }
  }

  $btnDelete.addEventListener("click", deleteDB);
  $btnCheck.addEventListener("click", checkStatus);
  $btnClearLog.addEventListener("click", clearLog);

  // í˜ì´ì§€ ë¡œë“œì‹œ ìƒíƒœ í•œ ë²ˆ í‘œì‹œ
  clearLog();
  log("hongbuMemo ì´ˆê¸°í™” í˜ì´ì§€ ë¡œë“œë¨");
  checkStatus();
})();
</script>
</body>
</html>
