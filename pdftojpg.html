<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF to JPG</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    input, button { margin: 10px; }
    #progress { font-size: 18px; margin-top: 20px; }
    #downloadContainer { margin-top: 20px; display: flex; flex-direction: column; align-items: center; }
    #downloadBtn { display: none; padding: 10px 20px; font-size: 16px; cursor: pointer; }

    #passwordContainer { display: none; margin-top: 10px; }
    #pdfPassword { padding: 8px 10px; font-size: 14px; width: 240px; }
  </style>
</head>

<body>
  <h1>[ë£¨ì‹œí¼í™] PDF to JPG</h1>

  <input type="file" id="pdfInput" accept="application/pdf" />
  <div id="passwordContainer">
    <input type="password" id="pdfPassword" placeholder="PDF ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
    <button id="passwordBtn">ë¹„ë°€ë²ˆí˜¸ ì ìš©</button>
  </div>

  <div id="progress">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>

  <div id="downloadContainer">
    <button id="downloadBtn">ZIP ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // âœ… worker ì„¤ì • (ì¤‘ìš”)
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";

      const pdfInput = document.getElementById('pdfInput');
      const progressEl = document.getElementById('progress');
      const downloadBtn = document.getElementById('downloadBtn');

      const passwordContainer = document.getElementById('passwordContainer');
      const pdfPasswordInput = document.getElementById('pdfPassword');
      const passwordBtn = document.getElementById('passwordBtn');

      let latestZipBlob = null;

      function showPasswordUI(msg) {
        passwordContainer.style.display = 'block';
        progressEl.innerText = msg || "ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•œ PDFì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        pdfPasswordInput.value = "";
        pdfPasswordInput.focus();
      }
      function hidePasswordUI() {
        passwordContainer.style.display = 'none';
        pdfPasswordInput.value = "";
      }

      async function openPdf(pdfData) {
        return new Promise((resolve, reject) => {
          const task = pdfjsLib.getDocument({ data: pdfData });

          task.onPassword = (updatePassword, reason) => {
            showPasswordUI(reason === 2 ? "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”." : "ë¹„ë°€ë²ˆí˜¸ê°€ ê±¸ë¦° PDFì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            const handler = () => {
              updatePassword(pdfPasswordInput.value || "");
              passwordBtn.removeEventListener('click', handler);
            };
            passwordBtn.addEventListener('click', handler);
          };

          task.promise.then(resolve).catch(reject);
        });
      }

      async function convert(pdf) {
        const zip = new JSZip();

        for (let i = 1; i <= pdf.numPages; i++) {
          progressEl.innerText = `ë³€í™˜ ì¤‘... (${i}/${pdf.numPages})`;

          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 2.0 });

          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          await page.render({ canvasContext: ctx, viewport }).promise;

          const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
          zip.file(`page_${i}.jpg`, base64, { base64: true });
        }

        return zip;
      }

      // âœ… ë””ë²„ê·¸ìš©: ì´ë²¤íŠ¸ê°€ ë¶™ëŠ”ì§€ ë°”ë¡œ í™•ì¸
      console.log("âœ… pdfInput found?", !!pdfInput);

      pdfInput.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  // âœ… ì™„ì „ ì´ˆê¸°í™” (ì´ê²Œ í•µì‹¬)
  hidePasswordUI();
  pdfPasswordInput.value = "";
  progressEl.innerText = "PDFë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  downloadBtn.style.display = 'none';
  latestZipBlob = null;

  // ğŸ”¥ ê°™ì€ íŒŒì¼ ì¬ì„ íƒë„ change ì´ë²¤íŠ¸ ë°œìƒí•˜ê²Œ
  e.target.value = "";

  try {
    const pdfData = new Uint8Array(await file.arrayBuffer());

    // âœ… ë§¤ë²ˆ ìƒˆ loadingTask ìƒì„±
    const pdf = await new Promise((resolve, reject) => {
      const task = pdfjsLib.getDocument({ data: pdfData });

      let passwordHandler = null;

      task.onPassword = (updatePassword, reason) => {
        showPasswordUI(
          reason === 2
            ? "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”."
            : "ë¹„ë°€ë²ˆí˜¸ê°€ ê±¸ë¦° PDFì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
        );

        // âœ… ì´ì „ í•¸ë“¤ëŸ¬ ì œê±°
        if (passwordHandler) {
          passwordBtn.removeEventListener('click', passwordHandler);
        }

        passwordHandler = () => {
          updatePassword(pdfPasswordInput.value || "");
        };

        passwordBtn.addEventListener('click', passwordHandler);
      };

      task.promise.then(resolve).catch(reject);
    });

    hidePasswordUI();
    progressEl.innerText = "PDFë¥¼ ë³€í™˜ ì¤‘...";

    const zip = await convert(pdf);

    progressEl.innerText = "ë³€í™˜ ì™„ë£Œ!";
    downloadBtn.style.display = 'block';

    downloadBtn.onclick = async () => {
      if (!latestZipBlob) {
        downloadBtn.disabled = true;
        downloadBtn.innerText = "ZIP ìƒì„± ì¤‘...";
        latestZipBlob = await zip.generateAsync({ type: "blob" });
        downloadBtn.disabled = false;
        downloadBtn.innerText = "ZIP ë‹¤ìš´ë¡œë“œ";
      }
      saveAs(latestZipBlob, "converted_images.zip");
    };

  } catch (err) {
    console.error(err);
    hidePasswordUI();
    progressEl.innerText = "ì˜¤ë¥˜: PDFë¥¼ ì—´ê±°ë‚˜ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
  }
});

    });
  </script>
</body>
</html>
