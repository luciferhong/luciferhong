<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì‹œêµ°êµ¬ ë©”ëª¨ í˜ì´ì§€ ì €ì¥ (ë©”ëª¨ ìˆëŠ” ì§€ì—­ë§Œ + ì‹œë„í‘œì‹œ)</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "ë§‘ì€ ê³ ë”•", sans-serif; margin: 16px; }
  h2 { margin: 0 0 10px 0; }
  .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  select, button { font-size: 14px; padding: 8px 10px; }
  button { cursor:pointer; }
  button:disabled { cursor: not-allowed; opacity: 0.65; }
  .card { border:1px solid #e5e5e5; border-radius: 12px; padding: 12px; margin: 10px 0; }
  #status { white-space: pre-wrap; font-size: 13px; line-height: 1.35; }
  .ok { background:#f3fff7; border-color:#b7ebc6; }
  .danger { background:#fff5f5; border-color:#f2b8b5; }
  .muted { color:#666; font-size: 12px; }
  #renderArea { margin-top: 12px; }
  .apt { margin-bottom: 14px; padding: 12px; border: 1px dashed #ccc; border-radius: 12px; }
  .apt h3 { margin: 0 0 6px 0; font-size: 16px; }
  .meta { font-size: 13px; color:#333; margin-bottom: 8px; }
  pre { margin: 8px 0 10px 0; padding: 10px; background: #f7f7f7; border-radius: 10px; overflow:auto; white-space: pre-wrap; word-break: break-word; }
  .images { display:flex; flex-wrap:wrap; gap:6px; }
  .images img { max-width: 220px; max-height: 220px; border-radius: 10px; border: 1px solid #ddd; cursor: zoom-in; }

  /* ì´ë¯¸ì§€ ëª¨ë‹¬ */
  #imageModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.82); justify-content:center; align-items:center; z-index:99999; }
  #modalImg { max-width:92vw; max-height:92vh; border-radius:10px; background:#fff; }
  #closeHint { position:absolute; bottom:16px; left:50%; transform: translateX(-50%); color:#fff; font-size: 12px; opacity: 0.85; }
</style>
</head>
<body>

<h2>ğŸ’¾ ì‹œêµ°êµ¬ ë©”ëª¨ í˜ì´ì§€ ì €ì¥</h2>
<div class="muted">
  â‘  ì‹œêµ°êµ¬ ëª©ë¡ì€ <b>ë©”ëª¨ê°€ ìˆëŠ” ì§€ì—­ë§Œ</b> ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤(ì‹œë„ í¬í•¨). â‘¡ <b>ì¡°íšŒ</b> ë²„íŠ¼ìœ¼ë¡œ ë©”ëª¨/ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
  â‘¢ ë¡œë”©ì´ ëë‚˜ë©´ <b>í˜ì´ì§€ ì €ì¥</b> ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤. â‘£ ì‚¬ì§„ í´ë¦­ ì‹œ í™•ëŒ€ë©ë‹ˆë‹¤.
</div>

<div class="card">
  <div class="row">
    <label>ì‹œêµ°êµ¬
      <select id="regionSelect" disabled>
        <option value="">ì§€ì—­ ë¡œë”©ì¤‘...</option>
      </select>
    </label>

    <label class="muted" style="display:flex; gap:6px; align-items:center;">
      <input type="checkbox" id="onlyHasMemo" checked />
      ë©”ëª¨/ì‚¬ì§„ ìˆëŠ” ì•„íŒŒíŠ¸ë§Œ
    </label>

    <button id="queryBtn">ğŸ” ì¡°íšŒ</button>
    <button id="downloadPageBtn" disabled>â³ ë¡œë”© ì¤‘...</button>
  </div>
</div>

<div id="status" class="card">ì´ˆê¸°í™” ì¤‘â€¦</div>
<div id="renderArea"></div>

<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div id="imageModal" aria-hidden="true">
  <img id="modalImg" alt="í™•ëŒ€ ì´ë¯¸ì§€" />
  <div id="closeHint">ë°°ê²½ í´ë¦­(ë˜ëŠ” ESC)ìœ¼ë¡œ ë‹«ê¸°</div>
</div>

<script>
(() => {
  // ---------- IndexedDB ----------
  const DB_NAME = 'hongbuMemo';
  const DB_VERSION = 4;
  const STORE_NOTES = 'apartmentNotes';

  // ---------- DOM ----------
  const els = {
    region: document.getElementById('regionSelect'),
    onlyHas: document.getElementById('onlyHasMemo'),
    query: document.getElementById('queryBtn'),
    download: document.getElementById('downloadPageBtn'),
    status: document.getElementById('status'),
    render: document.getElementById('renderArea'),
    imageModal: document.getElementById('imageModal'),
    modalImg: document.getElementById('modalImg'),
  };

  // ---------- State ----------
  // apt.json: id -> meta
  const aptById = new Map(); // id -> {sido, sidoNm, sigungu, sigunguNm, name, year, units}
  // regionKey -> {label, sido, sigungu}
  const regionOptions = new Map(); // key -> {label, sido, sigungu}
  // preload: note cache only for "ë©”ëª¨ ìˆëŠ” ì§€ì—­" ëª©ë¡ ìƒì„±
  let preloadNotes = null;
  // ì¡°íšŒ í›„: ë Œë”ìš© note cache
  let lastNotesCache = null;

  function setStatus(text, cls='') {
    els.status.textContent = text;
    els.status.className = 'card ' + (cls || '');
  }

  function setDownloadReady(isReady) {
    if (isReady) {
      els.download.disabled = false;
      els.download.textContent = 'ğŸ’¾ í˜ì´ì§€ ì €ì¥(ì´ë¯¸ì§€ í¬í•¨)';
    } else {
      els.download.disabled = true;
      els.download.textContent = 'â³ ë¡œë”© ì¤‘...';
    }
  }

  function setQueryBusy(isBusy) {
    els.query.disabled = isBusy;
    els.query.textContent = isBusy ? 'â³ ì¡°íšŒ ì¤‘...' : 'ğŸ” ì¡°íšŒ';
    els.region.disabled = isBusy;
    els.onlyHas.disabled = isBusy;
  }

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function stripHtmlAndTrim(s) {
    return String(s ?? '')
      .replace(/<[^>]*>/g, '')
      .replace(/&nbsp;/gi, ' ')
      .trim();
  }

  function hasMemoContent(n) {
    const memoText = stripHtmlAndTrim(n?.memo);
    const imgs = Array.isArray(n?.images) ? n.images : [];
    return memoText.length > 0 || imgs.length > 0;
  }

  function noteIdOf(n) {
    return String(n?.id ?? n?.aptId ?? n?.apartmentId ?? '').trim();
  }

  async function waitForImagesLoaded(root) {
    const imgs = Array.from(root.querySelectorAll('img'));
    if (imgs.length === 0) return;
    await Promise.all(imgs.map(img => new Promise(resolve => {
      if (img.complete) return resolve();
      const done = () => resolve();
      img.addEventListener('load', done, { once: true });
      img.addEventListener('error', done, { once: true });
    })));
  }

  // ---------- DB ----------
  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = () => reject(new Error('DB ì—´ê¸° ì‹¤íŒ¨'));
    });
  }

  async function readAllNotes() {
    const db = await openDB();
    const tx = db.transaction([STORE_NOTES], 'readonly');
    const st = tx.objectStore(STORE_NOTES);

    const notes = [];
    await new Promise((resolve, reject) => {
      const req = st.openCursor();
      req.onsuccess = e => {
        const cur = e.target.result;
        if (!cur) { resolve(); return; }
        notes.push(cur.value);
        cur.continue();
      };
      req.onerror = () => reject(new Error('cursor ì‹¤íŒ¨'));
    });

    db.close();
    return notes;
  }

  // ---------- apt.json ----------
  async function loadAptJson() {
    const res = await fetch(`apt.json?t=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) throw new Error('apt.json fetch ì‹¤íŒ¨: HTTP ' + res.status);

    // JSONì´ ì•„ë‹ˆë¼ HTML(404 í˜ì´ì§€ ë“±)ì´ ì˜¤ë©´ ì—¬ê¸°ì„œ ì—ëŸ¬ê°€ ë‚˜ëŠ”ë°,
    // ì´ë¥¼ ëª…í™•íˆ ë³´ì—¬ì£¼ê¸° ìœ„í•´ content-type ì²´í¬
    const ct = (res.headers.get('content-type') || '').toLowerCase();
    if (!ct.includes('application/json') && !ct.includes('text/json')) {
      const head = (await res.text()).slice(0, 120);
      throw new Error('apt.jsonì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤(ê²½ë¡œ/ì„œë²„ í™•ì¸). ì‘ë‹µ head: ' + head);
    }

    const data = await res.json();
    const arr = Array.isArray(data) ? data :
      (Array.isArray(data?.apartments) ? data.apartments :
       Array.isArray(data?.data) ? data.data : []);

    aptById.clear();
    for (const a of arr) {
      const id = String(a.id ?? a.apartmentId ?? a.aptId ?? '').trim();
      if (!id) continue;
      aptById.set(id, {
        sido: String(a.sido ?? a.sidoCode ?? '').trim(),
        sidoNm: String(a.sidoNm ?? a.sidoName ?? '').trim(),
        sigungu: String(a.sigungu ?? a.sigunguCode ?? '').trim(),
        sigunguNm: String(a.sigunguNm ?? a.sigunguName ?? '').trim(),
        name: String(a.name ?? '').trim(),
        year: a.year ?? '',
        units: (a.units != null ? parseInt(a.units, 10) : ''),
      });
    }
  }

  // ---------- Region options (ë©”ëª¨ ìˆëŠ” ì§€ì—­ë§Œ + ì‹œë„ í‘œì‹œ) ----------
  function regionKeyOf(meta) {
    // ë‚¨êµ¬ ê°™ì€ ì¤‘ë³µ ë°©ì§€: sido + sigungu
    const s1 = String(meta?.sido ?? '').trim();
    const s2 = String(meta?.sigungu ?? '').trim();
    return `${s1}__${s2}`;
  }

  function regionLabelOf(meta) {
    const sidoNm = (meta?.sidoNm || meta?.sido || '').trim();
    const sigunguNm = (meta?.sigunguNm || meta?.sigungu || '').trim();
    return (sidoNm && sigunguNm) ? `${sidoNm} ${sigunguNm}` : (sigunguNm || sidoNm || 'ì•Œìˆ˜ì—†ìŒ');
  }

  async function buildRegionOptionsFromNotes(notes) {
    regionOptions.clear();

    for (const n of notes) {
      if (!hasMemoContent(n)) continue;
      const id = noteIdOf(n);
      if (!id) continue;
      const meta = aptById.get(id);
      if (!meta) continue;
      if (!meta.sido || !meta.sigungu) continue;

      const key = regionKeyOf(meta);
      if (!regionOptions.has(key)) {
        regionOptions.set(key, {
          key,
          label: regionLabelOf(meta),
          sido: String(meta.sido).trim(),
          sigungu: String(meta.sigungu).trim(),
        });
      }
    }

    const items = Array.from(regionOptions.values())
      .sort((a, b) => a.label.localeCompare(b.label, 'ko'));

    els.region.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'ì „ì²´(ë©”ëª¨ ìˆëŠ” ì§€ì—­)';
    els.region.appendChild(optAll);

    for (const it of items) {
      const opt = document.createElement('option');
      opt.value = it.key;            // "sido__sigungu"
      opt.textContent = it.label;    // "ì‹œë„ ì‹œêµ°êµ¬"
      els.region.appendChild(opt);
    }
  }

  function selectedRegionFilter() {
    const v = (els.region.value || '').trim();
    if (!v) return null;
    const it = regionOptions.get(v);
    if (!it) return null;
    return { sido: it.sido, sigungu: it.sigungu };
  }

  // ---------- Image modal (event delegation) ----------
  function openModal(src){
    els.modalImg.src = src;
    els.imageModal.style.display = 'flex';
    els.imageModal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    els.imageModal.style.display = 'none';
    els.imageModal.setAttribute('aria-hidden','true');
    els.modalImg.removeAttribute('src');
  }

  els.render.addEventListener('click', (e) => {
    const img = e.target && e.target.closest && e.target.closest('img');
    if (!img) return;
    const src = img.getAttribute('src') || '';
    if (!src) return;
    openModal(src);
  });

  els.imageModal.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeModal();
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });

  // ---------- Render ----------
  async function renderFromNotes(notes) {
    setDownloadReady(false);
    els.render.innerHTML = '';

    const onlyHas = els.onlyHas.checked;
    const filter = selectedRegionFilter();

    let rendered = 0;
    let imagesCount = 0;

    for (const n of notes) {
      if (onlyHas && !hasMemoContent(n)) continue;

      const id = noteIdOf(n);
      if (!id) continue;

      const meta = aptById.get(id);
      if (!meta) continue;

      if (filter) {
        if (String(meta.sido || '').trim() !== filter.sido) continue;
        if (String(meta.sigungu || '').trim() !== filter.sigungu) continue;
      }

      const div = document.createElement('div');
      div.className = 'apt';
      div.innerHTML = `
        <h3>${escapeHtml(meta.name || ('ID ' + id))}</h3>
        <div class="meta">ì…ì£¼ì‹œê¸°(ì—°ë„): ${escapeHtml(meta.year || '-')} / ì´ì„¸ëŒ€ìˆ˜: ${escapeHtml(meta.units || '-')}</div>
        <pre>${escapeHtml((n.memo || '').trim())}</pre>
        <div class="images"></div>
      `;

      const imgBox = div.querySelector('.images');
      const imgs = (Array.isArray(n.images) ? n.images : []);
      imagesCount += imgs.length;
      for (const src of imgs) {
        const img = document.createElement('img');
        img.src = src;
        imgBox.appendChild(img);
      }

      els.render.appendChild(div);
      rendered++;
    }

    await waitForImagesLoaded(els.render);
    setDownloadReady(true);
    return { rendered, imagesCount };
  }

  // ---------- Export (self-contained html) ----------
  async function ensureImagesAreDataUrls(root) {
    const imgs = Array.from(root.querySelectorAll("img"));
    for (const img of imgs) {
      const src = img.getAttribute("src") || "";
      if (src.startsWith("data:")) continue;
      try {
        const res = await fetch(src, { cache: "no-store" });
        const blob = await res.blob();
        const dataUrl = await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(blob);
        });
        img.setAttribute("src", dataUrl);
      } catch (e) {
        console.warn("ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨:", src, e);
      }
    }
  }

  function downloadSelfContainedHtml(filename, htmlString) {
    const blob = new Blob([htmlString], { type: "text/html;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2000);
  }

  async function exportCurrentPageWithImages() {
    await ensureImagesAreDataUrls(els.render);

    const styles = Array.from(document.querySelectorAll("style"))
      .map(s => s.innerHTML)
      .join("\n");

    const now = new Date();
    const ts = now.toISOString().slice(0,19).replace("T","_").replace(/:/g,"-");
    const regionLabel = els.region?.selectedOptions?.[0]?.textContent || 'ì „ì²´';
    const safeLabel = String(regionLabel).replace(/[\\/:*?"<>|]/g, "_");
    const filename = `ì‹œêµ°êµ¬ë©”ëª¨_${safeLabel}_${ts}.html`;

    // backtick ë°©ì§€
    const contentHTML = String(els.render.innerHTML || '').replace(/`/g, '&#96;');

    const out = `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>${safeLabel} ë©”ëª¨</title>
<style>${styles}</style>
<style>
  #imageModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.82);justify-content:center;align-items:center;z-index:99999}
  #modalImg{max-width:92vw;max-height:92vh;border-radius:10px;background:#fff}
  #closeHint{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);color:#fff;font-size:12px;opacity:.85}
</style>
</head>
<body>
<h2>${safeLabel} ë©”ëª¨</h2>

<div id="exportContent">${contentHTML}</div>

<div id="imageModal" aria-hidden="true">
  <img id="modalImg" alt="í™•ëŒ€ ì´ë¯¸ì§€" />
  <div id="closeHint">ë°°ê²½ í´ë¦­(ë˜ëŠ” ESC)ìœ¼ë¡œ ë‹«ê¸°</div>
</div>

<script>
(function(){
  const root = document.getElementById('exportContent');
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImg');

  function openModal(src){
    modalImg.src = src;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
    modalImg.removeAttribute('src');
  }

  root.addEventListener('click', (e) => {
    const img = e.target && e.target.closest && e.target.closest('img');
    if (!img) return;
    const src = img.getAttribute('src') || '';
    if (!src) return;
    openModal(src);
  });

  modal.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeModal();
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });
})();
<\/script>

</body>
</html>`;

    downloadSelfContainedHtml(filename, out);
  }

  // ---------- Events ----------
  els.query.addEventListener('click', async () => {
    try {
      if (!aptById.size) {
        setStatus('âš ï¸ ì§€ì—­ ë¡œë”©ì´ ì•„ì§ ëë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'danger');
        return;
      }

      setQueryBusy(true);
      setDownloadReady(false);
      els.render.innerHTML = '';
      setStatus('ì¡°íšŒ ì¤‘â€¦ (ë©”ëª¨/ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤)', '');

      // notesëŠ” ì‹¤ì œ ë Œë”ë¥¼ ìœ„í•´ ë‹¤ì‹œ ì½ìŒ(ìµœì‹  ë°˜ì˜)
      const notes = await readAllNotes();
      lastNotesCache = notes;

      const { rendered, imagesCount } = await renderFromNotes(notes);

      // í†µê³„
      const filter = selectedRegionFilter();
      const onlyHas = els.onlyHas.checked;
      const usedSet = new Set();
      let filteredCount = 0;

      for (const n of notes) {
        if (onlyHas && !hasMemoContent(n)) continue;
        const id = noteIdOf(n);
        const meta = aptById.get(id);
        if (!meta) continue;
        if (filter) {
          if (String(meta.sido || '').trim() !== filter.sido) continue;
          if (String(meta.sigungu || '').trim() !== filter.sigungu) continue;
        }
        filteredCount++;
        if (id) usedSet.add(id);
      }

      setStatus(
        `âœ… ì¡°íšŒ ì™„ë£Œ\n` +
        `- ë©”ëª¨ ë ˆì½”ë“œ: ${notes.length}ê°œ\n` +
        `- í‘œì‹œ: ${rendered}ê°œ\n` +
        `- í‘œì‹œ ì•„íŒŒíŠ¸ ID: ${usedSet.size}ê°œ\n` +
        `- ì´ë¯¸ì§€: ${imagesCount}ê°œ\n\n` +
        `â€» ì´ë¯¸ì§€ ë¡œë”©ì´ ëë‚˜ë©´ ì €ì¥ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.`,
        'ok'
      );
    } catch (e) {
      console.error(e);
      lastNotesCache = null;
      setDownloadReady(false);
      setStatus(
        `âŒ ì¡°íšŒ ì‹¤íŒ¨: ${e?.message || e}\n\n` +
        `ì²´í¬:\n` +
        `1) file:// ë¡œ ì—´ì§€ ë§ê³  http://127.0.0.1:8000 ê°™ì€ ì„œë²„ë¡œ ì—´ê¸°\n` +
        `2) ê°™ì€ ê²½ë¡œì— apt.json ì¡´ì¬ ì—¬ë¶€\n` +
        `3) í•´ë‹¹ ì˜¤ë¦¬ì§„ì— hongbuMemo(apartmentNotes)ì— ë©”ëª¨ê°€ ì €ì¥ë˜ì–´ ìˆëŠ”ì§€`,
        'danger'
      );
    } finally {
      setQueryBusy(false);
    }
  });

  // ì¡°íšŒ í›„ì—ë§Œ í•„í„° ë³€ê²½ ì‹œ ë¦¬ë Œë”
  els.region.addEventListener('change', async () => {
    if (!lastNotesCache) return;
    const { rendered, imagesCount } = await renderFromNotes(lastNotesCache);
    const head = els.status.textContent.split('\n\n')[0];
    setStatus(`${head}\n- í‘œì‹œ: ${rendered}ê°œ\n- ì´ë¯¸ì§€: ${imagesCount}ê°œ`, 'ok');
  });

  els.onlyHas.addEventListener('change', async () => {
    if (!lastNotesCache) return;
    const { rendered, imagesCount } = await renderFromNotes(lastNotesCache);
    const head = els.status.textContent.split('\n\n')[0];
    setStatus(`${head}\n- í‘œì‹œ: ${rendered}ê°œ\n- ì´ë¯¸ì§€: ${imagesCount}ê°œ`, 'ok');
  });

  els.download.addEventListener('click', exportCurrentPageWithImages);

  // ---------- Init: ë©”ëª¨ ìˆëŠ” ì§€ì—­ë§Œ ë¯¸ë¦¬ êµ¬ì„± ----------
  (async () => {
    setDownloadReady(false);
    setQueryBusy(true);
    setStatus('ì´ˆê¸°í™” ì¤‘â€¦ (ë©”ëª¨ ìˆëŠ” ì§€ì—­ ëª©ë¡ ìƒì„±)', '');
    try {
      // 1) apt.json ë¡œë“œ
      await loadAptJson();

      // 2) notes ë¹ ë¥´ê²Œ ì½ì–´ì„œ(ë Œë”X) ì§€ì—­ ëª©ë¡ë§Œ ìƒì„±
      preloadNotes = await readAllNotes();
      await buildRegionOptionsFromNotes(preloadNotes);

      els.region.disabled = false;
      setStatus('âœ… ì¤€ë¹„ ì™„ë£Œ. ì§€ì—­ ì„ íƒ í›„ ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'ok');

      const regionCount = regionOptions.size;
      const memoIds = new Set();
      for (const n of preloadNotes) {
        if (!hasMemoContent(n)) continue;
        const id = noteIdOf(n);
        if (id) memoIds.add(id);
      }
      // ë²„íŠ¼ì€ ì¡°íšŒ ì „ì—ëŠ” ì €ì¥ ë¶ˆê°€
      setDownloadReady(false);

      // ìƒíƒœì— ê°„ë‹¨ í†µê³„
      const extra = `\n- ë©”ëª¨/ì‚¬ì§„ ìˆëŠ” ì•„íŒŒíŠ¸ ID: ${memoIds.size}ê°œ\n- ë©”ëª¨ ìˆëŠ” ì§€ì—­(ì‹œë„+ì‹œêµ°êµ¬): ${regionCount}ê°œ`;
      setStatus(els.status.textContent + extra, 'ok');
    } catch (e) {
      console.error(e);
      els.region.disabled = true;
      setStatus(
        `âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ${e?.message || e}\n\n` +
        `ì²´í¬:\n` +
        `1) ê°™ì€ ê²½ë¡œì— apt.json ì¡´ì¬ ì—¬ë¶€(ì„œë²„ì—ì„œ ì œê³µ)\n` +
        `2) file:// ë¡œ ì—´ì§€ ë§ê³  http://127.0.0.1:8000 ê°™ì€ ì„œë²„ë¡œ ì—´ê¸°\n` +
        `3) apt.jsonì´ 404ë©´ JSON ëŒ€ì‹  HTMLì´ ë‚´ë ¤ì˜¤ë©°(Unexpected token '<') ì˜¤ë¥˜ê°€ ë‚©ë‹ˆë‹¤`,
        'danger'
      );
    } finally {
      setQueryBusy(false);
    }
  })();

})();
</script>

</body>
</html>
