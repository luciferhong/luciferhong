<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
<link rel="icon" href="metro.png" type="image/png">
  <title>[ë£¨ì‹œí¼í™] 27íƒ„ ë©”íŠ¸ë¡œí™</title>
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=hcuap73kdc"></script>
  <style>
   
#map { width: 100%; height: calc(100vh - 65px); resize: both; }
    #checkbox-container {
      position: absolute;
      top: 65px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-family: sans-serif;
      font-size: 13px;
      max-height: 90vh;
      overflow-y: auto;
    }

    #checkbox-container label {
      display: block;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
<h1 style="font-size: 20px; font-weight: bold; text-align: left; margin-left:10px">
    [ë£¨ì‹œí¼í™] 27íƒ„ ë©”íŠ¸ë¡œí™(ê·¸ ì–´ë””ì—ë„ ì—†ëŠ” ì§€í•˜ì²  ë…¸ì„ ë„)
</h1>
<div id="map"></div>
<div id="checkbox-container"></div>

<!-- 
<div id="control-panel" style="position:absolute; top:10px; right:10px; background:white; padding:10px; border-radius:6px; z-index:1000; box-shadow:0 2px 6px rgba(0,0,0,0.2); font-family:sans-serif; font-size:13px;">
  <button id="start-btn">ì‹œì‘</button>
  <button id="reset-btn">ë¦¬ì…‹</button>
  <button id="copy-btn">ë³µì‚¬</button>
  <pre id="output" style="margin-top:10px; max-height:300px; overflow:auto; white-space:pre-wrap;"></pre>
</div>  -->

<script>
const map = new naver.maps.Map('map', {
  center: new naver.maps.LatLng(37.5665, 126.9780),
  zoom: 13
});

const lineLayers = {};
const lineCheckboxes = {};
const markers = [];
let lastLoadedData = null;

const container = document.getElementById('checkbox-container');

// ìŠ¬ë¼ì´ë” UI
const opacityWrapper = document.createElement('div');
opacityWrapper.style.marginBottom = '10px';

const opacityLabel = document.createElement('div');
opacityLabel.textContent = 'ì§€ë„ íˆ¬ëª…ë„';
opacityLabel.style.marginBottom = '4px';
opacityLabel.style.fontWeight = 'bold';

const opacityInput = document.createElement('input');
opacityInput.type = 'range';
opacityInput.min = 0;
opacityInput.max = 100;
opacityInput.value = 45; // âœ… ì´ˆê¸°ê°’ì„ 30ìœ¼ë¡œ ì„¤ì •
opacityInput.style.width = '100%';
opacityInput.title = 'ì§€ë„ ì´ë¯¸ì§€ íˆ¬ëª…ë„';

opacityWrapper.appendChild(opacityLabel);
opacityWrapper.appendChild(opacityInput);
container.prepend(opacityWrapper);

applyOpacity(); // âœ… ì´ˆê¸° íˆ¬ëª…ë„ ì ìš©


// ì—­ëª… í‘œê¸° ì²´í¬ë°•ìŠ¤
const stationLabelToggle = document.createElement('label');
stationLabelToggle.style.display = 'block';
stationLabelToggle.style.marginTop = '10px';

const stationCheckbox = document.createElement('input');
stationCheckbox.type = 'checkbox';
stationCheckbox.checked = true;
stationCheckbox.style.marginRight = '4px';

stationLabelToggle.appendChild(stationCheckbox);
stationLabelToggle.appendChild(document.createTextNode('ì—­ëª… í‘œê¸°'));
opacityWrapper.appendChild(stationLabelToggle);

// íˆ¬ëª…ë„ ì ìš© í•¨ìˆ˜
function applyOpacity() {
  const opacity = opacityInput.value / 100;
  document.querySelectorAll('#map img').forEach(img => {
    img.style.opacity = opacity;
  });
}

opacityInput.addEventListener('input', applyOpacity);

// ì§€ë„ í™•ëŒ€/ì¶•ì†Œ ì‹œì—ë„ ìœ ì§€
const observer = new MutationObserver(() => {
  setTimeout(applyOpacity, 10);
});
observer.observe(document.getElementById('map'), { childList: true, subtree: true });

// ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
fetch('data-metro-line-1.0.0.json')
  .then(res => res.json())
  .then(data => {
    lastLoadedData = data;
    const lines = data.DATA;

    // ì „ì²´ ì„ íƒ/í•´ì œ
    const allLabel = document.createElement('label');
    const allCheckbox = document.createElement('input');
    allCheckbox.type = 'checkbox';
    allCheckbox.checked = true;
    allLabel.appendChild(allCheckbox);
    allLabel.append(' ì „ì²´ ì„ íƒ / í•´ì œ');
    container.appendChild(allLabel);
    container.appendChild(document.createElement('hr'));

    allCheckbox.addEventListener('click', () => {
      const isChecked = allCheckbox.checked;
      Object.entries(lineCheckboxes).forEach(([lineId, checkbox]) => {
        checkbox.checked = isChecked;
        lineLayers[lineId].forEach(obj => obj.setMap(isChecked ? map : null));
      });
      updateMarkers(lastLoadedData);
    });

    // ë…¸ì„ ë³„ UI ë° ë ˆì´ì–´
    lines.forEach(line => {
      const sections = line.node;
      const firstStation = sections[0]?.station[0];
      const lineId = firstStation?.line || 'ë…¸ì„ ';

      if (!lineLayers[lineId]) {
        lineLayers[lineId] = [];

        const label = document.createElement('label');
label.style.display = 'flex';
label.style.alignItems = 'center';
label.style.gap = '6px';  // ì²´í¬ë°•ìŠ¤ì™€ ë„¤ëª¨ ì‚¬ì´ ê°„ê²©

const checkbox = document.createElement('input');
checkbox.type = 'checkbox';
checkbox.checked = true;
checkbox.dataset.line = lineId;
lineCheckboxes[lineId] = checkbox;

// ìƒ‰ìƒ ë°•ìŠ¤
const colorBox = document.createElement('span');
colorBox.style.width = '12px';
colorBox.style.height = '12px';
colorBox.style.backgroundColor = line.color || '#000';
colorBox.style.borderRadius = '2px';
colorBox.style.flexShrink = '0';

// ë…¸ì„  í…ìŠ¤íŠ¸
const labelText = document.createElement('span');
labelText.textContent = `${lineId}`;

// ì¡°ë¦½
label.appendChild(checkbox);
label.appendChild(colorBox);
label.appendChild(labelText);
container.appendChild(label);



        checkbox.addEventListener('change', () => {
          const isVisible = checkbox.checked;
          lineLayers[lineId].forEach(obj => obj.setMap(isVisible ? map : null));

          // ì „ì²´ ì„ íƒ ìƒíƒœ ë°˜ì˜
          allCheckbox.checked = Object.values(lineCheckboxes).every(cb => cb.checked);

          // ë§ˆì»¤ ê°±ì‹ 
          updateMarkers(lastLoadedData);
        });
      }

      sections.forEach(section => {
        // ì„  (NewVia ê¸°ì¤€)
        if (Array.isArray(section.NewVia)) {
          section.NewVia.forEach(pathArray => {
            const path = pathArray.map(([lat, lng]) => new naver.maps.LatLng(lat, lng));
            const polyline = new naver.maps.Polyline({
              path,
              map: map,
              strokeColor: line.color || '#000000',
              strokeWeight: 4,
              strokeOpacity: 1
            });
            lineLayers[lineId].push(polyline);
          });
        }
      });
    });

    // ìµœì´ˆ ë§ˆì»¤ í‘œì‹œ
    updateMarkers(lastLoadedData);
  });


// ë§ˆì»¤ ê°±ì‹  í•¨ìˆ˜
function updateMarkers(data) {
  markers.forEach(({ marker }) => marker.setMap(null));
  markers.length = 0;

  const showStations = stationCheckbox.checked;

  Object.entries(lineCheckboxes).forEach(([lineId, checkbox]) => {
    if (checkbox.checked) {
      const line = data.DATA.find(l => l.node[0]?.station[0]?.line === lineId);
      if (line) {
        line.node.forEach(section => {
          section.station.forEach(station => {
            const isDuplicate = markers.some(m => m.name === station.name);
            if (!isDuplicate && showStations) {
              const marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(station.lat, station.lng),
                map: map,
                icon: {
                  content: `
                    <div style="
                      background: white;
                      padding: 2px 6px;
                      border: 1px solid #555;
                      border-radius: 3px;
                      font-size: 12px;
                      font-weight: bold;
                      color: black;
                      white-space: nowrap;
                      box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
                    ">${station.name}</div>`,
                  size: new naver.maps.Size(80, 20),
                  anchor: new naver.maps.Point(40, 10)
                }
              });
              markers.push({ marker, name: station.name });
            }
          });
        });
      }
    }
  });
}

// ì—­ëª… í‘œê¸° í† ê¸€ ì‹œ ë§ˆì»¤ ê°±ì‹ 
stationCheckbox.addEventListener('change', () => {
  updateMarkers(lastLoadedData);
});


/// ì¢Œí‘œêµ¬í•˜ê¸°
let isRecording = false;
const coords = [];
const outputEl = document.getElementById('output');

// ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ ê¸°ë¡ ì‹œì‘
document.getElementById('start-btn').addEventListener('click', () => {
  isRecording = true;
});

// ë¦¬ì…‹ ë²„íŠ¼ í´ë¦­ ì‹œ ì´ˆê¸°í™”
document.getElementById('reset-btn').addEventListener('click', () => {
  isRecording = false;
  coords.length = 0;
  outputEl.textContent = '';
});

// ë³µì‚¬ ë²„íŠ¼ í´ë¦­ ì‹œ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬
document.getElementById('copy-btn').addEventListener('click', () => {
  const text = outputEl.textContent.trim();
  if (!text) {
    alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  navigator.clipboard.writeText(text)
    .then(() => alert("ì¢Œí‘œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"))
    .catch(err => alert("ë³µì‚¬ ì‹¤íŒ¨: " + err));
});

// ì§€ë„ í´ë¦­ ì‹œ ì¢Œí‘œ ì €ì¥ ë° ë§ˆì»¤ í‘œì‹œ
naver.maps.Event.addListener(map, 'click', function(e) {
  if (!isRecording) return;

  const lat = parseFloat(e.coord.lat().toFixed(5));
  const lng = parseFloat(e.coord.lng().toFixed(5));
  coords.push([lat, lng]);

  // í´ë¦­í•œ ìœ„ì¹˜ì— ë§ˆì»¤ í‘œì‹œ
  new naver.maps.Marker({
    position: new naver.maps.LatLng(lat, lng),
    map: map,
    icon: {
      content: `<div style="
        background: yellow;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: bold;
        color: black;
        border: 1px solid #333;
      ">ğŸ“</div>`,
      size: new naver.maps.Size(24, 24),
      anchor: new naver.maps.Point(12, 12)
    }
  });

  // ì¶œë ¥ì°½ì— ëˆ„ì  ì¢Œí‘œ í‘œì‹œ
  outputEl.textContent = coords.map(c => `[${c[0]}, ${c[1]}]`).join(',\n') + ',';
});

</script>
</body>
</html>
