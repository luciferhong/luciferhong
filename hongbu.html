<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta id="dynamicViewport" name="viewport" content="width=device-width, initial-scale=0.85, user-scalable=no">

    <link rel="icon" href="route.png" type="image/png">
    <title>[ë£¨ì‹œí¼í™] í™ë¶€ê°€ ê¸°ê°€ë§‰í˜€</title>
	<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=hcuap73kdc"></script>
	<script type="text/javascript" src="MarkerClustering.js"></script>



    <style>
        #map { width: 100%; height: calc(100vh - 260px); resize: both; }
        #controls { margin: 10px; }
        button { margin: 5px; padding: 10px; cursor: pointer; }

		/* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
		#locationButton {
			position: absolute;
			top: 120px; /* ğŸ”¹ ì§€ë„ ë‚´ë¶€ì˜ ìƒë‹¨ */
			left: 5px; /* ğŸ”¹ ì§€ë„ ë‚´ë¶€ì˜ ì™¼ìª½ */
			background-color: white;
			border: 2px solid gray;
			padding: 10px;
			border-radius: 50%;
			cursor: pointer;
			font-size: 18px;
			text-align: center;
			box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
			z-index: 1000; /* ğŸ”¹ ì§€ë„ ìœ„ì— í‘œì‹œ */
		}

		/* ìœ„ì¹˜ ì¶”ì  ì¢…ë£Œ ë²„íŠ¼ */
		#stopTrackingButton {
			position: absolute;
			top: 125px; /* ğŸ”¹ ì§€ë„ ë‚´ë¶€ì˜ ìƒë‹¨ */
			left: 60px; /* ğŸ”¹ í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ê³¼ ê°„ê²© ìœ ì§€ */
			background-color: white;
			border: 2px solid gray;
			padding: 10px;
			border-radius: 50%;
			cursor: pointer;
			font-size: 14px;
			text-align: center;
			box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
			z-index: 1000; /* ğŸ”¹ ì§€ë„ ìœ„ì— í‘œì‹œ */
		}


		#unitFilter {
			width: 60px; /* ìˆ«ì 3ìë¦¬(ìµœëŒ€ 999) ì…ë ¥ ê°€ëŠ¥ */
			height: 10px;
			font-size: 16px;
			text-align: center;
			border: 2px solid #4A90E2; /* íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
			border-radius: 8px;
			padding: 5px;
			outline: none;
			transition: all 0.3s ease-in-out;
		}

		#unitFilter:focus {
			border-color: #2D5DA7; /* í¬ì»¤ìŠ¤ ì‹œ ë” ì§„í•œ íŒŒë€ìƒ‰ */
			box-shadow: 0px 0px 5px rgba(74, 144, 226, 0.5);
		}

	#controls {
    display: flex; /* âœ… ê°€ë¡œ ì •ë ¬ */
    align-items: center; /* âœ… ë‚´ë¶€ ìš”ì†Œ ì„¸ë¡œ ì •ë ¬ */
    gap: 10px; /* âœ… ìš”ì†Œ ê°„ê²© ì¡°ì • */
}

#scaleControls {
    display: flex; /* âœ… ê°€ë¡œ ì •ë ¬ */
    align-items: center; /* âœ… ë²„íŠ¼ì´ ì²´í¬ë°•ìŠ¤ì™€ ê°™ì€ ë†’ì´ë¡œ */
    margin-left: 10px; /* âœ… ê°„ê²© ì¡°ì • */
}

#scaleControls button {
    width: 30px;
    height: 30px;
    font-size: 16px;
    font-weight: bold;
    background-color: white;
    border: 2px solid gray;
    border-radius: 5px;
    cursor: pointer;
    text-align: center;
    margin-left: 5px; /* âœ… ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
    display: flex;
    justify-content: center;
    align-items: center;
}

#scaleControls button:hover {
    background-color: #f0f0f0;
}


    </style>
</head>
<body>
    <h1>[ë£¨ì‹œí¼í™] í™ë¶€ê°€ ê¸°ê°€ë§‰í˜€</h1>
<div id="controls">
    <label for="unitFilter">ìµœì†Œ ì„¸ëŒ€ìˆ˜: </label>
    <input type="number" id="unitFilter" min="0" value="150">
    <label><input type="checkbox" id="toggleApartments" checked>ì•„íŒŒíŠ¸</label>
    <label><input type="checkbox" id="toggleSchools" checked>ì´ˆêµ</label>

    <!-- âœ… ìŠ¤ì¼€ì¼ ì¡°ì • ë²„íŠ¼ì„ 'ì´ˆë“±í•™êµ' ì²´í¬ë°•ìŠ¤ ì˜†ìœ¼ë¡œ ì´ë™ -->
    <div id="scaleControls">
		<label>ë°°ìœ¨</label>
        <button id="scaleUpButton">+</button>
        <button id="scaleDownButton">-</button>
    </div>
</div>



    <div id="map"></div>
    <div id="controls">
        <button id="startPolyline">ê²½ë¡œ ê·¸ë¦¬ê¸°</button>
		<button id="undoLastPointButton">ì§ì „ ì·¨ì†Œ</button>
        <button id="completePolyline">ê²½ë¡œ ê·¸ë¦¬ê¸° ì™„ë£Œ</button>
        <button id="downloadGPX">GPX ë‹¤ìš´ë¡œë“œ</button>
        <button id="uploadGPX">GPX ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="gpxFileInput" style="display: none;" accept=".gpx">
        <button id="clearMap">ì´ˆê¸°í™”</button>
    </div>
    <div id="locationButton" title="í˜„ì¬ ìœ„ì¹˜">ğŸ“</div> <!-- âœ… í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
    <div id="stopTrackingButton" style="display:none" title="ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€">ğŸ›‘</div> <!-- âœ… ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€ ë²„íŠ¼ -->
    <span style="font-size: 14px; color: gray;">
        ë°±ìŠ¤í˜ì´ìŠ¤ : ì§ì „ ì·¨ì†Œ<br>
        ESC, ë§ˆìš°ìŠ¤ ìš°í´ë¦­, [ê²½ë¡œ ê·¸ë¦¬ê¸° ì™„ë£Œ] ë²„íŠ¼ í´ë¦­ : ê·¸ë¦¬ê¸° ì¢…ë£Œ<br>
        ëª¨ë°”ì¼ì—ì„œë„ ê²½ë¡œê·¸ë¦¬ê¸°, ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤
    </span>

<script>
 class MapHandler {

		

            constructor(map) {
                this.map = map;
                this.shapes = [];
                this.currentPath = [];
                this.currentPolyline = null;
                this.markers = [];
                this.initUI();
            }
				
            initUI() {
				document.getElementById("startPolyline").addEventListener("click", () => this.startPolylineMode());
				document.getElementById("undoLastPointButton").addEventListener("click", () => this.undoLastPoint());
				document.getElementById("completePolyline").addEventListener("click", () => this.completePolyline()); // âœ… ì¶”ê°€ë¨*				
				document.getElementById("downloadGPX").addEventListener("click", () => this.downloadGPX());
				document.getElementById("uploadGPX").addEventListener("click", () => document.getElementById("gpxFileInput").click());

				// ğŸ”¹ `this`ë¥¼ `MapHandler` ì¸ìŠ¤í„´ìŠ¤ë¡œ ìœ ì§€
				document.getElementById("gpxFileInput").addEventListener("change", this.handleFileChange.bind(this));

				document.getElementById("clearMap").addEventListener("click", () => this.clearMap());
				
				document.addEventListener("keydown", (e) => {
					if (e.key === "Escape") {
						this.completePolyline();
					} else if (e.key === "Backspace") {
						this.undoLastPoint();
					}
				});

				naver.maps.Event.addListener(this.map, "click", (e) => {
					this.currentPath.push(e.coord);
					this.currentPolyline.setPath(this.currentPath);
					this.addMilestoneMarker(e.coord);
				});

				naver.maps.Event.addListener(this.map, "rightclick", () => {
					this.completePolyline();
				});

			
			}

			handleFileChange(event) {
				const file = event.target.files[0];
				if (!file) return; // ì„ íƒëœ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ

				this.loadGPX(file);

				// ğŸ”¹ ë™ì¼í•œ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ input ê°’ ì´ˆê¸°í™”
				event.target.value = ""; 
			}


			startPolylineMode() {
				if (this.shapes.length > 0) {
					const userConfirmed = confirm("ì´ì „ì— ê·¸ë¦° ê²½ë¡œê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
					if (!userConfirmed) return;

					this.clearMap(); // ê¸°ì¡´ ê²½ë¡œ ì´ˆê¸°í™”
				}

				this.currentPath = [];
				this.markers = [];
				this.currentPolyline = new naver.maps.Polyline({
					map: this.map,
					path: this.currentPath,
					strokeColor: "#FF0000",
					strokeWeight: 3.33,
					strokeOpacity: 0.8
				});	
			}
		
			downloadGPX() {
				if (this.shapes.length === 0) {
					alert("ë‹¤ìš´ë¡œë“œí•  ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.");
					return;
				}

				let gpxData = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="MapHandler">\n  <trk>\n    <trkseg>\n`;
				
				this.shapes.forEach(({ polyline }) => {
					polyline.getPath().forEach((coord) => {
						gpxData += `      <trkpt lat="${coord.y}" lon="${coord.x}"></trkpt>\n`;
					});
				});

				gpxData += `    </trkseg>\n  </trk>\n</gpx>`;
				
				const blob = new Blob([gpxData], { type: "application/gpx+xml" });
				const a = document.createElement("a");
				a.href = URL.createObjectURL(blob);
				a.download = "route.gpx";
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
			}

            completePolyline() {
                if (this.currentPolyline && this.currentPath.length > 1) {
                    this.addStartEndMarkers();
                    this.shapes.push({ polyline: this.currentPolyline, markers: [...this.markers] });
                    this.currentPolyline = null;
                }
            }

            addMilestoneMarker(coord) {
                const marker = new naver.maps.Marker({
                    position: coord,
                    map: this.map,
                    icon: {
                        content: `<div style="width: 8px; height: 8px; background-color: #FF0000; border-radius: 50%; border: 2px solid #FFF;"></div>`,
                        anchor: new naver.maps.Point(4, 4)
                    }
                });
                this.markers.push(marker);
            }

            addStartEndMarkers() {
                if (this.currentPath.length < 2) return;
                this.createLabeledMarker(this.currentPath[0], "ì¶œë°œ");
                this.createEndMarker(this.currentPath[this.currentPath.length - 1]);
            }

            createLabeledMarker(coord, label) {
                const marker = new naver.maps.Marker({
                    position: coord,
                    map: this.map,
                    icon: {
                        content: `<div style="padding:5px; background-color:#fff; border:1px solid #000; text-align:center;">
                                    <span style="font-size:12px; font-weight:bold; color:#f00;">${label}</span>
                                  </div>`
                    }
                });
                this.markers.push(marker);
            }
			clearMap() {
				if (!Array.isArray(this.shapes)) {
					this.shapes = []; // shapesê°€ ë°°ì—´ì´ ì•„ë‹ˆë©´ ì´ˆê¸°í™”
				}

				// ê¸°ì¡´ ê²½ë¡œ ë° ë§ˆì»¤ ì œê±°
				this.shapes.forEach(({ polyline, markers }) => {
					if (polyline) polyline.setMap(null);
					if (Array.isArray(markers)) {
						markers.forEach(marker => marker.setMap(null));
					}
				});

				// ğŸ”¹ ì¶œë°œ & ë„ì°© ë§ˆì»¤ ì‚­ì œ
				if (Array.isArray(this.markers)) {
					this.markers.forEach(marker => marker.setMap(null));
				}

				// ğŸ”¹ ë„ì°© ë§ˆì»¤ ì‚­ì œ ì¶”ê°€
				if (this.endMarker) {
					this.endMarker.setMap(null);
					this.endMarker = null; // ë„ì°© ë§ˆì»¤ ë³€ìˆ˜ ì´ˆê¸°í™”
				}

				// ë°ì´í„° ì´ˆê¸°í™”
				this.shapes = [];
				this.markers = [];
				this.currentPath = [];
				this.currentPolyline = null;
			}

		loadGPX(file) {

			this.clearMap();
			const reader = new FileReader();
			reader.onload = (event) => {
				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(event.target.result, "text/xml");

				const trkpts = xmlDoc.getElementsByTagName("trkpt");
				if (trkpts.length === 0) {
					alert("ìœ íš¨í•œ GPX íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
					return;
				}

				let path = [];
				for (let i = 0; i < trkpts.length; i++) {
					const lat = parseFloat(trkpts[i].getAttribute("lat"));
					const lon = parseFloat(trkpts[i].getAttribute("lon"));
					path.push(new naver.maps.LatLng(lat, lon));
				}

				this.drawGPXPath(path);
				this.updateEndMarker(path); // ğŸ”¹ GPX ë¡œë“œ í›„ ë„ì°© ë§ˆì»¤ ì—…ë°ì´íŠ¸
			};
			reader.readAsText(file);
		}

		updateEndMarker(path) {
			if (path.length < 2) return; // ìœ íš¨í•œ ê²½ë¡œê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ

			const totalDistance = this.calculateTotalDistance(path); // ê±°ë¦¬ ì¬ê³„ì‚°
			const formattedDistance = totalDistance >= 1000 
				? (totalDistance / 1000).toFixed(2) + "km" 
				: totalDistance.toFixed(0) + "m";

			const estimatedTime = this.calculateWalkingTime(totalDistance / 1000); // ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
			const label = `ë„ì°©<br>${formattedDistance}<br>${estimatedTime}<br>(ì‹œì† 4km ê¸°ì¤€)`;

			// ê¸°ì¡´ ë„ì°© ë§ˆì»¤ ì‚­ì œ
			if (this.endMarker) this.endMarker.setMap(null);

			// ìƒˆ ë„ì°© ë§ˆì»¤ ì¶”ê°€
			this.endMarker = new naver.maps.Marker({
				position: path[path.length - 1],
				map: this.map,
				icon: {
					content: `<div style="padding:5px; background-color:#fff; border:1px solid #000; text-align:center;">
								<span style="font-size:12px; font-weight:bold; color:#f00;">${label}</span>
							  </div>`
				}
			});
		}




		drawGPXPath(path) {
			if (path.length < 2) {
				alert("ê²½ë¡œ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
				return;
			}

			const polyline = new naver.maps.Polyline({
				map: this.map,
				path: path,
				strokeColor: "#0000FF", // GPX ê²½ë¡œ ìƒ‰ìƒ (íŒŒë€ìƒ‰)
				strokeWeight: 3.33,
				strokeOpacity: 0.8
			});

			this.shapes.push({ polyline });

			this.createLabeledMarker(path[0], "ì¶œë°œ");
			this.createEndMarker(path[path.length - 1]);
		}

		createEndMarker(coord) {
			const totalDistance = this.calculateTotalDistance(); // m ë‹¨ìœ„ë¡œ ê°€ì ¸ì˜´
			const formattedDistance = totalDistance >= 1000 
				? (totalDistance / 1000).toFixed(2) + "km" 
				: totalDistance.toFixed(0) + "m";

			const estimatedTime = this.calculateWalkingTime(totalDistance / 1000); // km ë‹¨ìœ„ë¡œ ë³€í™˜
			const label = `ë„ì°©<br>${formattedDistance}<br>${estimatedTime}<br>(ì‹œì† 4km ê¸°ì¤€)`;

			const marker = new naver.maps.Marker({
				position: coord,
				map: this.map,
				icon: {
					content: `<div style="padding:5px; background-color:#fff; border:1px solid #000; text-align:center;">
								<span style="font-size:12px; font-weight:bold; color:#f00;">${label}</span>
							  </div>`
				}
			});
			this.markers.push(marker);
		}


		calculateTotalDistance(path = this.currentPath) {
			if (!Array.isArray(path) || path.length < 2) {
				return 0; // ğŸ”¹ ê²½ë¡œê°€ ì—†ìœ¼ë©´ ê±°ë¦¬ 0 ë°˜í™˜
			}

			let total = 0;
			for (let i = 1; i < path.length; i++) {
				total += this.computeDistance(path[i - 1], path[i]);
			}
			return total; // ê±°ë¦¬ ë°˜í™˜ (m ë‹¨ìœ„)
		}




		computeDistance(coord1, coord2) {
			const R = 6371000;
			const lat1 = coord1.y * Math.PI / 180;
			const lat2 = coord2.y * Math.PI / 180;
			const deltaLat = (coord2.y - coord1.y) * Math.PI / 180;
			const deltaLng = (coord2.x - coord1.x) * Math.PI / 180;

			const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
					  Math.cos(lat1) * Math.cos(lat2) *
					  Math.sin(deltaLng / 2) * Math.sin(deltaLng / 2);
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
			return R * c;
		}

        calculateWalkingTime(distanceKm) { 
			const speed = 4; // ì‹œì† 4km
			const hours = Math.floor(distanceKm / speed);
			const minutes = Math.round((distanceKm % speed) * 60 / speed);
			return (hours > 0 ? `${hours}ì‹œê°„ ${minutes}ë¶„` : `${minutes}ë¶„`);
		}


        undoLastPoint() {
			if (this.currentPath.length > 0) {
				this.currentPath.pop(); // ë§ˆì§€ë§‰ ì¢Œí‘œ ì‚­ì œ
				this.currentPolyline.setPath(this.currentPath); // ë°˜ì˜

				// ë§ˆì§€ë§‰ ë§ˆì»¤ ì‚­ì œ
				const lastMarker = this.markers.pop();
				if (lastMarker) lastMarker.setMap(null);
			}
		}

    }


	document.addEventListener("DOMContentLoaded", async () => {
		window.map = new naver.maps.Map("map", {
			center: new naver.maps.LatLng(37.5665, 126.9780),
			zoom: 16
		});

		// âœ… `MapHandler` í´ë˜ìŠ¤ ìƒì„± í›„ ì§€ë„ ê°ì²´ì™€ ì—°ê²°
		new MapHandler(window.map);

		// âœ… ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
		await loadApartments();

		// âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸ ë§ˆì»¤ ì—…ë°ì´íŠ¸
		naver.maps.Event.addListener(window.map, "idle", () => {
			const bounds = window.map.getBounds();
			updateMarkers(bounds);
		});

		console.log("âœ… ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ.");
	});



	const mapElement = document.getElementById('map');

	function getMapSize() {
		return new naver.maps.Size(mapElement.offsetWidth, mapElement.offsetHeight);
	}

	let isTracking = false; // âœ… ìœ„ì¹˜ ì¶”ì  ì—¬ë¶€ (true: ì¶”ì  ì¤‘)

	document.getElementById("locationButton").addEventListener("click", () => {
		if (!window.map || !(window.map instanceof naver.maps.Map)) {
			console.error("ë„¤ì´ë²„ ì§€ë„ ê°ì²´ê°€ ì˜¬ë°”ë¥´ê²Œ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
			return;
		}

		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(
				(position) => {
					updateUserLocation(position, true); // âœ… ê°•ì œ ì´ë™ (true)
					startTracking(); // âœ… ìœ„ì¹˜ ì¶”ì  ì‹œì‘
				},
				(error) => {
					alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
				}
			);
		} else {
			alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
		}
	});

	function startTracking() {
		if (navigator.geolocation) {
			isTracking = true; // âœ… ìœ„ì¹˜ ì¶”ì  í™œì„±í™”
			window.watchId = navigator.geolocation.watchPosition(
				(position) => {
					updateUserLocation(position, false); // âœ… ì„¼í„° ì´ë™ X (false)
				},
				(error) => {
					alert("ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				},
				{ enableHighAccuracy: true }
			);
			console.log("ìœ„ì¹˜ ì¶”ì  ì‹œì‘ (watchId):", window.watchId);
		}
	}

	function stopTracking() {
		if (window.watchId !== null) {
			navigator.geolocation.clearWatch(window.watchId);
			console.log("ìœ„ì¹˜ ì¶”ì ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. watchId:", window.watchId);
			window.watchId = null;
			isTracking = false; // âœ… ìœ„ì¹˜ ì¶”ì  ë¹„í™œì„±í™”

			// âœ… ë§ˆì»¤ ì œê±°
			if (window.currentLocationMarker) {
				window.currentLocationMarker.setMap(null);
				window.currentLocationMarker = null;
			}
		} else {
			console.warn("ìœ„ì¹˜ ì¶”ì ì´ ì´ë¯¸ ì¤‘ì§€ëœ ìƒíƒœì…ë‹ˆë‹¤.");
		}
	}

	// âœ… "ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€" ë²„íŠ¼ ì´ë²¤íŠ¸
	document.getElementById("stopTrackingButton").addEventListener("click", stopTracking);

	function updateUserLocation(position, forceCenter = false) {
		const lat = position.coords.latitude;
		const lon = position.coords.longitude;
		const currentLocation = new naver.maps.LatLng(lat, lon);

		console.log("í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:", currentLocation, "ê°•ì œ ì´ë™ ì—¬ë¶€:", forceCenter);

		// âœ… ìœ„ì¹˜ ì¶”ì  ì¤‘ì´ ì•„ë‹ˆê±°ë‚˜, ê°•ì œ ì´ë™ í”Œë˜ê·¸ê°€ trueì¼ ë•Œë§Œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
		if (!isTracking || forceCenter) {
			window.map.setCenter(currentLocation);
			window.map.setZoom(16);
		}

		// âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
		if (window.currentLocationMarker) {
			window.currentLocationMarker.setMap(null);
		}

		// âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
		window.currentLocationMarker = new naver.maps.Marker({
			position: currentLocation,
			map: window.map,
			icon: {
				content: `<div style="width: 14px; height: 14px; background-color: red; border-radius: 50%; border: 3px solid white;"></div>`,
				anchor: new naver.maps.Point(7, 7)
			}
		});
	}


	let map; // âœ… ì „ì—­ ë³€ìˆ˜ ì„¤ì •
	let watchId = null; // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ ìœ„ì¹˜ ì¶”ì  ID ì €ì¥

	let locationCircle = null; // âœ… ë°˜ê²½ 500m ì› ê°ì²´ ì €ì¥
	let currentLocationMarker = null; // âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì €ì¥

	let apartmentData = []; // âœ… ì „ì²´ ì•„íŒŒíŠ¸ ë°ì´í„° ì €ì¥
	let apartmentMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ë§ˆì»¤ ì €ì¥
	let markerCluster = null; // âœ… ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§ ê°ì²´

	// âœ… 2. ì•„íŒŒíŠ¸ ë°ì´í„°ë¥¼ fetch()ë¡œ ê°€ì ¸ì˜¤ê¸°
	async function loadApartments() {
    
		try {
			//const response = await fetch("https://your-github-username.github.io/data/apt.json"); // âœ… JSON íŒŒì¼ ì‚¬ìš©
			const response = await fetch("apt.json");
			const data = await response.json();

			apartmentData = data.map((apt, index) => ({
				id: index,
				name: apt.name, // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				year: apt.year, // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				units: parseInt(apt.units, 10), // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				lat: parseFloat(apt.lat), // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				lng: parseFloat(apt.lng) // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
			}));


			console.log("âœ… ì•„íŒŒíŠ¸ ë°ì´í„° fetch ì™„ë£Œ");
			updateMarkers(window.map.getBounds())
		} catch (error) {
			console.error("âŒ ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
		}
	}

	// âœ… 3. ì§€ë„ ì´ë™í•  ë•Œë§ˆë‹¤ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸ë§Œ ë§ˆì»¤ë¡œ í‘œì‹œ
	function updateMarkers(bounds) {

		const minUnits = parseInt(document.getElementById("unitFilter").value, 10) || 0;
		const showApartments = document.getElementById("toggleApartments").checked;

		

	   // âœ… ê¸°ì¡´ ë§ˆì»¤ ëª¨ë‘ ì œê±°
		apartmentMarkers.forEach(marker => {
			if (marker instanceof naver.maps.Marker) {
				marker.setMap(null);
			}
		});

		// âœ… ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™” (ë§ˆì»¤ê°€ ì—¬ì „íˆ ë‚¨ì•„ìˆëŠ” ê²½ìš° ëŒ€ë¹„)
		apartmentMarkers.length = 0;

		// âœ… ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§ì„ ì‚¬ìš© ì¤‘ì´ë¼ë©´ ê¸°ì¡´ ë§ˆì»¤ ì´ˆê¸°í™”
		 if (markerCluster) {
			markerCluster.setMarkers([]); // ê¸°ì¡´ ë§ˆì»¤ë¥¼ ì œê±°
		}

	 

		if (!showApartments) return; // ì•„íŒŒíŠ¸ í‘œì‹œ ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ

		// âœ… í˜„ì¬ ì§€ë„ ë²”ìœ„ì— ìˆëŠ” ì•„íŒŒíŠ¸ í•„í„°ë§
		let filteredApartments = apartmentData.filter(apartment => {
			return bounds.hasLatLng(new naver.maps.LatLng(apartment.lat, apartment.lng)) && apartment.units >= minUnits;
		});

		//console.log("ğŸ“Œ í˜„ì¬ ì§€ë„ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸:", filteredApartments.length, "ê°œ");

		// âœ… ìƒˆë¡œìš´ HTML ë§ˆì»¤ ì¶”ê°€
		filteredApartments.forEach(apartment => {
		let yearValue = parseInt(apartment.year.slice(2), 10); // ë’¤ 2ìë¦¬ ìˆ«ìë¡œ ë³€í™˜
		let bgColor = "#E96A2B"; // ê¸°ë³¸ê°’ (00ë³´ë‹¤ í° ê²½ìš°)

		if (yearValue > 50) {
			bgColor = "#5C6267";
		} else if (yearValue > 20) {
			bgColor = "#3E24D7";
		} else if (yearValue > 10) {
			bgColor = "#EE1A24";
		} 

    const shortName = apartment.name.length > 6 ? apartment.name.slice(0, 6) + "..." : apartment.name; // âœ… 6ê¸€ìê¹Œì§€ë§Œ í‘œì‹œ
	const markerElement = document.createElement("div");
	markerElement.style = `
		background-color: ${bgColor};
		color: white;
		border-radius: 6px;
		padding: 0px;
		border: 3px  black;  /* âœ… í…Œë‘ë¦¬ ë‘ê»˜ 2px, ê²€ì •ìƒ‰ */
		text-align: center;
		font-size: 12px;
		font-weight: bold;
		box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
		white-space: nowrap;
		display: inline-block;
	`;

	const nameElement = document.createElement("div");
	nameElement.style = `
		background: white;
		color: black;
		font-size: 12px;
		font-weight: bold;
		display: flex; /* âœ… Flexbox ì‚¬ìš© */
		align-items: center;
		justify-content: center;
		padding: 2px 5px; /* âœ… ìµœì†Œ íŒ¨ë”© ìœ ì§€ */
		border-radius: 3px;
		min-width: 85px; /* âœ… ìµœì†Œ ë„ˆë¹„ ê³ ì • */
		max-width: 85px; /* âœ… ìµœëŒ€ ë„ˆë¹„ ê³ ì • */
		overflow: hidden;
		text-overflow: ellipsis;
	`;

	const detailsElement = document.createElement("div");
	detailsElement.style = `
		font-size: 12px;
		padding: 2px 5px;
		min-width: 85px; /* âœ… ì„¸ë¶€ ì •ë³´ë„ ìµœì†Œ í¬ê¸° ë™ì¼ */
		max-width: 85px;
		display: flex;
		justify-content: center;
	`;

	nameElement.textContent = apartment.name.length > 6 ? apartment.name.slice(0, 6) + "..." : apartment.name;
	detailsElement.textContent = `${apartment.year.slice(-5)} ${apartment.units}ì„¸ëŒ€`;

	markerElement.appendChild(nameElement);
	markerElement.appendChild(detailsElement);

	const marker = new naver.maps.Marker({
		position: new naver.maps.LatLng(apartment.lat, apartment.lng),
		map: window.map,
		icon: {
			content: markerElement,
			anchor: new naver.maps.Point(10, 30)
		}
	});


    // âœ… ë§ˆì»¤ í´ë¦­ ì‹œ ê°€ë¡œ ê¸¸ì´ í™•ì¥ â†’ 3ì´ˆ í›„ ë‹¤ì‹œ ì¶•ì†Œ
    naver.maps.Event.addListener(marker, "click", function() {
        nameElement.style.maxWidth = "500px"; // âœ… ì „ì²´ ì´ë¦„ì´ ë³´ì´ë„ë¡ í™•ì¥
        nameElement.textContent = apartment.name; // âœ… ì „ì²´ ì´ë¦„ í‘œì‹œ

        setTimeout(() => {
            nameElement.style.maxWidth = "70px"; // âœ… 3ì´ˆ í›„ ë‹¤ì‹œ ì¶•ì†Œ
            nameElement.textContent = shortName; // âœ… ë‹¤ì‹œ ì¶•ì•½ëœ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
        }, 1500);
    });

    apartmentMarkers.push(marker);
});


    // âœ… ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§ ì ìš© (ê¸°ì¡´ ë§ˆì»¤ëŠ” í´ëŸ¬ìŠ¤í„°ë§ ëŒ€ìƒì—ì„œ ì œì™¸)
	if (markerCluster) {
		markerCluster.setMarkers([]); // âœ… í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”
		markerCluster.setMarkers(apartmentMarkers);
	} else {
		markerCluster = new MarkerClustering({
			minClusterSize: 2,
			maxZoom: 14,
			map: window.map,
			markers: apartmentMarkers,
			disableClickZoom: true, // âœ… í´ëŸ¬ìŠ¤í„° í´ë¦­ ì‹œ ê¸°ë³¸ ë§ˆì»¤ê°€ í‘œì‹œë˜ì§€ ì•Šë„ë¡ ì„¤ì •
			icons: [{
				content: `<div style="display:none;"></div>`,  // âœ… ê¸°ë³¸ ë§ˆì»¤ë¥¼ ì•ˆ ë³´ì´ê²Œ ì„¤ì •
				size: new naver.maps.Size(1, 1),
				anchor: new naver.maps.Point(0, 0)
			}]
		});
	}
}
let schoolMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ í•™êµ ë§ˆì»¤ ì €ì¥

async function loadSchools() {
    try {
        const response = await fetch("school.json");
        const schools = await response.json();
        
        console.log("âœ… í•™êµ ë°ì´í„° ë¡œë“œ ì™„ë£Œ", schools);

        window.schoolData = schools; // âœ… ì „ì²´ í•™êµ ë°ì´í„° ì €ì¥

        // âœ… ì´ˆê¸° ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateSchoolMarkers(window.map.getBounds());

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ í•™êµ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            const bounds = window.map.getBounds();
            updateSchoolMarkers(bounds);
        });

    } catch (error) {
        console.error("âŒ í•™êµ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}

function updateSchoolMarkers() {
    const showSchools = document.getElementById("toggleSchools").checked;

    // âœ… ê¸°ì¡´ í•™êµ ë§ˆì»¤ ì œê±°
    schoolMarkers.forEach(marker => marker.setMap(null));
    schoolMarkers = [];

    if (!showSchools) return; // ì´ˆë“±í•™êµ í‘œì‹œ ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ

    let bounds = window.map.getBounds();
    let filteredSchools = window.schoolData.filter(school =>
        bounds.hasLatLng(new naver.maps.LatLng(school.latitude, school.longitude))
    );

    filteredSchools.forEach(school => {
        const markerContainer = document.createElement("div");
        markerContainer.style = "text-align: center; display: flex; flex-direction: column; align-items: center;";

        const markerIcon = document.createElement("img");
        markerIcon.src = "school.png";
        markerIcon.style = "width: 32px; height: 32px;";

        const infoBox = document.createElement("div");
        infoBox.style = `
			background: white;
			border: 1px solid gray;
			border-radius: 6px;
			padding: 5px 10px;
			font-size: 14px;
			font-weight: bold;
			box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
			white-space: nowrap; /* âœ… ì¤„ ë°”ê¿ˆ ë°©ì§€ */
			display: inline-block; /* âœ… ì¸ë¼ì¸ ë¸”ë¡ ìš”ì†Œë¡œ ì„¤ì • */
			max-width: 120px; /* âœ… ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
			overflow: hidden; /* âœ… ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìˆ¨ê¹€ */
			text-overflow: ellipsis; /* âœ… ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° "..." í‘œì‹œ */
			text-align: center; /* âœ… í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
		`;
        infoBox.textContent = `${school.schoolName.replace(/ë“±í•™êµ/g, "")} (${school.studentCountPerClassroom})`;

        markerContainer.appendChild(markerIcon);
        markerContainer.appendChild(infoBox);

        const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(school.latitude, school.longitude),
            map: window.map,
            icon: { content: markerContainer, anchor: new naver.maps.Point(16, 32) }
        });

        schoolMarkers.push(marker);
    });
}


// âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", async () => {
	await loadApartments();
    await loadSchools();


    const metaViewport = document.querySelector("meta[name='viewport']");
    let currentScale = 0.85; // ì´ˆê¸° ë°°ìœ¨ (ê¸°ë³¸ê°’)

     function updateViewportScale(scale) {
        currentScale = Math.max(0.5, Math.min(1.5, scale)); // âœ… ìµœì†Œ 0.5 ~ ìµœëŒ€ 1.5 ì œí•œ
        metaViewport.setAttribute("content", `width=device-width, initial-scale=${currentScale}, user-scalable=no`);

        console.log("ğŸ“Œ ìƒˆë¡œìš´ Viewport Scale:", currentScale);

        // âœ… ê°•ì œë¡œ í™”ë©´ í™•ëŒ€/ì¶•ì†Œ íš¨ê³¼ ì ìš©
        document.documentElement.style.zoom = 1; // **Reflow**
        document.documentElement.style.zoom = currentScale; // **ì¦‰ì‹œ ë°˜ì˜**
    }

    document.getElementById("scaleUpButton").addEventListener("click", () => {
        updateViewportScale(currentScale + 0.05); // âœ… 5% í™•ëŒ€
		console.log("í™•ëŒ€");
    });

    document.getElementById("scaleDownButton").addEventListener("click", () => {
        updateViewportScale(currentScale - 0.05); // âœ… 5% ì¶•ì†Œ
    });



});
document.getElementById("toggleApartments").addEventListener("change", () => {
    updateMarkers(window.map.getBounds()); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});

document.getElementById("toggleSchools").addEventListener("change", () => {
    updateSchoolMarkers(); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});


</script>





</body>
</html>
