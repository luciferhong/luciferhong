<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta id="dynamicViewport" name="viewport" content="width=device-width, initial-scale=0.85, user-scalable=no">

    <link rel="icon" href="route.png" type="image/png">
    <title>[ë£¨ì‹œí¼í™] í™ë¶€ê°€ ê¸°ê°€ë§‰í˜€</title>
	<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=hcuap73kdc"></script>
	<script type="text/javascript" src="MarkerClustering.js"></script>



    <style>
        #map { width: 100%; height: calc(100vh - 150px); resize: both; }
        #controls { margin: 10px; }
        button { margin: 5px; padding: 10px; cursor: pointer; }

		/* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
		#locationButton {
			position: absolute;
			top: 90px; /* ğŸ”¹ ì§€ë„ ë‚´ë¶€ì˜ ìƒë‹¨ */
			left: 8px; /* ğŸ”¹ ì§€ë„ ë‚´ë¶€ì˜ ì™¼ìª½ */
			background-color: white;
			border: 2px solid gray;
			padding: 10px;
			border-radius: 50%;
			cursor: pointer;
			font-size: 12px;
			text-align: center;
			box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
			z-index: 1000; /* ğŸ”¹ ì§€ë„ ìœ„ì— í‘œì‹œ */
		}

		/* ìœ„ì¹˜ ì¶”ì  ì¢…ë£Œ ë²„íŠ¼ */
		#stopTrackingButton {
			position: absolute;
			top: 125px; /* ğŸ”¹ ì§€ë„ ë‚´ë¶€ì˜ ìƒë‹¨ */
			left: 60px; /* ğŸ”¹ í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ê³¼ ê°„ê²© ìœ ì§€ */
			background-color: white;
			border: 2px solid gray;
			padding: 10px;
			border-radius: 50%;
			cursor: pointer;
			font-size: 14px;
			text-align: center;
			box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
			z-index: 1000; /* ğŸ”¹ ì§€ë„ ìœ„ì— í‘œì‹œ */
		}


		#unitFilter {
			width: 45px; /* ìˆ«ì 3ìë¦¬(ìµœëŒ€ 999) ì…ë ¥ ê°€ëŠ¥ */
			height: 10px;
			font-size: 16px;
			text-align: center;
			border: 2px solid #4A90E2; /* íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
			border-radius: 8px;
			padding: 5px;
			outline: none;
			transition: all 0.3s ease-in-out;
		}

		#unitFilter:focus {
			border-color: #2D5DA7; /* í¬ì»¤ìŠ¤ ì‹œ ë” ì§„í•œ íŒŒë€ìƒ‰ */
			box-shadow: 0px 0px 5px rgba(74, 144, 226, 0.5);
		}

	#controls {
    display: flex; /* âœ… ê°€ë¡œ ì •ë ¬ */
    align-items: center; /* âœ… ë‚´ë¶€ ìš”ì†Œ ì„¸ë¡œ ì •ë ¬ */
    gap: 10px; /* âœ… ìš”ì†Œ ê°„ê²© ì¡°ì • */
	}

	#scaleControls {
		display: flex; /* âœ… ê°€ë¡œ ì •ë ¬ */
		align-items: center; /* âœ… ë²„íŠ¼ì´ ì²´í¬ë°•ìŠ¤ì™€ ê°™ì€ ë†’ì´ë¡œ */
		margin-left: 5px; /* âœ… ê°„ê²© ì¡°ì • */
	}

	#scaleControls button {
		width: 30px;
		height: 30px;
		font-size: 16px;
		font-weight: bold;
		background-color: white;
		border: 2px solid gray;
		border-radius: 5px;
		cursor: pointer;
		text-align: center;
		margin-left: 5px; /* âœ… ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
		box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
		display: flex;
		justify-content: center;
		align-items: center;
	}

	#scaleControls button:hover {
		background-color: #f0f0f0;
	}
	.fullscreen-btn {
		position: fixed;
		top: 170px;
		left: 20px;
		background-color: white;
		border: 2px solid gray;
		padding: 10px;
		border-radius: 50%;
		cursor: pointer;
		font-size: 14px;
		text-align: center;
		box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
		z-index: 10000; /* âœ… ìµœìƒë‹¨ ìœ ì§€ */
	}
#apartmentInfo {
    position: fixed;
    top: 50%;
    left: 50%;
    
    background: white;
    border: 1px solid black;
    padding: 8px;
    width: auto;
    font-size: 16px;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    display: none;
    z-index: 10000;
     will-change: transform; /* GPU ë Œë”ë§ íŒíŠ¸ */
  contain: layout paint;  /* ë ˆì´ì•„ì›ƒ ë³€í™” ì œí•œ */
    max-width: 90%;
    max-height: 70vh; /* âœ… í™”ë©´ ë†’ì´ì˜ 80%ê¹Œì§€ í™•ì¥ */
    overflow-y: auto; /* âœ… ë‚´ë¶€ ìŠ¤í¬ë¡¤ í™œì„±í™” */
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch; /* âœ… iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
 backface-visibility: hidden; /* ê¹œë°•ì„ ë°©ì§€ */
    transform: translateZ(0);    /* GPU ë Œë”ë§ ì•ˆì •í™” */
}


#apartmentInfo table {
    width: auto; /* ğŸ”¹ í‘œ í¬ê¸°ë¥¼ ë‚´ìš©ì— ë§ê²Œ ìë™ ì¡°ì • */
    table-layout: auto; /* ğŸ”¹ í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ìë™ ì¡°ì • */
    border-collapse: collapse;
}

#apartmentInfo th, #apartmentInfo td {
    border: 1px solid black;
    padding: 2px 5px; /* ğŸ”¹ ë‚´ë¶€ ì—¬ë°± ìµœì†Œí™” */
    text-align: center;
    white-space: nowrap; /* ğŸ”¹ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
}

#apartmentInfo th {
    background: #f0f0f0;
    font-weight: bold;
}

#apartmentInfo .close-button {
    position: absolute;
    top: 5px;
    right: 8px;
    background: red;
    color: white;
    border: none;
    font-size: 14px;
    padding: 3px 6px;
    cursor: pointer;
    border-radius: 3px;
}
table {
    border-collapse: collapse; /* âœ… í…Œë‘ë¦¬ ì¤‘ë³µ ì œê±° */
    width: 100%; /* âœ… í…Œì´ë¸” í¬ê¸° ì¡°ì • */
}

td, th {
    border: 1px solid black; /* âœ… í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ í™•ì¸ */
    padding: 5px; /* âœ… ë‚´ë¶€ ì—¬ë°± ì¡°ì • */
    text-align: center;
    white-space: nowrap; /* âœ… ì¤„ë°”ê¿ˆ ë°©ì§€ */
}
buttonContainer {
    display: flex;
    justify-content: center; /* âœ… ë²„íŠ¼ë“¤ì„ ì¤‘ì•™ ì •ë ¬ */
    gap: 10px; /* âœ… ë²„íŠ¼ ê°„ê²© ì¡°ì • */
    margin-top: 10px;
}
#imagePreview {
  width: 100%;
  height: 72px;              /* ê³ ì • ë†’ì´ */
  overflow-x: auto;
  white-space: nowrap;       /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
}

#imagePreview > div {
  display: inline-block;
}
#imageModal {
  display: none;
  justify-content: center;
  align-items: center;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 99999;
  backface-visibility: hidden;
  will-change: opacity;
}

#modalCanvas {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
}


    </style>
</head>
<body>
<h1 style="font-size: 20px; font-weight: bold; text-align: left;">
    [ë£¨ì‹œí¼í™] í™ë¶€ê°€ ê¸°ê°€ë§‰í˜€
</h1>

<div id="controls">
    <label for="unitFilter">ìµœì†Œì„¸ëŒ€ìˆ˜: </label>
    <input type="number" id="unitFilter" min="0" value="190">
    <label><input type="checkbox" id="toggleApartments" checked>ì•„íŒŒíŠ¸</label>
    <label><input type="checkbox" id="toggleSchools" >ì´ˆ</label>
	<label><input type="checkbox" id="toggleMiddleSchools" >ì¤‘</label>
	<label><input type="checkbox" id="toggleFacilities">í™˜ê²½</label>
	<label><input type="checkbox" id="toggleStarbucks">ìŠ¤ë²…</label>
	<label><input type="checkbox" id="toggleMemoIcon" checked>ë©”ëª¨ ì•„ì´ì½˜ í‘œì‹œ</label>

	<label><input type="checkbox" id="toggleSiseMap" >ì‹œì„¸ì§€ë„</label>




    <!-- âœ… ìŠ¤ì¼€ì¼ ì¡°ì • ë²„íŠ¼ì„ 'ì´ˆë“±í•™êµ' ì²´í¬ë°•ìŠ¤ ì˜†ìœ¼ë¡œ ì´ë™ 
    <div id="scaleControls">
		<label>ë°°ìœ¨</label>
        <button id="scaleUpButton">+</button>
        <button id="scaleDownButton">-</button>
    </div>
-->
</div>



    <div id="map"></div>
    <div id="controls">
        <button id="startPolyline">ê²½ë¡œ ê·¸ë¦¬ê¸°</button>
		<button id="undoLastPointButton">ì§ì „ ì·¨ì†Œ</button>
        <button id="completePolyline">ê²½ë¡œ ê·¸ë¦¬ê¸° ì™„ë£Œ</button>
        <button id="downloadGPX">GPX ë‹¤ìš´ë¡œë“œ</button>
        <button id="uploadGPX">GPX ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="gpxFileInput" style="display: none;" accept=".gpx">
        <button id="clearMap">ê²½ë¡œ ì´ˆê¸°í™”</button>

<div style="margin-top: 0px;">
    <button onclick="backupMemoDB()">ğŸ—‚ï¸ ë©”ëª¨ ë°±ì—…</button>
    <button onclick="restoreMemoDB()">ğŸ—ƒï¸ ë©”ëª¨ ë³µì›</button>
	<button onclick="deleteMemoDB()">ğŸ—‘ï¸ ë©”ëª¨ ì¼ê´„ ì‚­ì œ</button>

    <input type="file" id="memoRestoreInput" accept=".json" style="display: none" />
</div>


<button id="siseExportBtn" style="display: none;">ì‹œì„¸ì§€ë„ ë°±ì—…</button>
<button id="siseImportBtn" style="display: none;">ì‹œì„¸ì§€ë„ ë³µì›</button>
<button id="siseResetBtn" style="display: none;">ì‹œì„¸ì§€ë„ ì´ˆê¸°í™”</button>



    </div>
    <div id="locationButton" title="í˜„ì¬ ìœ„ì¹˜">ğŸ“</div> <!-- âœ… í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
    <div id="stopTrackingButton" style="display:none" title="ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€">ğŸ›‘</div> <!-- âœ… ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€ ë²„íŠ¼ -->
    <span style="font-size: 14px; color: gray;">
        ë°±ìŠ¤í˜ì´ìŠ¤ : ì§ì „ ì·¨ì†Œ<br>
        ESC, ë§ˆìš°ìŠ¤ ìš°í´ë¦­, [ê²½ë¡œ ê·¸ë¦¬ê¸° ì™„ë£Œ] ë²„íŠ¼ í´ë¦­ : ê·¸ë¦¬ê¸° ì¢…ë£Œ<br>
        ëª¨ë°”ì¼ì—ì„œë„ ê²½ë¡œê·¸ë¦¬ê¸°, ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤
    </span>

<div id="apartmentInfo" style="border: 1px solid black; padding: 10px; display:none">
    <p>ì•„íŒŒíŠ¸ ì •ë³´ë¥¼ í™•ì¸í•˜ë ¤ë©´ ë§ˆì»¤ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
</div>
<!-- ëª¨ë‹¬ ìµœìƒë‹¨ + ë°°ê²½ íë¦¼ -->
<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ (canvasë¡œ ë³€ê²½) -->
<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:99999;">
  <canvas id="modalCanvas" style="max-width:90vw; max-height:90vh; border-radius:8px;"></canvas>
  <button id="copyImageButton" style="position: absolute; top: 20px; right: 20px;  background: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
    ğŸ“‹ ë³µì‚¬
  </button>
  
</div>



<script>
//ì´ë¯¸ì§€ í™•ëŒ€ ì—¬ë¶€
let imageModalShowYn = false;
 class MapHandler {

		

            constructor(map) {
                this.map = map;
                this.shapes = [];
                this.currentPath = [];
                this.currentPolyline = null;
                this.markers = [];
                this.initUI();
            }
				
            initUI() {
				document.getElementById("startPolyline").addEventListener("click", () => this.startPolylineMode());
				document.getElementById("undoLastPointButton").addEventListener("click", () => this.undoLastPoint());
				document.getElementById("completePolyline").addEventListener("click", () => this.completePolyline()); // âœ… ì¶”ê°€ë¨*				
				document.getElementById("downloadGPX").addEventListener("click", () => this.downloadGPX());
				 // âœ… ì‹œì„¸ì§€ë„ ë°±ì—… (ìµìŠ¤í¬íŠ¸)
				document.getElementById("siseExportBtn").addEventListener("click", () => {
					exportToJSON();
				});

				// âœ… ì‹œì„¸ì§€ë„ ë³µì› (ì„í¬íŠ¸)
				document.getElementById("siseImportBtn").addEventListener("click", () => {
					const input = document.createElement('input');
					input.type = 'file';
					input.accept = 'application/json';
					input.onchange = function (event) {
						const file = event.target.files[0];
						if (file) {
							importFromJSON(file);
						}
					};
					input.click();
				});

				document.getElementById("siseResetBtn").addEventListener("click", () => {
				const confirmReset = confirm("âš ï¸ ì‹œì„¸ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œì„¸ì§€ë„ ë°±ì—…ì„ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤. \nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
				if (!confirmReset) return;

				const request = indexedDB.open("hongbu", 2);
				request.onsuccess = function(event) {
					const db = event.target.result;
					const transaction = db.transaction(["apartments"], "readwrite");
					const store = transaction.objectStore("apartments");

					const clearRequest = store.clear(); // âœ… ì „ì²´ ì‚­ì œ

					clearRequest.onsuccess = function() {
						alert("âœ… ì‹œì„¸ì§€ë„ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
						// ğŸ” ë§ˆì»¤ ì—…ë°ì´íŠ¸
						prevSiseMapState = "ì´ˆê¸°í™”";
						updateMarkers(window.map.getBounds());
					};

					clearRequest.onerror = function(event) {
						console.error("âŒ ì‹œì„¸ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:", event.target.error);
						alert("âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
					};
				};
			});



				document.getElementById("uploadGPX").addEventListener("click", () => document.getElementById("gpxFileInput").click());

				// ğŸ”¹ `this`ë¥¼ `MapHandler` ì¸ìŠ¤í„´ìŠ¤ë¡œ ìœ ì§€
				document.getElementById("gpxFileInput").addEventListener("change", this.handleFileChange.bind(this));

				document.getElementById("clearMap").addEventListener("click", () => this.clearMap());
				
				document.addEventListener("keydown", (e) => {
					if (e.key === "Escape") {
						this.completePolyline();
					} else if (e.key === "Backspace") {
						this.undoLastPoint();
					}
				});

				naver.maps.Event.addListener(this.map, "click", (e) => {
					if (!this.currentPolyline) {
						console.warn("âš ï¸ ê²½ë¡œ ê·¸ë¦¬ê¸° ëª¨ë“œê°€ ì•„ë‹˜");
						return; // ğŸš« ì‹¤í–‰ ì¤‘ë‹¨ (ì˜¤ë¥˜ ë°©ì§€)
					}
					this.currentPath.push(e.coord);
					this.currentPolyline.setPath(this.currentPath);
					this.addMilestoneMarker(e.coord);
				});

				naver.maps.Event.addListener(this.map, "rightclick", () => {
					this.completePolyline();
				});

			
			}

			handleFileChange(event) {
				const file = event.target.files[0];
				if (!file) return; // ì„ íƒëœ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ

				this.loadGPX(file);

				// ğŸ”¹ ë™ì¼í•œ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ input ê°’ ì´ˆê¸°í™”
				event.target.value = ""; 
			}


			startPolylineMode() {
				if (this.shapes.length > 0) {
					const userConfirmed = confirm("ì´ì „ì— ê·¸ë¦° ê²½ë¡œê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
					if (!userConfirmed) return;

					this.clearMap(); // ê¸°ì¡´ ê²½ë¡œ ì´ˆê¸°í™”
				}

				this.currentPath = [];
				this.markers = [];
				this.currentPolyline = new naver.maps.Polyline({
					map: this.map,
					path: this.currentPath,
					strokeColor: "#FF0000",
					strokeWeight: 3.33,
					strokeOpacity: 0.8
				});	
			}
		
			downloadGPX() {
				if (this.shapes.length === 0) {
					alert("ë‹¤ìš´ë¡œë“œí•  ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.");
					return;
				}

				let gpxData = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="MapHandler">\n  <trk>\n    <trkseg>\n`;
				
				this.shapes.forEach(({ polyline }) => {
					polyline.getPath().forEach((coord) => {
						gpxData += `      <trkpt lat="${coord.y}" lon="${coord.x}"></trkpt>\n`;
					});
				});

				gpxData += `    </trkseg>\n  </trk>\n</gpx>`;
				
				const blob = new Blob([gpxData], { type: "application/gpx+xml" });
				const a = document.createElement("a");
				a.href = URL.createObjectURL(blob);
				a.download = "route.gpx";
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
			}

            completePolyline() {
                if (this.currentPolyline && this.currentPath.length > 1) {
                    this.addStartEndMarkers();
                    this.shapes.push({ polyline: this.currentPolyline, markers: [...this.markers] });
                    this.currentPolyline = null;
                }
            }

            addMilestoneMarker(coord) {
                const marker = new naver.maps.Marker({
                    position: coord,
                    map: this.map,
                    icon: {
                        content: `<div style="width: 8px; height: 8px; background-color: #FF0000; border-radius: 50%; border: 2px solid #FFF;"></div>`,
                        anchor: new naver.maps.Point(4, 4)
                    }
                });
                this.markers.push(marker);
            }

            addStartEndMarkers() {
                if (this.currentPath.length < 2) return;
                this.createLabeledMarker(this.currentPath[0], "ì¶œë°œ");
                this.createEndMarker(this.currentPath[this.currentPath.length - 1]);
            }

            createLabeledMarker(coord, label) {
                const marker = new naver.maps.Marker({
                    position: coord,
                    map: this.map,
                    icon: {
                        content: `<div style="padding:5px; background-color:#fff; border:1px solid #000; text-align:center;">
                                    <span style="font-size:12px; font-weight:bold; color:#f00;">${label}</span>
                                  </div>`
                    }
                });
                this.markers.push(marker);
            }
			clearMap() {
				if (!Array.isArray(this.shapes)) {
					this.shapes = []; // shapesê°€ ë°°ì—´ì´ ì•„ë‹ˆë©´ ì´ˆê¸°í™”
				}

				// ê¸°ì¡´ ê²½ë¡œ ë° ë§ˆì»¤ ì œê±°
				this.shapes.forEach(({ polyline, markers }) => {
					if (polyline) polyline.setMap(null);
					if (Array.isArray(markers)) {
						markers.forEach(marker => marker.setMap(null));
					}
				});

				// ğŸ”¹ ì¶œë°œ & ë„ì°© ë§ˆì»¤ ì‚­ì œ
				if (Array.isArray(this.markers)) {
					this.markers.forEach(marker => marker.setMap(null));
				}

				// ğŸ”¹ ë„ì°© ë§ˆì»¤ ì‚­ì œ ì¶”ê°€
				if (this.endMarker) {
					this.endMarker.setMap(null);
					this.endMarker = null; // ë„ì°© ë§ˆì»¤ ë³€ìˆ˜ ì´ˆê¸°í™”
				}

				// ë°ì´í„° ì´ˆê¸°í™”
				this.shapes = [];
				this.markers = [];
				this.currentPath = [];
				this.currentPolyline = null;
			}

		loadGPX(file) {

			this.clearMap();
			const reader = new FileReader();
			reader.onload = (event) => {
				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(event.target.result, "text/xml");

				const trkpts = xmlDoc.getElementsByTagName("trkpt");
				if (trkpts.length === 0) {
					alert("ìœ íš¨í•œ GPX íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
					return;
				}

				let path = [];
				for (let i = 0; i < trkpts.length; i++) {
					const lat = parseFloat(trkpts[i].getAttribute("lat"));
					const lon = parseFloat(trkpts[i].getAttribute("lon"));
					path.push(new naver.maps.LatLng(lat, lon));
				}

				this.drawGPXPath(path);
				this.updateEndMarker(path); // ğŸ”¹ GPX ë¡œë“œ í›„ ë„ì°© ë§ˆì»¤ ì—…ë°ì´íŠ¸
			};
			reader.readAsText(file);
		}

		updateEndMarker(path) {
			if (path.length < 2) return; // ìœ íš¨í•œ ê²½ë¡œê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ

			const totalDistance = this.calculateTotalDistance(path); // ê±°ë¦¬ ì¬ê³„ì‚°
			const formattedDistance = totalDistance >= 1000 
				? (totalDistance / 1000).toFixed(2) + "km" 
				: totalDistance.toFixed(0) + "m";

			const estimatedTime = this.calculateWalkingTime(totalDistance / 1000); // ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
			const label = `ë„ì°©<br>${formattedDistance}<br>${estimatedTime}<br>(ì‹œì† 4km ê¸°ì¤€)`;

			// ê¸°ì¡´ ë„ì°© ë§ˆì»¤ ì‚­ì œ
			if (this.endMarker) this.endMarker.setMap(null);

			// ìƒˆ ë„ì°© ë§ˆì»¤ ì¶”ê°€
			this.endMarker = new naver.maps.Marker({
				position: path[path.length - 1],
				map: this.map,
				icon: {
					content: `<div style="padding:5px; background-color:#fff; border:1px solid #000; text-align:center;">
								<span style="font-size:12px; font-weight:bold; color:#f00;">${label}</span>
							  </div>`
				}
			});
		}




		drawGPXPath(path) {
			if (path.length < 2) {
				alert("ê²½ë¡œ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
				return;
			}

			const polyline = new naver.maps.Polyline({
				map: this.map,
				path: path,
				strokeColor: "#0000FF", // GPX ê²½ë¡œ ìƒ‰ìƒ (íŒŒë€ìƒ‰)
				strokeWeight: 3.33,
				strokeOpacity: 0.8
			});

			this.shapes.push({ polyline });

			this.createLabeledMarker(path[0], "ì¶œë°œ");
			this.createEndMarker(path[path.length - 1]);
		}

		createEndMarker(coord) {
			const totalDistance = this.calculateTotalDistance(); // m ë‹¨ìœ„ë¡œ ê°€ì ¸ì˜´
			const formattedDistance = totalDistance >= 1000 
				? (totalDistance / 1000).toFixed(2) + "km" 
				: totalDistance.toFixed(0) + "m";

			const estimatedTime = this.calculateWalkingTime(totalDistance / 1000); // km ë‹¨ìœ„ë¡œ ë³€í™˜
			const label = `ë„ì°©<br>${formattedDistance}<br>${estimatedTime}<br>(ì‹œì† 4km ê¸°ì¤€)`;

			const marker = new naver.maps.Marker({
				position: coord,
				map: this.map,
				icon: {
					content: `<div style="padding:5px; background-color:#fff; border:1px solid #000; text-align:center;">
								<span style="font-size:12px; font-weight:bold; color:#f00;">${label}</span>
							  </div>`
				}
			});
			this.markers.push(marker);
		}


		calculateTotalDistance(path = this.currentPath) {
			if (!Array.isArray(path) || path.length < 2) {
				return 0; // ğŸ”¹ ê²½ë¡œê°€ ì—†ìœ¼ë©´ ê±°ë¦¬ 0 ë°˜í™˜
			}

			let total = 0;
			for (let i = 1; i < path.length; i++) {
				total += this.computeDistance(path[i - 1], path[i]);
			}
			return total; // ê±°ë¦¬ ë°˜í™˜ (m ë‹¨ìœ„)
		}




		computeDistance(coord1, coord2) {
			const R = 6371000;
			const lat1 = coord1.y * Math.PI / 180;
			const lat2 = coord2.y * Math.PI / 180;
			const deltaLat = (coord2.y - coord1.y) * Math.PI / 180;
			const deltaLng = (coord2.x - coord1.x) * Math.PI / 180;

			const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
					  Math.cos(lat1) * Math.cos(lat2) *
					  Math.sin(deltaLng / 2) * Math.sin(deltaLng / 2);
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
			return R * c;
		}

        calculateWalkingTime(distanceKm) { 
			const speed = 4; // ì‹œì† 4km
			const hours = Math.floor(distanceKm / speed);
			const minutes = Math.round((distanceKm % speed) * 60 / speed);
			return (hours > 0 ? `${hours}ì‹œê°„ ${minutes}ë¶„` : `${minutes}ë¶„`);
		}


        undoLastPoint() {
			if (this.currentPath.length > 0) {
				this.currentPath.pop(); // ë§ˆì§€ë§‰ ì¢Œí‘œ ì‚­ì œ
				this.currentPolyline.setPath(this.currentPath); // ë°˜ì˜

				// ë§ˆì§€ë§‰ ë§ˆì»¤ ì‚­ì œ
				const lastMarker = this.markers.pop();
				if (lastMarker) lastMarker.setMap(null);
			}
		}

    }


	document.addEventListener("DOMContentLoaded", async () => {
		window.map = new naver.maps.Map("map", {
			center: new naver.maps.LatLng(37.5665, 126.9780),
			zoom: 15
		});

		// âœ… `MapHandler` í´ë˜ìŠ¤ ìƒì„± í›„ ì§€ë„ ê°ì²´ì™€ ì—°ê²°
		new MapHandler(window.map);

		// âœ… ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
		await loadApartments();

		// âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸ ë§ˆì»¤ ì—…ë°ì´íŠ¸
		naver.maps.Event.addListener(window.map, "idle", () => {
			const bounds = window.map.getBounds();
			updateMarkers(bounds);
		});

		console.log("âœ… ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ.");
	});



	const mapElement = document.getElementById('map');

	function getMapSize() {
		return new naver.maps.Size(mapElement.offsetWidth, mapElement.offsetHeight);
	}

	let isTracking = false; // âœ… ìœ„ì¹˜ ì¶”ì  ì—¬ë¶€ (true: ì¶”ì  ì¤‘)

	document.getElementById("locationButton").addEventListener("click", () => {
		if (!window.map || !(window.map instanceof naver.maps.Map)) {
			console.error("ë„¤ì´ë²„ ì§€ë„ ê°ì²´ê°€ ì˜¬ë°”ë¥´ê²Œ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
			return;
		}

		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(
				(position) => {
					updateUserLocation(position, true); // âœ… ê°•ì œ ì´ë™ (true)
					startTracking(); // âœ… ìœ„ì¹˜ ì¶”ì  ì‹œì‘
				},
				(error) => {
					alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
				}
			);
		} else {
			alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
		}
	});

	function startTracking() {
		if (navigator.geolocation) {
			isTracking = true; // âœ… ìœ„ì¹˜ ì¶”ì  í™œì„±í™”
			window.watchId = navigator.geolocation.watchPosition(
				(position) => {
					updateUserLocation(position, false); // âœ… ì„¼í„° ì´ë™ X (false)
				},
				(error) => {
					alert("ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				},
				{ enableHighAccuracy: true }
			);
			//console.log("ìœ„ì¹˜ ì¶”ì  ì‹œì‘ (watchId):", window.watchId);
		}
	}

	function stopTracking() {
		if (window.watchId !== null) {
			navigator.geolocation.clearWatch(window.watchId);
			//console.log("ìœ„ì¹˜ ì¶”ì ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. watchId:", window.watchId);
			window.watchId = null;
			isTracking = false; // âœ… ìœ„ì¹˜ ì¶”ì  ë¹„í™œì„±í™”

			// âœ… ë§ˆì»¤ ì œê±°
			if (window.currentLocationMarker) {
				window.currentLocationMarker.setMap(null);
				window.currentLocationMarker = null;
			}
		} else {
			console.warn("ìœ„ì¹˜ ì¶”ì ì´ ì´ë¯¸ ì¤‘ì§€ëœ ìƒíƒœì…ë‹ˆë‹¤.");
		}
	}

	// âœ… "ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€" ë²„íŠ¼ ì´ë²¤íŠ¸
	document.getElementById("stopTrackingButton").addEventListener("click", stopTracking);

	function updateUserLocation(position, forceCenter = false) {
		const lat = position.coords.latitude;
		const lon = position.coords.longitude;
		const currentLocation = new naver.maps.LatLng(lat, lon);

		//console.log("í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:", currentLocation, "ê°•ì œ ì´ë™ ì—¬ë¶€:", forceCenter);

		// âœ… ìœ„ì¹˜ ì¶”ì  ì¤‘ì´ ì•„ë‹ˆê±°ë‚˜, ê°•ì œ ì´ë™ í”Œë˜ê·¸ê°€ trueì¼ ë•Œë§Œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
		if (!isTracking || forceCenter) {
			window.map.setCenter(currentLocation);
			window.map.setZoom(16);
		}

		// âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
		if (window.currentLocationMarker) {
			window.currentLocationMarker.setMap(null);
		}

		// âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
		window.currentLocationMarker = new naver.maps.Marker({
			position: currentLocation,
			map: window.map,
			icon: {
				content: `<div style="width: 14px; height: 14px; background-color: red; border-radius: 50%; border: 3px solid white;"></div>`,
				anchor: new naver.maps.Point(7, 7)
			}
		});
	}


	let map; // âœ… ì „ì—­ ë³€ìˆ˜ ì„¤ì •
	let watchId = null; // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ ìœ„ì¹˜ ì¶”ì  ID ì €ì¥

	let locationCircle = null; // âœ… ë°˜ê²½ 500m ì› ê°ì²´ ì €ì¥
	let currentLocationMarker = null; // âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì €ì¥

	let apartmentData = []; // âœ… ì „ì²´ ì•„íŒŒíŠ¸ ë°ì´í„° ì €ì¥
	let apartmentMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ë§ˆì»¤ ì €ì¥
	let markerCluster = null; // âœ… ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§ ê°ì²´

	// âœ… 2. ì•„íŒŒíŠ¸ ë°ì´í„°ë¥¼ fetch()ë¡œ ê°€ì ¸ì˜¤ê¸°
	async function loadApartments() { 
    
		try {
			//const response = await fetch("https://your-github-username.github.io/data/apt.json"); // âœ… JSON íŒŒì¼ ì‚¬ìš©
			const response = await fetch("apt.json");
			const data = await response.json();

			apartmentData = data.map((apt, index) => ({
				id: apt.id,
				name: apt.name, // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				year: apt.year, // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				units: parseInt(apt.units, 10), // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				lat: parseFloat(apt.lat), // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				lng: parseFloat(apt.lng), // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				lease: apt.lease // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
			}));

			
			//console.log("âœ… ì•„íŒŒíŠ¸ ë°ì´í„° fetch ì™„ë£Œ");
			updateMarkers(window.map.getBounds())
		} catch (error) {
			console.error("âŒ ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
		}
	}



function closePopup() {
  //console.log("í˜¸ì¶œ")
    isPopupOpen = false;
    if (activeMarkerSet) {

        activeMarkerSet = null;
    }
    //console.log("âŒ ì´ë™ ëª¨ë“œ ì¢…ë£Œ");
}

function makeModalDraggable(modal) {
        let isDragging = false;
        let offsetX, offsetY;

        const header = document.createElement('div');
        header.className = 'draggable';
        header.style.padding = '10px';
        header.style.cursor = 'move';
        header.style.backgroundColor = '#f1f1f1';
        header.style.borderBottom = '1px solid #ccc';
        header.textContent = 'Drag me';

        modal.insertBefore(header, modal.firstChild);

        header.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - modal.offsetLeft;
            offsetY = e.clientY - modal.offsetTop;
            document.addEventListener('mousemove', moveModal);
            document.addEventListener('mouseup', stopDragging);
        });

        function moveModal(e) {
            if (isDragging) {
                modal.style.left = `${e.clientX - offsetX}px`;
                modal.style.top = `${e.clientY - offsetY}px`;
            }
        }

        function stopDragging() {
            isDragging = false;
            document.removeEventListener('mousemove', moveModal);
            document.removeEventListener('mouseup', stopDragging);
        }
    }


// âœ… ì‹œì„¸ ë§ˆì»¤ì—ì„œ í…Œì´ë¸”ì´ ì•„ë‹Œ ì˜ì—­ì„ ìš°í´ë¦­í•˜ë©´ ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
function addSiseMapMarkerLeftClickEvent(marker, markerElement) {
//console.log("addSiseMapMarkerLeftClickEvent ì‹¤í–‰ë¨");
    naver.maps.Event.addListener(marker, "click", (e) => {
        e.domEvent.preventDefault(); // ê¸°ë³¸ ìš°í´ë¦­ ë©”ë‰´ ë°©ì§€
        e.domEvent.stopPropagation();

        const tableContainer = markerElement.querySelector(".tableContainer");

        // âœ… í…Œì´ë¸” ì˜ì—­ì„ í´ë¦­í•œ ê²½ìš° ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬ì„ ë„ìš°ì§€ ì•ŠìŒ
        if (e.domEvent.target.closest(".tableContainer")) {
            return;
        }

        //console.log("ğŸš€ ë§ˆì»¤ ìš°í´ë¦­ ê°ì§€:", markerElement.dataset);

        let apartmentId = markerElement.dataset.apartmentId;
        if (!apartmentId) {
            console.error("âŒ apartmentId ì°¾ì„ ìˆ˜ ì—†ìŒ!");
            return;
        }

        showColorPickerModal(apartmentId, markerElement.style.backgroundColor, markerElement.style.color, markerElement.style.fontSize, 
			(selectedColor, textColor, fontSize) => {
				markerElement.style.backgroundColor = selectedColor;
				markerElement.style.color = textColor;
				markerElement.style.fontSize = fontSize;

				updateMarkerStyleAndSave(apartmentId, selectedColor, textColor, fontSize); // âœ… apartmentIdê°€ ì •ìƒì ìœ¼ë¡œ ì „ë‹¬ë¨
			});



    });
}

function updateMarkerStyleAndSave(id, selectedColor, textColor, fontSize) {
    getFromIndexedDB(id, "ì‹œì„¸1").then(existingData => {
        let existingText = existingData?.text || generateDefaultTable();

        // âœ… ê¸°ë³¸ê°’ ê°•ì œ ì ìš©
        selectedColor = selectedColor?.trim() || '#9F9F9F';
        textColor = textColor?.trim() || '#FFFFFF';
        fontSize = fontSize?.trim() || '12px';

        //console.log(`ğŸ¨ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ ì‹œë„ (ID: ${id})`, { selectedColor, textColor, fontSize });

        // âœ… IndexedDB ì €ì¥
        saveToIndexedDB(id, "ì‹œì„¸1", existingText, selectedColor, textColor, fontSize);

        // âœ… ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        let markerElement = document.querySelector(`[data-apartment-id='${id}']`);
        if (!markerElement) {
            console.error(`âŒ ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID: ${id}`);
            return;
        }

        // âœ… ğŸ’¡ ì¤‘ìš”: ê¸€ì ìƒ‰ìƒ ë° í¬ê¸° ì¦‰ì‹œ ë°˜ì˜
        markerElement.style.backgroundColor = selectedColor;
        markerElement.style.color = textColor;
        markerElement.style.setProperty("color", textColor, "important"); // âœ… ì¦‰ì‹œ ì ìš© (ì¤‘ìš”ë„ ë†’ì´ê¸°)
        markerElement.style.setProperty("font-size", fontSize, "important");

        markerElement.style.setProperty("font-size", fontSize, "important"); // âœ… ì¦‰ì‹œ ì ìš© (ì¤‘ìš”ë„ ë†’ì´ê¸°)


        // âœ… ë‚´ë¶€ í…Œì´ë¸”ì˜ ê¸€ììƒ‰ & í¬ê¸° ì¦‰ì‹œ ë°˜ì˜
        let tableContainer = markerElement.querySelector(".tableContainer");
        if (tableContainer) {
            tableContainer.style.color = textColor;
            tableContainer.style.fontSize = fontSize;
            tableContainer.style.setProperty("font-size", fontSize, "important");
        }

    }).catch(error => {
        console.error("âŒ IndexedDB ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    });
}








// âœ… ê¸°ë³¸ ë§ˆì»¤ ìƒì„± (ì‹œì„¸ì§€ë„ ì²´í¬ í•´ì œ ì‹œ)
function createDefaultMarker(apartment) {
    let yearValue = parseInt(apartment.year.slice(2), 10);
    let bgColor = "#FFFA00"; // yellow
    let fongColor = "white";

    if (yearValue > 50) bgColor = "#5C6267";
    else if (yearValue >= 20) bgColor = "#3E24D7";
    else if (yearValue >= 10) bgColor = "#EE1A24";

    if (yearValue >= 00 && yearValue < 10) fongColor = "black"; 

    const markerElement = document.createElement("div");
	markerElement.style = `
		background-color: ${bgColor};
		color: ${fongColor};
		border-radius: 6px;
		padding: 0px;
		border: 3px  black;  /* âœ… í…Œë‘ë¦¬ ë‘ê»˜ 2px, ê²€ì •ìƒ‰ */
		text-align: center;
		font-size: 12px;
		font-weight: bold;
		box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
		white-space: nowrap;
		display: inline-block;
	`;

	const nameElement = document.createElement("div");
	nameElement.style = `
		background: white;
		color: black;
		font-size: 12px;
		font-weight: bold;
		display: flex; /* âœ… Flexbox ì‚¬ìš© */
		align-items: center;
		justify-content: center;
		padding: 2px 5px; /* âœ… ìµœì†Œ íŒ¨ë”© ìœ ì§€ */
		border-radius: 3px;
		min-width: 85px; /* âœ… ìµœì†Œ ë„ˆë¹„ ê³ ì • */
		max-width: 85px; /* âœ… ìµœëŒ€ ë„ˆë¹„ ê³ ì • */
		overflow: hidden;
		text-overflow: ellipsis;
	`;

	const detailsElement = document.createElement("div");
	detailsElement.style = `
		font-size: 12px;
		padding: 2px 5px;
		min-width: 85px; /* âœ… ì„¸ë¶€ ì •ë³´ë„ ìµœì†Œ í¬ê¸° ë™ì¼ */
		max-width: 85px;
		display: flex;
		justify-content: center;
	`;


    nameElement.textContent = apartment.name.length > 7 ? apartment.name.slice(0, 6) + "..." : apartment.name;
    detailsElement.textContent = `${apartment.year.slice(-5)} ${apartment.units}ì„¸ëŒ€`;

    markerElement.appendChild(nameElement);
    markerElement.appendChild(detailsElement);

getMemoFromIndexedDB(apartment.id).then(memo => {
    const hasMemo = memo?.memo?.trim()?.length > 0;
    const hasImages = Array.isArray(memo?.images) && memo.images.length > 0;
    const showMemoIcon = document.getElementById("toggleMemoIcon")?.checked;

    if (showMemoIcon && (hasMemo || hasImages)) {
        const memoIcon = document.createElement("img");
        memoIcon.src = "memo.png"; // ğŸ”º ì´ë¯¸ì§€ íŒŒì¼ëª…
        memoIcon.style = `
            position: absolute;
            top: -16px;
            left: -20px;
            width: 28px;
            height: 28px;
            z-index: 10;
            pointer-events: none;
        `;
        markerElement.style.position = "relative";
        markerElement.appendChild(memoIcon);
    }
});




		// âœ… ë§ˆì»¤ í´ë¦­ ì‹œ ê°€ë¡œ ê¸¸ì´ í™•ì¥ â†’ 3ì´ˆ í›„ ë‹¤ì‹œ ì¶•ì†Œ
    

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(apartment.lat, apartment.lng),
        map: window.map,
        icon: {
            content: markerElement,
            anchor: new naver.maps.Point(10, 30)
        }
    });
	marker.apartmentId = apartment.id; // âœ… ë§ˆì»¤ ê°ì²´ì— ì§ì ‘ ID ì €ì¥

	naver.maps.Event.addListener(marker, "click",  function(e) {
		showApartmentInfo(apartment.id, {
			x: e.offset.x,
			y: e.offset.y
		});
	});

	addMarkerRightClickEvent(marker, markerElement); // âœ… ë§ˆì»¤ ì„ íƒ ì´ë²¤íŠ¸ ë“±ë¡

	return marker;
}


let prevSiseMapState = null; // ğŸ”¹ ì „ì—­ ë³€ìˆ˜ë¡œ ì´ì „ ì‹œì„¸ì§€ë„ ìƒíƒœ ì €ì¥

function removeLinesOutsideBounds(bounds) {
    Object.entries(apartmentMarkers).forEach(([id, marker]) => {
        const position = marker.getPosition();
        const line = marker.lineToOrigin;

        const isMarkerInside = bounds.hasLatLng(position);

        // ë§ˆì»¤ê°€ bounds ë°”ê¹¥ì´ë©´
        if (!isMarkerInside) {
            //console.log(`âŒ ë§ˆì»¤ ì œê±°ë¨: ${id}`);
			if(marker.movementLine){
				marker.movementLine.setMap(null);
				marker.movementLine = null;
			}
            marker.setMap(null);
            delete apartmentMarkers[id];

            // ì„ ë„ ê°™ì´ ì œê±°
            if (line) {
                //console.log(`âŒ ì„ ë„ ê°™ì´ ì œê±°ë¨: ${id}`);
                line.setMap(null);
                delete marker.lineToOrigin;
            }
        }
    });
}

function removeAllLines() {
	
     Object.entries(apartmentMarkers).forEach(([id, marker]) => {
        const position = marker.getPosition();
        const isMarkerInside = window.map.getBounds().hasLatLng(position);

        if (isMarkerInside) {
            // ğŸ”¥ ë²”ìœ„ ì•ˆì˜ ë§ˆì»¤ì— ì—°ê²°ëœ ì´ë™ì„  ì œê±°
            if (marker.movementLine) {
                marker.movementLine.setMap(null);
                marker.movementLine = null;
                //console.log(`ğŸ§¹ ${id}ì˜ ì´ë™ì„  ì œê±°ë¨`);
            }
        }
    });
}

	// âœ… 3. ì§€ë„ ì´ë™í•  ë•Œë§ˆë‹¤ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸ë§Œ ë§ˆì»¤ë¡œ í‘œì‹œ
	function updateMarkers(bounds) {


const showApartments = document.getElementById("toggleApartments").checked;
    if (!showApartments) {
        Object.values(apartmentMarkers).forEach(marker => {
            if (marker instanceof naver.maps.Marker) {
                marker.setMap(null);
            }
        });
        apartmentMarkers = {}; // ìºì‹œ ì´ˆê¸°í™”
        return; // âœ… ë§ˆì»¤ ì œê±° í›„ ë” ì´ìƒ ì‘ì—…í•˜ì§€ ì•ŠìŒ
    }


//ë²”ìœ„ ë²—ì–´ë‚˜ë©´ ë§ˆì»¤ ì‚­ì œ
removeLinesOutsideBounds(bounds)

		const minUnits = parseInt(document.getElementById("unitFilter").value, 10) || 0;
		//const showApartments = document.getElementById("toggleApartments").checked;
		const isSiseMapActive = document.getElementById("toggleSiseMap").checked;

		if (!showApartments || window.map.getZoom() < 14) return;

		const filtered = apartmentData.filter(apartment =>
			bounds.hasLatLng(new naver.maps.LatLng(apartment.lat, apartment.lng)) &&
			apartment.units >= minUnits
		);

		const newMarkers = [];

		// âœ… ì‹œì„¸ì§€ë„ ì²´í¬ ìƒíƒœê°€ ë°”ë€ ê²½ìš° â†’ ëª¨ë“  ë§ˆì»¤ ì œê±°
		if (prevSiseMapState !== isSiseMapActive) {
			Object.values(apartmentMarkers).forEach(marker => {
				if (marker instanceof naver.maps.Marker) {
					naver.maps.Event.clearInstanceListeners(marker);
					marker.setMap(null);
				}
			});
			apartmentMarkers = {}; // ìºì‹œ ì´ˆê¸°í™”
			prevSiseMapState = isSiseMapActive; // ìƒíƒœ ê°±ì‹ 
		}

		// âœ… ìƒˆ ë§ˆì»¤ ìƒì„± or ì¬ì‚¬ìš©
		filtered.forEach(apartment => {
			if (apartment.name.includes("ë„ì‹œí˜•") || apartment.name.includes("ìƒí™œí˜•")) return;
			let marker = apartmentMarkers[apartment.id];

			if (!marker) {
				marker = isSiseMapActive
					? renderSiseMapMarker(apartment)
					: createDefaultMarker(apartment);

				marker.__siseMap = isSiseMapActive;
				apartmentMarkers[apartment.id] = marker;
			}

			newMarkers.push(marker);
		});


		if (markerCluster) {
			markerCluster.setMarkers(newMarkers);
		}



	}




let schoolMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ í•™êµ ë§ˆì»¤ ì €ì¥

async function loadSchools() {
    try {
        const response = await fetch("eliSchools.json");
        const schools = await response.json();
        
        //console.log("âœ… í•™êµ ë°ì´í„° ë¡œë“œ ì™„ë£Œ", schools);

        window.schoolData = schools; // âœ… ì „ì²´ í•™êµ ë°ì´í„° ì €ì¥

        // âœ… ì´ˆê¸° ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateSchoolMarkers(window.map.getBounds());

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ í•™êµ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            const bounds = window.map.getBounds();
            updateSchoolMarkers(bounds);
        });

    } catch (error) {
        console.error("âŒ í•™êµ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}

function updateSchoolMarkers() {
    const showSchools = document.getElementById("toggleSchools").checked;

    // âœ… ê¸°ì¡´ í•™êµ ë§ˆì»¤ ì œê±°
    schoolMarkers.forEach(marker => marker.setMap(null));
    schoolMarkers = [];

    if (!showSchools) return; // ì´ˆë“±í•™êµ í‘œì‹œ ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ
	if (window.map.getZoom() < 14) { 
			return; // âœ… ì¤Œ ë ˆë²¨ì´ 14ë³´ë‹¤ ì‘ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨
	}
    let bounds = window.map.getBounds();
    let filteredSchools = window.schoolData.filter(school =>
        bounds.hasLatLng(new naver.maps.LatLng(school.latitude, school.longitude))
    );

    filteredSchools.forEach(school => {
    // âœ… ë§ˆì»¤ ì»¨í…Œì´ë„ˆë¥¼ markerElementë¡œ í™œìš©
    const markerElement = document.createElement("div");
    markerElement.style = "text-align: center; display: flex; flex-direction: column; align-items: center;";

    const markerIcon = document.createElement("img");
    markerIcon.src = "eliSchool.png";
    markerIcon.style = "width: 32px; height: 32px;";

    const infoBox = document.createElement("div");
    infoBox.style = `
        background: white;
        border: 1px solid gray;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
    `;
    infoBox.textContent = `${school.schoolName.replace(/ë“±í•™êµ/g, "")} (${school.studentCountPerClassroom}/${school.totalStudentCount})`;

    markerElement.appendChild(markerIcon);
    markerElement.appendChild(infoBox);

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(school.latitude, school.longitude),
        map: window.map,
        icon: { content: markerElement, anchor: new naver.maps.Point(16, 32) }
    });

    // âœ… ìš°í´ë¦­ ì´ë²¤íŠ¸ì— markerElement ì „ë‹¬ (í…Œë‘ë¦¬ í™œì„±í™” ê°€ëŠ¥)
    addMarkerRightClickEvent(marker, markerElement);

    schoolMarkers.push(marker);
});

}


// âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", async () => {
	await loadApartments();
    await loadSchools();
    await loadMiddleSchools();
	await loadApartmentsDetail();
    await loadFacilities();
    await loadStarbucks();
	await initIndexedDB();
	await initMemoIndexedDB();

	if (window.map) {
        setupRightClickEvent();
    } else {
        // âœ… ì§€ë„ ë¡œë“œ í›„ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•˜ëŠ” ë°©ì‹
        const checkMapLoaded = setInterval(() => {
            if (window.map) {
                clearInterval(checkMapLoaded);
                setupRightClickEvent();
            }
        }, 100); // ğŸ”¹ 100ms ê°„ê²©ìœ¼ë¡œ ì§€ë„ ë¡œë“œ í™•ì¸
    }


    const metaViewport = document.querySelector("meta[name='viewport']");


    function updateViewportScale(scale) {
		const metaViewport = document.querySelector("meta[name='viewport']");
		currentScale = Math.max(0.5, Math.min(1.5, scale)); // âœ… ìµœì†Œ 0.5 ~ ìµœëŒ€ 1.5 ì œí•œ
		metaViewport.setAttribute("content", `width=device-width, initial-scale=${currentScale}, user-scalable=no`);

		//console.log("ğŸ“Œ ìƒˆë¡œìš´ Viewport Scale:", currentScale);

		// âœ… ê°•ì œë¡œ í™”ë©´ í™•ëŒ€/ì¶•ì†Œ íš¨ê³¼ ì ìš©
		document.documentElement.style.zoom = 1; // **Reflow**
		document.documentElement.style.zoom = currentScale; // **ì¦‰ì‹œ ë°˜ì˜**

		// âœ… ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ (zoom ë³€ê²½ í›„ body, html í¬ê¸° ì¡°ì •)
		document.documentElement.style.overflow = "hidden";
		document.body.style.overflow = "hidden";
		document.body.style.width = "100vw"; // **ğŸ“Œ ê°•ì œ ì¡°ì •í•˜ì—¬ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì œê±°**

		// âœ… ì§€ë„ í¬ê¸° ê°•ì œ ì—…ë°ì´íŠ¸ (idle ì´ë²¤íŠ¸ ë°œìƒ ìœ ë„)
		if (window.map) {
			setTimeout(() => {
				let mapElement = document.getElementById("map");
				let width = mapElement.clientWidth;
				let height = mapElement.clientHeight;
				window.map.setSize(new naver.maps.Size(width, height));
				//console.log("ğŸ”„ ì§€ë„ í¬ê¸° ë³€ê²½ë¨:", width, height);
			}, 200); // âœ… ë¸Œë¼ìš°ì € ë¦¬í”Œë¡œìš° í›„ ì‹¤í–‰
		}
	}

//ì´ë™ì‹œ ì„  ê¸‹ê¸°
naver.maps.Event.addListener(window.map, "click", function(e) {
    if (activeMarker && activeMarker instanceof naver.maps.Marker) {
        const newPosition = e.coord;

        const origin = activeMarker.originPosition;
        if (origin) {
            // ğŸ”´ ì´ì „ ì„ ì´ ìˆë‹¤ë©´ ì§€ë„ì—ì„œ ì œê±°
            if (activeMarker.movementLine) {
                activeMarker.movementLine.setMap(null);
            }

            // ğŸ”µ ìƒˆ ì„  ìƒì„± ë° ë§ˆì»¤ì— ì €ì¥
            const line = new naver.maps.Polyline({
                map: window.map,
                path: [origin, newPosition],
                strokeColor: "#000000",
                strokeOpacity: 0.8,
                strokeWeight: 2
            });

            activeMarker.movementLine = line;
        }

        activeMarker.setPosition(newPosition);
        //console.log("ğŸ“Œ ë§ˆì»¤ ì´ë™ë¨:", newPosition.toString());
    }
});




});

document.getElementById("toggleApartments").addEventListener("change", () => {
    updateMarkers(window.map.getBounds()); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});


document.getElementById("toggleMemoIcon").addEventListener("change", () => {
Object.values(apartmentMarkers).forEach(marker => {
        if (marker instanceof naver.maps.Marker) {
            marker.setMap(null);
        }
    });
    apartmentMarkers = {}; // âœ… ë§ˆì»¤ ìºì‹œë„ ì´ˆê¸°í™”

    // âœ… ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    
    updateMarkers(window.map.getBounds()); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});


document.getElementById("toggleSchools").addEventListener("change", () => {
    updateSchoolMarkers(); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});

let observer = new ResizeObserver(() => {
    if (window.map) {
        let mapElement = document.getElementById("map");
        //let width = mapElement.clientWidth;
        //let height = mapElement.clientHeight;
        //window.map.setSize(new naver.maps.Size(width, height)); // ì§€ë„ í¬ê¸° ì—…ë°ì´íŠ¸
		//console.log("ì§€ë„ ë³€í•¨");
    }
});

// `#map` ìš”ì†Œì˜ í¬ê¸° ë³€í™”ë¥¼ ê°ì§€í•˜ì—¬ ìë™ ì—…ë°ì´íŠ¸
observer.observe(document.getElementById("map"));

let isFullscreen = false; // í˜„ì¬ ì „ì²´ í™”ë©´ ì—¬ë¶€ ì €ì¥
let originalHeight = document.getElementById("map").style.height; // ê¸°ì¡´ ì§€ë„ ë†’ì´ ì €ì¥

function toggleFullscreen() {
    let mapElement = document.getElementById("map");

    if (!isFullscreen) {
        // ğŸ”¹ ì „ì²´ í™”ë©´ ëª¨ë“œë¡œ ì „í™˜
        originalHeight = mapElement.style.height; // ì›ë˜ ë†’ì´ ì €ì¥
        mapElement.style.position = "fixed";
        mapElement.style.top = "0";
        mapElement.style.left = "0";
        mapElement.style.width = "100vw";
        mapElement.style.height = "100vh";
        mapElement.style.zIndex = "9999";
        document.body.style.overflow = "hidden"; // ìŠ¤í¬ë¡¤ ë°©ì§€
        isFullscreen = true;
    } else {
        // ğŸ”¹ ì›ë˜ ìƒíƒœë¡œ ë³µê·€
        mapElement.style.position = "";
        mapElement.style.top = "";
        mapElement.style.left = "";
        mapElement.style.width = "100%";
        mapElement.style.height = originalHeight; // ì €cì¥ëœ ë†’ì´ ë³µì›
        mapElement.style.zIndex = "";
        document.body.style.overflow = ""; // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
        isFullscreen = false;
    }

    // ì§€ë„ í¬ê¸° ê°±ì‹ 
    window.map.setSize(new naver.maps.Size(mapElement.clientWidth, mapElement.clientHeight));
}






let apartmentDetailData = {};

// JSON ë°ì´í„° ë¡œë“œ
async function loadApartmentsDetail() {
    try {
        //console.log("ğŸ“Œ JSON ë°ì´í„° ë¡œë“œ ì‹œì‘");

        // ğŸ”¹ ë‘ ê°œì˜ JSON íŒŒì¼ fetch()
        const [res1, res2] = await Promise.all([
            fetch("apartments1.json").then(res => res.json()),
            fetch("apartments2.json").then(res => res.json())
        ]);

        // ğŸ”¹ JSON ë³‘í•© (Object.assign() ì‚¬ìš©)
        apartmentDetailData = Object.assign({}, res1, res2);

        //console.log("âœ… ì•„íŒŒíŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", apartmentDetailData);

        // ğŸ”¹ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateMarkers(window.map.getBounds());

    } catch (error) {
        console.error("âŒ ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }
}
// ë§¨ ìœ„ ì „ì—­ì— ì¶”ê°€
const aptMemoImageList = {};

   // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ
// ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ

async function compressImage(base64, maxSize = 600, quality = 0.8) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement("canvas");
            let [w, h] = [img.width, img.height];
            if (w > h && w > maxSize) {
                h *= maxSize / w;
                w = maxSize;
            } else if (h >= w && h > maxSize) {
                w *= maxSize / h;
                h = maxSize;
            }
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);
            const compressedBase64 = canvas.toDataURL("image/jpeg", quality);
            resolve(compressedBase64);
        };
        img.src = base64;
    });
}



 function showApartmentInfo(apartmentId, markerPosition) {
  event?.stopPropagation();
  if (document.getElementById("toggleSiseMap").checked) return;

  apartmentId = String(apartmentId);
  if (!apartmentDetailData[apartmentId]) {
    alert("ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  let apt = apartmentDetailData[apartmentId];
  let aptInfo = apartmentData.find(apartment => String(apartment.id) === apartmentId);
  let leaseInfo = aptInfo ? aptInfo.lease : "ì •ë³´ ì—†ìŒ";
  let typeInfo = apt.íƒ€ì…ì •ë³´ || [];

apartmentInfo.setAttribute("data-id", apartmentId);


  let infoHtml = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0; text-align: left;">${apt.ì•„íŒŒíŠ¸ëª…}</h3>
      <button onclick="openNaverRealEstate(${apartmentId})" 
        style="padding: 8px; background: #4A90E2; color: white; border: none; border-radius: 4px; cursor: pointer;">
        ë„¤ë¶€ ë°”ë¡œê°€ê¸°
      </button>
    </div>
    <p>ì…ì£¼ì‹œê¸°: ${apt.ì…ì£¼ì‹œê¸°}</p>
    <p>ì´ì„¸ëŒ€ìˆ˜: ${apt.ì´ì„¸ëŒ€ìˆ˜} (ì„ëŒ€ : ${leaseInfo})</p>
    <table style="width: 100%; border-collapse: collapse;">
      <tr>
        <th>ê³µê¸‰í‰ìˆ˜</th>
        <th>ê³µê¸‰ã¡</th>
        <th>ì „ìš©ã¡</th>
        <th>êµ¬ì¡°</th>
        <th>ë°©</th>
        <th>í™”</th>
        <th>íƒ€ì…</th>
        <th>ì„¸ëŒ€ìˆ˜</th>
      </tr>`;

  typeInfo.forEach(type => {
    infoHtml += `
      <tr>
        <td>${type["ê³µê¸‰í‰ìˆ˜"]}</td>
        <td>${type["ê³µê¸‰ë©´ì "]}</td>
        <td>${type["ì „ìš©ë©´ì "]}</td>
        <td>${type["êµ¬ì¡°"]}</td>
        <td>${type["ë°© ê°¯ìˆ˜"]}</td>
        <td>${type["í™”ì¥ì‹¤ ê°¯ìˆ˜"]}</td>
        <td>${type["íƒ€ì…"]}</td>
        <td>${type["í‰í˜• ì„¸ëŒ€ìˆ˜"]}</td>
      </tr>`;
  });

  infoHtml += `
    </table>
    <div style="margin-top: 20px;">
      <label>ë©”ëª¨:</label>
      <textarea id="noteText" rows="5" style="width: 100%; box-sizing: border-box;"></textarea>
      <div id="imagePreview" style="margin-top: 10px; display: none; flex-wrap: wrap; gap: 8px;"></div>
      <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">

        <label style="cursor: pointer; background: white; color: black; padding: 8px 4px; border-radius: 4px;">
          ğŸ“· ì‚¬ì§„ ì°ê¸°
          <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" />
        </label>

        <label style="cursor: pointer; background: white; color: black; padding: 8px 4px; border-radius: 4px;">
          ğŸ“ íŒŒì¼ ì„ íƒ
          <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" />
        </label>
<!-- 
        <label style="cursor: pointer; background: white; color: black; padding: 8px 6px; border-radius: 4px;">
          ğŸ’¾ ì €ì¥
          <button onclick="saveNote('${apartmentId}')" style="display: none;"></button>
        </label> -->

		<label style="cursor: pointer; background: white; color: black; padding: 8px 5px; border-radius: 4px;">
		  ğŸ—‘ ì´ˆê¸°í™”
		  <button onclick="deleteNote('${apartmentId}')" style="display: none;"></button>
		</label>
      </div>
    </div>`;

  const infoDiv = document.getElementById("apartmentInfo");
  if (!infoDiv.dataset.positioned) {
    infoDiv.style.top = "50%";
    infoDiv.style.left = "50%";
    infoDiv.style.transform = "translate(-50%, -50%)";
    infoDiv.dataset.positioned = "true";
  }
  infoDiv.innerHTML = infoHtml;
  infoDiv.style.display = "block";

  loadNote(apartmentId);

  setTimeout(() => { 
    const imageInput = document.getElementById("imageInput");
    const cameraInput = document.getElementById("cameraInput");
    const preview = document.getElementById("imagePreview");

    const handleImageFiles = (files) => {
      if (!files.length) return;
      preview.style.display = "flex";
      for (const file of files) {
        const reader = new FileReader();
        reader.onload = async function (event) {

          const imageDataUrl = event.target.result;
          if (!aptMemoImageList[apartmentId]) {
            aptMemoImageList[apartmentId] = [];
          }
			aptMemoImageList[apartmentId].push(imageDataUrl);


/*
const originalBase64 = event.target.result;

  // âœ… ì••ì¶•
  const compressedBase64 = await compressImage(originalBase64, 600, 1.0);

  if (!aptMemoImageList[apartmentId]) {
    aptMemoImageList[apartmentId] = [];
  }
  aptMemoImageList[apartmentId].push(compressedBase64);
*/
          const wrapper = document.createElement("div");
          wrapper.style.position = "relative";
          wrapper.style.display = "inline-block";
          wrapper.style.marginRight = "6px";
          wrapper.style.width = "60px";
          wrapper.style.height = "60px";

          const canvas = document.createElement("canvas");
          canvas.width = 60;
          canvas.height = 60;
          canvas.style.border = "1px solid #ccc";
          canvas.style.borderRadius = "4px";
          canvas.style.cursor = "pointer";
          canvas.title = "ë¯¸ë¦¬ë³´ê¸°";

          const ctx = canvas.getContext("2d");
          const img = new Image();
          img.onload = () => ctx.drawImage(img, 0, 0, 60, 60);
          img.src = imageDataUrl;

          canvas.onclick = (e) => {
            e.stopPropagation();
            const modal = document.getElementById("imageModal");
            const modalCanvas = document.getElementById("modalCanvas");
            const modalCtx = modalCanvas.getContext("2d");
            const previewImg = new Image();
            previewImg.onload = () => {
              modalCanvas.width = previewImg.width;
              modalCanvas.height = previewImg.height;
              modalCtx.drawImage(previewImg, 0, 0);
              modal.style.display = "flex";
              window.imageModalShowYn = true;
            };
            previewImg.src = imageDataUrl;
          };

          const deleteBtn = document.createElement("div");
          deleteBtn.textContent = "âœ•";
          deleteBtn.style.position = "absolute";
          deleteBtn.style.top = "2px";
          deleteBtn.style.right = "2px";
          deleteBtn.style.background = "rgba(0,0,0,0.6)";
          deleteBtn.style.color = "white";
          deleteBtn.style.borderRadius = "50%";
          deleteBtn.style.width = "16px";
          deleteBtn.style.height = "16px";
          deleteBtn.style.display = "flex";
          deleteBtn.style.alignItems = "center";
          deleteBtn.style.justifyContent = "center";
          deleteBtn.style.cursor = "pointer";
          deleteBtn.style.fontSize = "12px";

          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm("ì‚¬ì§„ì„ ì‚­ì œí•©ë‹ˆë‹¤")) {
              aptMemoImageList[apartmentId] = aptMemoImageList[apartmentId].filter(img => img !== imageDataUrl);
              wrapper.remove();
              if (preview.children.length === 0) {
                preview.style.display = "none";
              }
            }
          };

          wrapper.appendChild(canvas);
          wrapper.appendChild(deleteBtn);
          preview.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
      }
    };

    if (imageInput) {
      imageInput.addEventListener("change", (e) => {
        handleImageFiles(e.target.files);
        e.target.value = "";
      });
    }

    if (cameraInput) {
      cameraInput.addEventListener("change", (e) => {
        handleImageFiles(e.target.files);
        e.target.value = "";
      });
    }
  }, 0);
}






// âœ… ë„¤ì´ë²„ ë¶€ë™ì‚° ë§í¬ ì—´ê¸° í•¨ìˆ˜ ì¶”ê°€
	function openNaverRealEstate(apartmentId) {
		let url = `https://new.land.naver.com/complexes/${apartmentId}`;
		window.open(url, "_blank");
	}


document.addEventListener("click", (event) => {
    const apartmentInfo = document.getElementById("apartmentInfo");
    const imageModal = document.getElementById("imageModal");

    // apartmentInfoê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ë¦¬í„´
    if (!apartmentInfo) return;

    setTimeout(() => {
        // ğŸ”’ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ì§€ ì•ŠìŒ

        if (imageModalShowYn === true) {imageModalShowYn = false; return;}

        // apartmentInfo ë‚´ë¶€ í´ë¦­ì´ë©´ ë‹«ì§€ ì•ŠìŒ
        if (apartmentInfo.contains(event.target)) return;

        // ê·¸ ì™¸ì—” ë‹«ê¸°
        if (apartmentInfo.style.display === "block") {
//console.log("ì‹¤í–‰ë¨");

 const apartmentInfo = document.getElementById("apartmentInfo");
 const id = apartmentInfo.getAttribute("data-id");
      const memo = document.getElementById("noteText")?.value?.trim();
      const images = aptMemoImageList?.[id] ?? [];
console.log(id);
console.log(memo);
console.log(images);
      //if ((memo && memo !== "") || images.length > 0) {
        saveNote(id); // âœ… ìë™ ì €ì¥
      //}




            apartmentInfo.style.display = "none";
        }
    }, 0);
});



document.getElementById("apartmentInfo").addEventListener("touchstart", function(event) {
    const infoDiv = event.currentTarget;
    infoDiv.dataset.startY = event.touches[0].clientY;
    infoDiv.dataset.startScrollTop = infoDiv.scrollTop;
}, { passive: false });

document.getElementById("apartmentInfo").addEventListener("touchmove", function(event) {
    const infoDiv = event.currentTarget;
    
    // ë‚´ë¶€ ìŠ¤í¬ë¡¤ì´ ê°€ëŠ¥í•œ ê²½ìš°
    if (infoDiv.scrollHeight > infoDiv.clientHeight) {
        let startY = parseFloat(infoDiv.dataset.startY);
        let startScrollTop = parseFloat(infoDiv.dataset.startScrollTop);
        let currentY = event.touches[0].clientY;
        let scrollDiff = startScrollTop + (startY - currentY);

        // âœ… ìµœìƒë‹¨ì—ì„œ ì•„ë˜ë¡œ ë‹¹ê¸°ë ¤ê³  í•  ë•Œ
        if (infoDiv.scrollTop <= 0 && scrollDiff < 0) {
            event.preventDefault();
        }
        
         // âœ… ìµœí•˜ë‹¨ì—ì„œ ìœ„ë¡œ ìŠ¤í¬ë¡¤í•  ë•Œ ì œí•œì„ í•´ì œ
		if (infoDiv.dataset.atBottom === "true" && scrollDiff > 0) {
			event.preventDefault();
			infoDiv.scrollTop = infoDiv.scrollHeight - infoDiv.clientHeight - 1; // âœ… ìŠ¤í¬ë¡¤ì„ ì¡°ì •í•˜ì—¬ ì •ìƒ ì‘ë™
		}

    } else {
        // âœ… ë‚´ë¶€ ìŠ¤í¬ë¡¤ì´ ì—†ëŠ” ê²½ìš° ë°”ë”” ìŠ¤í¬ë¡¤ ì°¨ë‹¨
        event.preventDefault();
    }
}, { passive: false });

document.addEventListener("touchmove", function(event) {
    const infoDiv = document.getElementById("apartmentInfo");

    if (infoDiv.style.display === "block") {
        if (infoDiv.scrollHeight <= infoDiv.clientHeight) {
            event.preventDefault(); // ë‚´ë¶€ ìŠ¤í¬ë¡¤ì´ ì—†ìœ¼ë©´ ë°”ë”” ìŠ¤í¬ë¡¤ ë§‰ê¸°
        }
    }
}, { passive: false });

let middleSchoolMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ì¤‘í•™êµ ë§ˆì»¤ ì €ì¥
/*
async function loadMiddleSchools() {
    try {
        const response = await fetch("middleSchools.json");
        const middleSchools = await response.json();
        
        console.log("âœ… ì¤‘í•™êµ ë°ì´í„° ë¡œë“œ ì™„ë£Œ", middleSchools);

        window.middleSchoolData = middleSchools; // âœ… ì „ì²´ ì¤‘í•™êµ ë°ì´í„° ì €ì¥

        // âœ… ì´ˆê¸° ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateMiddleSchoolMarkers(window.map.getBounds());

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ì¤‘í•™êµ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            const bounds = window.map.getBounds();
            updateMiddleSchoolMarkers(bounds);
        });

    } catch (error) {
        console.error("âŒ ì¤‘í•™êµ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}
*/

async function loadMiddleSchools() {
    try {
        const response = await fetch("middleSchools.json");
        let middleSchools = await response.json();

        // âœ… ì¤‘ë³µ ì œê±°: í•™êµ IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì²« ë²ˆì§¸ ê°’ë§Œ ìœ ì§€
        const uniqueSchools = [];
        const seenIds = new Set();

        middleSchools.forEach(school => {
            if (!seenIds.has(school["í•™êµ ID"])) {
                seenIds.add(school["í•™êµ ID"]);
                uniqueSchools.push(school);
            }
        });

        //console.log("âœ… ì¤‘ë³µ ì œê±° ì™„ë£Œ: ì´", uniqueSchools.length, "ê°œ í•™êµ ë¡œë“œë¨");

        window.middleSchoolData = uniqueSchools; // âœ… ì¤‘ë³µ ì œê±°ëœ ë°ì´í„° ì €ì¥

        // âœ… ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateMiddleSchoolMarkers();

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ì¤‘í•™êµ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            updateMiddleSchoolMarkers();
        });

    } catch (error) {
        console.error("âŒ ì¤‘í•™êµ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}



function updateMiddleSchoolMarkers() {
    const showMiddleSchools = document.getElementById("toggleMiddleSchools").checked;
	
    // âœ… ê¸°ì¡´ ì¤‘í•™êµ ë§ˆì»¤ ì œê±°
    middleSchoolMarkers.forEach(marker => marker.setMap(null));
    middleSchoolMarkers = [];

    if (!showMiddleSchools) return; // ì¤‘í•™êµ í‘œì‹œ ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ
	
	if (window.map.getZoom() < 14) { 
        return; // âœ… ì¤Œ ë ˆë²¨ì´ 14ë³´ë‹¤ ì‘ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨
    }

    let bounds = window.map.getBounds();
    let filteredSchools = window.middleSchoolData.filter(school =>
        bounds.hasLatLng(new naver.maps.LatLng(school["ìœ„ë„"], school["ê²½ë„"]))
    );

    filteredSchools.forEach(school => {
    // âœ… ë§ˆì»¤ ì»¨í…Œì´ë„ˆë¥¼ markerElementë¡œ í™œìš©
    const markerElement = document.createElement("div");
    markerElement.style = "text-align: center; display: flex; flex-direction: column; align-items: center;";

    const markerIcon = document.createElement("img");
    markerIcon.src = "midSchool.png";
    markerIcon.style = "width: 32px; height: 32px;";

    const infoBox = document.createElement("div");
    infoBox.style = `
        background: white;
        border: 1px solid gray;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
    `;
    infoBox.textContent = `${school["í•™êµëª…"]} (${school["í•™ì—…ì„±ì·¨ë„"]})`;

    markerElement.appendChild(markerIcon);
    markerElement.appendChild(infoBox);

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(school["ìœ„ë„"], school["ê²½ë„"]),
        map: window.map,
        icon: { content: markerElement, anchor: new naver.maps.Point(16, 32) }
    });

    // âœ… ìš°í´ë¦­ ì´ë²¤íŠ¸ì— markerElement ì „ë‹¬ (í…Œë‘ë¦¬ í™œì„±í™” ê°€ëŠ¥)
    addMarkerRightClickEvent(marker, markerElement);

    middleSchoolMarkers.push(marker);
});

}


// âœ… ì¤‘í•™êµ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
document.getElementById("toggleMiddleSchools").addEventListener("change", () => {
    updateMiddleSchoolMarkers(); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});

let facilityMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ì‹œì„¤ ë§ˆì»¤ ì €ì¥

async function loadFacilities() {
    try {
        const response = await fetch("facility.json");
        const facilities = await response.json();

        //console.log("âœ… ì‹œì„¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ", facilities);
        window.facilityData = facilities; // âœ… ì „ì²´ ì‹œì„¤ ë°ì´í„° ì €ì¥

        // âœ… ì´ˆê¸° ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateFacilityMarkers(window.map.getBounds());

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ì‹œì„¤ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            const bounds = window.map.getBounds();
            updateFacilityMarkers(bounds);
        });

    } catch (error) {
        console.error("âŒ ì‹œì„¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}

function updateFacilityMarkers() {
    const showFacilities = document.getElementById("toggleFacilities").checked;

    // âœ… ê¸°ì¡´ ì‹œì„¤ ë§ˆì»¤ ì œê±°
    facilityMarkers.forEach(marker => marker.setMap(null));
    facilityMarkers = [];

    if (!showFacilities) return; // ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ
    if (window.map.getZoom() < 14) return; // âœ… ì¤Œ ë ˆë²¨ì´ 14ë³´ë‹¤ ì‘ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨

    let bounds = window.map.getBounds();
    let filteredFacilities = window.facilityData.filter(facility =>
        bounds.hasLatLng(new naver.maps.LatLng(facility.lat, facility.lng))
    );

    filteredFacilities.forEach(facility => {
    let iconSrc = "default.png"; // ê¸°ë³¸ ì•„ì´ì½˜ (ì˜ˆì™¸ì²˜ë¦¬)
    if (facility.category === 10) {
        iconSrc = facility.description.includes("ë°±í™”ì ") ? "depart.png" : "mart.png";
    } else if (facility.category === 9) {
        iconSrc = "hospital.png";
    }

    // âœ… ë§ˆì»¤ ì»¨í…Œì´ë„ˆë¥¼ markerElementë¡œ í™œìš©
    const markerElement = document.createElement("div");
    markerElement.style = "text-align: center; display: flex; flex-direction: column; align-items: center;";

    const markerIcon = document.createElement("img");
    markerIcon.src = iconSrc;
    markerIcon.style = "width: 32px; height: 32px;";

    const infoBox = document.createElement("div");
    infoBox.style = `
        background: white;
        border: 1px solid gray;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
        display: inline-block;
        max-width: 140px;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
    `;

    if (facility.category === 10) {
        infoBox.textContent = `${facility.description} (${facility.name})`;
    } else if (facility.category === 9) {
        infoBox.textContent = `${facility.name}`;
    }

    markerElement.appendChild(markerIcon);
    markerElement.appendChild(infoBox);

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(facility.lat, facility.lng),
        map: window.map,
        icon: { content: markerElement, anchor: new naver.maps.Point(16, 32) }
    });

    // âœ… ìš°í´ë¦­ ì´ë²¤íŠ¸ì— markerElement ì „ë‹¬ (í…Œë‘ë¦¬ í™œì„±í™” ê°€ëŠ¥)
    addMarkerRightClickEvent(marker, markerElement);

    facilityMarkers.push(marker);
});

}

// âœ… ì‹œì„¤ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
document.getElementById("toggleFacilities").addEventListener("change", () => {
    updateFacilityMarkers(); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});

let starbucksMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ìŠ¤íƒ€ë²…ìŠ¤ ë§ˆì»¤ ì €ì¥

async function loadStarbucks() {
    try {
        const response = await fetch("starbucks.json");
        const starbucks = await response.json();

        //console.log("âœ… ìŠ¤íƒ€ë²…ìŠ¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ", starbucks);
        window.starbucksData = starbucks; // âœ… ì „ì²´ ìŠ¤íƒ€ë²…ìŠ¤ ë°ì´í„° ì €ì¥

        // âœ… ì´ˆê¸° ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateStarbucksMarkers(window.map.getBounds());

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ìŠ¤íƒ€ë²…ìŠ¤ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            const bounds = window.map.getBounds();
            updateStarbucksMarkers(bounds);
        });

    } catch (error) {
        console.error("âŒ ìŠ¤íƒ€ë²…ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}

function updateStarbucksMarkers() {
    const showStarbucks = document.getElementById("toggleStarbucks").checked;

    // âœ… ê¸°ì¡´ ìŠ¤íƒ€ë²…ìŠ¤ ë§ˆì»¤ ì œê±°
    starbucksMarkers.forEach(marker => marker.setMap(null));
    starbucksMarkers = [];

    if (!showStarbucks) return; // ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ
    if (window.map.getZoom() < 14) return; // âœ… ì¤Œ ë ˆë²¨ì´ 14ë³´ë‹¤ ì‘ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨

    let bounds = window.map.getBounds();
    let filteredStarbucks = window.starbucksData.filter(store =>
        bounds.hasLatLng(new naver.maps.LatLng(store.lat, store.lot))
    );

     filteredStarbucks.forEach(store => {
        let iconSrc = store.s_name.includes("R") ? "starbucksReserve.png" : "starbucks.png";

        // âœ… ë§ˆì»¤ ì»¨í…Œì´ë„ˆë¥¼ markerElementë¡œ í™œìš©
        const markerElement = document.createElement("div");
        markerElement.style = "text-align: center; display: flex; flex-direction: column; align-items: center;";

        const markerIcon = document.createElement("img");
        markerIcon.src = iconSrc;
        markerIcon.style = "width: 32px; height: 32px;";

        markerElement.appendChild(markerIcon);

        const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(store.lat, store.lot),
            map: window.map,
            icon: { content: markerElement, anchor: new naver.maps.Point(16, 32) }
        });

        // âœ… ìš°í´ë¦­ ì´ë²¤íŠ¸ì— markerElement ì „ë‹¬
        addMarkerRightClickEvent(marker, markerElement);

        starbucksMarkers.push(marker);
    });
}

// âœ… ìŠ¤íƒ€ë²…ìŠ¤ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
document.getElementById("toggleStarbucks").addEventListener("change", () => {
    updateStarbucksMarkers(); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});


////////////////////////// ì´ë™ ì´ë²¤íŠ¸ //////////////////////////
var activeMarker = null; // âœ… í˜„ì¬ ì„ íƒëœ ë§ˆì»¤
var activeMarkerElement = null; // âœ… í˜„ì¬ ì„ íƒëœ ë§ˆì»¤ì˜ ìš”ì†Œ (í…Œë‘ë¦¬ ë³€ê²½ìš©)

// âœ… ğŸ”¥ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì„ íƒëœ ê²½ìš° ê°•ì¡°)
function updateMarkerSelection(markerElement, isSelected) {
    if (markerElement) {
        setTimeout(() => {
            markerElement.style.outline = isSelected ? "3px solid red" : "";
        }, 50); // âœ… DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸° í›„ ìŠ¤íƒ€ì¼ ì ìš©
    }
}


function addMarkerRightClickEvent(marker, markerElement) {
    naver.maps.Event.addListener(marker, "rightclick", (e) => {
        e.domEvent.preventDefault();
        e.domEvent.stopPropagation();

        const isSiseMapActive = document.getElementById("toggleSiseMap").checked;

        console.log("ğŸš€ ë§ˆì»¤ ìš°í´ë¦­ ê°ì§€ (ID: " + marker.apartmentId + ")");

        // âœ… ê¸°ì¡´ ì„ íƒëœ ë§ˆì»¤ í…Œë‘ë¦¬ ì œê±°
        if (activeMarkerElement) {
            updateMarkerSelection(activeMarkerElement, false);
        }

        // âœ… í˜„ì¬ ì„ íƒëœ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        activeMarker = marker;
        activeMarkerElement = markerElement; // âœ… ê¸°ì¡´ ë°©ì‹
        updateMarkerSelection(activeMarkerElement, true);

        // âœ… ë§Œì•½ ë§ˆì»¤ê°€ ì‹œì„¸ì§€ë„ ë§ˆì»¤ì´ë©´ `.siseMapMarker`ë¥¼ ë‹¤ì‹œ ì°¾ê³  ìŠ¤íƒ€ì¼ ì ìš©
        if (isSiseMapActive) {
            setTimeout(() => {
                const updatedMarkerElement = markerElement.querySelector(".siseMapMarker");
                if (updatedMarkerElement) {
                    activeMarkerElement = updatedMarkerElement;
                    updateMarkerSelection(updatedMarkerElement, true);
                }
            }, 100); // âœ… DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸° í›„ ìŠ¤íƒ€ì¼ ì ìš©
        }
    });
}





// âœ… í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë“±ë¡
document.removeEventListener("keydown", handleKeyDown);
document.addEventListener("keydown", handleKeyDown);



function setupRightClickEvent() {
    let radiusCircle = null; // âœ… ë°˜ê²½ ì› ê°ì²´
    let centerMarker = null; // âœ… ë°˜ê²½ ì¤‘ì‹¬ ë§ˆì»¤

    // âœ… ì§€ë„ì—ì„œ ìš°í´ë¦­ ì‹œ (ë°˜ê²½ 1km ì› + ì¤‘ì‹¬ ë¹¨ê°„ ì  ì¶”ê°€)
    naver.maps.Event.addListener(window.map, "mousedown", function (e) {
        if (e.domEvent.button !== 2) return; // âœ… ìš°í´ë¦­ì´ ì•„ë‹ ê²½ìš° ë¬´ì‹œ

        let clickedPosition = e.coord; // âœ… ìš°í´ë¦­í•œ ìœ„ì¹˜ì˜ ì¢Œí‘œ
        //console.log("ğŸ“ ìš°í´ë¦­ ìœ„ì¹˜:", clickedPosition);

        // âœ… ì´ë¯¸ ë°˜ê²½ ì›ì´ ìˆëŠ” ê²½ìš°, ì œê±° í›„ ì¢…ë£Œ (í† ê¸€ ë°©ì‹)
        if (radiusCircle) {
            radiusCircle.setMap(null);
            radiusCircle = null;
        }
        if (centerMarker) {
            centerMarker.setMap(null);
            centerMarker = null;
            return; // âœ… ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±í•˜ì§€ ì•ŠìŒ
        }

        // âœ… ë°˜ê²½ 1km ì› ì¶”ê°€
        radiusCircle = new naver.maps.Circle({
            map: window.map,
            center: clickedPosition,
            radius: 1000, // âœ… ë°˜ê²½ 1km
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.08
        });

        // âœ… ë°˜ê²½ ì¤‘ì‹¬ì— ë¹¨ê°„ìƒ‰ ì‘ì€ ì  ì¶”ê°€
        centerMarker = new naver.maps.Marker({
            position: clickedPosition,
            map: window.map,
            icon: {
                content: `<div style="width: 8px; height: 8px; background-color: red; border-radius: 50%; border: 1px solid white;"></div>`,
                anchor: new naver.maps.Point(4, 4) // âœ… ì¤‘ì‹¬ ì •ë ¬
            }
        });

        // âœ… ì§€ë„ ì¤‘ì‹¬ì„ í´ë¦­í•œ ìœ„ì¹˜ë¡œ ì´ë™
        window.map.panTo(clickedPosition);
    });

    // âœ… ê¸°ë³¸ì ì¸ ìš°í´ë¦­ ë©”ë‰´ ë°©ì§€
    document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
    });

    //console.log("âœ… ì§€ë„ ë¡œë“œ ì™„ë£Œ í›„ ìš°í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡ë¨");
}

//////////////////////////////////ì‹œì„¸ ì§€ë„ ////////////////////////////




var activeMarkerSet = null;

// âœ… IndexedDB ì´ˆê¸°í™”
function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('hongbu', 2);

        request.onupgradeneeded = function(event) {
            const db = event.target.result;

            if (!db.objectStoreNames.contains('apartments')) {
                const store = db.createObjectStore('apartments', { keyPath: 'idType' });
                store.createIndex('id', 'id', { unique: false });
                console.log('âœ… IndexedDB ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ: apartments store ìƒì„±ë¨');
            }
        };

        request.onsuccess = function(event) {
            console.log('ğŸ“Œ hongbu ì—°ê²° ì„±ê³µ (DB: hongbu)');
            resolve(event.target.result);
        };

        request.onerror = function(event) {
            console.error('âŒ IndexedDB ì—°ê²° ì‹¤íŒ¨:', event.target.error);
            reject(event.target.error);
        };
    });
}

function initMemoIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('hongbuMemo', 2);

        request.onupgradeneeded = function(event) {
            const db = event.target.result;

           

			 if (!db.objectStoreNames.contains("apartmentNotes")) {
				db.createObjectStore("apartmentNotes", { keyPath: "id" });
			}
        };

        request.onsuccess = function(event) {
            console.log('ğŸ“Œ hongbuMemo ì—°ê²° ì„±ê³µ (DB: hongbu)');
            resolve(event.target.result);
        };

        request.onerror = function(event) {
            console.error('âŒ IndexedDB ì—°ê²° ì‹¤íŒ¨:', event.target.error);
            reject(event.target.error);
        };
    });
}

// âœ… IndexedDB ì €ì¥ í•¨ìˆ˜
function saveToIndexedDB(id, type, text, color, textColor, fontSize) {
    const request = indexedDB.open("hongbu", 2);
    request.onsuccess = function(event) {
        const db = event.target.result;
        const transaction = db.transaction(["apartments"], "readwrite");
        const store = transaction.objectStore("apartments");

        store.put({ idType: `${id}-${type}`, text, color, textColor, fontSize });

        transaction.oncomplete = () => console.log(`âœ… IndexedDB ì €ì¥ ì™„ë£Œ: ${id}`);
        transaction.onerror = (e) => console.error(`âŒ IndexedDB ì €ì¥ ì˜¤ë¥˜: ${e.target.error}`);

    };
	markerElement = document.querySelector(`[data-apartment-id='${id}']`);
	markerElement.style.maxWidth = '160px';


}

// âœ… IndexedDBì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
function getFromIndexedDB(id, type) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open("hongbu", 2);

        request.onerror = (event) => {
            reject("âŒ IndexedDB ì—´ê¸° ì˜¤ë¥˜: " + event.target.errorCode);
        };

        request.onsuccess = (event) => {
            const db = event.target.result;
            const transaction = db.transaction(["apartments"], "readonly");
            const store = transaction.objectStore("apartments");

            const idType = `${id}-${type}`;
            const getRequest = store.get(idType);

            getRequest.onsuccess = () => {
                if (getRequest.result) {
                    resolve(getRequest.result);
                } else {
                    resolve({ text: "", color: "#9F9F9F", textColor: "#ffffff", fontSize: "12px" });
                }
            };

            getRequest.onerror = () => {
                reject("âŒ IndexedDB ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨");
            };
        };
    });
}
document.getElementById("toggleSiseMap").addEventListener("change", function() {
    const isChecked = this.checked;

	document.getElementById("siseExportBtn").style.display = isChecked ? "inline-block" : "none";
    document.getElementById("siseImportBtn").style.display = isChecked ? "inline-block" : "none";
	document.getElementById("siseResetBtn").style.display = isChecked ? "inline-block" : "none";
	if(!isChecked){
		removeAllLines(window.map.getBounds());
	}
    updateMarkers(window.map.getBounds())
	
});



function renderSiseMapMarker(apartment) {
    // âœ… ê¸°ì¡´ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ì‚­ì œ
    if (apartmentMarkers[apartment.id]) {
        naver.maps.Event.clearInstanceListeners(apartmentMarkers[apartment.id]); // ğŸ”¥ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
        apartmentMarkers[apartment.id].setMap(null); // ğŸ”¥ ì§€ë„ì—ì„œ ì‚­ì œ
        delete apartmentMarkers[apartment.id]; // ğŸ”¥ ë©”ëª¨ë¦¬ì—ì„œ ì œê±°
    }

    const markerElement = document.createElement("div");
    markerElement.className = "siseMapMarker";
    markerElement.style = `
    background: #fff;
    border: 2px solid black;
    padding: 0px;
    font-size: 12px;
    text-align: center;
    border-radius: 6px;
    display: inline-block;  /* âœ… ìë™ ë„ˆë¹„ ì„¤ì • */
    max-width: 200px;        /* âœ… í•„ìš”í•˜ë©´ ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
min-width: 120px;
    word-break: keep-all;   /* âœ… ì¤„ë°”ê¿ˆ ë°©ì§€ */
`;


    markerElement.setAttribute("data-apartment-id", apartment.id);

    const nameElement = document.createElement("div");
    nameElement.innerHTML = `${apartment.name}<br>${apartment.year.slice(-5)} ${apartment.units}ì„¸ëŒ€`;
    nameElement.style = `
        font-weight: bold;
        font-size: 12px;
        margin: 5px;
overflow: hidden; /* âœ… ë„˜ì¹˜ëŠ” ë‚´ìš© ìˆ¨ê¹€ */
    white-space: nowrap; /* âœ… í•œ ì¤„ ìœ ì§€ */
    text-overflow: ellipsis; /* âœ… ë§ì¤„ì„ (...) ì²˜ë¦¬ */
    `;

    const tableContainer = document.createElement("div");
    tableContainer.className = "tableContainer";
    tableContainer.style = `
    background: white;
    padding: 0px;
    font-size: 12px;
min-height: 24px;
    display: block;
    width: auto;           /* âœ… ë§ˆì»¤ê°€ ë‚´ìš©ì— ë§ê²Œ ëŠ˜ì–´ë‚˜ë„ë¡ */
    max-width: none;       /* âœ… ì œí•œ ì œê±° */
    overflow: visible;     /* âœ… ë„˜ì¹¨ í—ˆìš© */
`;


    markerElement.appendChild(nameElement);
    markerElement.appendChild(tableContainer);

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(apartment.lat, apartment.lng),
        map: window.map,
        icon: {
            content: markerElement,
            anchor: new naver.maps.Point(10, 30)
        }
    });
	marker.originPosition = new naver.maps.LatLng(apartment.lat, apartment.lng); // âœ… ìµœì´ˆ ìœ„ì¹˜ ì €ì¥
    marker.apartmentId = apartment.id;

    // âœ… ì¤‘ë³µ ì´ë²¤íŠ¸ ë°©ì§€ ìœ„í•´ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€
    addSiseMapMarkerLeftClickEvent(marker, markerElement);
    addMarkerRightClickEvent(marker, markerElement);

    // âœ… IndexedDBì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    updateT2FromIndexedDB(apartment.id, markerElement, tableContainer);

    return marker;
}


// âœ… IndexedDBì—ì„œ ë°ì´í„° ê°€ì ¸ì™€ í…Œì´ë¸” ì—…ë°ì´íŠ¸ + ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ ì ìš©
function updateT2FromIndexedDB(id, markerElement, tableContainer) {
	let siseChecked = document.getElementById("toggleSiseMap").checked;
    if (!siseChecked) return;
	

    getFromIndexedDB(id, "ì‹œì„¸1").then(data => {
        let tableData = data?.text || generateDefaultTable();
        tableContainer.innerHTML = createEditableTableHTML(id, tableData);

        let bgColor = data?.color?.trim() || '#9F9F9F';
		let textColor = data?.textColor?.trim() || '#FFFFFF';
		let fontSize = data?.fontSize?.trim();

		if (!fontSize || fontSize === "undefined" || fontSize === "") {
			fontSize = "12px";
		}


        // âœ… IndexedDBì—ì„œ ê°€ì ¸ì˜¨ ê°’ ë””ë²„ê¹… ì¶œë ¥
        //console.log(`ğŸ¨ IndexedDB ë¶ˆëŸ¬ì˜¨ ë°ì´í„° (ID: ${id}):`, data);
        //console.log(`ğŸ”¹ ì ìš©í•  ìƒ‰ìƒ: ë°°ê²½ìƒ‰=${bgColor}, ê¸€ììƒ‰=${textColor}, ê¸€ì í¬ê¸°=${fontSize}`);

        markerElement.style.backgroundColor = bgColor;
        markerElement.style.color = textColor;
        markerElement.style.fontSize = fontSize;
		tableContainer.style.fontSize = fontSize;

        // âœ… ê°•ì œ ì ìš© í›„ í™•ì¸
        //console.log(`ğŸŸ¢ ì ìš©ëœ markerElement.style.color: ${markerElement.style.color}`);

        // âœ… ë§Œì•½ colorê°€ ë¹ˆ ê°’ì´ë©´ ê¸°ë³¸ê°’ ê°•ì œ ì ìš©
        if (!markerElement.style.color || markerElement.style.color === "" || markerElement.style.color === "undefined") {
            markerElement.style.color = "#FFFFFF"; 
            //console.log(`âš ï¸ ê°•ì œ ì ìš© í›„ markerElement.style.color: ${markerElement.style.color}`);
        }

		// âœ… tableData ê°’ì„ ê²€ì‚¬í•´ì„œ ê°’ì´ ìˆìœ¼ë©´ â†’ 160px, ì—†ìœ¼ë©´ â†’ 120px
let maxWidth = 120;

if (data?.text?.trim()) {
    // âœ… í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆì§€ ì•Šìœ¼ë©´ ë„ˆë¹„ë¥¼ ëŠ˜ë¦¼
    maxWidth = 200;
}

// âœ… markerElementì— max-width ë°˜ì˜
markerElement.style.maxWidth = `${maxWidth}px`;



        makeTableEditable(tableContainer); // âœ… í…Œì´ë¸”ì„ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
    }).catch(console.error);
}



// âœ… ê¸°ë³¸ 3x4 í…Œì´ë¸” ìƒì„±
function generateDefaultTable() {
    let defaultTable = [];
    for (let i = 0; i < 3; i++) {
        let row = [];
        for (let j = 0; j < 4; j++) {
            row.push("");  // ê¸°ë³¸ê°’ ì„¤ì •
        }
        defaultTable.push(row.join('\t'));
    }
    return defaultTable.join('\n'); // ì¤„ë°”ê¿ˆ í¬í•¨í•˜ì—¬ ì €ì¥
}

// âœ… ìˆ˜ì • ê°€ëŠ¥í•œ í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
function createEditableTableHTML(id, textData) {
    let rows = textData.split('\n').map(row => row.split('\t'));
    const table = document.createElement("table");
    table.style.borderCollapse = "collapse";
    table.style.width = "100%";             // âœ… ìë™ ë„ˆë¹„
    table.style.tableLayout = "auto";       // âœ… ì—´ë§ˆë‹¤ ìœ ë™ì  ë„ˆë¹„
    table.style.color = "black";

    rows.forEach((row, rowIndex) => {
        const tr = document.createElement("tr");
        row.forEach((cell, colIndex) => {
            const td = document.createElement("td");
            td.dataset.id = id;
            td.dataset.row = rowIndex;
            td.dataset.col = colIndex;
            td.textContent = cell.trim();

            td.style = `
				border: 1px solid black;
				padding: 2px 4px;
				text-align: center;
				height: 24px;

				vertical-align: middle;
				white-space: normal;  /* âœ… ì¤„ë°”ê¿ˆ í—ˆìš© */
				word-break: break-word; /* âœ… í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ */
			`;


            tr.appendChild(td);
        });
        table.appendChild(tr);
    });

    return table.outerHTML;
}



// âœ… IndexedDBì— í…Œì´ë¸” ë°ì´í„° ì €ì¥ (tableContainerê°€ ì—†ì„ ê²½ìš° ë³µêµ¬)
function saveTableToIndexedDB(id, tableContainer) {
    if (!tableContainer) {
        console.warn(`âš ï¸ [saveTableToIndexedDB] tableContainerê°€ ì—†ìŠµë‹ˆë‹¤. ID: ${id || "undefined"}`);
        return;
    }

    // âœ… ì´ë¯¸ ì €ì¥ ì¤‘ì¸ì§€ ì²´í¬í•˜ì—¬ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (window.isSaving) {
        console.warn("âš ï¸ IndexedDB ì €ì¥ ì¤‘, ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€");
        return;
    }
    window.isSaving = true;  // âœ… ì €ì¥ ì¤‘ ìƒíƒœ í”Œë˜ê·¸ ì„¤ì •

    let tableData = [];
    tableContainer.querySelectorAll("tr").forEach(row => {
        let rowData = [];
        row.querySelectorAll("td").forEach(td => {
            rowData.push(td.textContent.trim());
        });
        tableData.push(rowData.join('\t'));
    });

    // âœ… IndexedDBì—ì„œ ê¸°ì¡´ ìƒ‰ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ìœ ì§€
    getFromIndexedDB(id, "ì‹œì„¸1").then(existingData => {
        let existingColor = existingData?.color || "#9F9F9F"; // âœ… ê¸°ì¡´ ë°°ê²½ìƒ‰ ìœ ì§€
        let existingTextColor = existingData?.textColor || "#ffffff"; // âœ… ê¸°ì¡´ ê¸€ììƒ‰ ìœ ì§€
        let existingFontSize = existingData?.fontSize || "12px"; // âœ… ê¸°ì¡´ í°íŠ¸ í¬ê¸° ìœ ì§€

        saveToIndexedDB(id, "ì‹œì„¸1", tableData.join('\n'), existingColor, existingTextColor, existingFontSize);
    }).catch(error => {
        console.error("âŒ IndexedDB ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }).finally(() => {
        setTimeout(() => {
            window.isSaving = false;  // âœ… ì¼ì • ì‹œê°„ í›„ ë‹¤ì‹œ ì €ì¥ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
        }, 100);
    });
}




// âœ… ì…€ ì‚­ì œ í•¨ìˆ˜ ìˆ˜ì • (ì‚­ì œ í›„ ì˜¤ë¥˜ ë°©ì§€)
function deleteSelectedCells() {
    if (!selectedCells || selectedCells.size === 0) {
        console.warn("âš ï¸ ì„ íƒëœ ì…€ì´ ì—†ìŒ");
        return;
    }

    selectedCells.forEach(td => {
        if (td && td instanceof HTMLElement) {
            td.textContent = ""; // âœ… ë‚´ìš©ë§Œ ì‚­ì œ
        }
    });

    // â— activeMarkerElementê°€ ì—†ì„ ê²½ìš° ë³µêµ¬ ì‹œë„
    if (!activeMarkerElement && selectedCells.size > 0) {
        let firstCell = Array.from(selectedCells)[0];
        activeMarkerElement = firstCell.closest(".siseMapMarker");
    }

    if (activeMarkerElement) {
        let tableContainer = activeMarkerElement.querySelector(".tableContainer");
        let id = activeMarkerElement.dataset.apartmentId;

        if (!id || id === "undefined") {
            console.warn("âš ï¸ ì‚­ì œ í›„ ì €ì¥í•  IDê°€ ì—†ìŒ.");
            return;
        }

        if (tableContainer) {
            // âœ… ë¶ˆí•„ìš”í•œ setTimeout ì œê±° (ì¦‰ì‹œ ì €ì¥)
            saveTableToIndexedDB(id, tableContainer);
        } else {
            console.warn("âš ï¸ tableContainer ì°¾ì„ ìˆ˜ ì—†ìŒ");
        }
    } else {
        console.warn("âš ï¸ activeMarkerElementê°€ ì—†ìŒ");
    }
}

// âœ… ì…€ì„ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • + IME í•œê¸€ ì…ë ¥ ì²˜ë¦¬ (ì¤‘ë³µ ë°©ì§€)
function makeTableEditable(tableContainer) {
    let isComposing = false; // âœ… í•œê¸€ ì…ë ¥ ì¤‘ì¸ì§€ í™•ì¸
    let lastFocusedTd = null; // âœ… ë§ˆì§€ë§‰ìœ¼ë¡œ í¬ì»¤ìŠ¤ëœ ì…€ ì €ì¥

    tableContainer.querySelectorAll("td").forEach(td => {
        // âœ… ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        td.removeEventListener("click", handleTdClick);
        td.removeEventListener("compositionstart", handleCompositionStart);
        td.removeEventListener("compositionend", handleCompositionEnd);
        //td.removeEventListener("keydown", handleKeyDown);
        td.removeEventListener("blur", handleTdBlur);
        td.removeEventListener("paste", handlePaste);

        // âœ… ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ì¶”ê°€
        td.addEventListener("click", handleTdClick);
        td.addEventListener("compositionstart", handleCompositionStart);
        td.addEventListener("compositionend", handleCompositionEnd);
        //td.addEventListener("keydown", handleKeyDown);
        td.addEventListener("blur", handleTdBlur);
        td.addEventListener("paste", handlePaste);
    });

    // âœ… í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ì…€ì„ í´ë¦­í•˜ë©´ í¸ì§‘ ê°€ëŠ¥)
    function handleTdClick(event) {
		const td = event.target;
		td.setAttribute("contenteditable", "true");
		td.focus();
		lastFocusedTd = td;

		// âœ… ì»¤ì„œë¥¼ ì œì¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ì‹œí‚¤ê¸°
		const range = document.createRange();
		const selection = window.getSelection();

		range.selectNodeContents(td);
		range.collapse(false); // false â†’ ì»¤ì„œë¥¼ ëìœ¼ë¡œ ë³´ëƒ„
		selection.removeAllRanges();
		selection.addRange(range);
	}


    // âœ… í•œê¸€ ì…ë ¥ ì‹œì‘ (IME ì…ë ¥ ê°ì§€)
    function handleCompositionStart() {
        isComposing = true;
    }

    // âœ… í•œê¸€ ì…ë ¥ ì™„ë£Œ (í¬ì»¤ìŠ¤ ìœ ì§€ ì¤‘ì´ë©´ ì €ì¥ ì•ˆ í•¨)
    function handleCompositionEnd(event) {
    isComposing = false; // âœ… ì¡°í•© ì¢…ë£Œ í”Œë˜ê·¸
    setTimeout(() => {
        saveTableToIndexedDB(event.target.dataset.id, event.target.closest(".tableContainer"));
    }, 50);
}


    

    // âœ… í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ì €ì¥ (IME ì…ë ¥ ì¤‘ì´ë©´ ì €ì¥ ë°©ì§€)
    function handleTdBlur(event) {
        setTimeout(() => {
            if (isComposing) return; // âœ… IME ì…ë ¥ ì¤‘ì´ë©´ blur ì €ì¥ ë°©ì§€
            isComposing = false; // âœ… í¬ì»¤ìŠ¤ê°€ ì•„ì›ƒë˜ì—ˆì„ ë•Œ ì…ë ¥ ì¢…ë£Œ
            saveTableToIndexedDB(event.target.dataset.id, event.target.closest(".tableContainer"));
        }, 50);
    }

    // âœ… ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ (ë¶™ì—¬ë„£ê¸° í›„ ì¦‰ì‹œ ì €ì¥)
     function handlePaste(event) {
        event.preventDefault();
        let clipboardData = event.clipboardData || window.clipboardData;
        let pastedText = clipboardData.getData("text");

        if (!pastedText.includes("\t") && !pastedText.includes("\n")) {
            // âœ… ì¼ë°˜ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°
            document.execCommand("insertText", false, pastedText);
            return;
        }

        // âœ… ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— ë§ì¶° ì‚½ì…
        let rows = pastedText.split("\n").map(row => row.split("\t"));
        let startRow = parseInt(lastFocusedTd.dataset.row, 10);
        let startCol = parseInt(lastFocusedTd.dataset.col, 10);
        let table = lastFocusedTd.closest("table");

        rows.forEach((row, rowIndex) => {
            row.forEach((cellText, colIndex) => {
                let targetRow = startRow + rowIndex;
                let targetCol = startCol + colIndex;
                let targetCell = table.querySelector(`td[data-row="${targetRow}"][data-col="${targetCol}"]`);
                
                if (targetCell) {
                    targetCell.textContent = cellText.trim();
                }
            });
        });

        // âœ… ì €ì¥
        saveTableToIndexedDB(lastFocusedTd.dataset.id, lastFocusedTd.closest(".tableContainer"));
    }

/*
    // âœ… í…Œì´ë¸” ë„ˆë¹„ ì¡°ì •
    setTimeout(() => {
        adjustTableColumnWidths(tableContainer.querySelector("table"));
    }, 100);
*/    
    //enableArrowKeyNavigation(tableContainer);
    enableMultiCellSelection(tableContainer);
}



// âœ… í…Œì´ë¸”ì„ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ ì´ë²¤íŠ¸ ì¶”ê°€ (ë°©í–¥í‚¤ ì´ë™ í¬í•¨)
// âœ… í…Œì´ë¸” ì…€ì˜ ë„ˆë¹„ë¥¼ ë™ì ìœ¼ë¡œ ì¡°ì •í•˜ëŠ” í•¨ìˆ˜
// âœ… í…Œì´ë¸”ì˜ ê° ì—´ ë„ˆë¹„ë¥¼ ë™ì ìœ¼ë¡œ ì¡°ì •í•˜ëŠ” í•¨ìˆ˜
// âœ… í…Œì´ë¸”ì˜ ê° ì—´ ë„ˆë¹„ë¥¼ ë°ì´í„° ê¸¸ì´ì— ë§ê²Œ ì¡°ì •í•˜ëŠ” í•¨ìˆ˜
function adjustTableColumnWidths(table) {
    let colWidths = [];
    let totalWidth = 190; // âœ… í…Œì´ë¸” ì „ì²´ ë„ˆë¹„ (ê¸°ë³¸ê°’)
    let minWidth = 30;    // âœ… ìµœì†Œ ì—´ ë„ˆë¹„
    let maxWidth = 100;   // âœ… ìµœëŒ€ ì—´ ë„ˆë¹„

    // 1ï¸âƒ£ ê° ì—´ì˜ ìµœëŒ€ í…ìŠ¤íŠ¸ ê¸¸ì´ ê³„ì‚°
    table.querySelectorAll("tr").forEach(row => {
        row.querySelectorAll("td").forEach((cell, colIndex) => {
            let contentWidth = getTextWidth(cell.textContent.trim(), window.getComputedStyle(cell).font);
            colWidths[colIndex] = Math.max(colWidths[colIndex] || minWidth, contentWidth + 10); // ğŸ”¹ íŒ¨ë”© ì¶”ê°€
        });
    });

    // 2ï¸âƒ£ ê°€ì¥ ê¸´ ì—´ ì°¾ê¸°
    let totalContentWidth = colWidths.reduce((sum, w) => sum + w, 0);
    let scaleFactor = totalWidth / totalContentWidth;

    // 3ï¸âƒ£ ë¹„ìœ¨ì— ë§ì¶° ì—´ ë„ˆë¹„ ì¡°ì • (ìµœëŒ€ ë„ˆë¹„ ì œí•œ)
    colWidths = colWidths.map(w => Math.min(maxWidth, Math.max(minWidth, Math.floor(w * scaleFactor))));

    // 4ï¸âƒ£ ê° ì—´ì— ê³„ì‚°ëœ ë„ˆë¹„ ì ìš©
    table.querySelectorAll("tr").forEach(row => {
        row.querySelectorAll("td").forEach((cell, colIndex) => {
            cell.style.minWidth = colWidths[colIndex] + "px"; // âœ… ìµœì†Œ ë„ˆë¹„ ì ìš©
            cell.style.maxWidth = colWidths[colIndex] + "px"; // âœ… ìµœëŒ€ ë„ˆë¹„ ì ìš©
            cell.style.wordBreak = "break-word"; // âœ… í…ìŠ¤íŠ¸ê°€ ê¸¸ë©´ ìë™ ì¤„ë°”ê¿ˆ
        });
    });
}


// âœ… í…ìŠ¤íŠ¸ì˜ ì‹¤ì œ í”½ì…€ ë„ˆë¹„ë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
function getTextWidth(text, font) {
    let canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
    let context = canvas.getContext("2d");
    context.font = font || "12px Arial";
    return context.measureText(text).width;
}


// âœ… í˜„ì¬ ì„ íƒëœ ì…€ ëª©ë¡
let selectedCells = new Set();
let lastSelectedCell = null;

// âœ… ì…€ ì„ íƒ ê¸°ëŠ¥ (Shift í‚¤ ì§€ì›)
function enableMultiCellSelection(tableContainer) {
    let isMouseDown = false;

    // âœ… ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    document.removeEventListener("mouseup", handleMouseUp);
    //document.removeEventListener("keydown", handleKeyDown);
    document.removeEventListener("click", handleOutsideClick);

    // âœ… ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¬ë“±ë¡
    document.addEventListener("mouseup", handleMouseUp);
    //document.addEventListener("keydown", handleKeyDown);
    document.addEventListener("click", handleOutsideClick);

    tableContainer.querySelectorAll("td").forEach(td => {
        td.addEventListener("mousedown", function(event) {
            event.preventDefault();
            isMouseDown = true;

            if (event.shiftKey && lastSelectedCell) {
                selectRangeCells(lastSelectedCell, td, tableContainer);
            } else {
                clearSelectedCells();
                toggleCellSelection(td);
                lastSelectedCell = td;
            }
        });

        td.addEventListener("mouseover", function(event) {
            if (isMouseDown) {
                if (event.shiftKey && lastSelectedCell) {
                    selectRangeCells(lastSelectedCell, td, tableContainer);
                } else {
                    clearSelectedCells();
                    toggleCellSelection(td);
                }
            }
        });

        td.addEventListener("mouseup", function() {
            isMouseDown = false;
        });

        td.addEventListener("click", function(event) {
            event.stopPropagation();
        });
    });
}

// âœ… ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ì¤‘ë³µ ë°©ì§€)
function handleMouseUp() {
    isMouseDown = false;
}
function handleKeyDown(event) {
    const activeElement = document.activeElement;

	// âœ… case 2: ì§€ë„ ë§ˆì»¤ ì´ë™ìš© WASD

    if (activeMarker) {
        let position = activeMarker.getPosition();
        let lat = position.lat();
        let lng = position.lng();
        let step = 0.0004;

        switch (event.key) {
            case "w": case "ã…ˆ": lat += step; break;
            case "s": case "ã„´": lat -= step; break;
            case "a": case "ã…": lng -= step; break;
            case "d": case "ã…‡": lng += step; break;
            case "Escape":
                updateMarkerSelection(activeMarkerElement, false);
                activeMarker = null;
                activeMarkerElement = null;
                return;
            default:
                return;
        }

        let newPosition = new naver.maps.LatLng(lat, lng);
console.log(newPosition);
        activeMarker.setPosition(newPosition);
    }

    // âœ… case 1: í…Œì´ë¸” ì…€ ì•ˆì—ì„œ í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    if (activeElement && activeElement.tagName === "TD") {
        // IME í•œê¸€ ì…ë ¥ ì¤‘ì´ë©´ ë¬´ì‹œ
        if (window.isComposing) return;

        const tableContainer = activeElement.closest(".tableContainer");
        const currentRow = parseInt(activeElement.dataset.row, 10);
        const currentCol = parseInt(activeElement.dataset.col, 10);
        const table = tableContainer.querySelector("table");

        switch (event.key) {
            case "ArrowUp":
                event.preventDefault();
                moveToCell(table, currentRow - 1, currentCol);
                return;
            case "ArrowDown":
                event.preventDefault();
                moveToCell(table, currentRow + 1, currentCol);
                return;
            case "ArrowLeft":
                event.preventDefault();
                moveToCell(table, currentRow, currentCol - 1);
                console.log("ì™¼ìª½");
                return;
            case "ArrowRight":
                event.preventDefault();
                moveToCell(table, currentRow, currentCol + 1);
                console.log("ì˜¤ë¥¸ìª½");
                return;
            case "Delete":
            case "Backspace":
                if (selectedCells.size > 1) {
                    event.preventDefault();
                    deleteSelectedCells();
                }
                return;
        }

        // âœ… Ctrl+C ë˜ëŠ” Cmd+C ë³µì‚¬ ì²˜ë¦¬
        if ((event.ctrlKey || event.metaKey) && event.key === "c") {
            if (selectedCells.size > 0) {
                event.preventDefault();

                const cellsArray = Array.from(selectedCells);
                cellsArray.sort((a, b) => {
                    const rowA = parseInt(a.dataset.row, 10);
                    const rowB = parseInt(b.dataset.row, 10);
                    if (rowA !== rowB) return rowA - rowB;
                    return parseInt(a.dataset.col, 10) - parseInt(b.dataset.col, 10);
                });

                const maxRow = Math.max(...cellsArray.map(td => parseInt(td.dataset.row)));
                const minRow = Math.min(...cellsArray.map(td => parseInt(td.dataset.row)));
                const maxCol = Math.max(...cellsArray.map(td => parseInt(td.dataset.col)));
                const minCol = Math.min(...cellsArray.map(td => parseInt(td.dataset.col)));

                const rowCount = maxRow - minRow + 1;
                const colCount = maxCol - minCol + 1;
                const grid = Array.from({ length: rowCount }, () => Array(colCount).fill(""));

                cellsArray.forEach(td => {
                    const r = parseInt(td.dataset.row) - minRow;
                    const c = parseInt(td.dataset.col) - minCol;
                    grid[r][c] = td.textContent.trim();
                });

                const tsv = grid.map(row => row.join("\t")).join("\n");

                navigator.clipboard.writeText(tsv).then(() => {
                    console.log("âœ… ì…€ ë³µì‚¬ ì™„ë£Œ");
                }).catch(err => {
                    console.error("âŒ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:", err);
                });
            }
        }
    }

    
}



// âœ… ë§ˆì»¤ ì™¸ë¶€ í´ë¦­ ì‹œ ë¸”ë¡ í•´ì œ (ì¤‘ë³µ ë°©ì§€)
function handleOutsideClick(event) {
    if (!event.target.closest(".siseMapMarker")) {
        clearSelectedCells();
    }
}

function clearSelectedCells() {
    if (!selectedCells) return;
    selectedCells.forEach(cell => {
        cell.style.backgroundColor = ""; // âœ… ê¸°ì¡´ ì„ íƒ í•´ì œ
    });
    selectedCells.clear(); // âœ… Set ì´ˆê¸°í™”
}


// âœ… ë²”ìœ„ ì„ íƒ ê¸°ëŠ¥ (Shift í‚¤ ì‚¬ìš©)
function selectRangeCells(startCell, endCell, tableContainer) {
    let table = tableContainer.querySelector("table");
    let startRow = parseInt(startCell.dataset.row);
    let startCol = parseInt(startCell.dataset.col);
    let endRow = parseInt(endCell.dataset.row);
    let endCol = parseInt(endCell.dataset.col);

    let minRow = Math.min(startRow, endRow);
    let maxRow = Math.max(startRow, endRow);
    let minCol = Math.min(startCol, endCol);
    let maxCol = Math.max(startCol, endCol);

    selectedCells.clear();

    for (let row = minRow; row <= maxRow; row++) {
        for (let col = minCol; col <= maxCol; col++) {
            let targetCell = table.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
            if (targetCell) {
                selectedCells.add(targetCell);
                targetCell.style.backgroundColor = "#FFD700"; // âœ… ë…¸ë€ìƒ‰ ë¸”ë¡ í‘œì‹œ
            }
        }
    }
}

// âœ… ì…€ ì„ íƒ/í•´ì œ ê¸°ëŠ¥ (Shift ë¯¸ì‚¬ìš© ì‹œ ë‹¨ì¼ ì„ íƒ)
function toggleCellSelection(td) {
    if (selectedCells.has(td)) {
        selectedCells.delete(td);
        td.style.backgroundColor = ""; // âœ… ì„ íƒ í•´ì œ
    } else {
        selectedCells.add(td);
        td.style.backgroundColor = "#FFD700"; // âœ… ë…¸ë€ìƒ‰ ë¸”ë¡ ì§€ì •
    }
}


function enableArrowKeyNavigation(tableContainer) {
    const table = tableContainer.querySelector("table");
    if (!table) return;

    // âœ… ê¸°ì¡´ td ì´ë²¤íŠ¸ ì œê±°
    table.querySelectorAll("td").forEach(td => {
        td.removeEventListener("keydown", handleArrowKey); // ì¤‘ë³µ ì œê±°
        td.addEventListener("keydown", handleArrowKey);     // ìƒˆë¡œ ë“±ë¡
    });
}

function handleArrowKey(event) {
    const td = event.currentTarget;
    const currentRow = parseInt(td.dataset.row, 10);
    const currentCol = parseInt(td.dataset.col, 10);
    const table = td.closest("table");

    switch (event.key) {
        case "ArrowUp":
            event.preventDefault();
            moveToCell(table, currentRow - 1, currentCol);
            break;
        case "ArrowDown":
            event.preventDefault();
            moveToCell(table, currentRow + 1, currentCol);
            break;
        case "ArrowLeft":
            event.preventDefault();
            moveToCell(table, currentRow, currentCol - 1);
console.log("ì™¼ìª½");
            break;
        case "ArrowRight":
            event.preventDefault();
            moveToCell(table, currentRow, currentCol + 1);
console.log("ì˜¤ë¥¸ìª½");
            break;
        case "Delete":
        case "Backspace":
            if (selectedCells && selectedCells.size > 1) {
                event.preventDefault();
                deleteSelectedCells();
            }
            break;
    }
}
function moveToCell(table, row, col) {
    console.log("â¡ moveToCell í˜¸ì¶œ:", row, col);

    let maxRows = table.rows.length;
    let maxCols = table.rows[0].cells.length;

    if (row < 0 || row >= maxRows || col < 0 || col >= maxCols) {
        console.warn(`âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë™ ìœ„ì¹˜: row=${row}, col=${col}`);
        return;
    }

    let targetCell = table.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
    console.log("ğŸ¯ targetCell:", targetCell);

    if (targetCell) {
        targetCell.setAttribute("contenteditable", "true");
        setTimeout(() => {
            targetCell.focus();

            // âœ… ì»¤ì„œë¥¼ í…ìŠ¤íŠ¸ ëìœ¼ë¡œ ì´ë™
            const range = document.createRange();
            const selection = window.getSelection();
            range.selectNodeContents(targetCell);
            range.collapse(false); // ëìœ¼ë¡œ ì´ë™
            selection.removeAllRanges();
            selection.addRange(range);
        }, 10);
    }
}






function rgbToHex(rgb) {
    let rgbArray = rgb.match(/\d+/g);
    if (!rgbArray || rgbArray.length < 3) return "#000000"; // ê¸°ë³¸ê°’

    return `#${rgbArray
        .slice(0, 3)
        .map(x => parseInt(x).toString(16).padStart(2, "0"))
        .join("")}`.toUpperCase();
}

function showColorPickerModal(apartmentId, defaultColor, defaultTextColor, defaultFontSize, callback) {

    // âœ… ê¸°ì¡´ ëª¨ë‹¬ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    const existingModal = document.querySelector('.custom-modal-siseMap');
    if (existingModal) {
        document.body.removeChild(existingModal);
    }

    // âœ… RGB ìƒ‰ìƒì´ ë“¤ì–´ì˜¤ë©´ HEXë¡œ ë³€í™˜
    if (defaultColor.startsWith("rgb")) defaultColor = rgbToHex(defaultColor);
    if (defaultTextColor.startsWith("rgb")) defaultTextColor = rgbToHex(defaultTextColor);

    // âœ… ëª¨ë‹¬ ìƒì„±
    const modal = document.createElement('div');
    modal.className = 'custom-modal-siseMap';
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.backgroundColor = 'white';
    modal.style.border = '1px solid #ccc';
    modal.style.padding = '20px';
    modal.style.zIndex = '10000';
    modal.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
    modal.style.width = '300px';

    makeModalDraggable(modal);

    // âœ… ìƒ‰ìƒ ì„ íƒ ë¸”ë¡ ì¶”ê°€ (14ê°œ)
    const colorDiv = document.createElement('div');
    colorDiv.className = 'color-div';
    colorDiv.style.display = 'flex';
    colorDiv.style.flexWrap = 'wrap';
    colorDiv.style.marginTop = '10px';

    const colors = ['#000000', '#454648', '#474C4F', '#FF0000', '#FF6600', '#FFFF00', 
                    '#92D050', '#00B050', '#00B0F0', '#0070C0', '#000099', '#7030A0', 
                    '#CC3399', '#FF66CC'];

    colors.forEach(color => {
        const smallSquare = document.createElement('div');
        smallSquare.className = 'small-square';
        smallSquare.style.backgroundColor = color;
        smallSquare.style.width = '24px';
        smallSquare.style.height = '24px';
        smallSquare.style.margin = '2px';
        smallSquare.style.cursor = 'pointer';
        smallSquare.style.border = '1px solid #000';

        // âœ… ë¸”ë¡ í´ë¦­ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½
        smallSquare.onclick = () => {
            colorInput.value = color;
            colorPicker.value = color;
        };

        colorDiv.appendChild(smallSquare);
    });

    modal.appendChild(colorDiv);

    // âœ… ë°°ê²½ìƒ‰ ì„ íƒ (ì»¬ëŸ¬ ì„ íƒê¸° + ì§ì ‘ ì…ë ¥)
    const colorPickerWrapper = document.createElement('div');
    colorPickerWrapper.className = 'color-picker-wrapper';

    const colorPickerLabel = document.createElement('label');
    colorPickerLabel.textContent = 'ë°°ê²½ìƒ‰ : ';
    const colorPicker = document.createElement('input');
    colorPicker.type = 'color';
    colorPicker.value = defaultColor || '#1C32F7';

    const colorInput = document.createElement('input');
    colorInput.type = 'text';
    colorInput.className = 'color-input';
    colorInput.placeholder = 'ìƒ‰ìƒê°’ ì…ë ¥ #000000';
    colorInput.value = defaultColor || '#1C32F7';
    colorInput.style.width = '80px';
    colorInput.style.marginTop = '0px';

    colorPicker.oninput = () => {
        colorInput.value = colorPicker.value.toUpperCase();
    };

    colorPickerWrapper.appendChild(colorPickerLabel);
    colorPickerWrapper.appendChild(colorPicker);
    colorPickerWrapper.appendChild(colorInput);

    modal.appendChild(colorPickerWrapper);

    colorInput.addEventListener('input', () => {
        if (/^#[0-9A-F]{6}$/i.test(colorInput.value)) {
            colorPicker.value = colorInput.value.toUpperCase();
        }
    });

    // âœ… ê¸€ììƒ‰ ì„ íƒ (ì»¬ëŸ¬ ì„ íƒê¸° + ì§ì ‘ ì…ë ¥)
    const textColorPickerWrapper = document.createElement('div');
    textColorPickerWrapper.className = 'color-picker-wrapper';

    const textColorPickerLabel = document.createElement('label');
    textColorPickerLabel.textContent = 'ê¸€ììƒ‰ : ';
    const textColorPicker = document.createElement('input');
textColorPicker.type = 'color';
defaultTextColor = defaultTextColor?.trim() || '#FFFFFF'; // âœ… ê¸°ë³¸ê°’ ê°•ì œ ì ìš©
textColorPicker.value = defaultTextColor;


const textColorInput = document.createElement('input');
textColorInput.type = 'text';
textColorInput.className = 'color-input';
textColorInput.placeholder = 'ìƒ‰ìƒê°’ ì…ë ¥ #FFFFFF';
textColorInput.value = defaultTextColor;

    textColorInput.style.width = '80px';
    textColorInput.style.marginTop = '0px';

    textColorPicker.oninput = () => {
        textColorInput.value = textColorPicker.value.toUpperCase();
    };

    textColorInput.addEventListener('input', () => {
        if (/^#[0-9A-F]{6}$/i.test(textColorInput.value)) {
            textColorPicker.value = textColorInput.value.toUpperCase();
        }
    });

    textColorPickerWrapper.appendChild(textColorPickerLabel);
    textColorPickerWrapper.appendChild(textColorPicker);
    textColorPickerWrapper.appendChild(textColorInput);

    modal.appendChild(textColorPickerWrapper);

    // âœ… ê¸€ì í¬ê¸° ì¡°ì ˆ
    const fontSizeWrapper = document.createElement('div');
    fontSizeWrapper.className = 'font-size-wrapper';

    const fontSizeLabel = document.createElement('label');
    fontSizeLabel.textContent = 'ê¸€ì í¬ê¸° : ';
    const fontSizeInput = document.createElement('input');
    fontSizeInput.type = 'number';
    fontSizeInput.className = 'font-size-input';
    fontSizeInput.value = parseInt(defaultFontSize) || '13';
    fontSizeInput.style.width = '80px';

    fontSizeWrapper.appendChild(fontSizeLabel);
    fontSizeWrapper.appendChild(fontSizeInput);

    modal.appendChild(fontSizeWrapper);



const rowButtonContainer = document.createElement('div');
    rowButtonContainer.style.marginTop = '10px';


    // âœ… ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
    const buttonContainer = document.createElement('div');
    buttonContainer.style.marginTop = '10px';
    buttonContainer.style.textAlign = 'right';

    const saveButton = document.createElement('button');
    saveButton.textContent = ' í™•ì¸ ';
    saveButton.style.marginRight = '10px';
		saveButton.onclick = () => {
		updateMarkerStyleAndSave(apartmentId, colorInput.value, textColorInput.value, fontSizeInput.value + 'px');
		closePopup();
		document.body.removeChild(modal);
	};

 const addRowButton = document.createElement('button');
    addRowButton.textContent = 'í–‰ ì¶”ê°€';
    addRowButton.onclick = () => addRowToTable(apartmentId);
    rowButtonContainer.appendChild(addRowButton);

    const removeRowButton = document.createElement('button');
    removeRowButton.textContent = 'í–‰ ì œê±°';
    removeRowButton.onclick = () => removeRowFromTable(apartmentId);
    rowButtonContainer.appendChild(removeRowButton);

    modal.appendChild(rowButtonContainer);



const resetButton = document.createElement('button');
resetButton.textContent = ' ì´ˆê¸°í™” ';
resetButton.style.marginRight = '10px';
resetButton.onclick = () => {
    // âœ… IndexedDBì—ì„œ í•´ë‹¹ ë°ì´í„° ì‚­ì œ
    const request = indexedDB.open("hongbu", 2);
    request.onsuccess = function(event) {
        const db = event.target.result;
        const transaction = db.transaction(["apartments"], "readwrite");
        const store = transaction.objectStore("apartments");
        store.delete(`${apartmentId}-ì‹œì„¸1`);
        transaction.oncomplete = () => {
            console.log("âœ… ì´ˆê¸°í™” ì™„ë£Œ (IndexedDB ì‚­ì œë¨)");

            // âœ… ë§ˆì»¤ ìŠ¤íƒ€ì¼ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
            const markerElement = document.querySelector(`[data-apartment-id='${apartmentId}']`);
            if (markerElement) {
                markerElement.style.backgroundColor = "#9F9F9F";
                markerElement.style.color = "#ffffff";
                markerElement.style.fontSize = "12px";

                const tableContainer = markerElement.querySelector(".tableContainer");
                if (tableContainer) {
                    tableContainer.innerHTML = createEditableTableHTML(apartmentId, generateDefaultTable());
                    makeTableEditable(tableContainer);
                }
            }

            // âœ… ëª¨ë‹¬ ë‹«ê¸°
            closePopup();
            document.body.removeChild(modal);
        };
    };
};

buttonContainer.appendChild(resetButton);  // â¬… ì´ˆê¸°í™” ë²„íŠ¼ ë¨¼ì €
    buttonContainer.appendChild(saveButton);

    const cancelButton = document.createElement('button');
    cancelButton.textContent = ' ë‹«ê¸° ';
    cancelButton.onclick = () => {
        document.body.removeChild(modal);
        closePopup();
    };
    buttonContainer.appendChild(cancelButton);

    modal.appendChild(buttonContainer);

    // âœ… ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
    document.body.appendChild(modal);



}

function addRowToTable(apartmentId) {
    // í•´ë‹¹ apartmentIdì˜ í…Œì´ë¸”ì„ ì°¾ì•„ì„œ ìƒˆë¡œìš´ í–‰ ì¶”ê°€
    const tableContainer = document.querySelector(`[data-apartment-id='${apartmentId}'] .tableContainer`);
    if (tableContainer) {
        const table = tableContainer.querySelector("table");

        if (table) {
            const newRow = table.insertRow();
            // ê° ì…€ì— ê¸°ë³¸ê°’ ì¶”ê°€ (ì˜ˆ: ë¹ˆ í…ìŠ¤íŠ¸)
            for (let i = 0; i < table.rows[0].cells.length; i++) {
                const newCell = newRow.insertCell();
                newCell.textContent = ""; // ê¸°ë³¸ì ìœ¼ë¡œ ë¹ˆ í…ìŠ¤íŠ¸
                newCell.style.border = "1px solid black";
                newCell.style.padding = "0px";
                newCell.style.textAlign = "center";
				newCell.style.height = "24px";
            }
			saveTableToIndexedDB(apartmentId, tableContainer);
        }
    }
}

function removeRowFromTable(apartmentId) {
    // í•´ë‹¹ apartmentIdì˜ í…Œì´ë¸”ì„ ì°¾ì•„ì„œ ì„ íƒëœ í–‰ ì œê±°
    const tableContainer = document.querySelector(`[data-apartment-id='${apartmentId}'] .tableContainer`);
    if (tableContainer) {
        const table = tableContainer.querySelector("table");

        if (table && table.rows.length > 1) {
            // ë§ˆì§€ë§‰ í–‰ì„ ì‚­ì œ (ìµœì†Œ 1ê°œ í–‰ì´ ë‚¨ì•„ì•¼ í•˜ë¯€ë¡œ)
            table.deleteRow(table.rows.length - 1);
// âœ… ì‚­ì œ í›„ ë°”ë¡œ IndexedDBì— ì €ì¥
            saveTableToIndexedDB(apartmentId, tableContainer);
        }
    }
}

function parsePriceDataFromTable(tableContainer) {
    const rows = tableContainer.querySelectorAll("tr");
    const parsed = [];

    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length >= 3) {
            const í‰í˜• = cells[0].textContent.trim();
            const ë§¤ë§¤ = parseFloat(cells[1].textContent.trim());
            const ì „ì„¸ = parseFloat(cells[2].textContent.trim());

            if (!isNaN(ë§¤ë§¤) && !isNaN(ì „ì„¸)) {
                parsed.push({ í‰í˜•, ë§¤ë§¤, ì „ì„¸ });
            }
        }
    });

    return parsed;
}

function renderPriceChart(container, data) {
    const canvas = document.createElement("canvas");
    canvas.width = 200;
    canvas.height = data.length * 25 + 20; // í‰í˜• ìˆ˜ì— ë”°ë¼ ë†’ì´ ì¡°ì •
    canvas.style.margin = "5px";

    const ctx = canvas.getContext("2d");

    const maxPrice = Math.max(...data.flatMap(d => [d.ë§¤ë§¤, d.ì „ì„¸]));
    const barMaxWidth = 80;

    data.forEach((d, i) => {
        const y = i * 25 + 20;
        const label = d.í‰í˜•;
        ctx.fillStyle = "#000";
        ctx.font = "12px sans-serif";
        ctx.fillText(label, 0, y);

        const saleWidth = (d.ë§¤ë§¤ / maxPrice) * barMaxWidth;
        const leaseWidth = (d.ì „ì„¸ / maxPrice) * barMaxWidth;

        ctx.fillStyle = "#ff4d4d"; // ë¹¨ê°„ìƒ‰ ë§¤ë§¤
        ctx.fillRect(40, y - 10, saleWidth, 8);

        ctx.fillStyle = "#4d79ff"; // íŒŒë€ìƒ‰ ì „ì„¸
        ctx.fillRect(40, y, leaseWidth, 8);
    });

    container.appendChild(canvas);
}

async function exportToJSON() {
    try {
        const db = await initIndexedDB();
        const transaction = db.transaction(['apartments'], 'readonly');
        const store = transaction.objectStore('apartments');
        const request = store.getAll();

        request.onsuccess = async function(event) {
            const data = event.target.result;
            const jsonData = JSON.stringify(data, null, 2);

            // ğŸ’¾ ì €ì¥í•  íŒŒì¼ ì´ë¦„
            const now = new Date();
            const formattedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const formattedTime = `${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
            const defaultFilename = `í™ë¶€_ì‹œì„¸ì§€ë„_ë°±ì—…_${formattedDate}_${formattedTime}.json`;

            // âœ… showSaveFilePickerë¡œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ
            const handle = await window.showSaveFilePicker({
                suggestedName: defaultFilename,
                types: [
                    {
                        description: 'JSON Files',
                        accept: { 'application/json': ['.json'] }
                    }
                ]
            });

            const writable = await handle.createWritable();
            await writable.write(jsonData);
            await writable.close();

            console.log('âœ… ì €ì¥ ì™„ë£Œ:', handle.name);
        };

        request.onerror = function(event) {
            console.error('âŒ Export transaction error: ', event.target.errorCode);
        };
    } catch (error) {
        console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error);
    }
}


function importFromJSON(file) {
    const reader = new FileReader();
    reader.onload = function(event) {
        const data = JSON.parse(event.target.result);

        initIndexedDB().then(db => {
            const transaction = db.transaction(['apartments'], 'readwrite');
            const store = transaction.objectStore('apartments');

            data.forEach(item => {
                // âœ… ëˆ„ë½ëœ í•„ë“œ ë³´ì™„
                if (!item.type) item.type = 'ì‹œì„¸1';
                if (!item.idType) item.idType = `${item.id}-${item.type}`;
                store.put(item);
            });

            transaction.oncomplete = function() {
				alert('âœ… ì‹œì„¸ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');

				// â— ì‹œì„¸ì§€ë„ í™œì„±í™” ìƒíƒœì¼ ê²½ìš°, ë§ˆì»¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
				if (document.getElementById("toggleSiseMap").checked && window.map) {
					prevSiseMapState = "ì´ˆê¸°í™”";
					updateMarkers(window.map.getBounds());
				}
			};


            transaction.onerror = function(event) {
                console.error('âŒ Import transaction error:', event.target.errorCode);
            };
        }).catch(error => {
            console.error('âŒ Failed to initialize hongbu DB:', error);
        });
    };

    reader.readAsText(file);
}


/////////////////////////////////////////////////////////////////////////////////////////
let deletedImages = []; // ì‚­ì œëœ ì´ë¯¸ì§€ ëª©ë¡
function saveNote(id) {
  const memo = document.getElementById("noteText").value;
  const images = (aptMemoImageList && aptMemoImageList[id]) ? aptMemoImageList[id] : [];

  const request = indexedDB.open("hongbuMemo", 2);
  request.onsuccess = function (event) {
    const db = event.target.result;
    const transaction = db.transaction(["apartmentNotes"], "readwrite");
    const store = transaction.objectStore("apartmentNotes");

    const getRequest = store.get(id);
    getRequest.onsuccess = function () {
      let existing = getRequest.result || { id, memo: "", images: [] };

      existing.images = images;
      existing.memo = memo;

      store.put(existing);

      //alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      loadNote(id);

      // âœ… ë§ˆì»¤ ê°±ì‹  ì²˜ë¦¬
      const marker = apartmentMarkers[id];
      if (marker) {
        marker.setMap(null);  // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        delete apartmentMarkers[id];  // ìºì‹œ ì‚­ì œ

        const apartment = apartmentData.find(a => String(a.id) === String(id));
        if (apartment) {
          const isSiseMap = document.getElementById("toggleSiseMap")?.checked;
          const newMarker = isSiseMap
            ? renderSiseMapMarker(apartment)
            : createDefaultMarker(apartment);
          newMarker.__siseMap = isSiseMap;
          apartmentMarkers[id] = newMarker;
        }
      }
    };
  };
}




function base64ToBlobUrl(base64) {
    const byteString = atob(base64.split(',')[1]);
    const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    const blob = new Blob([ab], { type: mimeString });
    return URL.createObjectURL(blob);
}

function createCanvasThumbnail(blobUrl, base64, idx, onDelete) {
    const wrapper = document.createElement("div");
    wrapper.style.position = "relative";
    wrapper.style.display = "inline-block";
    wrapper.style.marginRight = "6px";
    wrapper.style.width = "60px";
    wrapper.style.height = "60px";

    const canvas = document.createElement("canvas");
    canvas.width = 60;
    canvas.height = 60;
    canvas.style.border = "1px solid #ccc";
    canvas.style.borderRadius = "4px";
    canvas.style.cursor = "pointer";
    canvas.title = `ì‚¬ì§„ ${idx + 1}`;

    const ctx = canvas.getContext("2d");
    const img = new Image();
    img.onload = () => {
        ctx.drawImage(img, 0, 0, 60, 60);
    };
    img.src = blobUrl;

    canvas.onclick = (e) => {
	  e.stopPropagation();

	  const modal = document.getElementById("imageModal");
	  const modalCanvas = document.getElementById("modalCanvas");
	  const ctx = modalCanvas.getContext("2d");

	  const img = new Image();
	  img.onload = () => {
		// ì´ë¯¸ì§€ í¬ê¸°ì— ë§ê²Œ ìº”ë²„ìŠ¤ ì¡°ì ˆ
		modalCanvas.width = img.width;
		modalCanvas.height = img.height;
		ctx.drawImage(img, 0, 0);
		modal.style.display = "flex";
		window.imageModalShowYn = true;
	  };
	  img.src = blobUrl;
	};


    const deleteBtn = document.createElement("div");
    deleteBtn.textContent = "âœ•";
    deleteBtn.style.position = "absolute";
    deleteBtn.style.top = "2px";
    deleteBtn.style.right = "2px";
    deleteBtn.style.background = "rgba(0,0,0,0.6)";
    deleteBtn.style.color = "white";
    deleteBtn.style.borderRadius = "50%";
    deleteBtn.style.width = "16px";
    deleteBtn.style.height = "16px";
    deleteBtn.style.display = "flex";
    deleteBtn.style.alignItems = "center";
    deleteBtn.style.justifyContent = "center";
    deleteBtn.style.cursor = "pointer";
    deleteBtn.style.fontSize = "12px";

    deleteBtn.onclick = (e) => {
        e.stopPropagation();
        if (confirm("ì‚¬ì§„ì„ ì‚­ì œí•©ë‹ˆë‹¤")) {
            onDelete(base64);
            wrapper.remove();
        }
    };

    wrapper.appendChild(canvas);
    wrapper.appendChild(deleteBtn);
    return wrapper;
}

function loadNote(id) {
  const request = indexedDB.open("hongbuMemo", 2);
  request.onsuccess = function (event) {
    const db = event.target.result;
    const transaction = db.transaction(["apartmentNotes"], "readonly");
    const store = transaction.objectStore("apartmentNotes");

    const getRequest = store.get(id);
    getRequest.onsuccess = function () {
      const result = getRequest.result;
      //if (!result) return;
	const noteEl = document.getElementById("noteText");
      const preview = document.getElementById("imagePreview");
    

 if (!result) {
        // âœ… ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° UI ì´ˆê¸°í™”
        if (noteEl) noteEl.value = "";
        if (preview) {
          preview.innerHTML = "";
          preview.style.display = "none";
        }
        aptMemoImageList[id] = [];
        return;
      }


  
preview.innerHTML = "";
      document.getElementById("noteText").value = result.memo || "";
	  if(result.images.length > 0){
		preview.style.display = "flex";
	 }
      aptMemoImageList[id] = result.images || [];

      
    

      for (const imageDataUrl of aptMemoImageList[id]) {
        const wrapper = document.createElement("div");
        wrapper.style.position = "relative";
        wrapper.style.display = "inline-block";
        wrapper.style.marginRight = "6px";
        wrapper.style.width = "60px";
        wrapper.style.height = "60px";

        const canvas = document.createElement("canvas");
        canvas.width = 60;
        canvas.height = 60;
        canvas.style.border = "1px solid #ccc";
        canvas.style.borderRadius = "4px";
        canvas.style.cursor = "pointer";
        canvas.title = "ë¯¸ë¦¬ë³´ê¸°";

        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.onload = () => {
          ctx.drawImage(img, 0, 0, 60, 60);
        };
        img.src = imageDataUrl;

       canvas.onclick = (e) => {
  e.stopPropagation();
  const modal = document.getElementById("imageModal");
  const modalCanvas = document.getElementById("modalCanvas");
  const modalCtx = modalCanvas.getContext("2d");

  const fullImage = new Image();
  fullImage.onload = () => {
    modalCanvas.width = fullImage.width;
    modalCanvas.height = fullImage.height;
    modalCtx.drawImage(fullImage, 0, 0);
    modal.style.display = "flex";
    window.imageModalShowYn = true;
  };
  fullImage.src = img.src; // âœ… ì¸ë„¤ì¼ ì´ë¯¸ì§€ ë§ê³  ì›ë³¸ìœ¼ë¡œ ìƒˆë¡œ ë¡œë“œ
};


        const deleteBtn = document.createElement("div");
        deleteBtn.textContent = "âœ•";
        deleteBtn.style.position = "absolute";
        deleteBtn.style.top = "2px";
        deleteBtn.style.right = "2px";
        deleteBtn.style.background = "rgba(0,0,0,0.6)";
        deleteBtn.style.color = "white";
        deleteBtn.style.borderRadius = "50%";
        deleteBtn.style.width = "16px";
        deleteBtn.style.height = "16px";
        deleteBtn.style.display = "flex";
        deleteBtn.style.alignItems = "center";
        deleteBtn.style.justifyContent = "center";
        deleteBtn.style.cursor = "pointer";
        deleteBtn.style.fontSize = "12px";

        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm("ì‚¬ì§„ì„ ì‚­ì œí•©ë‹ˆë‹¤")) {
            aptMemoImageList[id] = aptMemoImageList[id].filter(img => img !== imageDataUrl);
            wrapper.remove();
          }
        };

        wrapper.appendChild(canvas);
        wrapper.appendChild(deleteBtn);
        preview.appendChild(wrapper);
      }
    };
  };
}




// âœ… ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ë„ ë“±ë¡
document.getElementById("imageModal").addEventListener("click", () => {
    document.getElementById("imageModal").style.display = "none";
	imageModalShowYn = true;
});


function showImageModal(src) {
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImage");
    modalImg.src = src;
    modal.style.display = "flex";
}

// âœ… ë©”ëª¨ ë°±ì—…
function backupMemoDB() {
    const request = indexedDB.open("hongbuMemo", 2);
    request.onsuccess = function (event) {
        const db = event.target.result;
        const transaction = db.transaction(["apartmentNotes"], "readonly");
        const store = transaction.objectStore("apartmentNotes");

        const allData = [];
        store.openCursor().onsuccess = function (event) {
            const cursor = event.target.result;
            if (cursor) {
                allData.push(cursor.value);
                cursor.continue();
            } else {
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `í™ë¶€_ë©”ëª¨ë°±ì—…_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };
    };
}

// âœ… ë©”ëª¨ ë³µì›
function restoreMemoDB() {
    document.getElementById("memoRestoreInput").click();

    document.getElementById("memoRestoreInput").onchange = function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
            try {
                const jsonData = JSON.parse(event.target.result);
                if (!Array.isArray(jsonData)) {
                    alert("ìœ íš¨í•˜ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.");
                    return;
                }

                const request = indexedDB.open("hongbuMemo", 2);
                request.onsuccess = function (event) {
                    const db = event.target.result;
                    const transaction = db.transaction(["apartmentNotes"], "readwrite");
                    const store = transaction.objectStore("apartmentNotes");

                    jsonData.forEach(entry => store.put(entry));
                    alert("ë©”ëª¨ ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                };
            } catch (err) {
                alert("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: " + err.message);
            }
        };
        reader.readAsText(file);
    };
}

document.getElementById("copyImageButton").onclick = async () => {
  const canvas = document.getElementById("modalCanvas");

  canvas.toBlob(async (blob) => {
    try {
      await navigator.clipboard.write([
        new ClipboardItem({ "image/png": blob })
      ]);
      //alert("ì´ë¯¸ì§€ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!");
    } catch (err) {
      console.error("ì´ë¯¸ì§€ ë³µì‚¬ ì‹¤íŒ¨:", err);
      alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }
  }, "image/png");
};

function deleteMemoDB() {
  const confirmDelete = confirm("âš ï¸ ëª¨ë“  ë©”ëª¨ì™€ ì´ë¯¸ì§€ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
  if (!confirmDelete) return;

  const deleteRequest = indexedDB.deleteDatabase("hongbuMemo");
  deleteRequest.onsuccess = () => {
    alert("âœ… ë©”ëª¨ DBê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
    location.reload();
  };
  deleteRequest.onerror = (event) => {
    console.error("âŒ DB ì‚­ì œ ì‹¤íŒ¨:", event.target.error);
    //alert("âŒ ë©”ëª¨ DB ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");328
  };
}

function deleteNote(id) {
  if (!confirm("ì •ë§ ì´ ë©”ëª¨ì™€ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  const request = indexedDB.open("hongbuMemo", 2);
  request.onsuccess = function (event) {
    const db = event.target.result;
    const transaction = db.transaction(["apartmentNotes"], "readwrite");
    const store = transaction.objectStore("apartmentNotes");

    const deleteRequest = store.delete(id);
    deleteRequest.onsuccess = function () {
      //alert("í•´ë‹¹ ì•„íŒŒíŠ¸ ë©”ëª¨ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      loadNote(id);
    };
  };
}
function getMemoFromIndexedDB(id) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open("hongbuMemo", 2);
        request.onerror = () => reject("DB ì—´ê¸° ì‹¤íŒ¨");
        request.onsuccess = (event) => {
            const db = event.target.result;
            const transaction = db.transaction(["apartmentNotes"], "readonly"); // âœ… ì •í™•í•œ store ì´ë¦„
            const store = transaction.objectStore("apartmentNotes");
            const getRequest = store.get(String(id));
            getRequest.onsuccess = () => resolve(getRequest.result);
            getRequest.onerror = () => reject("ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨");
        };
    });
}


</script>





</body>
</html>
