<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì „êµ­ ì•„íŒŒíŠ¸ ë‹¨ì§€ ëŒ€ì‹œë³´ë“œ (ëª¨ë°”ì¼/ì—‘ì…€ ë°˜ì˜ ìµœì¢…)</title>

<!-- SheetJS (XLSX) for real Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0b0f17; --card:#121826; --muted:#93a4bf; --text:#e6eefc; --accent:#60a5fa;
    --border: rgba(255,255,255,.08);
    /* 1080p ê¸°ì¤€ ë‚´ë¶€ ìŠ¤í¬ë¡¤ìš© ë†’ì´ */
    --pane-h: 72vh;         /* ì¢Œ/ìš° í…Œì´ë¸” ë³¸ì²´ ë†’ì´ */
    --right-pager-h: 46px;  /* ìš°ì¸¡ í•˜ë‹¨ í˜ì´ì € ë†’ì´ */
  }
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b1020,#0b0f17);
    color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    overflow:hidden; /* ë°ìŠ¤í¬í†±: í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì—†ìŒ(ë‚´ë¶€ ìŠ¤í¬ë¡¤) */
  }
  .wrap{display:grid; grid-template-rows:auto 1fr; min-height:100vh; gap:14px; padding:16px;}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  header h1{margin:0; font-size:22px; font-weight:700}
  header .meta{font-size:12px; color:var(--muted)}
  .panes{display:grid; grid-template-columns:320px 1fr; gap:14px; min-height:0; height:calc(100vh - 96px);}
  .card{
    background:rgba(18,24,38,.82); border:1px solid var(--border); border-radius:16px;
    backdrop-filter: blur(6px); box-shadow:0 10px 30px rgba(0,0,0,.25);
    min-height:0; display:flex; flex-direction:column; overflow:hidden;
  }
  .card header{padding:10px 14px; border-bottom:1px solid var(--border)}
  .card header h2{margin:0; font-size:15px}
  .card .body{
    padding:10px; min-height:0; display:flex; flex-direction:column; gap:8px; height:100%;
  }
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  input[type="text"], input[type="number"], select{
    background:#0c1220; color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:8px 10px; outline:none;
  }
  label.ck{display:flex; gap:6px; align-items:center; font-size:13px; color:#cfe6ff;}
  .pill{border:1px solid var(--border); padding:6px 10px; border-radius:999px;
    font-size:12px; color:var(--muted);}
  .legend{font-size:12px; color:var(--muted)}
  .table-wrap{
    border:1px solid var(--border); border-radius:10px; overflow:auto; background:#0c1220;
  }
  table{border-collapse:separate; border-spacing:0; width:100%; font-size:13px;}
  thead th{
    position:sticky; top:0; background:#101828; color:#cfe6ff; z-index:1;
    text-align:left; padding:8px 10px; border-bottom:1px solid var(--border); white-space:nowrap;
  }
  tbody td{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.04)}
  tbody tr:hover{background:rgba(96,165,250,.08)}
  /* ì™¼ìª½ í‘œ */
  .left-wrap{height:var(--pane-h)}
  .left-wrap table{min-width:auto; table-layout:auto; width:100%}
  .left-wrap thead th:nth-child(1){width:38%}
  .left-wrap thead th:nth-child(2){width:42%}
  .left-wrap thead th:nth-child(3){width:20%; text-align:right;}
  .left-wrap td:last-child{text-align:right;}
  /* ì˜¤ë¥¸ìª½ í‘œ: ë³¸ë¬¸ ë‚´ ìŠ¤í¬ë¡¤ (í˜ì´ì € ë†’ì´ ê°ì•ˆ) */
  .right-wrap{height:calc(var(--pane-h) - var(--right-pager-h))}
  .count-badge{background:rgba(96,165,250,.15); color:#cfe6ff;
    padding:2px 8px; border-radius:999px; font-size:11px;
    border:1px solid rgba(96,165,250,.35);}
  #pager{display:flex; gap:6px; align-items:center; margin:4px 0 0 0; padding:0; height:var(--right-pager-h)}
  #pageSize{height:32px}
  .unit-btn, .download-btn {
    background:rgba(96,165,250,.15);
    color:#cfe6ff;
    border:1px solid rgba(96,165,250,.35);
    border-radius:8px;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
    transition:all .2s;
  }
  .unit-btn:hover, .download-btn:hover { background:rgba(96,165,250,.25); }

  /* ëª¨ë°”ì¼ ìµœì í™”: ì¢Œ/ìš° â†’ ìƒ/í•˜, ì™¼ìª½ì¹´ë“œ ë†’ì´ ì œí•œ(ì˜¤ë¥¸ìª½ì´ ì‚´ì§ ë³´ì´ê²Œ) */
  @media (max-width:1024px){
    html, body { height:auto; }
    body { overflow:auto; } /* ëª¨ë°”ì¼ì—ì„œ í˜ì´ì§€ ìŠ¤í¬ë¡¤ í—ˆìš© */

    .panes{
      grid-template-columns:1fr;
      grid-template-rows:auto auto;
      height:auto;
    }

    /* ì™¼ìª½ ì¹´ë“œ ì „ì²´ì— í™”ë©´ë³´ë‹¤ ì‚´ì§ ì‘ê²Œ ìµœëŒ€ ë†’ì´ ì ìš© */
    #leftCard{
      max-height:calc(100dvh - 120px) !important; /* í•„ìš”í•˜ë©´ 90~160pxë¡œ íŠœë‹ */
      overflow:hidden;
    }
    #leftCard .body{
      display:flex; flex-direction:column; height:100%; min-height:0;
    }
    #leftCard .left-wrap{
      flex:1 1 auto; min-height:0; overflow:auto; overscroll-behavior:contain;
    }

    .right-wrap{
      margin-top:12px;
      height:auto; max-height:none; /* ì•„ë˜ ê·¸ë¦¬ë“œëŠ” ë³¸ë¬¸ ìŠ¤í¬ë¡¤ë¡œ ì ‘ê·¼ */
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ì „êµ­ ì•„íŒŒíŠ¸ ë‹¨ì§€ ëŒ€ì‹œë³´ë“œ</h1>
        <div class="meta">ì¢Œ: ë™ì  ë‹¨ì§€ìˆ˜(í•„í„° ë°˜ì˜) Â· ìš°: ìƒì„¸ ë°ì´í„°</div>
      </div>
      <div class="toolbar"><span class="pill" id="summaryMeta">ë°ì´í„° ë¡œë”©ì¤‘â€¦</span></div>
    </header>

    <div class="panes">
      <!-- LEFT: Dynamic counts with filters -->
      <section class="card" id="leftCard">
        <header><h2>ì‹œêµ°êµ¬ë³„ ë‹¨ì§€ìˆ˜</h2></header>
        <div class="body">
          <div class="toolbar">
            <input id="leftSearch" type="text" placeholder="ê²€ìƒ‰: ì‹œë„ëª…/ì‹œêµ°êµ¬" />
          </div>
          <div class="toolbar">
            <label class="ck"><input type="checkbox" id="ckSale" />ì•„íŒŒíŠ¸ë¶„ì–‘ê¶Œ í¬í•¨</label>
            <label class="ck">ì„¸ëŒ€ìˆ˜(ì´ìƒ)
              <input id="minUnits" type="number" min="0" step="10" value="200" style="width:60px; text-align:right;" />
              <button class="unit-btn" data-val="200">200</button>
              <button class="unit-btn" data-val="300">300</button>
            </label>
          </div>
          <div class="toolbar">
            <label class="ck">ì „ìš©ë©´ì 
              <input id="areaFrom" type="number" min="0" step="1" placeholder="from" style="width:70px" /> ~
              <input id="areaTo" type="number" min="0" step="1" placeholder="to" style="width:70px" /> ã¡
            </label>
          </div>
          <div class="legend">í–‰ í´ë¦­ â†’ ìš°ì¸¡ ìƒì„¸ í•„í„°ë§ (ë‹¨ì§€ì½”ë“œ ì¤‘ë³µ ì œê±° í›„ ì¹´ìš´íŠ¸)</div>
          <div class="table-wrap left-wrap">
            <table id="leftTable">
              <thead>
                <tr>
                  <th>ì‹œë„ëª…</th>
                  <th>ì‹œêµ°êµ¬</th>
                  <th id="sortByCount" style="cursor:pointer;">ë‹¨ì§€ìˆ˜</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- RIGHT: Details -->
      <section class="card">
        <header><h2>ìƒì„¸ ë°ì´í„°</h2></header>
        <div class="body">
          <div class="toolbar">
            <input id="detailSearch" type="text" placeholder="ììœ  ê²€ìƒ‰ (ëª¨ë“  ì»¬ëŸ¼ ë˜ëŠ” ì„ íƒ ì»¬ëŸ¼)" />
            <select id="colSelect">
              <option value="">ëª¨ë“  ì»¬ëŸ¼ì—ì„œ ê²€ìƒ‰</option>
              <option>ì‹œë„ëª…</option><option>ì‹œêµ°êµ¬</option><option>ìë©´ë™</option><option>ìœ í˜•</option>
              <option>ë‹¨ì§€ì½”ë“œ</option><option>ë‹¨ì§€ëª…</option><option>ì‚¬ìš©ìŠ¹ì¸ì¼</option><option>ì´ì„¸ëŒ€ìˆ˜</option><option>ì „ìš©ë©´ì </option>
            </select>
            <span id="filterBadge" class="count-badge" style="display:none;"></span>
          </div>
          <div class="table-wrap right-wrap">
            <table id="detailTable">
              <thead><tr>
                <th>ì‹œë„ëª…</th><th>ì‹œêµ°êµ¬</th><th>ìë©´ë™</th><th>ìœ í˜•</th>
                <th>ë‹¨ì§€ì½”ë“œ</th><th>ë‹¨ì§€ëª…</th><th>ì‚¬ìš©ìŠ¹ì¸ì¼</th><th>ì´ì„¸ëŒ€ìˆ˜</th><th>ì „ìš©ë©´ì </th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="pager">
            <button id="prevBtn">ì´ì „</button>
            <span id="pageInfo" class="pill">-</span>
            <button id="nextBtn">ë‹¤ìŒ</button>
            <span style="flex:1"></span>
            <button id="downloadBtn" class="download-btn">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
  // DOM refs
  const leftTbody   = document.querySelector('#leftTable tbody');
  const detailTbody = document.querySelector('#detailTable tbody');
  const leftSearch  = document.getElementById('leftSearch');
  const detailSearch= document.getElementById('detailSearch');
  const colSelect   = document.getElementById('colSelect');
  const filterBadge = document.getElementById('filterBadge');
  const summaryMeta = document.getElementById('summaryMeta');
  const prevBtn     = document.getElementById('prevBtn');
  const nextBtn     = document.getElementById('nextBtn');
  const pageInfo    = document.getElementById('pageInfo');
  const ckSale      = document.getElementById('ckSale');
  const minUnitsInp = document.getElementById('minUnits');
  const areaFromInp = document.getElementById('areaFrom');
  const areaToInp   = document.getElementById('areaTo');
  const sortByCountTh = document.getElementById('sortByCount');
  const downloadBtn = document.getElementById('downloadBtn');

  // State
  let apartments = [];           // ì›ë³¸ í–‰(ë©´ì ë³„ ì¤‘ë³µ í¬í•¨)
  let complexes  = [];           // ë‹¨ì§€ ë‹¨ìœ„ ìš”ì•½(ì„¸ëŒ€ìˆ˜ ìµœëŒ€, ë©´ì  ë¦¬ìŠ¤íŠ¸, ë¶„ì–‘ê¶Œ ì¡´ì¬ ì—¬ë¶€)
  let sggCounts  = [];           // ë™ì  ê³„ì‚°ëœ ì‹œêµ°êµ¬ë³„ ë‹¨ì§€ìˆ˜
  let filteredDetail = [];       // ìš°ì¸¡ í‘œì‹œìš© ë°ì´í„°
  let currentPage = 1;
  let pageSize   = 100;
  let selectedSido = "", selectedSgg = ""; // ì¢Œì¸¡ ì„ íƒ
  let sortDir = null;            // null=ê¸°ë³¸, 'asc', 'desc' (ì¢Œì¸¡ ë‹¨ì§€ìˆ˜ ì •ë ¬ ìƒíƒœ)

  // Utils
  function fmt(n){ try{ return new Intl.NumberFormat('ko-KR').format(n ?? 0); }catch(e){ return n; } }
  function toNum(val){
    if(val===null || val===undefined || val==='') return NaN;
    const s = String(val).replace(/,/g,'').trim();
    const num = Number(s);
    return Number.isFinite(num) ? num : NaN;
  }

  // 1) ë‹¨ì§€ ë‹¨ìœ„ ìš”ì•½ ìƒì„±
  function buildComplexes(rows){
    const map = new Map(); // key: ë‹¨ì§€ì½”ë“œ
    for(const r of rows){
      const code = r['ë‹¨ì§€ì½”ë“œ'];
      if(!code) continue;
      const key = String(code);
      const units = toNum(r['ì´ì„¸ëŒ€ìˆ˜']);
      const area  = toNum(r['ì „ìš©ë©´ì ']);
      const type  = String(r['ìœ í˜•'] || '');

      if(!map.has(key)){
        map.set(key, {
          ë‹¨ì§€ì½”ë“œ: key,
          ì‹œë„ëª…: r['ì‹œë„ëª…'] || '',
          ì‹œêµ°êµ¬: r['ì‹œêµ°êµ¬'] || '',
          ì´ì„¸ëŒ€ìˆ˜: Number.isFinite(units) ? units : NaN,
          ë©´ì ëª©ë¡: Number.isFinite(area) ? [area] : [],
          ë¶„ì–‘ê¶Œ: type.includes('ì•„íŒŒíŠ¸ë¶„ì–‘ê¶Œ'),
        });
      }else{
        const ex = map.get(key);
        if(Number.isFinite(units)){
          ex.ì´ì„¸ëŒ€ìˆ˜ = Number.isFinite(ex.ì´ì„¸ëŒ€ìˆ˜) ? Math.max(ex.ì´ì„¸ëŒ€ìˆ˜, units) : units;
        }
        if(Number.isFinite(area)) ex.ë©´ì ëª©ë¡.push(area);
        if(type.includes('ì•„íŒŒíŠ¸ë¶„ì–‘ê¶Œ')) ex.ë¶„ì–‘ê¶Œ = true;
      }
    }
    complexes = Array.from(map.values());
  }

  // ë©´ì  ë²”ìœ„ ë§Œì¡± ì—¬ë¶€ (ë¹„ì–´ìˆìœ¼ë©´ ë¯¸ì ìš©)
  function complexAreaOk(ex, hasMin, min, hasMax, max){
    if(!hasMin && !hasMax) return true;        // í•„í„° ë¯¸ì ìš©
    if(!ex.ë©´ì ëª©ë¡.length) return false;      // í•„í„° í™œì„± ì‹œ ë©´ì ì •ë³´ ì—†ìœ¼ë©´ ì œì™¸
    for(const a of ex.ë©´ì ëª©ë¡){
      if(hasMin && a < min) continue;
      if(hasMax && a > max) continue;
      return true;
    }
    return false;
  }

  // 2) ë™ì  ì¹´ìš´íŠ¸ ê³„ì‚° (+ ì™¼ìª½ ê²€ìƒ‰ ë°˜ì˜)
  function computeSggCounts(){
    const includeSale = ckSale.checked;
    const minUnits = toNum(minUnitsInp.value) || 0;

    const minArea = toNum(areaFromInp.value);
    const maxArea = toNum(areaToInp.value);
    const hasMin = Number.isFinite(minArea);
    const hasMax = Number.isFinite(maxArea);

    const filteredComplexes = complexes.filter(c => {
      if(!includeSale && c.ë¶„ì–‘ê¶Œ) return false;
      if(!Number.isFinite(c.ì´ì„¸ëŒ€ìˆ˜) || c.ì´ì„¸ëŒ€ìˆ˜ < minUnits) return false;
      if(!complexAreaOk(c, hasMin, minArea, hasMax, maxArea)) return false;
      return true;
    });

    const map = new Map(); // key: ì‹œë„||ì‹œêµ°êµ¬
    for(const c of filteredComplexes){
      const gkey = `${c.ì‹œë„ëª…||''}||${c.ì‹œêµ°êµ¬||''}`;
      map.set(gkey, (map.get(gkey)||0)+1);
    }
    sggCounts = Array.from(map.entries()).map(([k,cnt])=>{
      const [sido, sgg] = k.split('||');
      return {ì‹œë„ëª…:sido, ì‹œêµ°êµ¬:sgg, ë‹¨ì§€ìˆ˜:cnt};
    });

    // ì •ë ¬ ìœ ì§€
    if(sortDir === 'asc'){
      sggCounts.sort((a,b)=> a.ë‹¨ì§€ìˆ˜ - b.ë‹¨ì§€ìˆ˜);
    }else if(sortDir === 'desc'){
      sggCounts.sort((a,b)=> b.ë‹¨ì§€ìˆ˜ - a.ë‹¨ì§€ìˆ˜);
    }else{
      sggCounts.sort((a,b)=> a.ì‹œë„ëª….localeCompare(b.ì‹œë„ëª…) || a.ì‹œêµ°êµ¬.localeCompare(b.ì‹œêµ°êµ¬));
    }

    // ğŸ” ì™¼ìª½ ê²€ìƒ‰ì–´ ì ìš© (ì‹œë„ëª…/ì‹œêµ°êµ¬)
    const q = (leftSearch.value || '').trim().toLowerCase();
    if(q){
      sggCounts = sggCounts.filter(r =>
        String(r['ì‹œë„ëª…']||'').toLowerCase().includes(q) ||
        String(r['ì‹œêµ°êµ¬']||'').toLowerCase().includes(q)
      );
    }

    // í—¤ë” ì•„ì´ì½˜ í‘œì‹œ
    if(sortDir==='asc') sortByCountTh.textContent = 'ë‹¨ì§€ìˆ˜ â–²';
    else if(sortDir==='desc') sortByCountTh.textContent = 'ë‹¨ì§€ìˆ˜ â–¼';
    else sortByCountTh.textContent = 'ë‹¨ì§€ìˆ˜';
  }

  // 3) ì¢Œì¸¡ ë Œë”
  function renderLeft(){
    leftTbody.innerHTML = '';
    for(const r of sggCounts){
      const tr = document.createElement('tr');
      const sggTxt = r['ì‹œêµ°êµ¬'] || '(ì—†ìŒ)';
      tr.innerHTML = `<td>${r['ì‹œë„ëª…']||''}</td><td>${sggTxt}</td><td style="text-align:right">${fmt(r['ë‹¨ì§€ìˆ˜'])}</td>`;
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', ()=>{
        selectedSido = r['ì‹œë„ëª…'] || '';
        selectedSgg  = r['ì‹œêµ°êµ¬'] || '';
        applyDetailFilter();
      });
      leftTbody.appendChild(tr);
    }
  }

  // 4) í˜ì´ì§•/ìƒì„¸
  function paginate(rows){
    const total = rows.length;
    const maxPage = Math.max(1, Math.ceil(total / pageSize));
    if(currentPage > maxPage) currentPage = maxPage;
    const start = (currentPage - 1) * pageSize;
    const slice = rows.slice(start, start + pageSize);
    pageInfo.textContent = `${fmt(currentPage)} / ${fmt(maxPage)} Â· ì´ ${fmt(total)} í–‰`;
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= maxPage;
    return slice;
  }
  function renderDetail(rows){
    detailTbody.innerHTML = '';
    for(const r of paginate(rows)){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r['ì‹œë„ëª…']||''}</td>
        <td>${r['ì‹œêµ°êµ¬']||''}</td>
        <td>${r['ìë©´ë™']||''}</td>
        <td>${r['ìœ í˜•']||''}</td>
        <td>${r['ë‹¨ì§€ì½”ë“œ']||''}</td>
        <td>${r['ë‹¨ì§€ëª…']||''}</td>
        <td>${r['ì‚¬ìš©ìŠ¹ì¸ì¼']||''}</td>
        <td style="text-align:right">${fmt(r['ì´ì„¸ëŒ€ìˆ˜'])}</td>
        <td style="text-align:right">${r['ì „ìš©ë©´ì ']||''}</td>
      `;
      detailTbody.appendChild(tr);
    }
  }

  // 5) ì¢Œì¸¡ ì„ íƒì„ ìš°ì¸¡ ìƒì„¸ì— ë°˜ì˜ (í˜„ì¬ í•„í„° ê¸°ì¤€)
  function applyDetailFilter(){
    const includeSale = ckSale.checked;
    const minUnits = toNum(minUnitsInp.value) || 0;

    const minArea = toNum(areaFromInp.value);
    const maxArea = toNum(areaToInp.value);
    const hasMin = Number.isFinite(minArea);
    const hasMax = Number.isFinite(maxArea);

    const complexOk = new Set();
    for(const c of complexes){
      if(!includeSale && c.ë¶„ì–‘ê¶Œ) continue;
      if(!Number.isFinite(c.ì´ì„¸ëŒ€ìˆ˜) || c.ì´ì„¸ëŒ€ìˆ˜ < minUnits) continue;
      if(!complexAreaOk(c, hasMin, minArea, hasMax, maxArea)) continue;
      if(selectedSido && (c.ì‹œë„ëª… || '') !== selectedSido) continue;
      if((selectedSgg ?? '') !== '' && (c.ì‹œêµ°êµ¬ || '') !== selectedSgg) continue;
      complexOk.add(c.ë‹¨ì§€ì½”ë“œ);
    }

    // ìš°ì¸¡ ìƒì„¸ëŠ” "í–‰ ë‹¨ìœ„"ë¡œë„ ë©´ì  ë²”ìœ„ë¥¼ ì ìš©í•´ ë³´ì—¬ì¤Œ
    filteredDetail = apartments.filter(r => {
      const ok = complexOk.has(String(r['ë‹¨ì§€ì½”ë“œ']||''));
      if(!ok) return false;

      const a = toNum(r['ì „ìš©ë©´ì ']);
      if(!hasMin && !hasMax) return true;               // ë©´ì  í•„í„° ë¯¸ì ìš©
      if(!Number.isFinite(a)) return false;             // í•„í„° í™œì„± ì‹œ ë©´ì ì •ë³´ ì—†ìœ¼ë©´ ì œì™¸
      if(hasMin && a < minArea) return false;
      if(hasMax && a > maxArea) return false;
      return true;
    });

    currentPage = 1;
    renderDetail(filteredDetail);

    const sggLabel = (selectedSgg ?? '') === '' ? '(ì—†ìŒ)' : selectedSgg;
    filterBadge.textContent = `${selectedSido || ''} ${sggLabel} Â· í–‰ ${fmt(filteredDetail.length)}ê°œ`;
    filterBadge.style.display = '';
  }

  // 6) ì˜¤ë¥¸ìª½ ììœ  ê²€ìƒ‰(ëª¨ë“  ì—´)
  function doDetailSearch(){
    const q = (detailSearch.value || '').trim().toLowerCase();
    const field = colSelect.value;
    const target = filteredDetail.length ? filteredDetail : apartments;
    if(!q){
      currentPage = 1;
      renderDetail(target);
      filterBadge.style.display = filteredDetail.length ? '' : 'none';
      return;
    }
    const keys = field ? [field] :
      ['ì‹œë„ëª…','ì‹œêµ°êµ¬','ìë©´ë™','ìœ í˜•','ë‹¨ì§€ì½”ë“œ','ë‹¨ì§€ëª…','ì‚¬ìš©ìŠ¹ì¸ì¼','ì´ì„¸ëŒ€ìˆ˜','ì „ìš©ë©´ì '];
    const out = target.filter(r => keys.some(k => String(r[k] ?? '').toLowerCase().includes(q)));
    currentPage = 1;
    renderDetail(out);
    filterBadge.textContent = `ê²€ìƒ‰ ê²°ê³¼: ${fmt(out.length)}í–‰`;
    filterBadge.style.display = '';
  }

  // XLSX(ì—‘ì…€) ë‹¤ìš´ë¡œë“œ: í˜„ì¬ í˜ì´ì§€ê°€ ì•„ë‹Œ 'ì „ì²´ ë°ì´í„°(í•„í„° ë°˜ì˜ ì „ì²´)'
  function downloadExcel(){
    const rows = (filteredDetail.length ? filteredDetail : apartments);
    if(!rows.length){
      alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    const headers = ['ì‹œë„ëª…','ì‹œêµ°êµ¬','ìë©´ë™','ìœ í˜•','ë‹¨ì§€ì½”ë“œ','ë‹¨ì§€ëª…','ì‚¬ìš©ìŠ¹ì¸ì¼','ì´ì„¸ëŒ€ìˆ˜','ì „ìš©ë©´ì '];

    // ì›Œí¬ì‹œíŠ¸ ìƒì„± (í—¤ë” ìˆœì„œ ì§€ì •)
    const ws = XLSX.utils.json_to_sheet(rows, { header: headers });
    // í•œê¸€ í—¤ë” ë³´ì •
    headers.forEach((key, i) => {
      const cell = XLSX.utils.encode_col(i) + '1';
      if(ws[cell]) ws[cell].v = key;
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ì•„íŒŒíŠ¸ë‹¨ì§€');

    // íŒŒì¼ëª…: ì„ íƒëœ ì‹œêµ°êµ¬ê°€ ìˆìœ¼ë©´ ê·¸ ì´ë¦„ìœ¼ë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ëª…
    const filename = (selectedSgg && selectedSgg.trim()!=='')
      ? `${selectedSgg.trim()}.xlsx`
      : 'apartments_all.xlsx';

    XLSX.writeFile(wb, filename);
  }

  // ì´ë²¤íŠ¸: ì™¼ìª½ ê²€ìƒ‰/í•„í„°
  leftSearch.addEventListener('input', ()=>{ computeSggCounts(); renderLeft(); });
  [ckSale, minUnitsInp, areaFromInp, areaToInp].forEach(el => {
    el.addEventListener('input', ()=>{
      computeSggCounts();
      renderLeft();
      if(selectedSido || selectedSgg) applyDetailFilter();
    });
  });

  // ì„¸ëŒ€ìˆ˜ ë¹ ë¥¸ì…ë ¥ ë²„íŠ¼
  document.querySelectorAll('.unit-btn').forEach(btn => {
    btn.addEventListener('click', ()=>{
      minUnitsInp.value = btn.dataset.val;
      computeSggCounts(); renderLeft();
      if(selectedSido || selectedSgg) applyDetailFilter();
    });
  });

  // ë‹¨ì§€ìˆ˜ í—¤ë” ì •ë ¬ í† ê¸€
  sortByCountTh.addEventListener('click', ()=>{
    if(sortDir === null) sortDir = 'asc';
    else if(sortDir === 'asc') sortDir = 'desc';
    else sortDir = null;
    computeSggCounts();
    renderLeft();
  });

  // ì´ë²¤íŠ¸: ì˜¤ë¥¸ìª½ ê²€ìƒ‰/í˜ì´ì§•/ë‹¤ìš´ë¡œë“œ
  detailSearch.addEventListener('input', doDetailSearch);
  colSelect.addEventListener('change', doDetailSearch);
  prevBtn.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderDetail(filteredDetail.length?filteredDetail:apartments); }});
  nextBtn.addEventListener('click', ()=>{ currentPage++; renderDetail(filteredDetail.length?filteredDetail:apartments); });
  downloadBtn.addEventListener('click', downloadExcel);

  async function init(){
    const aptRes = await fetch('apartments.json');
    apartments = await aptRes.json();

    // ìˆ«ì ì •ê·œí™”
    apartments = apartments.map(r => {
      const units = toNum(r['ì´ì„¸ëŒ€ìˆ˜']);
      if(Number.isFinite(units)) r['ì´ì„¸ëŒ€ìˆ˜'] = units;
      const area = toNum(r['ì „ìš©ë©´ì ']);
      if(Number.isFinite(area)) r['ì „ìš©ë©´ì '] = area;
      return r;
    });

    buildComplexes(apartments);
    computeSggCounts(); renderLeft();

    filteredDetail = [];  // ì´ˆê¸°ì—” ì „ì²´
    renderDetail(apartments);

    // ìƒë‹¨ ìš”ì•½: ë‹¨ì§€ ìˆ˜/ì‹œêµ°êµ¬ ìˆ˜
    const sggSet = new Set(complexes.map(c => (c.ì‹œë„ëª…||'')+'|'+(c.ì‹œêµ°êµ¬||'')));
    summaryMeta.textContent = `ì‹œêµ°êµ¬ ${fmt(sggSet.size)}ê°œ Â· ë‹¨ì§€ ${fmt(complexes.length)}ê°œ`;
  }
  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
