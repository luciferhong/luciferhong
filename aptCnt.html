<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>전국 아파트 단지 대시보드 (모바일 최적화)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0b0f17; --card:#121826; --muted:#93a4bf; --text:#e6eefc;
    --accent:#60a5fa; --border:rgba(255,255,255,.08);
    --pane-h: 72vh; --right-pager-h: 46px;
  }
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b1020,#0b0f17);
    color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system;
    overflow:hidden;
  }
  .wrap{display:grid; grid-template-rows:auto 1fr; min-height:100vh; gap:14px; padding:16px;}
  header{display:flex; align-items:center; justify-content:space-between;}
  header h1{margin:0; font-size:22px; font-weight:700}
  .panes{display:grid; grid-template-columns:320px 1fr; gap:14px; height:calc(100vh - 96px);}
  .card{
    background:rgba(18,24,38,.82); border:1px solid var(--border);
    border-radius:16px; backdrop-filter:blur(6px);
    box-shadow:0 10px 30px rgba(0,0,0,.25); display:flex; flex-direction:column; overflow:hidden;
  }
  .card header{padding:10px 14px; border-bottom:1px solid var(--border)}
  .card .body{padding:10px; display:flex; flex-direction:column; gap:8px; height:100%;}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  input[type="text"],input[type="number"],select{
    background:#0c1220; color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:8px 10px;
  }
  label.ck{display:flex; gap:6px; align-items:center; font-size:13px; color:#cfe6ff;}
  .pill{border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:#93a4bf;}
  .table-wrap{border:1px solid var(--border); border-radius:10px; overflow:auto; background:#0c1220;}
  table{border-collapse:separate; border-spacing:0; width:100%; font-size:13px;}
  thead th{position:sticky; top:0; background:#101828; color:#cfe6ff; padding:8px 10px;}
  tbody td{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.05);}
  tbody tr:hover{background:rgba(96,165,250,.08);}
  .left-wrap{height:var(--pane-h);}
  .right-wrap{height:calc(var(--pane-h) - var(--right-pager-h));}
  #pager{display:flex; align-items:center; gap:8px; height:var(--right-pager-h);}
  .unit-btn,.download-btn{
    background:rgba(96,165,250,.15); color:#cfe6ff;
    border:1px solid rgba(96,165,250,.35); border-radius:8px;
    padding:6px 10px; font-size:12px; cursor:pointer;
  }
  .unit-btn:hover,.download-btn:hover{background:rgba(96,165,250,.25);}
  @media (max-width:1024px){
    html,body{height:auto;} body{overflow:auto;}
    .panes{grid-template-columns:1fr; grid-template-rows:auto auto; height:auto;}
    #leftCard{
      max-height:calc(100dvh - 120px) !important; /* 화면보다 살짝 작게 */
      overflow:hidden;
    }
    #leftCard .body{flex-direction:column; height:100%; min-height:0;}
    #leftCard .left-wrap{
      flex:1 1 auto; min-height:0; overflow:auto; overscroll-behavior:contain;
    }
    .right-wrap{margin-top:12px; height:auto; max-height:none;}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>전국 아파트 단지 대시보드</h1>
    <span id="summaryMeta" class="pill">로딩중...</span>
  </header>

  <div class="panes">
    <!-- LEFT -->
    <section class="card" id="leftCard">
      <header><h2>시군구별 단지수</h2></header>
      <div class="body">
        <div class="toolbar">
          <input id="leftSearch" type="text" placeholder="검색: 시도명/시군구" />
        </div>
        <div class="toolbar">
          <label class="ck"><input type="checkbox" id="ckSale"/>아파트분양권 포함</label>
          <label class="ck">세대수(이상)
            <input id="minUnits" type="number" value="200" style="width:60px;text-align:right;"/>
            <button class="unit-btn" data-val="200">200</button>
            <button class="unit-btn" data-val="300">300</button>
          </label>
        </div>
        <div class="toolbar">
          <label class="ck">전용면적
            <input id="areaFrom" type="number" placeholder="from" style="width:70px"/> ~
            <input id="areaTo" type="number" placeholder="to" style="width:70px"/>㎡
          </label>
        </div>
        <div class="table-wrap left-wrap">
          <table id="leftTable"><thead>
            <tr><th>시도명</th><th>시군구</th><th id="sortByCount" style="cursor:pointer;">단지수</th></tr>
          </thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <header><h2>상세 데이터</h2></header>
      <div class="body">
        <div class="toolbar">
          <input id="detailSearch" type="text" placeholder="검색"/>
          <select id="colSelect">
            <option value="">모든 컬럼</option>
            <option>시도명</option><option>시군구</option><option>단지명</option>
          </select>
          <span id="filterBadge" class="pill" style="display:none;"></span>
        </div>
        <div class="table-wrap right-wrap">
          <table id="detailTable"><thead><tr>
            <th>시도명</th><th>시군구</th><th>읍면동</th><th>유형</th>
            <th>단지코드</th><th>단지명</th><th>사용승인일</th><th>총세대수</th><th>전용면적</th>
          </tr></thead><tbody></tbody></table>
        </div>
        <div id="pager">
          <button id="prevBtn">이전</button>
          <span id="pageInfo" class="pill">-</span>
          <button id="nextBtn">다음</button>
          <span style="flex:1"></span>
          <button id="downloadBtn" class="download-btn">엑셀 다운로드</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
const leftTbody=document.querySelector('#leftTable tbody');
const detailTbody=document.querySelector('#detailTable tbody');
const ckSale=document.getElementById('ckSale');
const minUnitsInp=document.getElementById('minUnits');
const areaFromInp=document.getElementById('areaFrom');
const areaToInp=document.getElementById('areaTo');
const leftSearch=document.getElementById('leftSearch');
const sortByCount=document.getElementById('sortByCount');
const pageInfo=document.getElementById('pageInfo');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const detailSearch=document.getElementById('detailSearch');
const colSelect=document.getElementById('colSelect');
const filterBadge=document.getElementById('filterBadge');
const downloadBtn=document.getElementById('downloadBtn');

let apartments=[],complexes=[],sggCounts=[],filteredDetail=[];
let currentPage=1,pageSize=100,selectedSido="",selectedSgg="",sortDir=null;

function fmt(n){return new Intl.NumberFormat('ko-KR').format(n??0);}
function toNum(v){if(v==null||v==='')return NaN;const n=Number(String(v).replace(/,/g,''));return Number.isFinite(n)?n:NaN;}

function buildComplexes(rows){
  const map=new Map();
  for(const r of rows){
    const code=r['단지코드']; if(!code) continue;
    const units=toNum(r['총세대수']), area=toNum(r['전용면적']);
    const type=String(r['유형']||'');
    if(!map.has(code)){
      map.set(code,{단지코드:code,시도명:r['시도명']||'',시군구:r['시군구']||'',
        총세대수:units,면적목록:Number.isFinite(area)?[area]:[],분양권:type.includes('아파트분양권')});
    }else{
      const ex=map.get(code);
      if(Number.isFinite(units)) ex.총세대수=Math.max(ex.총세대수||0,units);
      if(Number.isFinite(area)) ex.면적목록.push(area);
      if(type.includes('아파트분양권')) ex.분양권=true;
    }
  }
  complexes=[...map.values()];
}

function complexAreaOk(ex,hasMin,min,hasMax,max){
  if(!hasMin&&!hasMax)return true;
  if(!ex.면적목록.length)return false;
  return ex.면적목록.some(a=>(!hasMin||a>=min)&&(!hasMax||a<=max));
}

function computeSggCounts(){
  const inc=ckSale.checked,minU=toNum(minUnitsInp.value)||0;
  const minA=toNum(areaFromInp.value),maxA=toNum(areaToInp.value);
  const hasMin=Number.isFinite(minA),hasMax=Number.isFinite(maxA);
  const f=complexes.filter(c=>{
    if(!inc&&c.분양권)return false;
    if(!Number.isFinite(c.총세대수)||c.총세대수<minU)return false;
    if(!complexAreaOk(c,hasMin,minA,hasMax,maxA))return false;
    return true;
  });
  const map=new Map();
  for(const c of f){
    const key=(c.시도명||'')+'|'+(c.시군구||'');
    map.set(key,(map.get(key)||0)+1);
  }
  sggCounts=[...map.entries()].map(([k,v])=>{const[sido,sgg]=k.split('|');return{시도명:sido,시군구:sgg,단지수:v}});
  if(sortDir==='asc')sggCounts.sort((a,b)=>a.단지수-b.단지수);
  else if(sortDir==='desc')sggCounts.sort((a,b)=>b.단지수-a.단지수);
  else sggCounts.sort((a,b)=>a.시도명.localeCompare(b.시도명)||a.시군구.localeCompare(b.시군구));
}

function renderLeft(){
  leftTbody.innerHTML='';
  for(const r of sggCounts){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.시도명}</td><td>${r.시군구}</td><td style="text-align:right">${fmt(r.단지수)}</td>`;
    tr.onclick=()=>{selectedSido=r.시도명;selectedSgg=r.시군구;applyDetail();};
    leftTbody.appendChild(tr);
  }
}
function paginate(rows){
  const total=rows.length,max=Math.max(1,Math.ceil(total/pageSize));
  if(currentPage>max)currentPage=max;
  const start=(currentPage-1)*pageSize;
  const page=rows.slice(start,start+pageSize);
  pageInfo.textContent=`${fmt(currentPage)} / ${fmt(max)} · 총 ${fmt(total)} 행`;
  prevBtn.disabled=currentPage<=1;nextBtn.disabled=currentPage>=max;
  return page;
}
function renderDetail(rows){
  detailTbody.innerHTML='';
  for(const r of paginate(rows)){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.시도명}</td><td>${r.시군구}</td><td>${r.읍면동}</td>
      <td>${r.유형}</td><td>${r.단지코드}</td><td>${r.단지명}</td><td>${r.사용승인일}</td>
      <td>${fmt(r.총세대수)}</td><td>${r.전용면적}</td>`;
    detailTbody.appendChild(tr);
  }
}
function applyDetail(){
  const inc=ckSale.checked,minU=toNum(minUnitsInp.value)||0;
  const minA=toNum(areaFromInp.value),maxA=toNum(areaToInp.value);
  const hasMin=Number.isFinite(minA),hasMax=Number.isFinite(maxA);
  const ok=new Set();
  for(const c of complexes){
    if(!inc&&c.분양권)continue;
    if(!Number.isFinite(c.총세대수)||c.총세대수<minU)continue;
    if(!complexAreaOk(c,hasMin,minA,hasMax,maxA))continue;
    if(c.시도명!==selectedSido||c.시군구!==selectedSgg)continue;
    ok.add(c.단지코드);
  }
  filteredDetail=apartments.filter(r=>ok.has(String(r.단지코드||'')));
  currentPage=1;renderDetail(filteredDetail);
  filterBadge.style.display='';filterBadge.textContent=`${selectedSgg} (${fmt(filteredDetail.length)}행)`;
}

function downloadExcel(){
  const rows=filteredDetail.length?filteredDetail:apartments;
  if(!rows.length){alert('데이터 없음');return;}
  const headers=['시도명','시군구','읍면동','유형','단지코드','단지명','사용승인일','총세대수','전용면적'];
  const ws=XLSX.utils.json_to_sheet(rows,{header:headers});
  headers.forEach((h,i)=>{const c=XLSX.utils.encode_col(i)+'1';if(ws[c])ws[c].v=h;});
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'아파트단지');
  const fname=selectedSgg?`${selectedSgg}.xlsx`:'apartments_all.xlsx';
  XLSX.writeFile(wb,fname);
}

document.querySelectorAll('.unit-btn').forEach(b=>b.onclick=()=>{minUnitsInp.value=b.dataset.val;computeSggCounts();renderLeft();});
[ckSale,minUnitsInp,areaFromInp,areaToInp,leftSearch].forEach(el=>el.oninput=()=>{computeSggCounts();renderLeft();});
sortByCount.onclick=()=>{if(sortDir===null)sortDir='asc';else if(sortDir==='asc')sortDir='desc';else sortDir=null;computeSggCounts();renderLeft();};
prevBtn.onclick=()=>{if(currentPage>1){currentPage--;renderDetail(filteredDetail.length?filteredDetail:apartments);}};
nextBtn.onclick=()=>{currentPage++;renderDetail(filteredDetail.length?filteredDetail:apartments);};
downloadBtn.onclick=downloadExcel;

(async()=>{
  const r=await fetch('apartments.json');apartments=await r.json();
  buildComplexes(apartments);computeSggCounts();renderLeft();renderDetail(apartments);
})();
</script>
</body>
</html>
