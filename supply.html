<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>[ë£¨ì‹œí¼í™] í™ê¸‰ì§€ë„</title>
	
	<link rel="icon" href="icon.png" type="image/png">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=9t8y33hyq8"></script>
    <style>
        #map {
            width: 100%;
            height: calc(100vh - 260px);
            min-height: 500px;
            max-height: 90vh;
			resize: both; /* ì„¸ë¡œ í¬ê¸° ì¡°ì ˆ í—ˆìš© */
        }

        .custom-infowindow {
            padding: 6px 10px;
            border-radius: 5px;
            border: 1px solid #333;
            font-size: 12px;
            text-align: left;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            color: white;
            position: absolute;
            z-index: 10;
            white-space: nowrap;
            cursor: grab;
            transition: border 0.2s;
        }

        .selected {
            border: 2px solid red !important;
        }

        #filterContainer {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            position: relative;
            overflow: visible;
        }

        #dataTableContainer {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            max-height: 1000px;
            overflow-y: auto;
			resize: both; /* ì‚¬ìš©ìê°€ í¬ê¸° ì¡°ì ˆ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
        }

        #dataTable {
            width: 100%;
            border-collapse: collapse;
        }

        #dataTable th, #dataTable td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
        }

        #dataTable th {
            background-color: #f2f2f2;
        }

        .highlighted {
            background-color: yellow !important;
        }

		/* âœ… ê¸°ë³¸ ì²´í¬ë°•ìŠ¤ (ë¼ë²¨ í‘œì‹œ, í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ) â†’ ì£¼í™©ìƒ‰ */
		#filterContainer input[type="checkbox"] {
			accent-color: orange;
		}

		/* âœ… ì…ì£¼ì‹œê¸° ì²´í¬ë°•ìŠ¤ (ë…„ë„ í•„í„°) â†’ íŒŒë€ìƒ‰ */
		#yearFilter input[type="checkbox"] {
			accent-color: initial;
		}
		
		/* âœ… ì‹œêµ°êµ¬ í•„í„° ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
		#sigunguFilterWrapper {
			display: inline-block;
			position: relative;
		}

        #sidoFilter{
            border: 1px solid #ccc;
			padding: 4px 8px;
			display: inline-block;
			position: relative;
			background-color: #fff;
			border-radius: 4px;
			min-width: 80px;
			font-size: 13px;
			cursor: pointer;
			box-shadow: 0 2px 8px rgba(0,0,0,0.15);
			padding-right: 25px;

        }


		#sigunguFilterDisplay {
			border: 1px solid #ccc;
			padding: 4px 8px;
			display: inline-block;
			position: relative;
			background-color: #fff;
			border-radius: 4px;
			min-width: 150px;
			font-size: 13px;
			cursor: pointer;
			box-shadow: 0 2px 8px rgba(0,0,0,0.15);
			padding-right: 25px;
		}

		#sigunguToggleBtn {
			position: absolute;
			right: 8px;
			top: 50%;
			transform: translateY(-50%);
			cursor: pointer;
			font-weight: bold;
			user-select: none;
			pointer-events: none;
		}

		#sigunguFilter {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background-color: #fff;
			border: 1px solid #ccc;
			border-radius: 4px;
			max-height: 0;
			transition: max-height 0.3s ease;
			overflow: hidden;
			padding: 0;
			margin-top: 0;
			z-index: 10001;
		}
		
		#sigunguFilter.expanded {
			max-height: 50vh;
			overflow-y: auto;
			padding: 4px 8px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.15);
		}

    </style>


</head>
<body>

<h1>[ë£¨ì‹œí¼í™] í™ê¸‰ì§€ë„ <span style="font-size: 14px; color: gray;">(ê³µê¸‰ë°ì´í„° ì—…ë°ì´íŠ¸: 2026-02-18)</span></h1>
<div id="filterContainer">
    <label>ì‹œë„: <select id="sidoFilter" style="width: 100px;"></select></label>
    <label>ì‹œêµ°êµ¬:</label>
    <div id="sigunguFilterWrapper">
        <div id="sigunguFilterDisplay">
            <span id="sigunguDisplayText">ì „ì²´</span>
            <span id="sigunguToggleBtn">â–¼</span>
        </div>
        <div id="sigunguFilter"></div>
    </div>
    <label><input type="checkbox" id="toggleTextBox" checked> ë¼ë²¨ í‘œì‹œ</label>
    <label><input type="checkbox" id="toggleTextWrap" checked> ë¼ë²¨ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ</label>
    <label>&nbsp;&nbsp;&nbsp; ğŸŸ  ì…ì£¼ì‹œê¸°:</label>
<input type="month" id="fromDate" min="2000-01" max="2035-12">
<span> ~ </span>
<input type="month" id="toDate" min="2000-01" max="2035-12">
<label>&nbsp;&nbsp;&nbsp; ğŸŸ  ìµœì†Œ ì„¸ëŒ€ìˆ˜:
    <input type="number" id="minHouseholds" style="width:70px;" placeholder="0">
</label>

<button id="searchBtn">ì¡°íšŒ</button> (ì¡°íšŒê¸°ê°„ì„ ê¸¸ê²Œ í•˜ë©´ í™”ë©´ì´ ë²„ë²…ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤! 5ë…„ ì´ë‚´ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤)
   
</div>

<div id="map"></div>

<div id="dataTableContainer">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>ğŸ“Š í•„í„°ë§ëœ ë°ì´í„°</h2>
        <span id="copyTableBtn" style="cursor: pointer; font-size: 20px;">
            ğŸ“‹ <!-- ë³µì‚¬ ì•„ì´ì½˜ -->
        </span>
    </div>
    <table id="dataTable">
        <thead>
            <tr>
                <th>ì‹œë„ â‡…</th>
                <th>ì‹œêµ°êµ¬ â‡…</th>
                <th>ì•„íŒŒíŠ¸ëª… â‡…</th>
                <th>ì…ì£¼ì‹œê¸° â‡…</th>
                <th>ì„¸ëŒ€ìˆ˜ â‡…</th>
                <th>ì£¼ì†Œ â‡…</th>
                <th>ë¶„ì–‘ê°€ â‡…</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    window.map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(37.5665, 126.9780),
        zoom: 12
    });

    var markers = [];
    var showTextBoxes = true;
    var enableTextWrap = true;
    var selectedYears = new Set();
    var activeTextBox = null;
    var moveStep = 5;
	var selectedSido = "";
    var selectedSigungu = new Set(); // âœ… Setìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì—¬ëŸ¬ ê°œ ì„ íƒ ì§€ì›
	let minHouseholdsFilter = null;

    var sidoData = {};

	let sortConfig = { column: null, order: 'asc' }; // í˜„ì¬ ì •ë ¬ ê¸°ì¤€ ì €ì¥




// âœ… í˜„ì¬ ì—°ë„ ê°€ì ¸ì˜¤ê¸°
const currentYear = new Date().getFullYear();
const defaultFromDate = `${currentYear}-01`; // ì˜¬í•´ 1ì›”
const defaultToDate = "2035-12"; // ìµœì¢… ì„ íƒ ê°€ëŠ¥ ë‚ ì§œ

// âœ… ê¸°ë³¸ê°’ ì„¤ì •
document.getElementById("fromDate").value = defaultFromDate;
document.getElementById("toDate").value = defaultToDate;

// âœ… ì„ íƒëœ ë‚ ì§œ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
let selectedFromDate = defaultFromDate;
let selectedToDate = defaultToDate;

// âœ… FROM ë‚ ì§œ ë³€ê²½ ì´ë²¤íŠ¸
document.getElementById("fromDate").addEventListener("change", function() {
    selectedFromDate = this.value;
    //updateMarkers();
});

// âœ… TO ë‚ ì§œ ë³€ê²½ ì´ë²¤íŠ¸
document.getElementById("toDate").addEventListener("change", function() {
    selectedToDate = this.value;
    //updateMarkers();
});

document.getElementById("searchBtn").addEventListener("click", function() {
    updateMarkers();
});

document.getElementById("minHouseholds").addEventListener("input", function () {
    const v = this.value.trim();
    minHouseholdsFilter = v === "" ? null : parseInt(v, 10);
    updateMarkers(); // ì¦‰ì‹œ ë°˜ì˜
});


	// âœ… ì§€ë„ í¬ê¸° ìë™ ì¡°ì • (ResizeObserver ì‚¬ìš©)
const mapElement = document.getElementById('map');

function getMapSize() {
    return new naver.maps.Size(mapElement.offsetWidth, mapElement.offsetHeight);
}

let resizeObserver = new ResizeObserver(() => {
    window.map.setSize(getMapSize());
});

resizeObserver.observe(mapElement);
// âœ… ì°½ í¬ê¸° ì¡°ì ˆ ì‹œ ì§€ë„ í¬ê¸° ìë™ ì¡°ì •
window.addEventListener("resize", () => {
    window.map.setSize(getMapSize());
});

function copyTableToClipboard() {
    let table = document.querySelector("#dataTable");
    let rows = table.querySelectorAll("tr");
    let text = "";

    rows.forEach(row => {
        let cols = row.querySelectorAll("th, td");
        let rowData = [];

        cols.forEach((col, colIndex) => {
            let cellText = col.innerText.trim();

            // âœ… ì…ì£¼ ë‚ ì§œ(YYYY-MM)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
            // ì„¸ëŒ€ìˆ˜(colIndex 4)ì™€ ë¶„ì–‘ê°€(colIndex 6)ì—ì„œ ì‰¼í‘œ ì œê±° (ìˆ«ìë¡œ ì¸ì‹í•˜ë„ë¡)
            if (colIndex === 4 || colIndex === 6) {
                cellText = cellText.replace(/,/g, '');
            }

            rowData.push(cellText);
        });

        text += rowData.join("\t") + "\n"; // âœ… íƒ­(`\t`)ì„ ìœ ì§€í•˜ì—¬ ì—‘ì…€ì— ì˜ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥
    });

    navigator.clipboard.writeText(text).then(() => {
        alert("ğŸ“‹ í…Œì´ë¸” ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤");
    }).catch(err => {
        console.error("ë³µì‚¬ ì‹¤íŒ¨:", err);
    });
}

// âœ… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
document.getElementById("copyTableBtn").addEventListener("click", copyTableToClipboard);


function updateTable() {
    const tableBody = document.querySelector("#dataTable tbody");
    tableBody.innerHTML = ""; // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”

    let filteredMarkers = markers.filter(marker => {
        const { sido, sigungu, name, appr_dt, appr_dt_full, households, address, price } = marker.data;

        // âœ… ì—°ë„(ì…ì£¼ì‹œê¸°) í•„í„°ë§ ì¶”ê°€
        const isWithinDateRange =
            (!selectedFromDate || appr_dt_full >= selectedFromDate) &&
            (!selectedToDate || appr_dt_full <= selectedToDate);

        // âœ… ì‹œë„ ë° ì‹œêµ°êµ¬ í•„í„°ë§
        const isSidoSelected = !selectedSido || sido === selectedSido;
        const isSigunguSelected = selectedSigungu.size === 0 || selectedSigungu.has(sigungu);

        const householdsNum = parseInt(households, 10) || 0;
		const isMinHouseholdsOK =
			minHouseholdsFilter === null || householdsNum >= minHouseholdsFilter;

		

		const visible =
			isWithinDateRange && isSidoSelected && isSigunguSelected && isMinHouseholdsOK;


        return visible
    });

    // âœ… ì •ë ¬ ì ìš©
    if (sortConfig.column) {
        filteredMarkers.sort((a, b) => {
            let valA = a.data[sortConfig.column];
            let valB = b.data[sortConfig.column];

            if (!isNaN(valA) && !isNaN(valB)) { // ìˆ«ì ì •ë ¬
                valA = parseFloat(valA);
                valB = parseFloat(valB);
            } else { // ë¬¸ìì—´ ì •ë ¬
                valA = valA.toString().toLowerCase();
                valB = valB.toString().toLowerCase();
            }

            return sortConfig.order === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
        });
    }

    // âœ… í•„í„°ë§ëœ ë°ì´í„° í‘œì— ì¶”ê°€
    filteredMarkers.forEach((marker, index) => {
        const { sido, sigungu, name, appr_dt, appr_dt_full, households, address, price } = marker.data;

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${sido}</td>
            <td>${sigungu}</td>
            <td>${name}</td>
            <td>${appr_dt_full}</td> <!-- ğŸ”¥ ë…„ë„(ì…ì£¼ì‹œê¸°) ì¶”ê°€ -->
            <td>${households}</td>
            <td>${address}</td>
            <td>${price}</td>
        `;

        row.addEventListener("click", () => {
            if (activeMarkerElement) {
                updateMarkerSelection(activeMarkerElement, false);
            }
            activeMarker = marker;
            activeMarkerElement = document.querySelector(`[data-marker-index="${index}"]`);
            updateMarkerSelection(activeMarkerElement, true);

            window.map.setCenter(marker.getPosition()); // í´ë¦­ ì‹œ ì§€ë„ ì´ë™
        });

        tableBody.appendChild(row);
    });
}




    function getBackgroundColor(apprYear) {
    apprYear = parseInt(apprYear);
    if (isNaN(apprYear)) return "#FFFFFF";

    const yearDiff = apprYear - currentYear;

    if (yearDiff < 0) return "#000000"; // âœ… í˜„ì¬ ì—°ë„ ì´ì „ì€ ê²€ì€ìƒ‰
    if (yearDiff === 0) return "#FC2C2C";
    if (yearDiff === 1) return "#F25E04";
    if (yearDiff === 2) return "#F79905";
    if (yearDiff === 3) return "#EEA362";
    return "#DDC40D";
}


    function getMarkerSize(households) {
        households = parseInt(households);
        if (isNaN(households)) return { width: 24, height: 34, textOffsetX: 30, textOffsetY: -5 };

        if (households >= 1000) return { width: 60, height: 84, textOffsetX: 50, textOffsetY: 15 };
        if (households >= 500) return { width: 50, height: 64, textOffsetX: 40, textOffsetY: 7 };
        return { width: 40, height: 44, textOffsetX: 30, textOffsetY: -5 };
    }

    async function loadMarkers() {
		//console.log("ğŸ“Œ ë§ˆì»¤ ë°ì´í„° ë¡œë”© ì‹œì‘...");
		const response = await fetch("markers.txt");
		const text = await response.text();
		const rows = text.trim().split("\n");

		let tempMarkers = [];
		let minDate = "9999-12"; // ê°€ì¥ í° ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
		let maxDate = "0000-01"; // ê°€ì¥ ì‘ì€ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”

		rows.forEach((row, index) => {
			if (index === 0) return;
			const cols = row.split("\t");

			const lat = parseFloat(cols[cols.length - 1]);
			const lon = parseFloat(cols[cols.length - 2]);
			const sido = cols[0];
			const sigungu = cols[1];
			const name = cols[4];
			const appr_dt = cols[6].substring(0, 4);
			const appr_dt_full = cols[6]; // ğŸ”¥ "YYYY-MM" í˜•ì‹ìœ¼ë¡œ ì €ì¥ë¨
			const households = cols[7] || 0;
			const address = cols[5];
			const price = cols[9];
			//let markerSize = getMarkerSize(households);

			if (!appr_dt_full || appr_dt_full.length < 7) {
				console.warn(`âš ï¸ ${name}ì˜ ì…ì£¼ë‚ ì§œ(appr_dt_full)ê°€ ì˜ëª»ë¨: ${appr_dt_full}`);
				return;
			}

			 if (!sidoData[sido]) {
				sidoData[sido] = new Set();
			}
			sidoData[sido].add(sigungu);

			// âœ… MIN/MAX ë‚ ì§œ ì°¾ê¸°
			if (appr_dt_full < minDate) minDate = appr_dt_full;
			if (appr_dt_full > maxDate) maxDate = appr_dt_full;
			let bgColor = getBackgroundColor(appr_dt);
			let markerSize = getMarkerSize(households);
			let marker = new naver.maps.Marker({
				position: new naver.maps.LatLng(lat, lon),
				map: null,
				data: { sido, sigungu, appr_dt, appr_dt_full, name, households, bgColor, markerSize, address, price }
			});

			tempMarkers.push(marker);
		});

		markers = tempMarkers;

		console.log(`âœ… ìµœì € ë‚ ì§œ (MIN): ${minDate}, ìµœê³  ë‚ ì§œ (MAX): ${maxDate}`);

		// âœ… FROM/TO ì…ë ¥ì°½ì˜ min/max ê°’ ì„¤ì •
		setDateFilters(minDate, maxDate);
		updateSidoFilters();
        markers = tempMarkers;
       
		updateMarkers();
	}
	function setDateFilters(minDate, maxDate) {
		const fromDateInput = document.getElementById("fromDate");
		const toDateInput = document.getElementById("toDate");

		// âœ… MIN/MAX ê°’ ì ìš©
		fromDateInput.min = minDate;
		fromDateInput.max = maxDate;
		toDateInput.min = minDate;
		toDateInput.max = maxDate;

		// âœ… ê¸°ë³¸ê°’ ì„¤ì • (ìµœì†Œ ë‚ ì§œëŠ” MIN, ìµœëŒ€ ë‚ ì§œëŠ” MAX)
		fromDateInput.value = minDate;
		toDateInput.value = maxDate;

		// âœ… ì„ íƒëœ ë‚ ì§œ ì—…ë°ì´íŠ¸
		fromDateInput.value = selectedFromDate;
		toDateInput.value = selectedToDate;

		console.log(`ğŸ“Œ FROM: ${selectedFromDate}, TO: ${selectedToDate}`);
	}



	function updateSidoFilters() {
        const sidoFilter = document.getElementById("sidoFilter");
        sidoFilter.innerHTML = '<option value="">ì „ì²´</option>';
        Object.keys(sidoData).forEach(sido => {
            let option = document.createElement("option");
            option.value = sido;
            option.textContent = sido;
            sidoFilter.appendChild(option);
        });
    }

    function updateSigunguFilters() {
        const sigunguFilter = document.getElementById("sigunguFilter");
        
        // ëª¨ë“  ìš”ì†Œ ì œê±°
        sigunguFilter.innerHTML = "";
        
        if (selectedSido && sidoData[selectedSido]) {
            const sigunguArray = Array.from(sidoData[selectedSido]).sort();
            
            // âœ… "ì „ì²´" ì²´í¬ë°•ìŠ¤ ì¶”ê°€
            const allLabel = document.createElement("label");
            allLabel.style.display = "block";
            allLabel.style.padding = "2px 0";
            allLabel.style.cursor = "pointer";
            allLabel.style.margin = "0";
            allLabel.style.lineHeight = "1.2";
            allLabel.innerHTML = `<input type="checkbox" value="__ALL__" style="accent-color: blue;"> ì „ì²´`;
            sigunguFilter.appendChild(allLabel);
            
            const allCheckbox = allLabel.querySelector("input");
            allCheckbox.addEventListener("change", function() {
                if (this.checked) {
                    // âœ… ì „ì²´ ì„ íƒ - selectedSigunguë¥¼ ë¹„ìš°ê¸° (ë°±ê·¸ë¼ìš´ë“œì—ì„œ size===0ì´ë©´ ëª¨ë“  ë°ì´í„° í‘œì‹œ)
                    selectedSigungu.clear();
                    // ëª¨ë“  ê°œë³„ ì²´í¬ë°•ìŠ¤ ì²´í¬ í•´ì œ ("ì „ì²´"ë§Œ ì²´í¬)
                    sigunguFilter.querySelectorAll("input:not([value=\"__ALL__\"])").forEach(cb => {
                        cb.checked = false;
                    });
                    document.getElementById("sigunguDisplayText").textContent = "ì „ì²´";
                } else {
                    // âœ… ì „ì²´ í•´ì œ
                    selectedSigungu.clear();
                    sigunguFilter.querySelectorAll("input:not([value=\"__ALL__\"])").forEach(cb => {
                        cb.checked = false;
                    });
                    document.getElementById("sigunguDisplayText").textContent = "ì„ íƒ ì—†ìŒ";
                }
                
                updateMarkers();
            });
            
            // âœ… ê° ì‹œêµ°êµ¬ ì²´í¬ë°•ìŠ¤ ì¶”ê°€
            sigunguArray.forEach(sigungu => {
                const label = document.createElement("label");
                label.style.display = "block";
                label.style.padding = "2px 0";
                label.style.cursor = "pointer";
                label.style.margin = "0";
                label.style.lineHeight = "1.2";
                label.innerHTML = `<input type="checkbox" value="${sigungu}" style="accent-color: orange;"> ${sigungu}`;
                sigunguFilter.appendChild(label);
                
                const checkbox = label.querySelector("input");
                checkbox.addEventListener("change", function() {
                    if (this.checked) {
                        selectedSigungu.add(sigungu);
                    } else {
                        selectedSigungu.delete(sigungu);
                    }
                    
                    // âœ… "ì „ì²´" ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ìë™ ì„ íƒ
                    const allCheckbox = sigunguFilter.querySelector("input[value='__ALL__']");
                    if (selectedSigungu.size === sigunguArray.length) {
                        // ëª¨ë“  ê°œë³„ ì‹œêµ°êµ¬ê°€ ì²´í¬ë˜ë©´ "ì „ì²´"ë¡œ ë³€ê²½
                        selectedSigungu.clear(); // selectedSigunguë¥¼ ë¹„ì›Œì„œ "ì „ì²´" ìƒíƒœë¡œ
                        allCheckbox.checked = true;
                        sigunguFilter.querySelectorAll("input:not([value=\"__ALL__\"])").forEach(cb => {
                            cb.checked = false;
                        });
                    } else {
                        allCheckbox.checked = false;
                    }
                    
                    // âœ… ë””ìŠ¤í”Œë ˆì´ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë° ìë™ ì „ì²´ë§Œ ì²´í¬ í‘œì‹œ
                    const selected = Array.from(selectedSigungu);
                    if (selected.length === 0) {
                        // ì„ íƒì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ "ì „ì²´" ìƒíƒœë¡œ ë³€ê²½
                        // selectedSigunguëŠ” ë¹„ìš´ ìƒíƒœë¡œ ìœ ì§€ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ëª¨ë“  ë°ì´í„° í‘œì‹œ)
                        sigunguFilter.querySelectorAll("input:not([value=\"__ALL__\"])").forEach(cb => {
                            cb.checked = false;
                        });
                        allCheckbox.checked = true;
                        document.getElementById("sigunguDisplayText").textContent = "ì „ì²´";
                    } else if (selected.length === sigunguArray.length) {
                        document.getElementById("sigunguDisplayText").textContent = "ì „ì²´";
                    } else {
                        document.getElementById("sigunguDisplayText").textContent = selected.length + "ê°œ ì„ íƒ";
                    }
                    
                    updateMarkers();
                });
            });
            
            // ì‹œë„ ë³€ê²½ í›„: "ì „ì²´" ìë™ ì²´í¬ (í•˜ì§€ë§Œ selectedSigunguëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ)
            allCheckbox.checked = true;
            // selectedSigunguëŠ” ë¹„ì›Œë‘” ìƒíƒœ ìœ ì§€ (ì‚¬ìš©ìê°€ ì§ì ‘ ì„ íƒí•´ì•¼ í•¨)
            document.getElementById("sigunguDisplayText").textContent = "ì „ì²´";
        } else {
            // ë©”ì‹œì§€ ì¶”ê°€
            const msgDiv = document.createElement("div");
            msgDiv.style.color = "#999";
            msgDiv.style.padding = "0";
            msgDiv.style.whiteSpace = "nowrap";
            msgDiv.textContent = "ì‹œë„ë¥¼ ì„ íƒí•˜ì„¸ìš”";
            sigunguFilter.appendChild(msgDiv);
        }
    }






var activeMarker = null; // ğŸ”¥ í˜„ì¬ ì„ íƒëœ ë§ˆì»¤
var activeMarkerElement = null; // ğŸ”¥ í˜„ì¬ ì„ íƒëœ ë§ˆì»¤ì˜ ìš”ì†Œ (í…Œë‘ë¦¬ ë³€ê²½ìš©)

// âœ… ğŸ”¥ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì„ íƒëœ ê²½ìš° ê°•ì¡°)
function updateMarkerSelection(markerElement, isSelected) {
    if (markerElement) {
        if (isSelected) {
            markerElement.classList.add("selected"); // ğŸ”¥ ë¹¨ê°„ í…Œë‘ë¦¬ ì¶”ê°€
        } else {
            markerElement.classList.remove("selected"); // ğŸ”¥ ì›ë˜ëŒ€ë¡œ ë³µê·€
        }
    }
}


    function updateMarkers() {
        selectedYears.clear();
        document.querySelectorAll("#yearFilter input[type='checkbox']:checked").forEach(cb => {
            selectedYears.add(cb.value);
        });

        const bounds = window.map.getBounds();

        markers.forEach((marker, index) => {
            const { sido, sigungu, appr_dt_full, name, households, bgColor, markerSize } = marker.data;
            const isWithinDateRange =
				(!selectedFromDate || appr_dt_full >= selectedFromDate) &&
				(!selectedToDate || appr_dt_full <= selectedToDate);

            const isSidoSelected = !selectedSido || sido === selectedSido;
			const isSigunguSelected = selectedSigungu.size === 0 || selectedSigungu.has(sigungu);

			// ğŸ”¹ ìµœì†Œ ì„¸ëŒ€ìˆ˜ í•„í„° ì ìš© (nullì´ë©´ í•„í„° ì•ˆ ê±¸ë¦¼)
			const householdsNum = parseInt(households, 10) || 0;
			const isMinHouseholdsOK =
				minHouseholdsFilter === null || householdsNum >= minHouseholdsFilter;

			const visible =
				isWithinDateRange && isSidoSelected && isSigunguSelected && isMinHouseholdsOK;


            if (visible && bounds.hasLatLng(marker.getPosition())) {
                let textContent = enableTextWrap
                    ? `${name} <br> ${appr_dt_full} (${households}ì„¸ëŒ€)`
                    : `${name} ${appr_dt_full} (${households}ì„¸ëŒ€)`;

                let newContent = `
					<div class="marker-container" 
						 data-marker-index="${index}" 
						 style="display: flex; align-items: center; position: relative;">
						<img src="icon.png" style="width:${markerSize.width}px; height:${markerSize.height}px;">
						<div class="custom-infowindow" 
							style="background:${bgColor}; 
								   left: ${markerSize.textOffsetX}px; 
								   top: ${markerSize.textOffsetY}px;
								   display: ${showTextBoxes ? 'block' : 'none'};">
							${textContent}
						</div>
					</div>
				`;


                marker.setIcon({ content: newContent, anchor: new naver.maps.Point(markerSize.width / 2, markerSize.height) });
                marker.setMap(map);

                // âœ… ê¸°ì¡´ ë§ˆì»¤ì—ëŠ” ìš°í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                if (!marker.hasContextMenu) {
                    addContextMenuEvent(marker, index);
                    marker.hasContextMenu = true;
                }
            } else {
                marker.setMap(null);
            }
        });

        // âœ… ë§ˆì»¤ ì—…ë°ì´íŠ¸ í›„, ìš°í´ë¦­ ì´ë²¤íŠ¸ ì¬ì„¤ì •
        setTimeout(updateContextMenuEvents, 500);

        updateTable();
    }

    // âœ… ë§ˆì»¤ ë¼ë²¨ì´ ê°±ì‹ ë  ë•Œ, ëª¨ë“  custom-infowindow ìš”ì†Œì— contextmenu ì´ë²¤íŠ¸ ë‹¤ì‹œ ë¶€ì—¬
    function updateContextMenuEvents() {
		document.querySelectorAll(".marker-container").forEach(container => {
			container.removeEventListener("contextmenu", handleContextMenu);
			container.addEventListener("contextmenu", handleContextMenu);
		});
	}


    function addContextMenuEvent(marker, index) {
        setTimeout(() => {
            const infoWindow = document.querySelector(`.custom-infowindow[data-marker-index="${index}"]`);
            if (infoWindow) {
                infoWindow.addEventListener("contextmenu", handleContextMenu);
            }
        }, 500);
    }

    function handleContextMenu(event) {
        event.preventDefault();
        const markerIndex = parseInt(this.getAttribute("data-marker-index"));

        if (!markers[markerIndex]) return;

        if (activeMarkerElement) {
            updateMarkerSelection(activeMarkerElement, false);
        }

        activeMarker = markers[markerIndex];
        activeMarkerElement = this;
        updateMarkerSelection(activeMarkerElement, true);
    }

    // âœ… WASD í‚¤ ì…ë ¥ìœ¼ë¡œ ë§ˆì»¤ ì´ë™
    function handleKeyDown(event) {
        if (!activeMarker) {
            console.warn("âš ï¸ ì´ë™í•  ë§ˆì»¤ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        let position = activeMarker.getPosition();
        let lat = position.lat();
        let lng = position.lng();
        let step = 0.001;

        switch (event.key) {
            case "w": case "ã…ˆ": case "W": lat += step; break;
            case "s": case "ã„´": case "S": lat -= step; break;
            case "a": case "ã…": case "A": lng -= step; break;
            case "d": case "ã…‡": case "D":lng += step; break;
            case "Escape":
                if (activeMarkerElement) {
                    updateMarkerSelection(activeMarkerElement, false);
                }
                activeMarker = null;
                activeMarkerElement = null;
                console.log("âŒ ë§ˆì»¤ ì„ íƒ í•´ì œ");
                return;
        }

        let newPosition = new naver.maps.LatLng(lat, lng);
        activeMarker.setPosition(newPosition);

        // âœ… markers ë°°ì—´ì—ì„œë„ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ì¶”í›„ ì´ë™ ìœ ì§€)
        markers.forEach(marker => {
            if (marker === activeMarker) {
                marker.setPosition(newPosition);
                marker.data.lat = lat;
                marker.data.lng = lng;
            }
        });

        console.log("â¡ï¸ ì´ë™í•œ ë§ˆì»¤:", activeMarker.getPosition());
    }

    // âœ… í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€
    document.removeEventListener("keydown", handleKeyDown);
    document.addEventListener("keydown", handleKeyDown);

    // âœ… ë¼ë²¨ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById("toggleTextWrap").addEventListener("change", function () {
        enableTextWrap = this.checked;
        updateMarkers(); // ğŸ”¥ ë§ˆì»¤ ê°±ì‹  ì‹œ ìš°í´ë¦­ ì´ë²¤íŠ¸ ìœ ì§€
    });

    document.getElementById("toggleTextBox").addEventListener("change", function () {
        showTextBoxes = this.checked;
        updateMarkers(); // ğŸ”¥ ë§ˆì»¤ ê°±ì‹  ì‹œ ìš°í´ë¦­ ì´ë²¤íŠ¸ ìœ ì§€
    });


    document.getElementById("toggleTextBox").addEventListener("change", function () {
        showTextBoxes = this.checked;
        updateMarkers();
    });

    document.getElementById("toggleTextWrap").addEventListener("change", function () {
        enableTextWrap = this.checked;
        updateMarkers();
    });


	naver.maps.Event.addListener(map, 'idle', updateMarkers);

    window.onload = function () {
        loadMarkers();
    };


	document.getElementById("sidoFilter").addEventListener("change", function() {
		selectedSido = this.value;
		selectedSigungu.clear(); 
		updateSigunguFilters();
		const sigunguFilter = document.getElementById("sigunguFilter");
		sigunguDropdownExpanded = false;
		sigunguFilter.classList.remove("expanded");
		
		const icon = document.getElementById("sigunguToggleBtn");
		icon.textContent = "â–¼";
		
		document.getElementById("sigunguDisplayText").textContent = "ì „ì²´";
		updateMarkers();
	});

	// âœ… ì‹œêµ°êµ¬ í•„í„° ì´ˆê¸°ê°’ ì„¤ì •
	const sigunguFilter = document.getElementById("sigunguFilter");
	const sigunguFilterDisplay = document.getElementById("sigunguFilterDisplay");
	const sigunguToggleBtn = document.getElementById("sigunguToggleBtn");
	let sigunguDropdownExpanded = false; // ë“œë¡­ë‹¤ìš´ ìƒíƒœ ì¶”ì 

	// âœ… ë””ìŠ¤í”Œë ˆì´ ì°½ í´ë¦­í•˜ë©´ í¼ì³ì§€ê³  ì ‘í˜
	sigunguFilterDisplay.addEventListener("click", function(e) {
		e.stopPropagation();
		sigunguDropdownExpanded = !sigunguDropdownExpanded;
		
		if (sigunguDropdownExpanded) {
			sigunguFilter.classList.add("expanded");
		} else {
			sigunguFilter.classList.remove("expanded");
		}
		
		sigunguToggleBtn.textContent = sigunguDropdownExpanded ? "â–²" : "â–¼";
	});
	
	// âœ… ì²´í¬ë°•ìŠ¤ë‚˜ ë¼ë²¨ í´ë¦­ ì‹œì—ëŠ” í¼ì¹¨ ìœ ì§€
	sigunguFilter.addEventListener("click", function(e) {
		e.stopPropagation();
	});
	
	// âœ… ì˜ì—­ ë°– í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸° (ì‹œë„ í•„í„°ì²˜ëŸ¼ ë™ì‘í•˜ë„ë¡)
	document.addEventListener("click", function(e) {
		if (!document.getElementById("sigunguFilterWrapper").contains(e.target)) {
			sigunguDropdownExpanded = false;
			sigunguFilter.classList.remove("expanded");
			sigunguToggleBtn.textContent = "â–¼";
		}
	});
	
	document.querySelectorAll("#dataTable th").forEach((th, index) => {
    th.addEventListener("click", () => {
        const columnMap = ["sido", "sigungu", "name", "appr_dt_full", "households", "address", "price"]; // ğŸ”¥ ë°ì´í„° ì†ì„± ë§¤í•‘
        const columnKey = columnMap[index];

        if (sortConfig.column === columnKey) {
            sortConfig.order = sortConfig.order === 'asc' ? 'desc' : 'asc'; // ğŸ”„ ê¸°ì¡´ ì •ë ¬ ë°˜ì „
        } else {
            sortConfig.column = columnKey;
            sortConfig.order = 'asc';
        }

        updateTable(); // ğŸ”¥ ì •ë ¬ í›„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    });
});

</script>

</body>
</html>

