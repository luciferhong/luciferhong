<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>[ë£¨ì‹œí¼í™] í™ê¸‰ì§€ë„</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=hcuap73kdc"></script>
    <style>
    #map {
		width: 100%;
		height: calc(100vh - 160px); /* ğŸ”¥ í™”ë©´ ë†’ì´ì—ì„œ í•„í„° ì»¨í…Œì´ë„ˆë¥¼ ì œì™¸í•œ ì˜ì—­ì„ ê³„ì‚° */
		min-height: 500px; /* ğŸ“Œ ìµœì†Œ ë†’ì´ ì„¤ì • (ê°€ë¡œê°€ ì¢ì•„ì§ˆ ë•Œ ëŒ€ë¹„) */
		max-height: 90vh; /* ğŸ“Œ ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šë„ë¡ ìµœëŒ€ ë†’ì´ ì„¤ì • */
	}

    .custom-infowindow {
        padding: 6px 10px;
        border-radius: 5px;
        border: 1px solid #333;
        font-size: 12px;
        font-weight: normal;
        text-align: left;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        color: white;
        position: absolute;
        z-index: 10;
        white-space: nowrap;
        cursor: grab;
        transition: border 0.2s;
    }
    .selected {
        border: 2px solid red !important;
    }
    #filterContainer {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #f9f9f9;
    }

    #yearFilter {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    #yearFilter label {
        display: flex;
        align-items: center;
        padding: 4px 6px;
        border-radius: 5px;
        background: #ffffff;
        border: 1px solid #ccc;
        cursor: pointer;
    }

    #yearFilter input[type="checkbox"] {
        margin-right: 4px;
    }

    /* âœ… ê¸°ë³¸ ì²´í¬ë°•ìŠ¤ (ë¼ë²¨ í‘œì‹œ, í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ) â†’ ì£¼í™©ìƒ‰ */
    #filterContainer input[type="checkbox"] {
        accent-color: orange;
    }

    /* âœ… ì…ì£¼ì‹œê¸° ì²´í¬ë°•ìŠ¤ (ë…„ë„ í•„í„°) â†’ íŒŒë€ìƒ‰ */
    #yearFilter input[type="checkbox"] {
        accent-color: initial;
    }
</style>


</head>
<body>

<h1>[ë£¨ì‹œí¼í™] í™ê¸‰ì§€ë„</h1>
<div id="filterContainer">
    <label>ì‹œë„: <select id="sidoFilter" style="width: 100px;"></select></label>
    <label>ì‹œêµ°êµ¬: 
        <select id="sigunguFilter" style="width: 100px;" disabled>
            <option value="">ì „ì²´</option>
        </select>
    </label>
    <label><input type="checkbox" id="toggleTextBox" checked> ë¼ë²¨ í‘œì‹œ</label>
    <label><input type="checkbox" id="toggleTextWrap" checked> ë¼ë²¨ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ</label>
       &nbsp;&nbsp;&nbsp; ì…ì£¼ì‹œê¸°
    <div id="yearFilter"></div>
</div>


<div id="map"></div>

<script>
    var map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(37.5665, 126.9780),
        zoom: 12
    });

    var markers = [];
    var showTextBoxes = true;
    var enableTextWrap = true;
    var selectedYears = new Set();
    var currentYear = new Date().getFullYear();
    var activeTextBox = null;
    var moveStep = 5;
	var selectedSido = "";
    var selectedSigungu = "";
    var sidoData = {};

    function getBackgroundColor(apprYear) {
        apprYear = parseInt(apprYear);
        if (isNaN(apprYear)) return "#FFFFFF";

        const yearDiff = apprYear - currentYear;
        if (yearDiff === 0) return "#FC2C2C";
        if (yearDiff === 1) return "#F25E04";
        if (yearDiff === 2) return "#F79905";
        if (yearDiff === 3) return "#EEA362";
        return "#DDC40D";
    }

    function getMarkerSize(households) {
        households = parseInt(households);
        if (isNaN(households)) return { width: 24, height: 34, textOffsetX: 30, textOffsetY: -5 };

        if (households >= 1000) return { width: 60, height: 84, textOffsetX: 50, textOffsetY: 15 };
        if (households >= 500) return { width: 50, height: 64, textOffsetX: 40, textOffsetY: 7 };
        return { width: 40, height: 44, textOffsetX: 30, textOffsetY: -5 };
    }

    async function loadMarkers() {
        console.log("loadMarkers");
        const response = await fetch("markers.txt");
        const text = await response.text();
        const rows = text.trim().split("\n");

        let yearSet = new Set();
        let tempMarkers = [];

        rows.forEach((row, index) => {
            if (index === 0) return;
            const cols = row.split("\t");

            const lat = parseFloat(cols[cols.length - 1]);
            const lon = parseFloat(cols[cols.length - 2]);
            const sido = cols[0];
            const sigungu = cols[1];
            const name = cols[4];
            const appr_dt = cols[6].substring(0, 4);
            const households = cols[7];

            if (!isNaN(lat) && !isNaN(lon)) {
                yearSet.add(appr_dt);
                if (!sidoData[sido]) sidoData[sido] = new Set();
                sidoData[sido].add(sigungu);

                let bgColor = getBackgroundColor(appr_dt);
				let markerSize = getMarkerSize(households);

				let marker = new naver.maps.Marker({
					position: new naver.maps.LatLng(lat, lon),
					map: null,
					data: { sido, sigungu, appr_dt, name, households, bgColor, markerSize }
				});


                tempMarkers.push(marker);
            }
        });
		updateYearFilters(yearSet);
        updateSidoFilters();
        markers = tempMarkers;
        updateMarkers();
    }


	function updateSidoFilters() {
        const sidoFilter = document.getElementById("sidoFilter");
        sidoFilter.innerHTML = '<option value="">ì „ì²´</option>';
        Object.keys(sidoData).forEach(sido => {
            let option = document.createElement("option");
            option.value = sido;
            option.textContent = sido;
            sidoFilter.appendChild(option);
        });
    }

    function updateSigunguFilters() {
        const sigunguFilter = document.getElementById("sigunguFilter");
        sigunguFilter.innerHTML = '<option value="">ì „ì²´</option>';
        if (selectedSido && sidoData[selectedSido]) {
            sigunguFilter.disabled = false;
            sidoData[selectedSido].forEach(sigungu => {
                let option = document.createElement("option");
                option.value = sigungu;
                option.textContent = sigungu;
                sigunguFilter.appendChild(option);
            });
        } else {
            sigunguFilter.disabled = true;
        }
    }
/*
	function updateSelectedYears() {
    selectedYears.clear();
    document.querySelectorAll(".year-checkbox").forEach(cb => {
        if (cb.checked) selectedYears.add(cb.value);
    });

    if (selectedYears.size === 0) {
        document.getElementById("selectAllYears").checked = true; // ëª¨ë“  ê°œë³„ ì²´í¬ë°•ìŠ¤ê°€ í•´ì œë˜ë©´ "ì „ì²´" ì²´í¬
        selectedYears.add("ì „ì²´");
        markers.forEach(marker => {
            selectedYears.add(marker.data.appr_dt); // ëª¨ë“  ì—°ë„ ì¶”ê°€
        });
    }

    updateMarkers();
}
*/
function handleYearCheckboxChange() {
    selectedYears.clear();
    
    document.querySelectorAll(".year-checkbox:checked").forEach(cb => {
        selectedYears.add(cb.value);
    });

    // âœ… ëª¨ë“  ì²´í¬ë°•ìŠ¤ê°€ í•´ì œëœ ê²½ìš°, ë§ˆì»¤ ìˆ¨ê¸°ê³  í•¨ìˆ˜ ì¢…ë£Œ
    if (selectedYears.size === 0) {
        markers.forEach(marker => marker.setMap(null));
        return;
    }

    updateMarkers();
}







    function updateYearFilters(yearSet) {
    const yearFilterDiv = document.getElementById("yearFilter");
    yearFilterDiv.innerHTML = "";

    selectedYears.clear();

    // ë…„ë„ ì •ë ¬ (ì˜¤ë¦„ì°¨ìˆœ)
    const sortedYears = Array.from(yearSet).sort();

    sortedYears.forEach(year => {
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = year;
        checkbox.checked = true; // âœ… ì´ˆê¸° ë¡œë“œì‹œ ëª¨ë“  ë…„ë„ ì²´í¬
        checkbox.classList.add("year-checkbox");
        checkbox.addEventListener("change", handleYearCheckboxChange);

        const label = document.createElement("label");
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(` ${year}ë…„ `));

        yearFilterDiv.appendChild(label);

        selectedYears.add(year); // âœ… ì´ˆê¸° ë¡œë“œì‹œ ëª¨ë“  ì—°ë„ë¥¼ ì„ íƒ
    });

    updateMarkers();
}




var activeMarker = null; // ğŸ”¥ í˜„ì¬ ì„ íƒëœ ë§ˆì»¤
var activeMarkerElement = null; // ğŸ”¥ í˜„ì¬ ì„ íƒëœ ë§ˆì»¤ì˜ ìš”ì†Œ (í…Œë‘ë¦¬ ë³€ê²½ìš©)

// âœ… ğŸ”¥ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì„ íƒëœ ê²½ìš° ê°•ì¡°)
function updateMarkerSelection(markerElement, isSelected) {
    if (markerElement) {
        if (isSelected) {
            markerElement.classList.add("selected"); // ğŸ”¥ ë¹¨ê°„ í…Œë‘ë¦¬ ì¶”ê°€
        } else {
            markerElement.classList.remove("selected"); // ğŸ”¥ ì›ë˜ëŒ€ë¡œ ë³µê·€
        }
    }
}

function updateMarkers() {
    selectedYears.clear();
    document.querySelectorAll("#yearFilter input[type='checkbox']:checked").forEach(cb => {
        selectedYears.add(cb.value);
    });

    const bounds = map.getBounds();

    markers.forEach((marker, index) => {
        const { sido, sigungu, appr_dt, name, households, bgColor, markerSize } = marker.data;
        const inBounds = bounds.hasLatLng(marker.getPosition());

        const isYearSelected = selectedYears.has(appr_dt);
        const isSidoSelected = !selectedSido || marker.data.sido === selectedSido;
        const isSigunguSelected = !selectedSigungu || marker.data.sigungu === selectedSigungu;
        const visible = isYearSelected && isSidoSelected && isSigunguSelected;

        if (visible && inBounds) {
            let textContent = enableTextWrap 
                ? `${name} <br> ${appr_dt} (${households}ì„¸ëŒ€)` 
                : `${name} ${appr_dt} (${households}ì„¸ëŒ€)`;

            let newContent = `
                <div class="marker-container" style="display: flex; align-items: center; position: relative;">
                    <img src="icon.png" style="width:${markerSize.width}px; height:${markerSize.height}px;">
                    <div class="custom-infowindow" 
                        data-marker-index="${index}" 
                        style="background:${bgColor}; 
                               left: ${markerSize.textOffsetX}px; 
                               top: ${markerSize.textOffsetY}px;
                               display: ${showTextBoxes ? 'block' : 'none'};">
                        ${textContent}
                    </div>
                </div>
            `;

            marker.setIcon({ content: newContent, anchor: new naver.maps.Point(markerSize.width / 2, markerSize.height) });
            marker.setMap(map);
        } else {
            marker.setMap(null);
        }
    });

    // âœ… ğŸ”¥ "ìš°í´ë¦­" ì´ë²¤íŠ¸ ì¶”ê°€ (ë§ˆì»¤ ì„ íƒ)
    setTimeout(() => {
        document.querySelectorAll(".custom-infowindow").forEach(infoWindow => {
            infoWindow.addEventListener("contextmenu", function (event) {
                event.preventDefault(); // ê¸°ë³¸ ìš°í´ë¦­ ë©”ë‰´ ì œê±°
                const markerIndex = parseInt(this.getAttribute("data-marker-index"));

                // ğŸ”¥ ì´ì „ ì„ íƒëœ ë§ˆì»¤ì˜ í…Œë‘ë¦¬ ì œê±°
                if (activeMarkerElement) {
                    updateMarkerSelection(activeMarkerElement, false);
                }

                activeMarker = markers[markerIndex]; // ğŸ”¥ ì„ íƒí•œ ë§ˆì»¤ ì €ì¥
                activeMarkerElement = this; // ğŸ”¥ ì„ íƒí•œ ë§ˆì»¤ ìš”ì†Œ ì €ì¥
                updateMarkerSelection(activeMarkerElement, true); // ğŸ”¥ í…Œë‘ë¦¬ ì¶”ê°€
                console.log("ğŸ”¹ ì„ íƒëœ ë§ˆì»¤:", activeMarker);
            });
        });
    }, 500);
}

// âœ… ğŸ”¥ WASD í‚¤ ì…ë ¥ ì‹œ ì„ íƒëœ ë§ˆì»¤ ì´ë™
document.addEventListener("keydown", function (event) {
    if (!activeMarker) return; // ì„ íƒëœ ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ

    let position = activeMarker.getPosition();
    let lat = position.lat();
    let lng = position.lng();
    let step = 0.001; // ì´ë™ ê±°ë¦¬

    switch (event.key) {
        case "w":
        case "ã…ˆ":
            lat += step; // ìœ„ë¡œ ì´ë™
            break;
        case "s":
        case "ã„´":
            lat -= step; // ì•„ë˜ë¡œ ì´ë™
            break;
        case "a":
        case "ã…":
            lng -= step; // ì™¼ìª½ ì´ë™
            break;
        case "d":
        case "ã…‡":
            lng += step; // ì˜¤ë¥¸ìª½ ì´ë™
            break;
        case "Escape":
            if (activeMarkerElement) {
                updateMarkerSelection(activeMarkerElement, false); // ğŸ”¥ í…Œë‘ë¦¬ ì œê±°
            }
            activeMarker = null; // ğŸ”¥ ì„ íƒ í•´ì œ
            activeMarkerElement = null;
            console.log("âŒ ë§ˆì»¤ ì„ íƒ í•´ì œ");
            return;
    }

    let newPosition = new naver.maps.LatLng(lat, lng);
    activeMarker.setPosition(newPosition);
    console.log("â¡ï¸ ì´ë™í•œ ë§ˆì»¤:", newPosition);
});




    document.getElementById("toggleTextBox").addEventListener("change", function () {
        showTextBoxes = this.checked;
        updateMarkers();
    });

    document.getElementById("toggleTextWrap").addEventListener("change", function () {
        enableTextWrap = this.checked;
        updateMarkers();
    });


	naver.maps.Event.addListener(map, 'idle', updateMarkers);

    window.onload = function () {
        loadMarkers();
    };


	document.getElementById("sidoFilter").addEventListener("change", function() {
		selectedSido = this.value;
		selectedSigungu = ""; // ì‹œë„ë¥¼ ë³€ê²½í•˜ë©´ ì‹œêµ°êµ¬ ì´ˆê¸°í™”
		updateSigunguFilters();
		updateMarkers(); // ì‹œë„ ë³€ê²½ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
	});

	document.getElementById("sigunguFilter").addEventListener("change", function() {
		selectedSigungu = this.value;
		updateMarkers(); // ì‹œêµ°êµ¬ ë³€ê²½ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
	});

</script>

</body>
</html>
