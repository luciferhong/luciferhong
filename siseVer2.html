<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta id="dynamicViewport" name="viewport" content="width=device-width, initial-scale=0.85, user-scalable=no">

    <link rel="icon" href="route.png" type="image/png">
    <title>[ë£¨ì‹œí¼í™] ì‹œì„¸ì§€ë„ Ver.2</title>
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=9t8y33hyq8"></script>
	<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=...&ver=20250604"></script>




    <style>
        #map { width: 100%; height: calc(100vh - 160px); resize: both; }
        #controls { margin: 10px; }
        button { margin: 5px; padding: 10px; cursor: pointer; }

		/* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
		#locationButton {
			position: absolute;
			top: 90px; /* ğŸ”¹ ì§€ë„ ë‚´ë¶€ì˜ ìƒë‹¨ */
			left: 8px; /* ğŸ”¹ ì§€ë„ ë‚´ë¶€ì˜ ì™¼ìª½ */
			background-color: white;
			border: 2px solid gray;
			padding: 10px;
			border-radius: 50%;
			cursor: pointer;
			font-size: 12px;
			text-align: center;
			box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
			z-index: 1000; /* ğŸ”¹ ì§€ë„ ìœ„ì— í‘œì‹œ */
		}

		/* ìœ„ì¹˜ ì¶”ì  ì¢…ë£Œ ë²„íŠ¼ */
		#stopTrackingButton {
			position: absolute;
			top: 125px; /* ğŸ”¹ ì§€ë„ ë‚´ë¶€ì˜ ìƒë‹¨ */
			left: 60px; /* ğŸ”¹ í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ê³¼ ê°„ê²© ìœ ì§€ */
			background-color: white;
			border: 2px solid gray;
			padding: 10px;
			border-radius: 50%;
			cursor: pointer;
			font-size: 14px;
			text-align: center;
			box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
			z-index: 1000; /* ğŸ”¹ ì§€ë„ ìœ„ì— í‘œì‹œ */
		}


		#unitFilter {
			width: 45px; /* ìˆ«ì 3ìë¦¬(ìµœëŒ€ 999) ì…ë ¥ ê°€ëŠ¥ */
			height: 10px;
			font-size: 16px;
			text-align: center;
			border: 2px solid #4A90E2; /* íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
			border-radius: 8px;
			padding: 5px;
			outline: none;
			transition: all 0.3s ease-in-out;
		}

		#unitFilter:focus {
			border-color: #2D5DA7; /* í¬ì»¤ìŠ¤ ì‹œ ë” ì§„í•œ íŒŒë€ìƒ‰ */
			box-shadow: 0px 0px 5px rgba(74, 144, 226, 0.5);
		}

	#controls {
    display: flex; /* âœ… ê°€ë¡œ ì •ë ¬ */
    align-items: center; /* âœ… ë‚´ë¶€ ìš”ì†Œ ì„¸ë¡œ ì •ë ¬ */
    gap: 10px; /* âœ… ìš”ì†Œ ê°„ê²© ì¡°ì • */
	}

	#scaleControls {
		display: flex; /* âœ… ê°€ë¡œ ì •ë ¬ */
		align-items: center; /* âœ… ë²„íŠ¼ì´ ì²´í¬ë°•ìŠ¤ì™€ ê°™ì€ ë†’ì´ë¡œ */
		margin-left: 5px; /* âœ… ê°„ê²© ì¡°ì • */
	}

	#scaleControls button {
		width: 30px;
		height: 30px;
		font-size: 16px;
		font-weight: bold;
		background-color: white;
		border: 2px solid gray;
		border-radius: 5px;
		cursor: pointer;
		text-align: center;
		margin-left: 5px; /* âœ… ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
		box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
		display: flex;
		justify-content: center;
		align-items: center;
	}

	#scaleControls button:hover {
		background-color: #f0f0f0;
	}
	.fullscreen-btn {
		position: fixed;
		top: 170px;
		left: 20px;
		background-color: white;
		border: 2px solid gray;
		padding: 10px;
		border-radius: 50%;
		cursor: pointer;
		font-size: 14px;
		text-align: center;
		box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
		z-index: 10000; /* âœ… ìµœìƒë‹¨ ìœ ì§€ */
	}
#apartmentInfo {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border: 1px solid black;
    padding: 8px;
    width: auto;
    font-size: 16px;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    display: none;
    z-index: 10000;
    
    max-width: 90%;
    max-height: 50vh; /* âœ… í™”ë©´ ë†’ì´ì˜ 80%ê¹Œì§€ í™•ì¥ */
    overflow-y: auto; /* âœ… ë‚´ë¶€ ìŠ¤í¬ë¡¤ í™œì„±í™” */
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch; /* âœ… iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
}


#apartmentInfo table {
    width: auto; /* ğŸ”¹ í‘œ í¬ê¸°ë¥¼ ë‚´ìš©ì— ë§ê²Œ ìë™ ì¡°ì • */
    table-layout: auto; /* ğŸ”¹ í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ìë™ ì¡°ì • */
    border-collapse: collapse;
}

#apartmentInfo th, #apartmentInfo td {
    border: 1px solid black;
    padding: 2px 5px; /* ğŸ”¹ ë‚´ë¶€ ì—¬ë°± ìµœì†Œí™” */
    text-align: center;
    white-space: nowrap; /* ğŸ”¹ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
}

#apartmentInfo th {
    background: #f0f0f0;
    font-weight: bold;
}

#apartmentInfo .close-button {
    position: absolute;
    top: 5px;
    right: 8px;
    background: red;
    color: white;
    border: none;
    font-size: 14px;
    padding: 3px 6px;
    cursor: pointer;
    border-radius: 3px;
}
table {
    border-collapse: collapse; /* âœ… í…Œë‘ë¦¬ ì¤‘ë³µ ì œê±° */
    width: 100%; /* âœ… í…Œì´ë¸” í¬ê¸° ì¡°ì • */
}

td, th {
    border: 1px solid black; /* âœ… í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ í™•ì¸ */
    padding: 5px; /* âœ… ë‚´ë¶€ ì—¬ë°± ì¡°ì • */
    text-align: center;
    white-space: nowrap; /* âœ… ì¤„ë°”ê¿ˆ ë°©ì§€ */
}
buttonContainer {
    display: flex;
    justify-content: center; /* âœ… ë²„íŠ¼ë“¤ì„ ì¤‘ì•™ ì •ë ¬ */
    gap: 10px; /* âœ… ë²„íŠ¼ ê°„ê²© ì¡°ì • */
    margin-top: 10px;
}
 #toggleSiseMapLabel {
    display: none;
  }
.filter-group {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-left: 30px;
}

.filter-label {
  <!-- font-weight: bold; -->
  font-size: 14px;
}

.filter-input {
  width: 60px;
  padding: 2px 6px;
  font-size: 14px;
  border: 2px solid #4A90E2;
  border-radius: 6px;
  outline: none;
  transition: 0.3s;
  text-align: center;
}

.filter-input:focus {
  border-color: #2D5DA7;
  box-shadow: 0 0 5px rgba(74, 144, 226, 0.4);
}

.filter-tilde {
  font-size: 16px;
  margin: 0 4px;
}


    </style>
</head>
<body>
<h1 style="font-size: 20px; font-weight: bold; text-align: left;">
    [ë£¨ì‹œí¼í™] ì‹œì„¸ì§€ë„ Ver.2
</h1>

<div id="controls">
    <label for="unitFilter">ìµœì†Œì„¸ëŒ€ìˆ˜: </label>
    <input type="number" id="unitFilter" min="0" value="190">
    <label><input type="checkbox" id="toggleApartments" checked>ì•„íŒŒíŠ¸</label>
    <label><input type="checkbox" id="toggleSchools" >ì´ˆ</label>
	<label><input type="checkbox" id="toggleMiddleSchools" >ì¤‘</label>
	<label><input type="checkbox" id="toggleFacilities">í™˜ê²½</label>
	<label><input type="checkbox" id="toggleStarbucks">ìŠ¤ë²…</label>
	<label id="toggleSiseMapLabel"><input type="checkbox" id="toggleSiseMap" checked>ì‹œì„¸ì§€ë„</label>


<!-- ì˜ˆ: ì‹œì„¸ì§€ë„ ë²„íŠ¼ ê·¼ì²˜ -->
<div class="filter-group">
  <label for="filterPyeongFrom" class="filter-label">ğŸ í‰í˜• í•„í„°:</label>
  <input type="number" id="filterPyeongFrom" class="filter-input" placeholder="From">
  <span class="filter-tilde">~</span>
  <input type="number" id="filterPyeongTo" class="filter-input" placeholder="To">
</div>

<div class="filter-group">
  <label for="filterPriceFrom" class="filter-label">ğŸ’°ë§¤ë§¤ê°€ í•„í„°:</label>
  <input type="number" id="filterPriceFrom" class="filter-input" placeholder="From">
  <span class="filter-tilde">~</span>
  <input type="number" id="filterPriceTo" class="filter-input" placeholder="To">
</div>

<div class="filter-group">
  <label for="filterLeaseFrom" class="filter-label">ğŸ“¦ì „ì„¸ê°€ í•„í„°:</label>
  <input type="number" id="filterLeaseFrom" class="filter-input" placeholder="From">
  <span class="filter-tilde">~</span>
  <input type="number" id="filterLeaseTo" class="filter-input" placeholder="To">
</div>
<button id="resetFiltersBtn" style="margin-left: 6px; padding: 6px 10px; font-size: 13px; border-radius: 6px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer;">
  ğŸ”„ í•„í„° ì´ˆê¸°í™”
</button>

<button id="hideNoPriceBtn" style="margin-left: 6px; padding: 6px 10px; font-size: 13px; border-radius: 6px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer;">
 ğŸ™ˆ ì‹œì„¸ ì—†ëŠ” ì•„íŒŒíŠ¸ ìˆ¨ê¸°ê¸°
</button>





    <!-- âœ… ìŠ¤ì¼€ì¼ ì¡°ì • ë²„íŠ¼ì„ 'ì´ˆë“±í•™êµ' ì²´í¬ë°•ìŠ¤ ì˜†ìœ¼ë¡œ ì´ë™ 
    <div id="scaleControls">
		<label>ë°°ìœ¨</label>
        <button id="scaleUpButton">+</button>
        <button id="scaleDownButton">-</button>
    </div>
-->
</div>



    <div id="map"></div>
    <div id="controls">
        <button id="startPolyline" style="display: none;">ê²½ë¡œ ê·¸ë¦¬ê¸°</button>
		<button id="undoLastPointButton" style="display: none;">ì§ì „ ì·¨ì†Œ</button>
        <button id="completePolyline" style="display: none;">ê²½ë¡œ ê·¸ë¦¬ê¸° ì™„ë£Œ</button>
        <button id="downloadGPX" style="display: none;">GPX ë‹¤ìš´ë¡œë“œ</button>
        <button id="uploadGPX" style="display: none;">GPX ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="gpxFileInput" style="display: none;" accept=".gpx">
        <button id="clearMap" style="display: none;">ê²½ë¡œ ì´ˆê¸°í™”</button> 
<button id="siseExportBtn" style="display: block;">ì‹œì„¸ì§€ë„ ë°±ì—…</button>
<button id="siseImportBtn" style="display: block;">ì‹œì„¸ì§€ë„ ë³µì›</button>
<button id="siseResetBtn" style="display: block;">ì‹œì„¸ì§€ë„ ì´ˆê¸°í™”</button>
<button id="colorExportBtn" style="display: block;">ìƒ‰ìƒ ì„¤ì • ë°±ì—…</button>
<button id="colorImportBtn" style="display: block;">ìƒ‰ìƒ ì„¤ì • ë³µì›</button>
<button id="colorResetBtn" style="display: none;">ìƒ‰ìƒ ì„¤ì • ì´ˆê¸°í™”</button>
<button id="priceColorSettingsBtn">ğŸ’°ì°¨íŠ¸ ìƒ‰ìƒ ì„¤ì •</button>
<button id="yearColorSettingsBtn">ğŸ“…ì—°ì‹ ìƒ‰ìƒ ì„¤ì •</button>



    </div>
    <div id="locationButton" title="í˜„ì¬ ìœ„ì¹˜">ğŸ“</div> <!-- âœ… í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
    <div id="stopTrackingButton" style="display:none" title="ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€">ğŸ›‘</div> <!-- âœ… ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€ ë²„íŠ¼ -->
   

<div id="apartmentInfo" style="border: 1px solid black; padding: 10px; display:none">
    <p>ì•„íŒŒíŠ¸ ì •ë³´ë¥¼ í™•ì¸í•˜ë ¤ë©´ ë§ˆì»¤ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
</div>

<script>
 class MapHandler {

		

            constructor(map) {
                this.map = map;
                this.shapes = [];
                this.currentPath = [];
                this.currentPolyline = null;
                this.markers = [];
                this.initUI();
            }
				
            initUI() {
				document.getElementById("startPolyline").addEventListener("click", () => this.startPolylineMode());
				document.getElementById("undoLastPointButton").addEventListener("click", () => this.undoLastPoint());
				document.getElementById("completePolyline").addEventListener("click", () => this.completePolyline()); // âœ… ì¶”ê°€ë¨*				
				document.getElementById("downloadGPX").addEventListener("click", () => this.downloadGPX());
				 // âœ… ì‹œì„¸ì§€ë„ ë°±ì—… (ìµìŠ¤í¬íŠ¸)
				document.getElementById("siseExportBtn").addEventListener("click", () => {
					exportHongSiseToJSON();
				});
				document.getElementById("colorExportBtn").addEventListener("click", () => {
					exportColorSettingsToJSON();
				});
				document.getElementById("colorImportBtn").addEventListener("click", () => {
					const input = document.createElement("input");
					  input.type = "file";
					  input.accept = ".json";
					  input.onchange = () => {
						const file = input.files[0];
						if (file) {
						  importFromJSONForColor(file);
						}
					  };
					  input.click();
					});
				document.getElementById("colorResetBtn").addEventListener("click", () => {
					resetColorSettingsDB();
				});


				// âœ… ì‹œì„¸ì§€ë„ ë³µì› (ì„í¬íŠ¸)
				document.getElementById("siseImportBtn").addEventListener("click", () => {
					const input = document.createElement('input');
					input.type = 'file';
					input.accept = 'application/json';
					input.onchange = function (event) {
						const file = event.target.files[0];
						if (file) {
							importFromJSONToHongSise(file);
						}
					};
					input.click();
				});

				document.getElementById("siseResetBtn").addEventListener("click", () => {
					const confirmReset = confirm("âš ï¸ ì‹œì„¸ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œì„¸ì§€ë„ ë°±ì—…ì„ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤. \nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
					if (!confirmReset) return;

					const request = indexedDB.open("hongSise", 4);

					request.onsuccess = function (event) {
						const db = event.target.result;
						const storeNames = Array.from(db.objectStoreNames);
						const tx = db.transaction(storeNames, "readwrite");

						let clearCount = 0;
						let hasError = false;

						storeNames.forEach(storeName => {
							const store = tx.objectStore(storeName);
							const clearRequest = store.clear();

							clearRequest.onsuccess = () => {
								clearCount++;
								if (clearCount === storeNames.length && !hasError) {
									alert("âœ… ì‹œì„¸ì§€ë„ ë°ì´í„°ê°€ ì „ì²´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
									prevSiseMapState = "ì´ˆê¸°í™”";
									updateMarkers(window.map.getBounds());
								}
							};

							clearRequest.onerror = (e) => {
								console.error(`âŒ ${storeName} ì´ˆê¸°í™” ì‹¤íŒ¨:`, e.target.error);
								hasError = true;
								alert(`âŒ ${storeName} ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ`);
							};
						});
					};

					request.onerror = function (event) {
						console.error("âŒ hongSise DB ì—´ê¸° ì‹¤íŒ¨:", event);
						alert("âŒ ì‹œì„¸ì§€ë„ DB ì—°ê²° ì‹¤íŒ¨");
					};
				});

	


				document.getElementById("uploadGPX").addEventListener("click", () => document.getElementById("gpxFileInput").click());

				// ğŸ”¹ `this`ë¥¼ `MapHandler` ì¸ìŠ¤í„´ìŠ¤ë¡œ ìœ ì§€
				document.getElementById("gpxFileInput").addEventListener("change", this.handleFileChange.bind(this));

				document.getElementById("clearMap").addEventListener("click", () => this.clearMap());
				
				document.addEventListener("keydown", (e) => {
					if (e.key === "Escape") {
						this.completePolyline();
					} else if (e.key === "Backspace") {
						this.undoLastPoint();
					}
				});

				naver.maps.Event.addListener(this.map, "click", (e) => {
					if (!this.currentPolyline) {
						console.warn("âš ï¸ ê²½ë¡œ ê·¸ë¦¬ê¸° ëª¨ë“œê°€ ì•„ë‹˜");
						return; // ğŸš« ì‹¤í–‰ ì¤‘ë‹¨ (ì˜¤ë¥˜ ë°©ì§€)
					}
					this.currentPath.push(e.coord);
					this.currentPolyline.setPath(this.currentPath);
					this.addMilestoneMarker(e.coord);
				});

				naver.maps.Event.addListener(this.map, "rightclick", () => {
					this.completePolyline();
				});

			
			}

			handleFileChange(event) {
				const file = event.target.files[0];
				if (!file) return; // ì„ íƒëœ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ

				this.loadGPX(file);

				// ğŸ”¹ ë™ì¼í•œ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ input ê°’ ì´ˆê¸°í™”
				event.target.value = ""; 
			}


			startPolylineMode() {
				if (this.shapes.length > 0) {
					const userConfirmed = confirm("ì´ì „ì— ê·¸ë¦° ê²½ë¡œê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
					if (!userConfirmed) return;

					this.clearMap(); // ê¸°ì¡´ ê²½ë¡œ ì´ˆê¸°í™”
				}

				this.currentPath = [];
				this.markers = [];
				this.currentPolyline = new naver.maps.Polyline({
					map: this.map,
					path: this.currentPath,
					strokeColor: "#FF0000",
					strokeWeight: 3.33,
					strokeOpacity: 0.8
				});	
			}
		
			downloadGPX() {
				if (this.shapes.length === 0) {
					alert("ë‹¤ìš´ë¡œë“œí•  ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.");
					return;
				}

				let gpxData = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="MapHandler">\n  <trk>\n    <trkseg>\n`;
				
				this.shapes.forEach(({ polyline }) => {
					polyline.getPath().forEach((coord) => {
						gpxData += `      <trkpt lat="${coord.y}" lon="${coord.x}"></trkpt>\n`;
					});
				});

				gpxData += `    </trkseg>\n  </trk>\n</gpx>`;
				
				const blob = new Blob([gpxData], { type: "application/gpx+xml" });
				const a = document.createElement("a");
				a.href = URL.createObjectURL(blob);
				a.download = "route.gpx";
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
			}

            completePolyline() {
                if (this.currentPolyline && this.currentPath.length > 1) {
                    this.addStartEndMarkers();
                    this.shapes.push({ polyline: this.currentPolyline, markers: [...this.markers] });
                    this.currentPolyline = null;
                }
            }

            addMilestoneMarker(coord) {
                const marker = new naver.maps.Marker({
                    position: coord,
                    map: this.map,
                    icon: {
                        content: `<div style="width: 8px; height: 8px; background-color: #FF0000; border-radius: 50%; border: 2px solid #FFF;"></div>`,
                        anchor: new naver.maps.Point(4, 4)
                    }
                });
                this.markers.push(marker);
            }

            addStartEndMarkers() {
                if (this.currentPath.length < 2) return;
                this.createLabeledMarker(this.currentPath[0], "ì¶œë°œ");
                this.createEndMarker(this.currentPath[this.currentPath.length - 1]);
            }

            createLabeledMarker(coord, label) {
                const marker = new naver.maps.Marker({
                    position: coord,
                    map: this.map,
                    icon: {
                        content: `<div style="padding:5px; background-color:#fff; border:1px solid #000; text-align:center;">
                                    <span style="font-size:12px; font-weight:bold; color:#f00;">${label}</span>
                                  </div>`
                    }
                });
                this.markers.push(marker);
            }
			clearMap() {
				if (!Array.isArray(this.shapes)) {
					this.shapes = []; // shapesê°€ ë°°ì—´ì´ ì•„ë‹ˆë©´ ì´ˆê¸°í™”
				}

				// ê¸°ì¡´ ê²½ë¡œ ë° ë§ˆì»¤ ì œê±°
				this.shapes.forEach(({ polyline, markers }) => {
					if (polyline) polyline.setMap(null);
					if (Array.isArray(markers)) {
						markers.forEach(marker => marker.setMap(null));
					}
				});

				// ğŸ”¹ ì¶œë°œ & ë„ì°© ë§ˆì»¤ ì‚­ì œ
				if (Array.isArray(this.markers)) {
					this.markers.forEach(marker => marker.setMap(null));
				}

				// ğŸ”¹ ë„ì°© ë§ˆì»¤ ì‚­ì œ ì¶”ê°€
				if (this.endMarker) {
					this.endMarker.setMap(null);
					this.endMarker = null; // ë„ì°© ë§ˆì»¤ ë³€ìˆ˜ ì´ˆê¸°í™”
				}

				// ë°ì´í„° ì´ˆê¸°í™”
				this.shapes = [];
				this.markers = [];
				this.currentPath = [];
				this.currentPolyline = null;
			}

		loadGPX(file) {

			this.clearMap();
			const reader = new FileReader();
			reader.onload = (event) => {
				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(event.target.result, "text/xml");

				const trkpts = xmlDoc.getElementsByTagName("trkpt");
				if (trkpts.length === 0) {
					alert("ìœ íš¨í•œ GPX íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
					return;
				}

				let path = [];
				for (let i = 0; i < trkpts.length; i++) {
					const lat = parseFloat(trkpts[i].getAttribute("lat"));
					const lon = parseFloat(trkpts[i].getAttribute("lon"));
					path.push(new naver.maps.LatLng(lat, lon));
				}

				this.drawGPXPath(path);
				this.updateEndMarker(path); // ğŸ”¹ GPX ë¡œë“œ í›„ ë„ì°© ë§ˆì»¤ ì—…ë°ì´íŠ¸
			};
			reader.readAsText(file);
		}

		updateEndMarker(path) {
			if (path.length < 2) return; // ìœ íš¨í•œ ê²½ë¡œê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ

			const totalDistance = this.calculateTotalDistance(path); // ê±°ë¦¬ ì¬ê³„ì‚°
			const formattedDistance = totalDistance >= 1000 
				? (totalDistance / 1000).toFixed(2) + "km" 
				: totalDistance.toFixed(0) + "m";

			const estimatedTime = this.calculateWalkingTime(totalDistance / 1000); // ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
			const label = `ë„ì°©<br>${formattedDistance}<br>${estimatedTime}<br>(ì‹œì† 4km ê¸°ì¤€)`;

			// ê¸°ì¡´ ë„ì°© ë§ˆì»¤ ì‚­ì œ
			if (this.endMarker) this.endMarker.setMap(null);

			// ìƒˆ ë„ì°© ë§ˆì»¤ ì¶”ê°€
			this.endMarker = new naver.maps.Marker({
				position: path[path.length - 1],
				map: this.map,
				icon: {
					content: `<div style="padding:5px; background-color:#fff; border:1px solid #000; text-align:center;">
								<span style="font-size:12px; font-weight:bold; color:#f00;">${label}</span>
							  </div>`
				}
			});
		}




		drawGPXPath(path) {
			if (path.length < 2) {
				alert("ê²½ë¡œ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
				return;
			}

			const polyline = new naver.maps.Polyline({
				map: this.map,
				path: path,
				strokeColor: "#0000FF", // GPX ê²½ë¡œ ìƒ‰ìƒ (íŒŒë€ìƒ‰)
				strokeWeight: 3.33,
				strokeOpacity: 0.8
			});

			this.shapes.push({ polyline });

			this.createLabeledMarker(path[0], "ì¶œë°œ");
			this.createEndMarker(path[path.length - 1]);
		}

		createEndMarker(coord) {
			const totalDistance = this.calculateTotalDistance(); // m ë‹¨ìœ„ë¡œ ê°€ì ¸ì˜´
			const formattedDistance = totalDistance >= 1000 
				? (totalDistance / 1000).toFixed(2) + "km" 
				: totalDistance.toFixed(0) + "m";

			const estimatedTime = this.calculateWalkingTime(totalDistance / 1000); // km ë‹¨ìœ„ë¡œ ë³€í™˜
			const label = `ë„ì°©<br>${formattedDistance}<br>${estimatedTime}<br>(ì‹œì† 4km ê¸°ì¤€)`;

			const marker = new naver.maps.Marker({
				position: coord,
				map: this.map,
				icon: {
					content: `<div style="padding:5px; background-color:#fff; border:1px solid #000; text-align:center;">
								<span style="font-size:12px; font-weight:bold; color:#f00;">${label}</span>
							  </div>`
				}
			});
			this.markers.push(marker);
		}


		calculateTotalDistance(path = this.currentPath) {
			if (!Array.isArray(path) || path.length < 2) {
				return 0; // ğŸ”¹ ê²½ë¡œê°€ ì—†ìœ¼ë©´ ê±°ë¦¬ 0 ë°˜í™˜
			}

			let total = 0;
			for (let i = 1; i < path.length; i++) {
				total += this.computeDistance(path[i - 1], path[i]);
			}
			return total; // ê±°ë¦¬ ë°˜í™˜ (m ë‹¨ìœ„)
		}




		computeDistance(coord1, coord2) {
			const R = 6371000;
			const lat1 = coord1.y * Math.PI / 180;
			const lat2 = coord2.y * Math.PI / 180;
			const deltaLat = (coord2.y - coord1.y) * Math.PI / 180;
			const deltaLng = (coord2.x - coord1.x) * Math.PI / 180;

			const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
					  Math.cos(lat1) * Math.cos(lat2) *
					  Math.sin(deltaLng / 2) * Math.sin(deltaLng / 2);
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
			return R * c;
		}

        calculateWalkingTime(distanceKm) { 
			const speed = 4; // ì‹œì† 4km
			const hours = Math.floor(distanceKm / speed);
			const minutes = Math.round((distanceKm % speed) * 60 / speed);
			return (hours > 0 ? `${hours}ì‹œê°„ ${minutes}ë¶„` : `${minutes}ë¶„`);
		}


        undoLastPoint() {
			if (this.currentPath.length > 0) {
				this.currentPath.pop(); // ë§ˆì§€ë§‰ ì¢Œí‘œ ì‚­ì œ
				this.currentPolyline.setPath(this.currentPath); // ë°˜ì˜

				// ë§ˆì§€ë§‰ ë§ˆì»¤ ì‚­ì œ
				const lastMarker = this.markers.pop();
				if (lastMarker) lastMarker.setMap(null);
			}
		}

    }




	const mapElement = document.getElementById('map');

	function getMapSize() {
		return new naver.maps.Size(mapElement.offsetWidth, mapElement.offsetHeight);
	}

	let isTracking = false; // âœ… ìœ„ì¹˜ ì¶”ì  ì—¬ë¶€ (true: ì¶”ì  ì¤‘)

	document.getElementById("locationButton").addEventListener("click", () => {
		if (!window.map || !(window.map instanceof naver.maps.Map)) {
			console.error("ë„¤ì´ë²„ ì§€ë„ ê°ì²´ê°€ ì˜¬ë°”ë¥´ê²Œ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
			return;
		}

		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(
				(position) => {
					updateUserLocation(position, true); // âœ… ê°•ì œ ì´ë™ (true)
					startTracking(); // âœ… ìœ„ì¹˜ ì¶”ì  ì‹œì‘
				},
				(error) => {
					alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
				}
			);
		} else {
			alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
		}
	});

	function startTracking() {
		if (navigator.geolocation) {
			isTracking = true; // âœ… ìœ„ì¹˜ ì¶”ì  í™œì„±í™”
			window.watchId = navigator.geolocation.watchPosition(
				(position) => {
					updateUserLocation(position, false); // âœ… ì„¼í„° ì´ë™ X (false)
				},
				(error) => {
					alert("ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				},
				{ enableHighAccuracy: true }
			);
			//console.log("ìœ„ì¹˜ ì¶”ì  ì‹œì‘ (watchId):", window.watchId);
		}
	}

	function stopTracking() {
		if (window.watchId !== null) {
			navigator.geolocation.clearWatch(window.watchId);
			//console.log("ìœ„ì¹˜ ì¶”ì ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. watchId:", window.watchId);
			window.watchId = null;
			isTracking = false; // âœ… ìœ„ì¹˜ ì¶”ì  ë¹„í™œì„±í™”

			// âœ… ë§ˆì»¤ ì œê±°
			if (window.currentLocationMarker) {
				window.currentLocationMarker.setMap(null);
				window.currentLocationMarker = null;
			}
		} else {
			console.warn("ìœ„ì¹˜ ì¶”ì ì´ ì´ë¯¸ ì¤‘ì§€ëœ ìƒíƒœì…ë‹ˆë‹¤.");
		}
	}

	// âœ… "ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€" ë²„íŠ¼ ì´ë²¤íŠ¸
	document.getElementById("stopTrackingButton").addEventListener("click", stopTracking);

	function updateUserLocation(position, forceCenter = false) {
		const lat = position.coords.latitude;
		const lon = position.coords.longitude;
		const currentLocation = new naver.maps.LatLng(lat, lon);

		//console.log("í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:", currentLocation, "ê°•ì œ ì´ë™ ì—¬ë¶€:", forceCenter);

		// âœ… ìœ„ì¹˜ ì¶”ì  ì¤‘ì´ ì•„ë‹ˆê±°ë‚˜, ê°•ì œ ì´ë™ í”Œë˜ê·¸ê°€ trueì¼ ë•Œë§Œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
		if (!isTracking || forceCenter) {
			window.map.setCenter(currentLocation);
			window.map.setZoom(16);
		}

		// âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
		if (window.currentLocationMarker) {
			window.currentLocationMarker.setMap(null);
		}

		// âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
		window.currentLocationMarker = new naver.maps.Marker({
			position: currentLocation,
			map: window.map,
			icon: {
				content: `<div style="width: 14px; height: 14px; background-color: red; border-radius: 50%; border: 3px solid white;"></div>`,
				anchor: new naver.maps.Point(7, 7)
			}
		});
	}


	let map; // âœ… ì „ì—­ ë³€ìˆ˜ ì„¤ì •
	let watchId = null; // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ ìœ„ì¹˜ ì¶”ì  ID ì €ì¥

	let locationCircle = null; // âœ… ë°˜ê²½ 500m ì› ê°ì²´ ì €ì¥
	let currentLocationMarker = null; // âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì €ì¥

	let apartmentData = []; // âœ… ì „ì²´ ì•„íŒŒíŠ¸ ë°ì´í„° ì €ì¥
	let apartmentMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ë§ˆì»¤ ì €ì¥
	let markerCluster = null; // âœ… ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§ ê°ì²´

	// âœ… 2. ì•„íŒŒíŠ¸ ë°ì´í„°ë¥¼ fetch()ë¡œ ê°€ì ¸ì˜¤ê¸°
	async function loadApartments() { 
    
		try {
			//const response = await fetch("https://your-github-username.github.io/data/apt.json"); // âœ… JSON íŒŒì¼ ì‚¬ìš©
			const response = await fetch("apt.json");
			const data = await response.json();

			apartmentData = data.map((apt, index) => ({
				id: apt.id,
				name: apt.name, // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				year: apt.year, // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				units: parseInt(apt.units, 10), // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				lat: parseFloat(apt.lat), // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				lng: parseFloat(apt.lng), // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
				lease: apt.lease // âœ… ì˜¬ë°”ë¥¸ ì†ì„± ì ‘ê·¼
			}));

			
			//console.log("âœ… ì•„íŒŒíŠ¸ ë°ì´í„° fetch ì™„ë£Œ");
			updateMarkers(window.map.getBounds())
		} catch (error) {
			console.error("âŒ ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
		}
	}



function closePopup() {
  //console.log("í˜¸ì¶œ")
    isPopupOpen = false;
    if (activeMarkerSet) {

        activeMarkerSet = null;
    }
    //console.log("âŒ ì´ë™ ëª¨ë“œ ì¢…ë£Œ");
}

function makeModalDraggable(modal) {
        let isDragging = false;
        let offsetX, offsetY;

        const header = document.createElement('div');
        header.className = 'draggable';
        header.style.padding = '10px';
        header.style.cursor = 'move';
        header.style.backgroundColor = '#f1f1f1';
        header.style.borderBottom = '1px solid #ccc';
        header.textContent = 'Drag me';

        modal.insertBefore(header, modal.firstChild);

        header.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - modal.offsetLeft;
            offsetY = e.clientY - modal.offsetTop;
            document.addEventListener('mousemove', moveModal);
            document.addEventListener('mouseup', stopDragging);
        });

        function moveModal(e) {
            if (isDragging) {
                modal.style.left = `${e.clientX - offsetX}px`;
                modal.style.top = `${e.clientY - offsetY}px`;
            }
        }

        function stopDragging() {
            isDragging = false;
            document.removeEventListener('mousemove', moveModal);
            document.removeEventListener('mouseup', stopDragging);
        }
    }


// âœ… ì‹œì„¸ ë§ˆì»¤ì—ì„œ í…Œì´ë¸”ì´ ì•„ë‹Œ ì˜ì—­ì„ ìš°í´ë¦­í•˜ë©´ ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
function addSiseMapMarkerLeftClickEvent(marker, markerElement) {
//console.log("addSiseMapMarkerLeftClickEvent ì‹¤í–‰ë¨");
    naver.maps.Event.addListener(marker, "click", (e) => {
        e.domEvent.preventDefault(); // ê¸°ë³¸ ìš°í´ë¦­ ë©”ë‰´ ë°©ì§€
        e.domEvent.stopPropagation();

        const tableContainer = markerElement.querySelector(".tableContainer");

        // âœ… í…Œì´ë¸” ì˜ì—­ì„ í´ë¦­í•œ ê²½ìš° ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬ì„ ë„ìš°ì§€ ì•ŠìŒ
        if (e.domEvent.target.closest(".tableContainer")) {
            return;
        }

        //console.log("ğŸš€ ë§ˆì»¤ ìš°í´ë¦­ ê°ì§€:", markerElement.dataset);

        let apartmentId = markerElement.dataset.apartmentId;
        if (!apartmentId) {
            console.error("âŒ apartmentId ì°¾ì„ ìˆ˜ ì—†ìŒ!");
            return;
        }

		let apartmentName = marker.apartmentName;
        if (!apartmentName) {
            console.error("âŒ apartmentId ì°¾ì„ ìˆ˜ ì—†ìŒ!");
            return;
        }
		
	


        showColorPickerModal(apartmentId, apartmentName,  markerElement.style.backgroundColor, markerElement.style.color, markerElement.style.fontSize, 
			(selectedColor, textColor, fontSize) => {
				markerElement.style.backgroundColor = selectedColor;
				markerElement.style.color = textColor;
				markerElement.style.fontSize = fontSize;

				updateMarkerStyleAndSave(apartmentId, selectedColor, textColor, fontSize); // âœ… apartmentIdê°€ ì •ìƒì ìœ¼ë¡œ ì „ë‹¬ë¨
			});



    });
}

  function updateMarkerStyleAndSave(id, selectedColor, textColor, fontSize) {
    getFromIndexedDB(id, "ì‹œì„¸1").then(async existingData => {
        let existingText = existingData?.text || generateDefaultTable();

        // âœ… ê¸°ë³¸ê°’ ê°•ì œ ì ìš©
        selectedColor = selectedColor?.trim() || '#9F9F9F';
        textColor = textColor?.trim() || '#FFFFFF';
        fontSize = fontSize?.trim() || '12px';

        //console.log(`ğŸ¨ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ ì‹œë„ (ID: ${id})`, { selectedColor, textColor, fontSize });

        // âœ… IndexedDB ì €ì¥
        await saveToIndexedDB(id, "ì‹œì„¸1", existingText, selectedColor, textColor, fontSize);

        // âœ… ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        let markerElement = document.querySelector(`[data-apartment-id='${id}']`);
        if (!markerElement) {
            console.error(`âŒ ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID: ${id}`);
            return;
        }

        // âœ… ğŸ’¡ ì¤‘ìš”: ê¸€ì ìƒ‰ìƒ ë° í¬ê¸° ì¦‰ì‹œ ë°˜ì˜
        markerElement.style.backgroundColor = selectedColor;
        markerElement.style.color = textColor;
        markerElement.style.setProperty("color", textColor, "important"); // âœ… ì¦‰ì‹œ ì ìš© (ì¤‘ìš”ë„ ë†’ì´ê¸°)
        markerElement.style.setProperty("font-size", fontSize, "important");

        markerElement.style.setProperty("font-size", fontSize, "important"); // âœ… ì¦‰ì‹œ ì ìš© (ì¤‘ìš”ë„ ë†’ì´ê¸°)


        // âœ… ë‚´ë¶€ í…Œì´ë¸”ì˜ ê¸€ììƒ‰ & í¬ê¸° ì¦‰ì‹œ ë°˜ì˜
        let tableContainer = markerElement.querySelector(".tableContainer");
        if (tableContainer) {
            tableContainer.style.color = textColor;
            tableContainer.style.fontSize = fontSize;
            tableContainer.style.setProperty("font-size", fontSize, "important");
        }

    }).catch(error => {
        console.error("âŒ IndexedDB ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    });
}








// âœ… ê¸°ë³¸ ë§ˆì»¤ ìƒì„± (ì‹œì„¸ì§€ë„ ì²´í¬ í•´ì œ ì‹œ)
function createDefaultMarker(apartment) {
    let yearValue = parseInt(apartment.year.slice(2), 10);
    let bgColor = "#FFFA00"; // yellow
    let fongColor = "white";

    if (yearValue > 50) bgColor = "#5C6267";
    else if (yearValue >= 20) bgColor = "#3E24D7";
    else if (yearValue >= 10) bgColor = "#EE1A24";

    if (yearValue >= 00 && yearValue < 10) fongColor = "black"; 

    const markerElement = document.createElement("div");
	markerElement.style = `
		background-color: ${bgColor};
		color: ${fongColor};
		border-radius: 6px;
		padding: 0px;
		border: 3px  black;  /* âœ… í…Œë‘ë¦¬ ë‘ê»˜ 2px, ê²€ì •ìƒ‰ */
		text-align: center;
		font-size: 12px;
		font-weight: bold;
		box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
		white-space: nowrap;
		display: inline-block;
	`;

	const nameElement = document.createElement("div");
	nameElement.style = `
		background: white;
		color: black;
		font-size: 12px;
		font-weight: bold;
		display: flex; /* âœ… Flexbox ì‚¬ìš© */
		align-items: center;
		justify-content: center;
		padding: 2px 5px; /* âœ… ìµœì†Œ íŒ¨ë”© ìœ ì§€ */
		border-radius: 3px;
		min-width: 85px; /* âœ… ìµœì†Œ ë„ˆë¹„ ê³ ì • */
		max-width: 85px; /* âœ… ìµœëŒ€ ë„ˆë¹„ ê³ ì • */
		overflow: hidden;
		text-overflow: ellipsis;
	`;

	const detailsElement = document.createElement("div");
	detailsElement.style = `
		font-size: 12px;
		padding: 2px 5px;
		min-width: 85px; /* âœ… ì„¸ë¶€ ì •ë³´ë„ ìµœì†Œ í¬ê¸° ë™ì¼ */
		max-width: 85px;
		display: flex;
		justify-content: center;
	`;


    nameElement.textContent = apartment.name.length > 7 ? apartment.name.slice(0, 6) + "..." : apartment.name;
    detailsElement.textContent = `${apartment.year.slice(-5)} ${apartment.units}ì„¸ëŒ€`;

    markerElement.appendChild(nameElement);
    markerElement.appendChild(detailsElement);


		// âœ… ë§ˆì»¤ í´ë¦­ ì‹œ ê°€ë¡œ ê¸¸ì´ í™•ì¥ â†’ 3ì´ˆ í›„ ë‹¤ì‹œ ì¶•ì†Œ
    

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(apartment.lat, apartment.lng),
        map: window.map,
        icon: {
            content: markerElement,
            anchor: new naver.maps.Point(10, 30)
        }
    });
	marker.apartmentId = apartment.id; // âœ… ë§ˆì»¤ ê°ì²´ì— ì§ì ‘ ID ì €ì¥

	naver.maps.Event.addListener(marker, "click",  function(e) {
		showApartmentInfo(apartment.id, {
			x: e.offset.x,
			y: e.offset.y
		});
	});

	addMarkerRightClickEvent(marker, markerElement); // âœ… ë§ˆì»¤ ì„ íƒ ì´ë²¤íŠ¸ ë“±ë¡

	return marker;
}


let prevSiseMapState = null; // ğŸ”¹ ì „ì—­ ë³€ìˆ˜ë¡œ ì´ì „ ì‹œì„¸ì§€ë„ ìƒíƒœ ì €ì¥


function removeLinesAllBounds(bounds) {
    Object.entries(apartmentMarkers).forEach(([id, marker]) => {
        //const position = marker.getPosition();
        //const line = marker.lineToOrigin;

        //const isMarkerInside = bounds.hasLatLng(position);

   
            //console.log(`âŒ ë§ˆì»¤ ì œê±°ë¨: ${id}`);
			if(marker.movementLine){
				marker.movementLine.setMap(null);
				marker.movementLine = null;
			}
            marker.setMap(null);
            delete apartmentMarkers[id];

            // ì„ ë„ ê°™ì´ ì œê±°
           
                //console.log(`âŒ ì„ ë„ ê°™ì´ ì œê±°ë¨: ${id}`);
               
        
    });
}
/*
function removeLinesOutsideBounds(bounds) {
    Object.entries(apartmentMarkers).forEach(([id, marker]) => {
        const position = marker.getPosition();
        const line = marker.lineToOrigin;

        const isMarkerInside = bounds.hasLatLng(position);

        // ë§ˆì»¤ê°€ bounds ë°”ê¹¥ì´ë©´
        if (!isMarkerInside) {
            //console.log(`âŒ ë§ˆì»¤ ì œê±°ë¨: ${id}`);
			if(marker.movementLine){
				marker.movementLine.setMap(null);
				marker.movementLine = null;
			}
            marker.setMap(null);
            delete apartmentMarkers[id];

            // ì„ ë„ ê°™ì´ ì œê±°
            if (line) {
                //console.log(`âŒ ì„ ë„ ê°™ì´ ì œê±°ë¨: ${id}`);
                line.setMap(null);
                delete marker.lineToOrigin;
            }
        }
    });
}*/
function removeLinesOutsideBounds(bounds) {
    Object.entries(apartmentMarkers).forEach(([id, marker]) => {
        // activeMarkerëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ
        if (marker === activeMarker) return;

        const position = marker.getPosition();
        const isMarkerInside = bounds.hasLatLng(position);

        if (!isMarkerInside) {
            if (marker.movementLine) {
                marker.movementLine.setMap(null);
                marker.movementLine = null;
            }
            marker.setMap(null);
            delete apartmentMarkers[id];
        }
    });
}


function removeAllLines() {
	
     Object.entries(apartmentMarkers).forEach(([id, marker]) => {
        const position = marker.getPosition();
        const isMarkerInside = window.map.getBounds().hasLatLng(position);

        if (isMarkerInside) {
            // ğŸ”¥ ë²”ìœ„ ì•ˆì˜ ë§ˆì»¤ì— ì—°ê²°ëœ ì´ë™ì„  ì œê±°
            if (marker.movementLine) {
                marker.movementLine.setMap(null);
                marker.movementLine = null;
                //console.log(`ğŸ§¹ ${id}ì˜ ì´ë™ì„  ì œê±°ë¨`);
            }
        }
    });
}

	// âœ… 3. ì§€ë„ ì´ë™í•  ë•Œë§ˆë‹¤ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸ë§Œ ë§ˆì»¤ë¡œ í‘œì‹œ
	function updateMarkers(bounds, all = false) {
//console.log(all+"|"+hideNoPrice)
		if (!all && hideNoPrice) {
			// ìˆ¨ê¸°ê¸° ìƒíƒœì¼ ê²½ìš°, ë§ˆì»¤ ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¼
			all = true; // âœ… ìƒíƒœ ì´ˆê¸°í™” (í•„ìš” ì‹œ)
			hideNoPrice = false;
		}	
//console.log("all : "+all);
		if(all == false){
		//console.log("ë¶€ë¶„ì‚­ì œ");
			removeLinesOutsideBounds(bounds);
		}else if(all == true){
		//console.log("ì „ì²´ì‚­ì œ");
			removeLinesAllBounds(bounds);
		}
		//ë²”ìœ„ ë²—ì–´ë‚˜ë©´ ë§ˆì»¤ ì‚­ì œ


		const minUnits = parseInt(document.getElementById("unitFilter").value, 10) || 0;
		const showApartments = document.getElementById("toggleApartments").checked;
		const isSiseMapActive = document.getElementById("toggleSiseMap").checked;

		if (!showApartments || window.map.getZoom() < 14) return;

		const filtered = apartmentData.filter(apartment =>
			bounds.hasLatLng(new naver.maps.LatLng(apartment.lat, apartment.lng)) &&
			apartment.units >= minUnits
		);

		const newMarkers = [];

		// âœ… ì‹œì„¸ì§€ë„ ì²´í¬ ìƒíƒœê°€ ë°”ë€ ê²½ìš° â†’ ëª¨ë“  ë§ˆì»¤ ì œê±°
		if (prevSiseMapState !== isSiseMapActive) {
			Object.values(apartmentMarkers).forEach(marker => {
				if (marker instanceof naver.maps.Marker) {
					naver.maps.Event.clearInstanceListeners(marker);
					marker.setMap(null);
				}
			});
			apartmentMarkers = {}; // ìºì‹œ ì´ˆê¸°í™”
			prevSiseMapState = isSiseMapActive; // ìƒíƒœ ê°±ì‹ 
		}

		// âœ… ìƒˆ ë§ˆì»¤ ìƒì„± or ì¬ì‚¬ìš©
		filtered.forEach(apartment => {
			if (apartment.name.includes("ë„ì‹œí˜•") || apartment.name.includes("ìƒí™œí˜•")) return;
			let marker = apartmentMarkers[apartment.id];

			if (!marker) {
				marker = isSiseMapActive
					? renderSiseMapMarker(apartment)
					: createDefaultMarker(apartment);

				marker.__siseMap = isSiseMapActive;
				apartmentMarkers[apartment.id] = marker;
			}

			newMarkers.push(marker);
		});


		if (markerCluster) {
			markerCluster.setMarkers(newMarkers);
		}



	}




let schoolMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ í•™êµ ë§ˆì»¤ ì €ì¥

async function loadSchools() {
    try {
        const response = await fetch("eliSchools.json");
        const schools = await response.json();
        
        //console.log("âœ… í•™êµ ë°ì´í„° ë¡œë“œ ì™„ë£Œ", schools);

        window.schoolData = schools; // âœ… ì „ì²´ í•™êµ ë°ì´í„° ì €ì¥

        // âœ… ì´ˆê¸° ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateSchoolMarkers(window.map.getBounds());

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ í•™êµ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            const bounds = window.map.getBounds();
            updateSchoolMarkers(bounds);
        });

    } catch (error) {
        console.error("âŒ í•™êµ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}

function updateSchoolMarkers() {
    const showSchools = document.getElementById("toggleSchools").checked;

    // âœ… ê¸°ì¡´ í•™êµ ë§ˆì»¤ ì œê±°
    schoolMarkers.forEach(marker => marker.setMap(null));
    schoolMarkers = [];

    if (!showSchools) return; // ì´ˆë“±í•™êµ í‘œì‹œ ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ
	if (window.map.getZoom() < 14) { 
			return; // âœ… ì¤Œ ë ˆë²¨ì´ 14ë³´ë‹¤ ì‘ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨
	}
    let bounds = window.map.getBounds();
    let filteredSchools = window.schoolData.filter(school =>
        bounds.hasLatLng(new naver.maps.LatLng(school.latitude, school.longitude))
    );

    filteredSchools.forEach(school => {
    // âœ… ë§ˆì»¤ ì»¨í…Œì´ë„ˆë¥¼ markerElementë¡œ í™œìš©
    const markerElement = document.createElement("div");
    markerElement.style = "text-align: center; display: flex; flex-direction: column; align-items: center;";

    const markerIcon = document.createElement("img");
    markerIcon.src = "eliSchool.png";
    markerIcon.style = "width: 32px; height: 32px;";

    const infoBox = document.createElement("div");
    infoBox.style = `
        background: white;
        border: 1px solid gray;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
    `;
    infoBox.textContent = `${school.schoolName.replace(/ë“±í•™êµ/g, "")} (${school.studentCountPerClassroom}/${school.totalStudentCount})`;

    markerElement.appendChild(markerIcon);
    markerElement.appendChild(infoBox);

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(school.latitude, school.longitude),
        map: window.map,
        icon: { content: markerElement, anchor: new naver.maps.Point(16, 32) }
    });

    // âœ… ìš°í´ë¦­ ì´ë²¤íŠ¸ì— markerElement ì „ë‹¬ (í…Œë‘ë¦¬ í™œì„±í™” ê°€ëŠ¥)
    addMarkerRightClickEvent(marker, markerElement);

    schoolMarkers.push(marker);
});

}


// âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", async () => {
		await initIndexedDB();

	window.map = new naver.maps.Map("map", {
		center: new naver.maps.LatLng(37.5665, 126.9780),
		zoom: 15
	});

	async function restoreMapPositionFromHongSiseDB() {
  try {
    const pos = await getSettingFromHongSiseDB("mapPosition");
    //console.log("pos:", pos); // âœ… ê°ì²´ ê·¸ëŒ€ë¡œ ì¶œë ¥

    if (pos && pos.lat && pos.lng) {
      //console.log("ì§€ë„ ì´ë™");
      window.map.setCenter(new naver.maps.LatLng(pos.lat, pos.lng));
    }
  } catch (err) {
    console.warn("ì§€ë„ ìœ„ì¹˜ ë³µì› ì‹¤íŒ¨:", err);
  }
}


	await restoreMapPositionFromHongSiseDB();
		// âœ… `MapHandler` í´ë˜ìŠ¤ ìƒì„± í›„ ì§€ë„ ê°ì²´ì™€ ì—°ê²°
		new MapHandler(window.map);

		// âœ… ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
		

		// âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ì•„íŒŒíŠ¸ ë§ˆì»¤ ì—…ë°ì´íŠ¸
	naver.maps.Event.addListener(window.map, "idle", () => {
		const bounds = window.map.getBounds();
		updateMarkers(bounds);

		const center = window.map.getCenter();
		  setSettingToHongSiseDB("mapPosition", {
			lat: center.lat(),
			lng: center.lng()
		  });
	});

/*
naver.maps.Event.addListener(window.map, "idle", function () {
console.log("bounds_changed");
  setSettingToHongSiseDB();  // ì¢Œí‘œë§Œ ì €ì¥
});
*/
		console.log("âœ… ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ.");


    await loadSchools();
    await loadMiddleSchools();
	await loadApartmentsDetail();
    await loadFacilities();
    await loadStarbucks();



	try {
		await initColorSettingsDB(); // DB ì—°ê²°
 //console.log("ì´ˆê¸°í™”");
		const settings = await loadColorSettingsFromDB(); // DBì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
//console.log("ë¡œë“œ");
		if (settings) {
		  priceColorSettings = settings; // ë©”ëª¨ë¦¬ì— ì €ì¥
		  console.log("ğŸ¨ ì´ˆê¸° ìƒ‰ìƒ ì„¤ì • ë¶ˆëŸ¬ì˜´:", priceColorSettings);
		} else {
		  console.log("â„¹ï¸ ì €ì¥ëœ ìƒ‰ìƒ ì„¤ì • ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©");
		}
	  } catch (e) {
		console.error("âŒ ìƒ‰ìƒ ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨", e);
	  }


	try {
	  //await initColorSettingsDB(); // DB ì—°ê²°
	  window.yearColorSettings = await loadYearColorSettingsFromDB();
	  
	} catch (e) {
	  console.error("âŒ ì—°ì‹ ìƒ‰ìƒ ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨", e);
	}



	if (window.map) {
        setupRightClickEvent();
    } else {
        // âœ… ì§€ë„ ë¡œë“œ í›„ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•˜ëŠ” ë°©ì‹
        const checkMapLoaded = setInterval(() => {
            if (window.map) {
                clearInterval(checkMapLoaded);
                setupRightClickEvent();
            }
        }, 100); // ğŸ”¹ 100ms ê°„ê²©ìœ¼ë¡œ ì§€ë„ ë¡œë“œ í™•ì¸
    }


	await loadApartments();
	
	//í•„í„°ê°’ ë³€ê²½ ì´ë²¤íŠ¸
	document.getElementById("filterPyeongFrom").addEventListener("input", () => {
		updateMarkers(window.map.getBounds(), true);
	  });

	document.getElementById("filterPyeongTo").addEventListener("input", () => {
		updateMarkers(window.map.getBounds(), true);
	  });

	document.getElementById("unitFilter").addEventListener("input", () => {
		updateMarkers(window.map.getBounds(), true);
	 });
});

document.getElementById("toggleApartments").addEventListener("change", () => {
    updateMarkers(window.map.getBounds()); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});

document.getElementById("toggleSchools").addEventListener("change", () => {
    updateSchoolMarkers(); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});


let isFullscreen = false; // í˜„ì¬ ì „ì²´ í™”ë©´ ì—¬ë¶€ ì €ì¥
let originalHeight = document.getElementById("map").style.height; // ê¸°ì¡´ ì§€ë„ ë†’ì´ ì €ì¥

function toggleFullscreen() {
    let mapElement = document.getElementById("map");

    if (!isFullscreen) {
        // ğŸ”¹ ì „ì²´ í™”ë©´ ëª¨ë“œë¡œ ì „í™˜
        originalHeight = mapElement.style.height; // ì›ë˜ ë†’ì´ ì €ì¥
        mapElement.style.position = "fixed";
        mapElement.style.top = "0";
        mapElement.style.left = "0";
        mapElement.style.width = "100vw";
        mapElement.style.height = "100vh";
        mapElement.style.zIndex = "9999";
        document.body.style.overflow = "hidden"; // ìŠ¤í¬ë¡¤ ë°©ì§€
        isFullscreen = true;
    } else {
        // ğŸ”¹ ì›ë˜ ìƒíƒœë¡œ ë³µê·€
        mapElement.style.position = "";
        mapElement.style.top = "";
        mapElement.style.left = "";
        mapElement.style.width = "100%";
        mapElement.style.height = originalHeight; // ì €cì¥ëœ ë†’ì´ ë³µì›
        mapElement.style.zIndex = "";
        document.body.style.overflow = ""; // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
        isFullscreen = false;
    }

    // ì§€ë„ í¬ê¸° ê°±ì‹ 
    window.map.setSize(new naver.maps.Size(mapElement.clientWidth, mapElement.clientHeight));
}






let apartmentDetailData = {};

// JSON ë°ì´í„° ë¡œë“œ
async function loadApartmentsDetail() {
    try {
        //console.log("ğŸ“Œ JSON ë°ì´í„° ë¡œë“œ ì‹œì‘");

        // ğŸ”¹ ë‘ ê°œì˜ JSON íŒŒì¼ fetch()
        const [res1, res2] = await Promise.all([
            fetch("apartments1.json").then(res => res.json()),
            fetch("apartments2.json").then(res => res.json())
        ]);

        // ğŸ”¹ JSON ë³‘í•© (Object.assign() ì‚¬ìš©)
        apartmentDetailData = Object.assign({}, res1, res2);

        //console.log("âœ… ì•„íŒŒíŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", apartmentDetailData);

        // ğŸ”¹ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateMarkers(window.map.getBounds());

    } catch (error) {
        console.error("âŒ ì•„íŒŒíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }
}

   
// ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ
function showApartmentInfo(apartmentId, markerPosition) {
//console.log(apartmentId)
	// âœ… ì‹œì„¸ ì§€ë„ê°€ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ì•„íŒŒíŠ¸ ì •ë³´ í‘œì‹œ ì•ˆ í•¨
    if (document.getElementById("toggleSiseMap").checked) {
        //console.log("ğŸš« ì‹œì„¸ ì§€ë„ê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ ì•„íŒŒíŠ¸ ì •ë³´ í‘œì‹œ ì•ˆ í•¨");
        return;
    }
    apartmentId = String(apartmentId);
    if (!apartmentDetailData[apartmentId]) {
        alert("ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    let apt = apartmentDetailData[apartmentId];
	//let aptInfo = apartmentData[apartmentId];
	let aptInfo = apartmentData.find(apartment => String(apartment.id) === apartmentId);

    let leaseInfo = aptInfo ? aptInfo.lease : "ì •ë³´ ì—†ìŒ"; // âœ… lease ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    let typeInfo = apt.íƒ€ì…ì •ë³´ || [];

    let infoHtml = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; text-align: left;">${apt.ì•„íŒŒíŠ¸ëª…}</h3>
            <button onclick="openNaverRealEstate(${apartmentId})" 
                style="padding: 8px; background: #4A90E2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ë„¤ë¶€ ë°”ë¡œê°€ê¸°
            </button>
        </div>
        <p>ì…ì£¼ì‹œê¸°: ${apt.ì…ì£¼ì‹œê¸°}</p>
        <p>ì´ì„¸ëŒ€ìˆ˜: ${apt.ì´ì„¸ëŒ€ìˆ˜} (ì„ëŒ€ : ${leaseInfo})</p>
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <th>ê³µê¸‰í‰ìˆ˜</th>
                <th>ê³µê¸‰ã¡</th>
                <th>ì „ìš©ã¡</th>
                <th>êµ¬ì¡°</th>
                <th>ë°©</th>
                <th>í™”</th>
                <th>íƒ€ì…</th>
                <th>ì„¸ëŒ€ìˆ˜</th>
            </tr>`;

    typeInfo.forEach(type => {
        infoHtml += `
            <tr>
                <td>${type["ê³µê¸‰í‰ìˆ˜"]}</td>
				<td>${type["ê³µê¸‰ë©´ì "]}</td>
                <td>${type["ì „ìš©ë©´ì "]}</td>
                <td>${type["êµ¬ì¡°"]}</td>
                <td>${type["ë°© ê°¯ìˆ˜"]}</td>
                <td>${type["í™”ì¥ì‹¤ ê°¯ìˆ˜"]}</td>
                <td>${type["íƒ€ì…"]}</td>
                <td>${type["í‰í˜• ì„¸ëŒ€ìˆ˜"]}</td>
            </tr>`;
    });

	

    infoHtml += `</table>`;



	

    let infoDiv = document.getElementById("apartmentInfo");
    infoDiv.innerHTML = infoHtml;
    infoDiv.style.display = "block"; // âœ… í‘œì‹œ

// ğŸ”¹ ìœ„ì¹˜ ì¬í™•ì¸ (ê°•ì œ ì ìš©)
    setTimeout(() => {
        infoDiv.style.top = "50%";
        infoDiv.style.left = "50%";
        infoDiv.style.transform = "translate(-50%, -50%)";
    }, 10);




     event.stopPropagation();

}


// âœ… ë„¤ì´ë²„ ë¶€ë™ì‚° ë§í¬ ì—´ê¸° í•¨ìˆ˜ ì¶”ê°€
	function openNaverRealEstate(apartmentId) {
		let url = `https://new.land.naver.com/complexes/${apartmentId}`;
		window.open(url, "_blank");
	}

document.addEventListener("click", (event) => {
    const apartmentInfo = document.getElementById("apartmentInfo");

    // âœ… í´ë¦­í•œ ìš”ì†Œê°€ apartmentInfo ë‚´ë¶€ì¼ ê²½ìš° ìœ ì§€
    if (apartmentInfo.contains(event.target)) {
        return;
    }

    // âœ… í´ë¦­ ìˆœê°„ í‘œì‹œë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ 100ms ì§€ì—° í›„ ë‹«ê¸° (ë²„ë¸”ë§ ë°©ì§€)
    setTimeout(() => {
        if (apartmentInfo.style.display === "block") {
            apartmentInfo.style.display = "none";
        }
    }, 0);
});

document.getElementById("apartmentInfo").addEventListener("touchstart", function(event) {
    const infoDiv = event.currentTarget;
    infoDiv.dataset.startY = event.touches[0].clientY;
    infoDiv.dataset.startScrollTop = infoDiv.scrollTop;
}, { passive: false });

document.getElementById("apartmentInfo").addEventListener("touchmove", function(event) {
    const infoDiv = event.currentTarget;
    
    // ë‚´ë¶€ ìŠ¤í¬ë¡¤ì´ ê°€ëŠ¥í•œ ê²½ìš°
    if (infoDiv.scrollHeight > infoDiv.clientHeight) {
        let startY = parseFloat(infoDiv.dataset.startY);
        let startScrollTop = parseFloat(infoDiv.dataset.startScrollTop);
        let currentY = event.touches[0].clientY;
        let scrollDiff = startScrollTop + (startY - currentY);

        // âœ… ìµœìƒë‹¨ì—ì„œ ì•„ë˜ë¡œ ë‹¹ê¸°ë ¤ê³  í•  ë•Œ
        if (infoDiv.scrollTop <= 0 && scrollDiff < 0) {
            event.preventDefault();
        }
        
         // âœ… ìµœí•˜ë‹¨ì—ì„œ ìœ„ë¡œ ìŠ¤í¬ë¡¤í•  ë•Œ ì œí•œì„ í•´ì œ
		if (infoDiv.dataset.atBottom === "true" && scrollDiff > 0) {
			event.preventDefault();
			infoDiv.scrollTop = infoDiv.scrollHeight - infoDiv.clientHeight - 1; // âœ… ìŠ¤í¬ë¡¤ì„ ì¡°ì •í•˜ì—¬ ì •ìƒ ì‘ë™
		}

    } else {
        // âœ… ë‚´ë¶€ ìŠ¤í¬ë¡¤ì´ ì—†ëŠ” ê²½ìš° ë°”ë”” ìŠ¤í¬ë¡¤ ì°¨ë‹¨
        event.preventDefault();
    }
}, { passive: false });

document.addEventListener("touchmove", function(event) {
    const infoDiv = document.getElementById("apartmentInfo");

    if (infoDiv.style.display === "block") {
        if (infoDiv.scrollHeight <= infoDiv.clientHeight) {
            event.preventDefault(); // ë‚´ë¶€ ìŠ¤í¬ë¡¤ì´ ì—†ìœ¼ë©´ ë°”ë”” ìŠ¤í¬ë¡¤ ë§‰ê¸°
        }
    }
}, { passive: false });

let middleSchoolMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ì¤‘í•™êµ ë§ˆì»¤ ì €ì¥

async function loadMiddleSchools() {
    try {
        const response = await fetch("middleSchools.json");
        let middleSchools = await response.json();

        // âœ… ì¤‘ë³µ ì œê±°: í•™êµ IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì²« ë²ˆì§¸ ê°’ë§Œ ìœ ì§€
        const uniqueSchools = [];
        const seenIds = new Set();

        middleSchools.forEach(school => {
            if (!seenIds.has(school["í•™êµ ID"])) {
                seenIds.add(school["í•™êµ ID"]);
                uniqueSchools.push(school);
            }
        });

        //console.log("âœ… ì¤‘ë³µ ì œê±° ì™„ë£Œ: ì´", uniqueSchools.length, "ê°œ í•™êµ ë¡œë“œë¨");

        window.middleSchoolData = uniqueSchools; // âœ… ì¤‘ë³µ ì œê±°ëœ ë°ì´í„° ì €ì¥

        // âœ… ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateMiddleSchoolMarkers();

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ì¤‘í•™êµ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            updateMiddleSchoolMarkers();
        });

    } catch (error) {
        console.error("âŒ ì¤‘í•™êµ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}



function updateMiddleSchoolMarkers() {
    const showMiddleSchools = document.getElementById("toggleMiddleSchools").checked;
	
    // âœ… ê¸°ì¡´ ì¤‘í•™êµ ë§ˆì»¤ ì œê±°
    middleSchoolMarkers.forEach(marker => marker.setMap(null));
    middleSchoolMarkers = [];

    if (!showMiddleSchools) return; // ì¤‘í•™êµ í‘œì‹œ ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ
	
	if (window.map.getZoom() < 14) { 
        return; // âœ… ì¤Œ ë ˆë²¨ì´ 14ë³´ë‹¤ ì‘ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨
    }

    let bounds = window.map.getBounds();
    let filteredSchools = window.middleSchoolData.filter(school =>
        bounds.hasLatLng(new naver.maps.LatLng(school["ìœ„ë„"], school["ê²½ë„"]))
    );

    filteredSchools.forEach(school => {
    // âœ… ë§ˆì»¤ ì»¨í…Œì´ë„ˆë¥¼ markerElementë¡œ í™œìš©
    const markerElement = document.createElement("div");
    markerElement.style = "text-align: center; display: flex; flex-direction: column; align-items: center;";

    const markerIcon = document.createElement("img");
    markerIcon.src = "midSchool.png";
    markerIcon.style = "width: 32px; height: 32px;";

    const infoBox = document.createElement("div");
    infoBox.style = `
        background: white;
        border: 1px solid gray;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
    `;
    infoBox.textContent = `${school["í•™êµëª…"]} (${school["í•™ì—…ì„±ì·¨ë„"]}/${school["íŠ¹ëª©ê³ "]})`;

    markerElement.appendChild(markerIcon);
    markerElement.appendChild(infoBox);

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(school["ìœ„ë„"], school["ê²½ë„"]),
        map: window.map,
        icon: { content: markerElement, anchor: new naver.maps.Point(16, 32) }
    });

    // âœ… ìš°í´ë¦­ ì´ë²¤íŠ¸ì— markerElement ì „ë‹¬ (í…Œë‘ë¦¬ í™œì„±í™” ê°€ëŠ¥)
    addMarkerRightClickEvent(marker, markerElement);

    middleSchoolMarkers.push(marker);
});

}


// âœ… ì¤‘í•™êµ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
document.getElementById("toggleMiddleSchools").addEventListener("change", () => {
    updateMiddleSchoolMarkers(); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});

let facilityMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ì‹œì„¤ ë§ˆì»¤ ì €ì¥

async function loadFacilities() {
    try {
        const response = await fetch("facility.json");
        const facilities = await response.json();

        //console.log("âœ… ì‹œì„¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ", facilities);
        window.facilityData = facilities; // âœ… ì „ì²´ ì‹œì„¤ ë°ì´í„° ì €ì¥

        // âœ… ì´ˆê¸° ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateFacilityMarkers(window.map.getBounds());

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ì‹œì„¤ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            const bounds = window.map.getBounds();
            updateFacilityMarkers(bounds);
        });

    } catch (error) {
        console.error("âŒ ì‹œì„¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}

function updateFacilityMarkers() {
    const showFacilities = document.getElementById("toggleFacilities").checked;

    // âœ… ê¸°ì¡´ ì‹œì„¤ ë§ˆì»¤ ì œê±°
    facilityMarkers.forEach(marker => marker.setMap(null));
    facilityMarkers = [];

    if (!showFacilities) return; // ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ
    if (window.map.getZoom() < 14) return; // âœ… ì¤Œ ë ˆë²¨ì´ 14ë³´ë‹¤ ì‘ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨

    let bounds = window.map.getBounds();
    let filteredFacilities = window.facilityData.filter(facility =>
        bounds.hasLatLng(new naver.maps.LatLng(facility.lat, facility.lng))
    );

    filteredFacilities.forEach(facility => {
    let iconSrc = "default.png"; // ê¸°ë³¸ ì•„ì´ì½˜ (ì˜ˆì™¸ì²˜ë¦¬)
    if (facility.category === 10) {
        iconSrc = facility.description.includes("ë°±í™”ì ") ? "depart.png" : "mart.png";
    } else if (facility.category === 9) {
        iconSrc = "hospital.png";
    }

    // âœ… ë§ˆì»¤ ì»¨í…Œì´ë„ˆë¥¼ markerElementë¡œ í™œìš©
    const markerElement = document.createElement("div");
    markerElement.style = "text-align: center; display: flex; flex-direction: column; align-items: center;";

    const markerIcon = document.createElement("img");
    markerIcon.src = iconSrc;
    markerIcon.style = "width: 32px; height: 32px;";

    const infoBox = document.createElement("div");
    infoBox.style = `
        background: white;
        border: 1px solid gray;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
        display: inline-block;
        max-width: 140px;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
    `;

    if (facility.category === 10) {
        infoBox.textContent = `${facility.description} (${facility.name})`;
    } else if (facility.category === 9) {
        infoBox.textContent = `${facility.name}`;
    }

    markerElement.appendChild(markerIcon);
    markerElement.appendChild(infoBox);

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(facility.lat, facility.lng),
        map: window.map,
        icon: { content: markerElement, anchor: new naver.maps.Point(16, 32) }
    });

    // âœ… ìš°í´ë¦­ ì´ë²¤íŠ¸ì— markerElement ì „ë‹¬ (í…Œë‘ë¦¬ í™œì„±í™” ê°€ëŠ¥)
    addMarkerRightClickEvent(marker, markerElement);

    facilityMarkers.push(marker);
});

}

// âœ… ì‹œì„¤ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
document.getElementById("toggleFacilities").addEventListener("change", () => {
    updateFacilityMarkers(); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});

let starbucksMarkers = []; // âœ… ì§€ë„ì— í‘œì‹œëœ ìŠ¤íƒ€ë²…ìŠ¤ ë§ˆì»¤ ì €ì¥

async function loadStarbucks() {
    try {
        const response = await fetch("starbucks.json");
        const starbucks = await response.json();

        //console.log("âœ… ìŠ¤íƒ€ë²…ìŠ¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ", starbucks);
        window.starbucksData = starbucks; // âœ… ì „ì²´ ìŠ¤íƒ€ë²…ìŠ¤ ë°ì´í„° ì €ì¥

        // âœ… ì´ˆê¸° ë§ˆì»¤ ì—…ë°ì´íŠ¸
        updateStarbucksMarkers(window.map.getBounds());

        // âœ… ì§€ë„ ì´ë™ ì‹œ í˜„ì¬ ë²”ìœ„ ë‚´ ìŠ¤íƒ€ë²…ìŠ¤ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(window.map, "idle", function () {
            const bounds = window.map.getBounds();
            updateStarbucksMarkers(bounds);
        });

    } catch (error) {
        console.error("âŒ ìŠ¤íƒ€ë²…ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}

function updateStarbucksMarkers() {
    const showStarbucks = document.getElementById("toggleStarbucks").checked;

    // âœ… ê¸°ì¡´ ìŠ¤íƒ€ë²…ìŠ¤ ë§ˆì»¤ ì œê±°
    starbucksMarkers.forEach(marker => marker.setMap(null));
    starbucksMarkers = [];

    if (!showStarbucks) return; // ì²´í¬ í•´ì œ ì‹œ ì¢…ë£Œ
    if (window.map.getZoom() < 14) return; // âœ… ì¤Œ ë ˆë²¨ì´ 14ë³´ë‹¤ ì‘ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨

    let bounds = window.map.getBounds();
    let filteredStarbucks = window.starbucksData.filter(store =>
        bounds.hasLatLng(new naver.maps.LatLng(store.lat, store.lot))
    );

     filteredStarbucks.forEach(store => {
        let iconSrc = store.s_name.includes("R") ? "starbucksReserve.png" : "starbucks.png";

        // âœ… ë§ˆì»¤ ì»¨í…Œì´ë„ˆë¥¼ markerElementë¡œ í™œìš©
        const markerElement = document.createElement("div");
        markerElement.style = "text-align: center; display: flex; flex-direction: column; align-items: center;";

        const markerIcon = document.createElement("img");
        markerIcon.src = iconSrc;
        markerIcon.style = "width: 32px; height: 32px;";

        markerElement.appendChild(markerIcon);

        const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(store.lat, store.lot),
            map: window.map,
            icon: { content: markerElement, anchor: new naver.maps.Point(16, 32) }
        });

        // âœ… ìš°í´ë¦­ ì´ë²¤íŠ¸ì— markerElement ì „ë‹¬
        addMarkerRightClickEvent(marker, markerElement);

        starbucksMarkers.push(marker);
    });
}

// âœ… ìŠ¤íƒ€ë²…ìŠ¤ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
document.getElementById("toggleStarbucks").addEventListener("change", () => {
    updateStarbucksMarkers(); // âœ… ì¦‰ì‹œ ì—…ë°ì´íŠ¸
});


////////////////////////// ì´ë™ ì´ë²¤íŠ¸ //////////////////////////
var activeMarker = null; // âœ… í˜„ì¬ ì„ íƒëœ ë§ˆì»¤
var activeMarkerElement = null; // âœ… í˜„ì¬ ì„ íƒëœ ë§ˆì»¤ì˜ ìš”ì†Œ (í…Œë‘ë¦¬ ë³€ê²½ìš©)

// âœ… ğŸ”¥ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì„ íƒëœ ê²½ìš° ê°•ì¡°)
function updateMarkerSelection(markerElement, isSelected) {
    if (markerElement) {
        setTimeout(() => {
            markerElement.style.outline = isSelected ? "3px solid red" : "";
        }, 50); // âœ… DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸° í›„ ìŠ¤íƒ€ì¼ ì ìš©
    }
}


function addMarkerRightClickEvent(marker, markerElement) {
    naver.maps.Event.addListener(marker, "rightclick", (e) => {
        e.domEvent.preventDefault();
        e.domEvent.stopPropagation();

        const isSiseMapActive = document.getElementById("toggleSiseMap").checked;

        console.log("ğŸš€ ë§ˆì»¤ ìš°í´ë¦­ ê°ì§€ (ID: " + marker.apartmentId + ")");

        // âœ… ê¸°ì¡´ ì„ íƒëœ ë§ˆì»¤ í…Œë‘ë¦¬ ì œê±°
        if (activeMarkerElement) {
            updateMarkerSelection(activeMarkerElement, false);
        }

        // âœ… í˜„ì¬ ì„ íƒëœ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        window.activeMarker = marker;
        activeMarkerElement = markerElement; // âœ… ê¸°ì¡´ ë°©ì‹
        updateMarkerSelection(activeMarkerElement, true);

        // âœ… ë§Œì•½ ë§ˆì»¤ê°€ ì‹œì„¸ì§€ë„ ë§ˆì»¤ì´ë©´ `.siseMapMarker`ë¥¼ ë‹¤ì‹œ ì°¾ê³  ìŠ¤íƒ€ì¼ ì ìš©
        if (isSiseMapActive) {
            setTimeout(() => {
                const updatedMarkerElement = markerElement.querySelector(".siseMapMarker");
                if (updatedMarkerElement) {
                    activeMarkerElement = updatedMarkerElement;
                    updateMarkerSelection(updatedMarkerElement, true);
                }
            }, 100); // âœ… DOM ì—…ë°ì´íŠ¸ ëŒ€ê¸° í›„ ìŠ¤íƒ€ì¼ ì ìš©
        }
    });
}





// âœ… í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë“±ë¡
document.removeEventListener("keydown", handleKeyDown);
document.addEventListener("keydown", handleKeyDown);



function setupRightClickEvent() {
    let radiusCircle = null; // âœ… ë°˜ê²½ ì› ê°ì²´
    let centerMarker = null; // âœ… ë°˜ê²½ ì¤‘ì‹¬ ë§ˆì»¤

    // âœ… ì§€ë„ì—ì„œ ìš°í´ë¦­ ì‹œ (ë°˜ê²½ 1km ì› + ì¤‘ì‹¬ ë¹¨ê°„ ì  ì¶”ê°€)
    naver.maps.Event.addListener(window.map, "mousedown", function (e) {
        if (e.domEvent.button !== 2) return; // âœ… ìš°í´ë¦­ì´ ì•„ë‹ ê²½ìš° ë¬´ì‹œ

        let clickedPosition = e.coord; // âœ… ìš°í´ë¦­í•œ ìœ„ì¹˜ì˜ ì¢Œí‘œ
        //console.log("ğŸ“ ìš°í´ë¦­ ìœ„ì¹˜:", clickedPosition);

        // âœ… ì´ë¯¸ ë°˜ê²½ ì›ì´ ìˆëŠ” ê²½ìš°, ì œê±° í›„ ì¢…ë£Œ (í† ê¸€ ë°©ì‹)
        if (radiusCircle) {
            radiusCircle.setMap(null);
            radiusCircle = null;
        }
        if (centerMarker) {
            centerMarker.setMap(null);
            centerMarker = null;
            return; // âœ… ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±í•˜ì§€ ì•ŠìŒ
        }

        // âœ… ë°˜ê²½ 1km ì› ì¶”ê°€
        radiusCircle = new naver.maps.Circle({
            map: window.map,
            center: clickedPosition,
            radius: 1000, // âœ… ë°˜ê²½ 1km
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.08
        });

        // âœ… ë°˜ê²½ ì¤‘ì‹¬ì— ë¹¨ê°„ìƒ‰ ì‘ì€ ì  ì¶”ê°€
        centerMarker = new naver.maps.Marker({
            position: clickedPosition,
            map: window.map,
            icon: {
                content: `<div style="width: 8px; height: 8px; background-color: red; border-radius: 50%; border: 1px solid white;"></div>`,
                anchor: new naver.maps.Point(4, 4) // âœ… ì¤‘ì‹¬ ì •ë ¬
            }
        });

        // âœ… ì§€ë„ ì¤‘ì‹¬ì„ í´ë¦­í•œ ìœ„ì¹˜ë¡œ ì´ë™
        window.map.panTo(clickedPosition);
    });

    // âœ… ê¸°ë³¸ì ì¸ ìš°í´ë¦­ ë©”ë‰´ ë°©ì§€
    document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
    });

    //console.log("âœ… ì§€ë„ ë¡œë“œ ì™„ë£Œ í›„ ìš°í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡ë¨");
}

//////////////////////////////////ì‹œì„¸ ì§€ë„ ////////////////////////////




var activeMarkerSet = null;

// âœ… IndexedDB ì´ˆê¸°í™”
async function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open("hongSise", 4);

        request.onupgradeneeded = function(event) {
            const db = event.target.result;

            if (!db.objectStoreNames.contains("settings")) {
				db.createObjectStore("settings");
				console.log("âœ… settings store ìƒì„±ë¨");
			}

			if (!db.objectStoreNames.contains("apartments")) {
				const store = db.createObjectStore("apartments", { keyPath: "idType" });
				store.createIndex("id", "id", { unique: false });
				console.log("âœ… apartments store ìƒì„±ë¨");
			}
        };

        request.onsuccess = function(event) {
            console.log('ğŸ“Œ IndexedDB ì—°ê²° ì„±ê³µ (DB: hongSise)');
            resolve(event.target.result);
        };

        request.onerror = function(event) {
            console.error('âŒ IndexedDB ì—°ê²° ì‹¤íŒ¨:', event.target.error);
            reject(event.target.error);
        };
    });
}

// âœ… IndexedDB ì €ì¥ í•¨ìˆ˜
function saveToIndexedDB(id, type, text, color, textColor, fontSize) {
    const request = indexedDB.open("hongSise", 4);
    request.onsuccess = function(event) {
        const db = event.target.result;
        const transaction = db.transaction(["apartments"], "readwrite");
        const store = transaction.objectStore("apartments");
//console.log("2073 ; "+text);
        store.put({ idType: `${id}-${type}`, text, color, textColor, fontSize });

        transaction.oncomplete = () => console.log(`âœ… IndexedDB ì €ì¥ ì™„ë£Œ: ${id}`);
        transaction.onerror = (e) => console.error(`âŒ IndexedDB ì €ì¥ ì˜¤ë¥˜: ${e.target.error}`);

    };
	markerElement = document.querySelector(`[data-apartment-id='${id}']`);
	markerElement.style.maxWidth = '160px';


}
function getFromIndexedDB(id, type) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open("hongSise", 4);

        request.onerror = (event) => {
            reject("âŒ IndexedDB ì—´ê¸° ì˜¤ë¥˜: " + event.target.errorCode);
        };

        request.onsuccess = (event) => {
            const db = event.target.result;

            // âœ… apartments store ì¡´ì¬ í™•ì¸
            if (!db.objectStoreNames.contains("apartments")) {
                console.warn("âš ï¸ apartments storeê°€ ì—†ìŠµë‹ˆë‹¤.");
                resolve({ text: "", color: "#9F9F9F", textColor: "#ffffff", fontSize: "12px" });
                return;
            }

            try {
                const transaction = db.transaction(["apartments"], "readonly");
                const store = transaction.objectStore("apartments");
                const idType = `${id}-${type}`;
                const getRequest = store.get(idType);

                getRequest.onsuccess = () => {
                    if (getRequest.result) {
                        resolve(getRequest.result);
                    } else {
                        resolve({ text: "", color: "#9F9F9F", textColor: "#ffffff", fontSize: "12px" });
                    }
                };

                getRequest.onerror = () => {
                    reject("âŒ IndexedDB ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨");
                };
            } catch (e) {
                reject("âŒ íŠ¸ëœì­ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜: " + e.message);
            }
        };
    });
}

/*
document.getElementById("toggleSiseMap").addEventListener("change", function() {
    const isChecked = this.checked;

	document.getElementById("siseExportBtn").style.display = isChecked ? "inline-block" : "none";
    document.getElementById("siseImportBtn").style.display = isChecked ? "inline-block" : "none";
	document.getElementById("siseResetBtn").style.display = isChecked ? "inline-block" : "none";
	if(!isChecked){
		removeAllLines(window.map.getBounds());
	}
    updateMarkers(window.map.getBounds())
	
});
*/

// âœ… ê¸°ë³¸ ë§ˆì»¤ ìƒì„± (ì‹œì„¸ì§€ë„ ì²´í¬ í•´ì œ ì‹œ)
function renderSiseMapMarker(apartment) {
    let yearValue = apartment.year.slice(0,4);
    let bgColor = "#f9daae"; // ê¸°ë³¸ ë°°ê²½ìƒ‰
    let fontColor = "#000000"; // ê¸°ë³¸ ê¸€ììƒ‰

    if (Array.isArray(window.yearColorSettings) && window.yearColorSettings.length > 0) {
//console.log(yearValue  )
        const matched = window.yearColorSettings.find(setting => yearValue >= setting.from && yearValue <= setting.to);
//console.log(matched);
        if (matched) {
            bgColor = matched.color;
            fontColor = matched.fontColor;
        }
    } else {
        // ê¸°ì¡´ í•˜ë“œì½”ë”©ëœ ê°’ (fallback)
        if (yearValue > 50) bgColor = "#5C6267";
        else if (yearValue >= 20) bgColor = "#3E24D7";
        else if (yearValue >= 10) bgColor = "#EE1A24";

        if (yearValue >= 0 && yearValue < 10) fontColor = "#000000"; 
    }

//console.log(`${bgColor} + "|" + ${fontColor}`);
    const markerElement = document.createElement("div");
	markerElement.style = `
		background-color: ${bgColor};
		color: ${fontColor};
		border-radius: 6px;
		padding: 0px;
		border: 3px  black;  /* âœ… í…Œë‘ë¦¬ ë‘ê»˜ 2px, ê²€ì •ìƒ‰ */
		text-align: center;
		font-size: 12px;
		font-weight: bold;
		box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
		white-space: nowrap;
		display: inline-block;
	`;

	const nameElement = document.createElement("div");
	nameElement.style = `
		background: white;
		color: black;
		font-size: 12px;
		font-weight: bold;
		display: flex; /* âœ… Flexbox ì‚¬ìš© */
		align-items: center;
		justify-content: center;
		padding: 2px 5px; /* âœ… ìµœì†Œ íŒ¨ë”© ìœ ì§€ */
		border-radius: 3px;
		min-width: 85px; /* âœ… ìµœì†Œ ë„ˆë¹„ ê³ ì • */
		max-width: 85px; /* âœ… ìµœëŒ€ ë„ˆë¹„ ê³ ì • */
		overflow: hidden;
		text-overflow: ellipsis;
	`;

	const detailsElement = document.createElement("div");
	detailsElement.style = `
		font-size: 12px;
		padding: 2px 5px;
		min-width: 85px; /* âœ… ì„¸ë¶€ ì •ë³´ë„ ìµœì†Œ í¬ê¸° ë™ì¼ */
		max-width: 85px;
		display: flex;
		justify-content: center;
	`;
// ê¸°ì¡´



    nameElement.textContent = apartment.name.length > 7 ? apartment.name.slice(0, 6) + "..." : apartment.name;
    detailsElement.textContent = `${apartment.year.slice(-5)} ${apartment.units}ì„¸ëŒ€`;
	markerElement.setAttribute("data-apartment-id", apartment.id);
	markerElement.setAttribute("data-apartment-name", apartment.name);
    markerElement.appendChild(nameElement);
    markerElement.appendChild(detailsElement);



const chartContainer = document.createElement("div");
chartContainer.className = "priceChartContainer";
chartContainer.style = `
    margin-top: 0px;
 align-items: flex-end;
`;

const outerWrapper  = document.createElement("div");
// ... ìŠ¤íƒ€ì¼ ì„¤ì •

// âœ… í´ë˜ìŠ¤ ì¶”ê°€
outerWrapper.classList.add("marker-wrapper");


outerWrapper.style = `
		
	
display: flex; flex-direction: row; align-items: flex-end;
		
	`;
outerWrapper.appendChild(markerElement);
outerWrapper.appendChild(chartContainer);

    

    const marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(apartment.lat, apartment.lng),
        map: window.map,
        icon: {
            content: outerWrapper,
            anchor: new naver.maps.Point(10, 30)
        }
    });
	marker.apartmentId = apartment.id; // âœ… ë§ˆì»¤ ê°ì²´ì— ì§ì ‘ ID ì €ì¥
    marker.apartmentName = apartment.name; // âœ… ë§ˆì»¤ ê°ì²´ì— ì§ì ‘ ID ì €ì¥
	marker._contentWrapper = outerWrapper;
	naver.maps.Event.addListener(marker, "click",  function(e) {
		showApartmentInfo(apartment.id, {
			x: e.offset.x,
			y: e.offset.y
		});
	});



// âœ… ì¤‘ë³µ ì´ë²¤íŠ¸ ë°©ì§€ ìœ„í•´ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€
    addSiseMapMarkerLeftClickEvent(marker, markerElement);
    addMarkerRightClickEvent(marker, markerElement);

    // âœ… IndexedDBì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    //updateT2FromIndexedDB(apartment.id, markerElement, tableContainer);

	getFromIndexedDB(apartment.id, "ì‹œì„¸1").then(data => {
		const tableData = data?.text || generateDefaultTable();
		
		const dummyDiv = document.createElement("div");
		dummyDiv.innerHTML = createEditableTableHTML(apartment.id, tableData);
		
		const parsed = parsePriceDataFromTable(dummyDiv);

		if (parsed.length > 0) {
			renderPriceChart(chartContainer, parsed, marker);
			 
		}
	});


		
	// âœ… ê¸°ì¡´ ë§ˆì»¤ ì œê±° ë° ìºì‹œ ì—…ë°ì´íŠ¸
	if (apartmentMarkers[apartment.id]) {
		apartmentMarkers[apartment.id].setMap(null);
		delete apartmentMarkers[apartment.id];
	}

	apartment.marker = marker;
	apartmentMarkers[apartment.id] = marker;
	return marker;
}





// âœ… ê¸°ë³¸ 3x4 í…Œì´ë¸” ìƒì„±
function generateDefaultTable() {
    let defaultTable = [];
    for (let i = 0; i < 3; i++) {
        let row = [];
        for (let j = 0; j < 4; j++) {
            row.push("");  // ê¸°ë³¸ê°’ ì„¤ì •
        }
        defaultTable.push(row.join('\t'));
    }
    return defaultTable.join('\n'); // ì¤„ë°”ê¿ˆ í¬í•¨í•˜ì—¬ ì €ì¥
}

// âœ… ìˆ˜ì • ê°€ëŠ¥í•œ í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
function createEditableTableHTML(id, textData) {

   


    let rows = textData.split('\n').map(row => row.split('\t'));
    const table = document.createElement("table");
    table.style.borderCollapse = "collapse";
    table.style.width = "100%";             // âœ… ìë™ ë„ˆë¹„
    table.style.tableLayout = "auto";       // âœ… ì—´ë§ˆë‹¤ ìœ ë™ì  ë„ˆë¹„
    table.style.color = "black";

    rows.forEach((row, rowIndex) => {
        const tr = document.createElement("tr");
        row.forEach((cell, colIndex) => {
            const td = document.createElement("td");
            td.dataset.id = id;
            td.dataset.row = rowIndex;
            td.dataset.col = colIndex;
            td.textContent = cell.trim();

            td.style = `
				border: 1px solid black;
				padding: 2px 4px;
				text-align: center;
				height: 24px;

				vertical-align: middle;
				white-space: normal;  /* âœ… ì¤„ë°”ê¿ˆ í—ˆìš© */
				word-break: break-word; /* âœ… í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ */
			`;


            tr.appendChild(td);
        });
        table.appendChild(tr);
    });

    return table.outerHTML;
}



// âœ… IndexedDBì— í…Œì´ë¸” ë°ì´í„° ì €ì¥ (tableContainerê°€ ì—†ì„ ê²½ìš° ë³µêµ¬)
function saveTableToIndexedDB(id, tableContainer) {
    if (!tableContainer) {
        console.warn(`âš ï¸ [saveTableToIndexedDB] tableContainerê°€ ì—†ìŠµë‹ˆë‹¤. ID: ${id || "undefined"}`);
        return;
    }

    // âœ… ì´ë¯¸ ì €ì¥ ì¤‘ì¸ì§€ ì²´í¬í•˜ì—¬ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (window.isSaving) {
        console.warn("âš ï¸ IndexedDB ì €ì¥ ì¤‘, ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€");
        return;
    }
    window.isSaving = true;  // âœ… ì €ì¥ ì¤‘ ìƒíƒœ í”Œë˜ê·¸ ì„¤ì •

    let tableData = [];
    tableContainer.querySelectorAll("tr").forEach(row => {
        let rowData = [];
        row.querySelectorAll("td").forEach(td => {
            rowData.push(td.textContent.trim());
        });
        tableData.push(rowData.join('\t'));
    });

    // âœ… IndexedDBì—ì„œ ê¸°ì¡´ ìƒ‰ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ìœ ì§€
    getFromIndexedDB(id, "ì‹œì„¸1").then(existingData => {
        let existingColor = existingData?.color || "#9F9F9F"; // âœ… ê¸°ì¡´ ë°°ê²½ìƒ‰ ìœ ì§€
        let existingTextColor = existingData?.textColor || "#ffffff"; // âœ… ê¸°ì¡´ ê¸€ììƒ‰ ìœ ì§€
        let existingFontSize = existingData?.fontSize || "12px"; // âœ… ê¸°ì¡´ í°íŠ¸ í¬ê¸° ìœ ì§€

        saveToIndexedDB(id, "ì‹œì„¸1", tableData.join('\n'), existingColor, existingTextColor, existingFontSize);
    }).catch(error => {
        console.error("âŒ IndexedDB ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }).finally(() => {
        setTimeout(() => {
            window.isSaving = false;  // âœ… ì¼ì • ì‹œê°„ í›„ ë‹¤ì‹œ ì €ì¥ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
        }, 100);
    });
}




// âœ… ì…€ ì‚­ì œ í•¨ìˆ˜ ìˆ˜ì • (ì‚­ì œ í›„ ì˜¤ë¥˜ ë°©ì§€)
function deleteSelectedCells() {
    if (!selectedCells || selectedCells.size === 0) {
        console.warn("âš ï¸ ì„ íƒëœ ì…€ì´ ì—†ìŒ");
        return;
    }

    selectedCells.forEach(td => {
        if (td && td instanceof HTMLElement) {
            td.textContent = ""; // âœ… ë‚´ìš©ë§Œ ì‚­ì œ
        }
    });

    // â— activeMarkerElementê°€ ì—†ì„ ê²½ìš° ë³µêµ¬ ì‹œë„
    if (!activeMarkerElement && selectedCells.size > 0) {
        let firstCell = Array.from(selectedCells)[0];
        activeMarkerElement = firstCell.closest(".siseMapMarker");
    }

    if (activeMarkerElement) {
        let tableContainer = activeMarkerElement.querySelector(".tableContainer");
        let id = activeMarkerElement.dataset.apartmentId;

        if (!id || id === "undefined") {
            console.warn("âš ï¸ ì‚­ì œ í›„ ì €ì¥í•  IDê°€ ì—†ìŒ.");
            return;
        }

        if (tableContainer) {
            // âœ… ë¶ˆí•„ìš”í•œ setTimeout ì œê±° (ì¦‰ì‹œ ì €ì¥)
            saveTableToIndexedDB(id, tableContainer);
        } else {
            console.warn("âš ï¸ tableContainer ì°¾ì„ ìˆ˜ ì—†ìŒ");
        }
    } else {
        console.warn("âš ï¸ activeMarkerElementê°€ ì—†ìŒ");
    }
}

// âœ… ì…€ì„ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • + IME í•œê¸€ ì…ë ¥ ì²˜ë¦¬ (ì¤‘ë³µ ë°©ì§€)
function makeTableEditable(tableContainer) {

    let isComposing = false; // âœ… í•œê¸€ ì…ë ¥ ì¤‘ì¸ì§€ í™•ì¸
    let lastFocusedTd = null; // âœ… ë§ˆì§€ë§‰ìœ¼ë¡œ í¬ì»¤ìŠ¤ëœ ì…€ ì €ì¥

    tableContainer.querySelectorAll("td").forEach(td => {
        // âœ… ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        td.removeEventListener("click", handleTdClick);
        td.removeEventListener("compositionstart", handleCompositionStart);
        td.removeEventListener("compositionend", handleCompositionEnd);
        //td.removeEventListener("keydown", handleKeyDown);
        td.removeEventListener("blur", handleTdBlur);
        td.removeEventListener("paste", handlePaste);

        // âœ… ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ì¶”ê°€
        td.addEventListener("click", handleTdClick);
        td.addEventListener("compositionstart", handleCompositionStart);
        td.addEventListener("compositionend", handleCompositionEnd);
        //td.addEventListener("keydown", handleKeyDown);
        td.addEventListener("blur", handleTdBlur);
        td.addEventListener("paste", handlePaste);
    });

    // âœ… í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ì…€ì„ í´ë¦­í•˜ë©´ í¸ì§‘ ê°€ëŠ¥)
    function handleTdClick(event) {
		const td = event.target;
		td.setAttribute("contenteditable", "true");
		td.focus();
		lastFocusedTd = td;

		// âœ… ì»¤ì„œë¥¼ ì œì¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ì‹œí‚¤ê¸°
		const range = document.createRange();
		const selection = window.getSelection();

		range.selectNodeContents(td);
		range.collapse(false); // false â†’ ì»¤ì„œë¥¼ ëìœ¼ë¡œ ë³´ëƒ„
		selection.removeAllRanges();
		selection.addRange(range);
	}


    // âœ… í•œê¸€ ì…ë ¥ ì‹œì‘ (IME ì…ë ¥ ê°ì§€)
    function handleCompositionStart() {
        isComposing = true;
    }

    // âœ… í•œê¸€ ì…ë ¥ ì™„ë£Œ (í¬ì»¤ìŠ¤ ìœ ì§€ ì¤‘ì´ë©´ ì €ì¥ ì•ˆ í•¨)
    function handleCompositionEnd(event) {
    isComposing = false; // âœ… ì¡°í•© ì¢…ë£Œ í”Œë˜ê·¸
    setTimeout(() => {
        saveTableToIndexedDB(event.target.dataset.id, event.target.closest(".tableContainer"));
    }, 50);
}


    

    // âœ… í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ì €ì¥ (IME ì…ë ¥ ì¤‘ì´ë©´ ì €ì¥ ë°©ì§€)
    function handleTdBlur(event) {
        setTimeout(() => {
            if (isComposing) return; // âœ… IME ì…ë ¥ ì¤‘ì´ë©´ blur ì €ì¥ ë°©ì§€
            isComposing = false; // âœ… í¬ì»¤ìŠ¤ê°€ ì•„ì›ƒë˜ì—ˆì„ ë•Œ ì…ë ¥ ì¢…ë£Œ
            saveTableToIndexedDB(event.target.dataset.id, event.target.closest(".tableContainer"));
        }, 50);
//console.log("handleTdBlur");
    }

    // âœ… ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ (ë¶™ì—¬ë„£ê¸° í›„ ì¦‰ì‹œ ì €ì¥)
     function handlePaste(event) {
        event.preventDefault();
        let clipboardData = event.clipboardData || window.clipboardData;
        let pastedText = clipboardData.getData("text");

        if (!pastedText.includes("\t") && !pastedText.includes("\n")) {
            // âœ… ì¼ë°˜ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°
            document.execCommand("insertText", false, pastedText);
            return;
        }

        // âœ… ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— ë§ì¶° ì‚½ì…
        let rows = pastedText.split("\n").map(row => row.split("\t"));
        let startRow = parseInt(lastFocusedTd.dataset.row, 10);
        let startCol = parseInt(lastFocusedTd.dataset.col, 10);
        let table = lastFocusedTd.closest("table");

        rows.forEach((row, rowIndex) => {
            row.forEach((cellText, colIndex) => {
                let targetRow = startRow + rowIndex;
                let targetCol = startCol + colIndex;
                let targetCell = table.querySelector(`td[data-row="${targetRow}"][data-col="${targetCol}"]`);
                
                if (targetCell) {
                    targetCell.textContent = cellText.trim();
                }
            });
        });

        // âœ… ì €ì¥
        saveTableToIndexedDB(lastFocusedTd.dataset.id, lastFocusedTd.closest(".tableContainer"));
    }

    enableMultiCellSelection(tableContainer);
}





// âœ… í…ìŠ¤íŠ¸ì˜ ì‹¤ì œ í”½ì…€ ë„ˆë¹„ë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
function getTextWidth(text, font) {
    let canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
    let context = canvas.getContext("2d");
    context.font = font || "12px Arial";
    return context.measureText(text).width;
}


// âœ… í˜„ì¬ ì„ íƒëœ ì…€ ëª©ë¡
let selectedCells = new Set();
let lastSelectedCell = null;

// âœ… ì…€ ì„ íƒ ê¸°ëŠ¥ (Shift í‚¤ ì§€ì›)
function enableMultiCellSelection(tableContainer) {
    let isMouseDown = false;

    // âœ… ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    document.removeEventListener("mouseup", handleMouseUp);
    //document.removeEventListener("keydown", handleKeyDown);
    document.removeEventListener("click", handleOutsideClick);

    // âœ… ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¬ë“±ë¡
    document.addEventListener("mouseup", handleMouseUp);
    //document.addEventListener("keydown", handleKeyDown);
    document.addEventListener("click", handleOutsideClick);

    tableContainer.querySelectorAll("td").forEach(td => {
        td.addEventListener("mousedown", function(event) {
            event.preventDefault();
            isMouseDown = true;

            if (event.shiftKey && lastSelectedCell) {
                selectRangeCells(lastSelectedCell, td, tableContainer);
            } else {
                clearSelectedCells();
                toggleCellSelection(td);
                lastSelectedCell = td;
            }
        });

        td.addEventListener("mouseover", function(event) {
            if (isMouseDown) {
                if (event.shiftKey && lastSelectedCell) {
                    selectRangeCells(lastSelectedCell, td, tableContainer);
                } else {
                    clearSelectedCells();
                    toggleCellSelection(td);
                }
            }
        });

        td.addEventListener("mouseup", function() {
            isMouseDown = false;
        });

        td.addEventListener("click", function(event) {
            event.stopPropagation();
        });
    });
}

// âœ… ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ì¤‘ë³µ ë°©ì§€)
function handleMouseUp() {
    isMouseDown = false;
}
function handleKeyDown(event) {
    const activeElement = document.activeElement;

	// âœ… case 2: ì§€ë„ ë§ˆì»¤ ì´ë™ìš© WASD
/*
console.log("activeMarker : "+activeMarker);
console.log("ğŸ” activeMarker ê°ì²´:", activeMarker);
console.log("ğŸ“Œ Marker ì¸ìŠ¤í„´ìŠ¤ì¸ê°€?", activeMarker instanceof naver.maps.Marker);
console.log("ğŸ“ getPosition ì¡´ì¬?", typeof activeMarker.getPosition);
console.log("ğŸ“ ìœ„ì¹˜:", activeMarker.getPosition && activeMarker.getPosition().toString());
console.log("2646ë²ˆì¤„")
console.log(activeMarker);
*/
    if (activeMarker) {
        let position = activeMarker.getPosition();
        let lat = position.lat();
        let lng = position.lng();
        let step = 0.0004;

        switch (event.key) {
            case "w": case "ã…ˆ": case "W": lat += step; break;
            case "s": case "ã„´": case "S": lat -= step; break;
            case "a": case "ã…": case "A": lng -= step; break;
            case "d": case "ã…‡": case "D":lng += step; break;
            case "Escape":
                updateMarkerSelection(activeMarkerElement, false);
                activeMarker = null;
                activeMarkerElement = null;
                return;
            default:
                return;
        }
//console.log("2647ë²ˆì¤„")
        let newPosition = new naver.maps.LatLng(lat, lng);
//console.log(newPosition);
//        activeMarker.setPosition(newPosition);

activeMarker.setPosition(newPosition);
activeMarker.setMap(null);  // ğŸ”„ ê°•ì œ ë¦¬ë Œë”ë§ ìœ ë„
activeMarker.setMap(window.map);



    }
	//console.log(activeElement)
//console.log(activeElement)
    // âœ… case 1: í…Œì´ë¸” ì…€ ì•ˆì—ì„œ í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    if (activeElement && activeElement.tagName === "TD") {
        // IME í•œê¸€ ì…ë ¥ ì¤‘ì´ë©´ ë¬´ì‹œ
        if (window.isComposing) return;

        const tableContainer = activeElement.closest(".tableContainer");
        const currentRow = parseInt(activeElement.dataset.row, 10);
        const currentCol = parseInt(activeElement.dataset.col, 10);
        const table = tableContainer.querySelector("table");

        switch (event.key) {
            case "ArrowUp":
                event.preventDefault();
                moveToCell(table, currentRow - 1, currentCol);
                return;
            case "ArrowDown":
                event.preventDefault();
                moveToCell(table, currentRow + 1, currentCol);
                return;
            case "ArrowLeft":
				event.preventDefault();

				if (currentCol > 0) {
					// ğŸ‘‰ ê°™ì€ í–‰ì˜ ì´ì „ ì—´ë¡œ ì´ë™
					moveToCell(table, currentRow, currentCol - 1);
				} else {
					// âœ… ì²« ë²ˆì§¸ ì—´ì—ì„œ ì™¼ìª½ ëˆ„ë¥´ë©´ â†’ ì´ì „ í–‰ì˜ ë§ˆì§€ë§‰ ì—´ë¡œ ì´ë™
					const prevRow = currentRow - 1;
					const prevRowCells = table.querySelectorAll(`td[data-row="${prevRow}"]`);
					if (prevRowCells.length > 0) {
						const maxCol = Math.max(...Array.from(prevRowCells)
							.map(td => parseInt(td.dataset.col, 10)));
						moveToCell(table, prevRow, maxCol);
					}
				}

				//console.log("ì™¼ìª½");
				return;

            case "ArrowRight":
			case "Tab":
				event.preventDefault();

				const maxCol = Math.max(...Array.from(table.querySelectorAll(`td[data-row="${currentRow}"]`))
					.map(td => parseInt(td.dataset.col, 10)));

				if (currentCol < maxCol) {
					moveToCell(table, currentRow, currentCol + 1);
				} else {
					const nextRow = currentRow + 1;
					const firstColTd = table.querySelector(`td[data-row="${nextRow}"][data-col="0"]`);
					if (firstColTd) {
						moveToCell(table, nextRow, 0);
					}
				}

				//console.log("ì˜¤ë¥¸ìª½ or Tab");
				return;


            case "Delete":
            case "Backspace":
                if (selectedCells.size > 1) {
                    event.preventDefault();
                    deleteSelectedCells();
                }
                return;
			

        }

        // âœ… Ctrl+C ë˜ëŠ” Cmd+C ë³µì‚¬ ì²˜ë¦¬
        if ((event.ctrlKey || event.metaKey) && event.key === "c") {
            if (selectedCells.size > 0) {
                event.preventDefault();

                const cellsArray = Array.from(selectedCells);
                cellsArray.sort((a, b) => {
                    const rowA = parseInt(a.dataset.row, 10);
                    const rowB = parseInt(b.dataset.row, 10);
                    if (rowA !== rowB) return rowA - rowB;
                    return parseInt(a.dataset.col, 10) - parseInt(b.dataset.col, 10);
                });

                const maxRow = Math.max(...cellsArray.map(td => parseInt(td.dataset.row)));
                const minRow = Math.min(...cellsArray.map(td => parseInt(td.dataset.row)));
                const maxCol = Math.max(...cellsArray.map(td => parseInt(td.dataset.col)));
                const minCol = Math.min(...cellsArray.map(td => parseInt(td.dataset.col)));

                const rowCount = maxRow - minRow + 1;
                const colCount = maxCol - minCol + 1;
                const grid = Array.from({ length: rowCount }, () => Array(colCount).fill(""));

                cellsArray.forEach(td => {
                    const r = parseInt(td.dataset.row) - minRow;
                    const c = parseInt(td.dataset.col) - minCol;
                    grid[r][c] = td.textContent.trim();
                });

                const tsv = grid.map(row => row.join("\t")).join("\n");

                navigator.clipboard.writeText(tsv).then(() => {
                    console.log("âœ… ì…€ ë³µì‚¬ ì™„ë£Œ");
                }).catch(err => {
                    console.error("âŒ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:", err);
                });
            }
        }
    }

    
}

function enableTabNavigation() {
  const cells = Array.from(document.querySelectorAll("td[contenteditable='true']"));

  cells.forEach((cell, index) => {
    cell.addEventListener("keydown", (e) => {
      if (e.key === "Tab") {
        e.preventDefault();

        // Shift + Tab â†’ ì™¼ìª½ ì´ë™
        const nextIndex = e.shiftKey ? index - 1 : index + 1;

        if (cells[nextIndex]) {
          cells[nextIndex].focus();
        }
      }
    });
  });
}
document.addEventListener("DOMContentLoaded", enableTabNavigation);


// âœ… ë§ˆì»¤ ì™¸ë¶€ í´ë¦­ ì‹œ ë¸”ë¡ í•´ì œ (ì¤‘ë³µ ë°©ì§€)
function handleOutsideClick(event) {
    if (!event.target.closest(".siseMapMarker")) {
        clearSelectedCells();
    }
}

function clearSelectedCells() {
    if (!selectedCells) return;
    selectedCells.forEach(cell => {
        cell.style.backgroundColor = ""; // âœ… ê¸°ì¡´ ì„ íƒ í•´ì œ
    });
    selectedCells.clear(); // âœ… Set ì´ˆê¸°í™”
}


// âœ… ë²”ìœ„ ì„ íƒ ê¸°ëŠ¥ (Shift í‚¤ ì‚¬ìš©)
function selectRangeCells(startCell, endCell, tableContainer) {
    let table = tableContainer.querySelector("table");
    let startRow = parseInt(startCell.dataset.row);
    let startCol = parseInt(startCell.dataset.col);
    let endRow = parseInt(endCell.dataset.row);
    let endCol = parseInt(endCell.dataset.col);

    let minRow = Math.min(startRow, endRow);
    let maxRow = Math.max(startRow, endRow);
    let minCol = Math.min(startCol, endCol);
    let maxCol = Math.max(startCol, endCol);

    selectedCells.clear();

    for (let row = minRow; row <= maxRow; row++) {
        for (let col = minCol; col <= maxCol; col++) {
            let targetCell = table.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
            if (targetCell) {
                selectedCells.add(targetCell);
                targetCell.style.backgroundColor = "#FFD700"; // âœ… ë…¸ë€ìƒ‰ ë¸”ë¡ í‘œì‹œ
            }
        }
    }
}

// âœ… ì…€ ì„ íƒ/í•´ì œ ê¸°ëŠ¥ (Shift ë¯¸ì‚¬ìš© ì‹œ ë‹¨ì¼ ì„ íƒ)
function toggleCellSelection(td) {
    if (selectedCells.has(td)) {
        selectedCells.delete(td);
        td.style.backgroundColor = ""; // âœ… ì„ íƒ í•´ì œ
    } else {
        selectedCells.add(td);
        td.style.backgroundColor = "#FFD700"; // âœ… ë…¸ë€ìƒ‰ ë¸”ë¡ ì§€ì •
    }
}

/*
function enableArrowKeyNavigation(tableContainer) {
    const table = tableContainer.querySelector("table");
    if (!table) return;

    // âœ… ê¸°ì¡´ td ì´ë²¤íŠ¸ ì œê±°
    table.querySelectorAll("td").forEach(td => {
        td.removeEventListener("keydown", handleArrowKey); // ì¤‘ë³µ ì œê±°
        td.addEventListener("keydown", handleArrowKey);     // ìƒˆë¡œ ë“±ë¡
    });
}

function handleArrowKey(event) {
    const td = event.currentTarget;
    const currentRow = parseInt(td.dataset.row, 10);
    const currentCol = parseInt(td.dataset.col, 10);
    const table = td.closest("table");
	console.log("event.key : "+event.key)
    switch (event.key) {
        case "ArrowUp":
            event.preventDefault();
            moveToCell(table, currentRow - 1, currentCol);
            break;
        case "ArrowDown":
            event.preventDefault();
            moveToCell(table, currentRow + 1, currentCol);
            break;
        case "ArrowLeft":
            event.preventDefault();
            moveToCell(table, currentRow, currentCol - 1);

            break;
        case "ArrowRight":
            event.preventDefault();
            moveToCell(table, currentRow, currentCol + 1);

            break;
        case "Delete":
        case "Backspace":
            if (selectedCells && selectedCells.size > 1) {
                event.preventDefault();
                deleteSelectedCells();
            }
            break;
    }
}
*/
function moveToCell(table, row, col) {
    //console.log("â¡ moveToCell í˜¸ì¶œ:", row, col);

    let maxRows = table.rows.length;
    let maxCols = table.rows[0].cells.length;

    if (row < 0 || row >= maxRows || col < 0 || col >= maxCols) {
        console.warn(`âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë™ ìœ„ì¹˜: row=${row}, col=${col}`);
        return;
    }

    let targetCell = table.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
    //console.log("ğŸ¯ targetCell:", targetCell);

    if (targetCell) {
        targetCell.setAttribute("contenteditable", "true");
        setTimeout(() => {
            targetCell.focus();

            // âœ… ì»¤ì„œë¥¼ í…ìŠ¤íŠ¸ ëìœ¼ë¡œ ì´ë™
            const range = document.createRange();
            const selection = window.getSelection();
            range.selectNodeContents(targetCell);
            range.collapse(false); // ëìœ¼ë¡œ ì´ë™
            selection.removeAllRanges();
            selection.addRange(range);
        }, 10);
    }
}






function rgbToHex(rgb) {
    let rgbArray = rgb.match(/\d+/g);
    if (!rgbArray || rgbArray.length < 3) return "#000000"; // ê¸°ë³¸ê°’

    return `#${rgbArray
        .slice(0, 3)
        .map(x => parseInt(x).toString(16).padStart(2, "0"))
        .join("")}`.toUpperCase();
}

function addApartmentTitle(modal, apartmentName) {
    const title = document.createElement("div");
    title.className = "modal-apartment-title";
    title.textContent = apartmentName;

    title.style.cssText = `
        padding: 8px 10px;
        font-weight: bold;
        font-size: 14px;
        background: #ffffff;
        border-bottom: 1px solid #ddd;
        text-align: center;
    `;

    modal.insertBefore(title, modal.firstChild);
}

async function showColorPickerModal(apartmentId,apartmentName,  defaultColor, defaultTextColor, defaultFontSize, callback) {

    // âœ… ê¸°ì¡´ ëª¨ë‹¬ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    const existingModal = document.querySelector('.custom-modal-siseMap');
    if (existingModal) {
        document.body.removeChild(existingModal);
    }

    // âœ… RGB ìƒ‰ìƒì´ ë“¤ì–´ì˜¤ë©´ HEXë¡œ ë³€í™˜
    if (defaultColor.startsWith("rgb")) defaultColor = rgbToHex(defaultColor);
    if (defaultTextColor.startsWith("rgb")) defaultTextColor = rgbToHex(defaultTextColor);

    // âœ… ëª¨ë‹¬ ìƒì„±
    const modal = document.createElement('div');
    modal.className = 'custom-modal-siseMap';
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.backgroundColor = 'white';
    modal.style.border = '1px solid #ccc';
    modal.style.padding = '20px';
    modal.style.zIndex = '10000';
    modal.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
    modal.style.width = '300px';

addApartmentTitle(modal, apartmentName); // âœ… ì œì¼ ìœ„
makeModalDraggable(modal);               // âœ… ê·¸ ì•„ë˜ Drag me


	const tableContainer = document.createElement("div");
    tableContainer.className = "tableContainer";



    await getFromIndexedDB(apartmentId, "ì‹œì„¸1").then(data => {
        let tableData = data?.text || generateDefaultTable();
/*
console.log("2851");
console.log(tableData);
console.log(createEditableTableHTML(apartmentId, tableData));
*/
        tableContainer.innerHTML = createEditableTableHTML(apartmentId, tableData);
	});




    modal.appendChild(tableContainer);

	makeTableEditable(tableContainer);
    //document.body.appendChild(modal);







	const rowButtonContainer = document.createElement('div');
    rowButtonContainer.style.marginTop = '10px';


    // âœ… ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
    const buttonContainer = document.createElement('div');
    buttonContainer.style.marginTop = '10px';
    buttonContainer.style.textAlign = 'right';

    const saveButton = document.createElement('button');
    saveButton.textContent = ' í™•ì¸ ';
    saveButton.style.marginRight = '10px';
	saveButton.onclick = async () => {
		//await updateMarkerStyleAndSave(apartmentId, colorInput.value, textColorInput.value, fontSizeInput.value + 'px');

		const apartment = apartmentData.find(a => a.id === apartmentId);
		if (apartment) {
			// âœ… í˜¹ì‹œ ë Œë” ì „ì— ë§ˆì»¤ê°€ ì§€ë„ì— ìˆìœ¼ë©´ ë¨¼ì € ì œê±°
			if (apartment.marker && typeof apartment.marker.setMap === "function") {
				apartment.marker.setMap(null);
				
			}
			delete apartmentMarkers[apartmentId]; // ğŸ‘ˆ ë§ˆì»¤ ê´€ë¦¬ ê°ì²´ì—ì„œë„ ì œê±°í•´ì•¼ í•¨
			// âœ… ìƒˆë¡œ ë Œë”ë§ â†’ ë‚´ë¶€ì—ì„œ apartment.markerì— ìƒˆ ë§ˆì»¤ ì €ì¥ë˜ë„ë¡
//console.log("3073");
			renderSiseMapMarker(apartment);
		}

		closePopup();
		document.body.removeChild(modal);
	};


	const addRowButton = document.createElement('button');
    addRowButton.textContent = 'í–‰ ì¶”ê°€';
    //addRowButton.onclick = () => addRowToTable(apartmentId);
    rowButtonContainer.appendChild(addRowButton);

    const removeRowButton = document.createElement('button');
    removeRowButton.textContent = 'í–‰ ì œê±°';
    //removeRowButton.onclick = () => removeRowFromTable(apartmentId);
    rowButtonContainer.appendChild(removeRowButton);

	addRowButton.onclick = () => addRowToTable(apartmentId, tableContainer);
	removeRowButton.onclick = () => removeRowFromTable(apartmentId, tableContainer);

    modal.appendChild(rowButtonContainer);



	const resetButton = document.createElement('button');
	resetButton.textContent = ' ì´ˆê¸°í™” ';
	resetButton.style.marginRight = '10px';
	resetButton.onclick = () => {
		const request = indexedDB.open("hongSise", 4);
		request.onsuccess = function(event) {
			const db = event.target.result;
			const transaction = db.transaction(["apartments"], "readwrite");
			const store = transaction.objectStore("apartments");
			store.delete(`${apartmentId}-ì‹œì„¸1`);

			transaction.oncomplete = () => {
				console.log("âœ… ì´ˆê¸°í™” ì™„ë£Œ (IndexedDB ì‚­ì œë¨)");

				const apartment = apartmentData.find(a => a.id === apartmentId);
				if (apartment) {
					// âœ… ë§ˆì»¤ê°€ ì§€ë„ì— ìˆìœ¼ë©´ ì œê±°
					if (apartment.marker && typeof apartment.marker.setMap === "function") {
						apartment.marker.setMap(null);
					
					}
					//delete apartmentMarkers[apartmentId]; // ğŸ‘ˆ ë§ˆì»¤ ê´€ë¦¬ ê°ì²´
					// âœ… ê¸°ì¡´ ì°¨íŠ¸ë„ ì œê±°
					const existing = document.querySelector(`[data-apartment-id='${apartmentId}']`);
					if (existing) {
						const chart = existing.closest('div[style*="position: absolute"]');
						if (chart && chart.parentNode) {
							chart.parentNode.removeChild(chart);
						}
					}

					// âœ… ìƒˆë¡œ ë§ˆì»¤ ë Œë”ë§
					renderSiseMapMarker(apartment);
				}

				// âœ… ëª¨ë‹¬ ë‹«ê¸°
				closePopup();
				document.body.removeChild(modal);
			};
		};
	};


	buttonContainer.appendChild(resetButton);  // â¬… ì´ˆê¸°í™” ë²„íŠ¼ ë¨¼ì €
    //buttonContainer.appendChild(saveButton);

    const cancelButton = document.createElement('button');
    cancelButton.textContent = ' ë‹«ê¸° ';
    cancelButton.onclick = () => {
        const apartment = apartmentData.find(a => a.id === apartmentId);
		if (apartment) {
			// âœ… í˜¹ì‹œ ë Œë” ì „ì— ë§ˆì»¤ê°€ ì§€ë„ì— ìˆìœ¼ë©´ ë¨¼ì € ì œê±°
			if (apartment.marker && typeof apartment.marker.setMap === "function") {
				apartment.marker.setMap(null);
				
			}
			delete apartmentMarkers[apartmentId]; // ğŸ‘ˆ ë§ˆì»¤ ê´€ë¦¬ ê°ì²´ì—ì„œë„ ì œê±°í•´ì•¼ í•¨
			// âœ… ìƒˆë¡œ ë Œë”ë§ â†’ ë‚´ë¶€ì—ì„œ apartment.markerì— ìƒˆ ë§ˆì»¤ ì €ì¥ë˜ë„ë¡
//console.log("3073");
			renderSiseMapMarker(apartment);
		}

		closePopup();
		document.body.removeChild(modal);
    };
    buttonContainer.appendChild(cancelButton);

    modal.appendChild(buttonContainer);

    // âœ… ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
    document.body.appendChild(modal);



}

function addRowToTable(apartmentId, tableContainer) {
    const table = tableContainer.querySelector("table");
    if (table) {
        const newRow = table.insertRow();
        const rowIndex = table.rows.length - 1; // ìƒˆë¡œ ì¶”ê°€ëœ í–‰ì˜ ì¸ë±ìŠ¤

        for (let colIndex = 0; colIndex < table.rows[0].cells.length; colIndex++) {
            const newCell = newRow.insertCell();
            newCell.textContent = "";
            newCell.style.border = "1px solid black";
            newCell.style.padding = "0px";
            newCell.style.textAlign = "center";
            newCell.style.height = "24px";

            // âœ… í¸ì§‘ì„ ìœ„í•´ í•„ìš”í•œ dataset ì¶”ê°€
            newCell.dataset.id = apartmentId;
            newCell.dataset.row = rowIndex;
            newCell.dataset.col = colIndex;
        }

        // âœ… ìƒˆë¡œ ì¶”ê°€ëœ ì…€ì—ë„ í¸ì§‘ ì´ë²¤íŠ¸ ì ìš©
        makeTableEditable(tableContainer);

        // âœ… ì €ì¥
        saveTableToIndexedDB(apartmentId, tableContainer);
    }
}

function removeRowFromTable(apartmentId, tableContainer) {
    const table = tableContainer.querySelector("table");
    if (table && table.rows.length > 1) {
        table.deleteRow(table.rows.length - 1);
        saveTableToIndexedDB(apartmentId, tableContainer);
    }
}


function parsePriceDataFromTable(tableContainer) {
    const rows = tableContainer.querySelectorAll("tr");
    const parsed = [];

    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length >= 3) {
            const í‰í˜• = cells[0].textContent.trim();
            const ë§¤ë§¤ = parseFloat(cells[1].textContent.trim());
            const ì „ì„¸ = parseFloat(cells[2].textContent.trim());

            if (!isNaN(ë§¤ë§¤) && !isNaN(ì „ì„¸)) {
                parsed.push({ í‰í˜•, ë§¤ë§¤, ì „ì„¸ });
            }
        }
    });

    return parsed;
}


async function exportHongSiseToJSON() {
    try {
        const request = indexedDB.open("hongSise");

        request.onerror = function(event) {
            console.error("âŒ hongSise DB ì—°ê²° ì‹¤íŒ¨:", event.target.error);
        };

        request.onsuccess = async function(event) {
            const db = event.target.result;
            const objectStoreNames = db.objectStoreNames;
            const exportData = {};

            const tx = db.transaction(objectStoreNames, "readonly");

            await Promise.all([...objectStoreNames].map(storeName => {
                return new Promise((resolve, reject) => {
                    const store = tx.objectStore(storeName);
                    const getAllRequest = store.getAll();

                    getAllRequest.onsuccess = () => {
                        exportData[storeName] = getAllRequest.result;
                        resolve();
                    };

                    getAllRequest.onerror = (e) => {
                        console.error(`âŒ ${storeName} ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨`, e);
                        reject(e);
                    };
                });
            }));

            // ì €ì¥í•  íŒŒì¼ ì´ë¦„ ìƒì„±
            const now = new Date();
            const formattedDate = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            const formattedTime = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
            const defaultFilename = `ì‹œì„¸ì§€ë„Ver2_ê°€ê²©_ë°±ì—…_${formattedDate}_${formattedTime}.json`;

            // showSaveFilePickerë¥¼ ì´ìš©í•´ ì‚¬ìš©ìì—ê²Œ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ë°›ê¸°
            const handle = await window.showSaveFilePicker({
                suggestedName: defaultFilename,
                types: [
                    {
                        description: "JSON íŒŒì¼",
                        accept: { "application/json": [".json"] }
                    }
                ]
            });

            const writable = await handle.createWritable();
            await writable.write(JSON.stringify(exportData, null, 2));
            await writable.close();

            console.log("âœ… hongSise DB ë°±ì—… ì™„ë£Œ:", defaultFilename);
        };
    } catch (error) {
        console.error("âŒ hongSise ë°±ì—… ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
    }
}



function importFromJSON(file) {
    const reader = new FileReader();
    reader.onload = function(event) {
        const data = JSON.parse(event.target.result);

        initIndexedDB().then(db => {
            const transaction = db.transaction(['apartments'], 'readwrite');
            const store = transaction.objectStore('apartments');

            data.forEach(item => {
                // âœ… ëˆ„ë½ëœ í•„ë“œ ë³´ì™„
                if (!item.type) item.type = 'ì‹œì„¸1';
                if (!item.idType) item.idType = `${item.id}-${item.type}`;
                store.put(item);
            });

            transaction.oncomplete = function() {
				alert('âœ… ì‹œì„¸ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');

				// â— ì‹œì„¸ì§€ë„ í™œì„±í™” ìƒíƒœì¼ ê²½ìš°, ë§ˆì»¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
				if (document.getElementById("toggleSiseMap").checked && window.map) {
					prevSiseMapState = "ì´ˆê¸°í™”";
					updateMarkers(window.map.getBounds());
				}
			};


            transaction.onerror = function(event) {
                console.error('âŒ Import transaction error:', event.target.errorCode);
            };
        }).catch(error => {
            console.error('âŒ Failed to initialize hongbu DB:', error);
        });
    };

    reader.readAsText(file);
}
function importFromJSONToHongSise(file) {
  const reader = new FileReader();

  reader.onload = function (event) {
    const data = JSON.parse(event.target.result);
    const request = indexedDB.open("hongSise");

    request.onerror = function (e) {
      console.error("âŒ hongSise DB ì—´ê¸° ì‹¤íŒ¨", e);
    };

    request.onsuccess = function (e) {
      const db = e.target.result;
      const storeNames = db.objectStoreNames;
      const tx = db.transaction(storeNames, "readwrite");

      let errorOccurred = false;

      tx.onerror = (e) => {
        console.error("âŒ íŠ¸ëœì­ì…˜ ì˜¤ë¥˜", e);
        errorOccurred = true;
      };

      tx.oncomplete = () => {
        if (!errorOccurred) {
          alert("âœ… hongSise DB ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ");

          if (document.getElementById("toggleSiseMap")?.checked && window.map) {
            prevSiseMapState = "ì´ˆê¸°í™”";
            updateMarkers(window.map.getBounds());
          }
        }
      };

      Object.keys(data).forEach(storeName => {
        if (!storeNames.contains(storeName)) {
          console.warn(`âš ï¸ hongSise DBì— ${storeName} store ì—†ìŒ`);
          return;
        }

        const store = tx.objectStore(storeName);
        const items = data[storeName];

        items.forEach(item => {
          try {
            if (store.keyPath) {
              store.put(item); // keyPathê°€ ìˆìœ¼ë©´ OK
            } else if ("id" in item || "idType" in item) {
              store.put(item, item.id || item.idType); // ìˆ˜ë™ key ì œê³µ
            } else {
              console.warn("â— í‚¤ ì—†ìŒ", item);
            }
          } catch (e) {
            console.error("âŒ put ì‹¤íŒ¨:", e, item);
            errorOccurred = true;
          }
        });
      });
    };
  };

  reader.readAsText(file);
}



// âœ… [1] hongSiseColor ë°±ì—… ë²„íŠ¼
async function exportColorSettingsToJSON() {
  try {
    const db = await initColorSettingsDB(); // hongSiseColor DB ì—´ê¸°
    const transaction = db.transaction(["chartColor", "yearColor"], "readonly");

    const chartStore = transaction.objectStore("chartColor");
    const yearStore = transaction.objectStore("yearColor");

    const [chartRequest, yearRequest] = [chartStore.getAll(), yearStore.getAll()];

    chartRequest.onsuccess = () => {
      yearRequest.onsuccess = async () => {
        const chartData = chartRequest.result;
        const yearData = yearRequest.result;

        const backup = {
  chartColor: chartData,
  yearColor: yearData
};


        const jsonData = JSON.stringify(backup, null, 2);
        const now = new Date();
        const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;

        const handle = await window.showSaveFilePicker({
          suggestedName: `ì‹œì„¸ì§€ë„Ver2_ìƒ‰ìƒì„¤ì •_ë°±ì—…_${timestamp}.json`,
          types: [{
            description: 'JSON Files',
            accept: { 'application/json': ['.json'] }
          }]
        });

        const writable = await handle.createWritable();
        await writable.write(jsonData);
        await writable.close();

        alert("âœ… ìƒ‰ìƒ ì„¤ì •ì´ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.");
      };
    };

    chartRequest.onerror = yearRequest.onerror = (e) => {
      console.error("âŒ ìƒ‰ìƒ ì„¤ì • ë°±ì—… ì˜¤ë¥˜", e);
    };
  } catch (e) {
    console.error("âŒ ìƒ‰ìƒ ì„¤ì • ë°±ì—… ì‹¤íŒ¨", e);
  }
}




// âœ… [2] hongSiseColor ë³µì› ë²„íŠ¼
function importFromJSONForColor(file) {
	const reader = new FileReader();

	reader.onload = function (event) {
		try {
			const data = JSON.parse(event.target.result);
			const request = indexedDB.open("hongSiseColor"); // ë°˜ë“œì‹œ 2 ì´ìƒìœ¼ë¡œ ì§€ì •

			request.onerror = function (event) {
				console.error("âŒ DB ì—°ê²° ì‹¤íŒ¨:", event);
				alert("âŒ ìƒ‰ìƒ ì„¤ì • ë³µì› ì‹¤íŒ¨: DB ì—°ê²° ì‹¤íŒ¨");
			};

			request.onsuccess = function (event) {
				const db = event.target.result;

				const transaction = db.transaction(["chartColor", "yearColor"], "readwrite");

				// chartColor ë³µì›
				const chartStore = transaction.objectStore("chartColor");
				if (Array.isArray(data.chartColor)) {
					data.chartColor.forEach(item => {
						chartStore.put(item);
					});
				}

				// yearColor ë³µì›
				const yearStore = transaction.objectStore("yearColor");
				if (Array.isArray(data.yearColor)) {
					data.yearColor.forEach(item => {
						yearStore.put(item);
					});
				}

				transaction.oncomplete = function () {
					alert("âœ… ìƒ‰ìƒ ì„¤ì • ë³µì› ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
					location.reload(); // âœ” ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°˜ì˜
				};

				transaction.onerror = function (event) {
					console.error("âŒ ìƒ‰ìƒ ì„¤ì • ë³µì› ì‹¤íŒ¨:", event);
					alert("âŒ ìƒ‰ìƒ ì„¤ì • ë³µì› ì‹¤íŒ¨: íŠ¸ëœì­ì…˜ ì˜¤ë¥˜");
				};
			};

			request.onupgradeneeded = function (event) {
				const db = event.target.result;

				if (!db.objectStoreNames.contains("chartColor")) {
					db.createObjectStore("chartColor", { keyPath: "id" });
				}
				if (!db.objectStoreNames.contains("yearColor")) {
					db.createObjectStore("yearColor", { keyPath: "id" });
				}
			};
		} catch (error) {
			console.error("âŒ ìƒ‰ìƒ ì„¤ì • ë³µì› ì‹¤íŒ¨:", error);
			alert("âŒ ìƒ‰ìƒ ì„¤ì • ë³µì› ì‹¤íŒ¨: JSON íŒŒì‹± ì˜¤ë¥˜");
		}
	};

	reader.onerror = function () {
		alert("âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨");
	};

	reader.readAsText(file);
}





function resetColorSettingsDB() {
    const confirmReset = confirm("âš ï¸ ìƒ‰ìƒ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°±ì—…ì„ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    if (!confirmReset) return;

    const request = indexedDB.open("hongSiseColor"); // âœ… ë²„ì „ ëª…ì‹œí•˜ì§€ ì•ŠìŒ

    request.onerror = function (event) {
        console.error("âŒ ìƒ‰ìƒ DB ì—°ê²° ì‹¤íŒ¨:", event);
        alert("âŒ ìƒ‰ìƒ ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨: DB ì—°ê²° ì˜¤ë¥˜");
    };

    request.onsuccess = function (event) {
        const db = event.target.result;
        const tx = db.transaction(["chartColor", "yearColor"], "readwrite");

        const chartStore = tx.objectStore("chartColor");
        const yearStore = tx.objectStore("yearColor");

        chartStore.clear();
        yearStore.clear();

        tx.oncomplete = () => {
            alert("âœ… ìƒ‰ìƒ ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.priceColorSettings = [];
            window.yearColorSettings = [];

            if (window.map) updateMarkers(window.map.getBounds(), true);
        };

        tx.onerror = function (event) {
            console.error("âŒ ìƒ‰ìƒ ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨:", event.target.error);
            alert("âŒ ìƒ‰ìƒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        };
location.reload(); // âœ” ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°˜ì˜
    };
}


////////////////////////////////////////ì‹œì„¸ ì°¨íŠ¸/////////////////////////////////////////////////

function parsePriceDataFromTable(tableContainer) {
    const rows = tableContainer.querySelectorAll("tr");
    const parsed = [];

    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length >= 2) {
            const í‰í˜• = cells[0].textContent.trim();
            const ë§¤ë§¤ = parseFloat(cells[1].textContent.trim());
            const ì „ì„¸ = parseFloat(cells[2].textContent.trim());
			const ê¸°íƒ€ = cells[3].textContent.trim();

            if (!isNaN(ë§¤ë§¤)) {
                parsed.push({ í‰í˜•, ë§¤ë§¤, ì „ì„¸, ê¸°íƒ€ });
            }
        }
    });

    return parsed;
}

function getColorForPrice(price, settings) {
    // ê°€ê²© ì´ìƒ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê°€ì¥ ë‚®ì€ ì„¤ì • ìƒ‰ìƒ ì‚¬ìš©
    for (let i = settings.length - 1; i >= 0; i--) {
        if (price >= settings[i].price) {
            return settings[i].color;
        }
    }
    // í•´ë‹¹ ì¡°ê±´ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’
    return "#cccccc";
}
function renderPriceChart(container, data, marker = null) {
const fromP = parseFloat(document.getElementById("filterPyeongFrom").value);
const toP = parseFloat(document.getElementById("filterPyeongTo").value);
const fromPrice = parseFloat(document.getElementById("filterPriceFrom").value);
const toPrice = parseFloat(document.getElementById("filterPriceTo").value);
const fromLease = parseFloat(document.getElementById("filterLeaseFrom").value);
const toLease = parseFloat(document.getElementById("filterLeaseTo").value);

const filteredData = data.filter(row => {
  const pyeong = parseFloat(row.í‰í˜•);
  const price = parseFloat(String(row.ë§¤ë§¤ ?? "").replace(/,/g, ""));
  const lease = parseFloat(String(row.ì „ì„¸ ?? "").replace(/,/g, ""));

  //console.log(fromP + "|" + toP + "|" + fromPrice + "|" + toPrice + "|" + fromLease + "|" + toLease);
  //console.log(pyeong + "|" + price + "|" + lease);

  const pyeongValid =
    (isNaN(fromP) && isNaN(toP)) ||
    (!isNaN(pyeong) && (isNaN(fromP) || pyeong >= fromP) && (isNaN(toP) || pyeong <= toP));

  const priceValid =
    (isNaN(fromPrice) && isNaN(toPrice)) ||
    (!isNaN(price) && (isNaN(fromPrice) || price >= fromPrice) && (isNaN(toPrice) || price <= toPrice));

  const leaseValid =
    (isNaN(fromLease) && isNaN(toLease)) ||
    (!isNaN(lease) && (isNaN(fromLease) || lease >= fromLease) && (isNaN(toLease) || lease <= toLease));

  return pyeongValid && priceValid && leaseValid;
});


    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.gap = "1px";

    const fallbackColors = ['#000000', '#454648', '#474C4F', '#FF0000', '#FF6600', '#FFFF00',
                            '#92D050', '#00B050', '#00B0F0', '#0070C0', '#000099', '#7030A0',
                            '#CC3399', '#FF66CC'];

    function getColorByPrice(price) {
		const priceFloor = Math.floor(price);

		if (Array.isArray(priceColorSettings) && priceColorSettings.length > 0) {
			// priceColorSettingsê°€ ìˆëŠ” ê²½ìš°
			const exact = priceColorSettings.find(p => p.price === priceFloor);
			if (exact) return { bg: exact.bgColor, text: exact.textColor };

			// ì •ë ¬ëœ ë¦¬ìŠ¤íŠ¸
			const sorted = [...priceColorSettings].sort((a, b) => a.price - b.price);
			const min = sorted[0];
			const max = sorted[sorted.length - 1];

			if (priceFloor < min.price) {
				return { bg: min.bgColor, text: min.textColor }; // âœ… ìµœì†Œê°’ ì ìš©
			}

			if (priceFloor > max.price) {
				return { bg: max.bgColor, text: max.textColor }; // âœ… ìµœëŒ€ê°’ ì ìš©
			}

			// ì¤‘ê°„ ëˆ„ë½ êµ¬ê°„ì¸ ê²½ìš°: price ì´í•˜ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ê°’
			for (let i = sorted.length - 1; i >= 0; i--) {
				if (sorted[i].price <= priceFloor) {
					return { bg: sorted[i].bgColor, text: sorted[i].textColor };
				}
			}
		} else {
			// fallback ìƒ‰ìƒ
			const index = Math.min(Math.max(priceFloor - 3, 0), fallbackColors.length - 1);
			return { bg: fallbackColors[index], text: "#ffffff" };
		}
	}

//console.log("filteredData : "+filteredData.length)
    filteredData.forEach(d => {

    if (isNaN(d.ë§¤ë§¤)) return; // ë§¤ë§¤ê°€ ì—†ëŠ” ê²½ìš°ëŠ” ê±´ë„ˆëœ€

    const card = document.createElement("div");
    card.style.display = "flex";
    card.style.flexDirection = "column";
    card.style.alignItems = "center";
    card.style.border = "1px solid black";
    card.style.borderRadius = "4px";
    card.style.overflow = "hidden";
    card.style.width = "32px";
    card.style.fontSize = "13px";
    card.style.boxShadow = "1px 1px 3px rgba(0,0,0,0.2)";

    // í‰í˜• (ìƒë‹¨)
    const top = document.createElement("div");
    top.textContent = d.í‰í˜•;
    top.style.background = "white";
    top.style.color = "black";
    top.style.fontWeight = "bold";
    top.style.width = "100%";
    top.style.textAlign = "center";
    top.style.padding = "2px 0";

    // ìƒ‰ìƒ
    const { bg, text } = getColorByPrice(d.ë§¤ë§¤);

    // ê°€ê²© ì˜ì—­ (í•˜ë‹¨)
    const bottom = document.createElement("div");
    bottom.style.background = bg;
    bottom.style.color = text;
    bottom.style.display = "flex";
    bottom.style.flexDirection = "column";
    bottom.style.alignItems = "center";
    bottom.style.justifyContent = "center";
    bottom.style.padding = "5px 0";
    bottom.style.width = "100%";

	 // ë§¤ë§¤
	const ë§¤ë§¤ = document.createElement("div");
	ë§¤ë§¤.style.fontWeight = "bold";
	ë§¤ë§¤.style.minHeight = "1.5em";
	if (d.ë§¤ë§¤ !== undefined && d.ë§¤ë§¤ !== null && d.ë§¤ë§¤ !== "" && !isNaN(d.ë§¤ë§¤)) {
		ë§¤ë§¤.textContent = Number(d.ë§¤ë§¤).toFixed(1);
	} else {
		ë§¤ë§¤.textContent = " ";
	}
	bottom.appendChild(ë§¤ë§¤);

	// ì „ì„¸
	const ì „ì„¸ = document.createElement("div");
	ì „ì„¸.style.fontWeight = "bold";
	ì „ì„¸.style.minHeight = "1.5em";
	if (d.ì „ì„¸ !== undefined && d.ì „ì„¸ !== null && d.ì „ì„¸ !== "" && !isNaN(d.ì „ì„¸)) {
		ì „ì„¸.textContent = Number(d.ì „ì„¸).toFixed(1);
	} else {
		ì „ì„¸.textContent = " ";
	}
	bottom.appendChild(ì „ì„¸);


	const ê¸°íƒ€í¬í•¨ê°¯ìˆ˜ = filteredData.filter(d => {
	  return d.ê¸°íƒ€ !== undefined &&
			 d.ê¸°íƒ€ !== null &&
			 //d.ê¸°íƒ€ !== "" &&
			 //!isNaN(d.ê¸°íƒ€);
			 d.ê¸°íƒ€ !== ""
	}).length;
//console.log(ê¸°íƒ€í¬í•¨ê°¯ìˆ˜);
	if(ê¸°íƒ€í¬í•¨ê°¯ìˆ˜ > 0){
		// ê¸°íƒ€
		const ê¸°íƒ€ = document.createElement("div");
		ê¸°íƒ€.style.fontWeight = "bold";
		ê¸°íƒ€.style.minHeight = "1.5em";
		if (d.ê¸°íƒ€ !== undefined && d.ê¸°íƒ€ !== null && d.ê¸°íƒ€ !== "" && !isNaN(d.ê¸°íƒ€)) {
			ê¸°íƒ€.textContent = Number(d.ê¸°íƒ€).toFixed(1);
		} else if(d.ê¸°íƒ€ !== undefined && d.ê¸°íƒ€ !== null && d.ê¸°íƒ€ !== ""){
			ê¸°íƒ€.textContent = d.ê¸°íƒ€;
		} else {
			ê¸°íƒ€.textContent = " ";
		}
		bottom.appendChild(ê¸°íƒ€);
	}
		card.appendChild(top);
		card.appendChild(bottom);
		wrapper.appendChild(card);
	});


    container.innerHTML = "";
    container.appendChild(wrapper);

//console.log(filteredData);
  // âœ… ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ì–´ ë§‰ëŒ€ê°€ ì—†ì„ ê²½ìš° anchor ì¬ì¡°ì •
	if (filteredData.length === 0) {
	marker.setIcon({
		content: marker._contentWrapper,
		anchor: new naver.maps.Point(0, 20)
	});
} else {
	const hasEtc = filteredData.some(item => parseFloat(item["ê¸°íƒ€"]) > 0);

	if (hasEtc && marker._contentWrapper) {
		//console.log("ğŸ‘‰ ê¸°íƒ€ í•­ëª© í¬í•¨ë¨!");
		marker.setIcon({
			content: marker._contentWrapper,
			anchor: new naver.maps.Point(10, 80)
		});
	}else if (marker._contentWrapper) {
		marker.setIcon({
			content: marker._contentWrapper,
			anchor: new naver.maps.Point(10, 60)
		});
	}
}
}




function getSavedOrDefaultTable(apartmentId) {
    // IndexedDBì—ì„œ ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œë„
    // ì—†ìœ¼ë©´ ê¸°ë³¸ í…Œì´ë¸” ë°˜í™˜
    return new Promise((resolve) => {
        const request = indexedDB.open("hongSise", 4);
        request.onsuccess = function(event) {
            const db = event.target.result;
            const transaction = db.transaction(["apartments"], "readonly");
            const store = transaction.objectStore("apartments");
            const getRequest = store.get(`${apartmentId}-ì‹œì„¸1`);
            getRequest.onsuccess = function(event) {
                if (getRequest.result && getRequest.result.table) {
                    resolve(getRequest.result.table);
                } else {
                    resolve(generateDefaultTable());
                }
            };
            getRequest.onerror = () => {
                resolve(generateDefaultTable());
            };
        };
        request.onerror = () => {
            resolve(generateDefaultTable());
        };
    });
}

///////////////////// ì°¨íŠ¸ ìƒ‰ìƒ ì„¤ì • /////////////////////

let priceColorSettings = [];
document.getElementById("priceColorSettingsBtn").addEventListener("click", () => {


  loadColorSettingsFromDB().then(settings => {
    if (settings) {
      applyColorSettings(settings); // ë„¤ê°€ ì •ì˜í•œ í•¨ìˆ˜
    }

  });


    if (document.getElementById("priceColorModal")) {
        document.body.removeChild(document.getElementById("priceColorModal")); // ì¤‘ë³µ ì œê±°
    }

    const modal = document.createElement("div");
    modal.id = "priceColorModal";
    modal.style = `
        position: fixed;
        top: 30px;
        left: 50%;
        transform: translate(0%, 0%);
        background: white;
        border: 1px solid gray;
        padding: 15px;
        z-index: 10000;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        width: 400px;
        max-height: 90vh;
        overflow-y: auto;
    `;


    const saveBtn = document.createElement("button");
    saveBtn.innerText = "ì €ì¥";
    saveBtn.style = "margin-top: 10px; padding: 5px 10px;";
    saveBtn.onclick = () => {
		const rows = modal.querySelectorAll('.color-setting-row');


		for (const row of rows) {
			const color = row.querySelector(".bg-color-hex")?.value;
			const textColor = row.querySelector(".text-color-hex")?.value;

			const hasAnyValue = row.querySelector(".price-input")?.value.trim() !== "" ;

			if (hasAnyValue && color == "" || textColor == ""){
				alert("ê¸ˆì•¡ì´ ìˆëŠ” í–‰ì˜ ë°°ê²½ìƒ‰ì™€ ê¸€ììƒ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”");
				return; // âœ… ì „ì²´ í•¨ìˆ˜ ë¹ ì ¸ë‚˜ì˜´
			}
		}

		console.log("ğŸ” ì €ì¥ ì „ rows í™•ì¸", rows);

		const settings = collectColorSettings(modal);
		console.log("ğŸ¯ ìˆ˜ì§‘ëœ ì„¤ì •:", settings);

		if (!settings || settings.length === 0) {
			console.warn('[ê²½ê³ ] ì €ì¥í•  ìƒ‰ìƒ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
			return;
		}

		const tx = window.colorDB.transaction('chartColor', 'readwrite');
		const store = tx.objectStore('chartColor');
		const data = { id: 'priceColorSettings', settings };

		const request = store.put(data);
		request.onsuccess = () => {
			console.log('âœ… ìƒ‰ìƒ ì„¤ì • ì €ì¥ ì™„ë£Œ:', data);
		};
		request.onerror = e => {
			console.error('âŒ ìƒ‰ìƒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨', e);
		};

		priceColorSettings = settings;
		updateMarkers(window.map.getBounds(), true);
		document.body.removeChild(modal);
	};


	const closeButton = document.createElement("button");
	closeButton.innerText = "ë‹«ê¸°";
	closeButton.style = "margin-top: 10px; padding: 5px 10px;";
	closeButton.onclick = () => {
		document.body.removeChild(modal);
	};


// ... ê¸°ì¡´ saveBtn, closeBtn ì´í›„ì— ì¶”ê°€

// ì„¤ì • ì´ˆê¸°í™” ë²„íŠ¼
const resetBtn = document.createElement("button");
	resetBtn.innerText = "ì„¤ì • ì´ˆê¸°í™”";
	resetBtn.style = "margin-top: 10px; padding: 5px 10px;";
	resetBtn.onclick = () => {


  if (!window.colorDB) {
    alert("DBê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const confirmed = confirm("ê¸ˆì•¡ëŒ€ ìƒ‰ìƒ ì„¤ì •ì„ ì´ˆê¸°ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?");
  if (!confirmed) return;

  const tx = window.colorDB.transaction("chartColor", "readwrite");
  const store = tx.objectStore("chartColor");

  const deleteRequest = store.delete("priceColorSettings");

  deleteRequest.onsuccess = () => {
    console.log("ğŸ§¹ ê¸°ì¡´ ì„¤ì • ì‚­ì œ ì™„ë£Œ");

    // âœ… ì´ˆê¸°ê°’ ì €ì¥
    const saveRequest = store.put({
      id: "priceColorSettings",
      settings: defaultPriceColorSettings
    });

    saveRequest.onsuccess = () => {
      console.log("âœ… ì´ˆê¸°ê°’ ì €ì¥ ì™„ë£Œ");
      priceColorSettings = defaultPriceColorSettings;
      updateMarkers(window.map.getBounds(), true); // ë§ˆì»¤ ì¬ë Œë”ë§
	  document.body.removeChild(modal);
document.getElementById("priceColorSettingsBtn").click();
      alert("âœ… ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™” ì™„ë£Œ");
    };

    saveRequest.onerror = (e) => {
      console.error("âŒ ì´ˆê¸°ê°’ ì €ì¥ ì‹¤íŒ¨", e);
      alert("ì´ˆê¸°ê°’ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    };
  };

  deleteRequest.onerror = (e) => {
    console.error("âŒ ì„¤ì • ì‚­ì œ ì‹¤íŒ¨", e);
    alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  };
};





	modal.appendChild(saveBtn); // ì €ì¥ ë²„íŠ¼ì€ ê·¸ ì•„ë˜ì—

	modal.appendChild(closeButton);
	modal.appendChild(resetBtn);


    const title = document.createElement("h3");
    title.innerText = "ğŸ’° ê¸ˆì•¡ëŒ€ë³„ ìƒ‰ìƒ ì„¤ì •";
    title.style.marginTop = "10px";
	modal.appendChild(title);

	// í—¤ë” í–‰ ì¶”ê°€
	const header = document.createElement("div");
	header.style = "display: flex; align-items: center; margin-bottom: 8px; gap: 6px; font-weight: bold;";
	["ì–µëŒ€", "ë°°ê²½ìƒ‰", "", "ê¸€ììƒ‰", ""].forEach(text => {
		const label = document.createElement("div");
		label.textContent = text;
		label.style = "width: 70px;";
		header.appendChild(label);
	});
	modal.appendChild(header);


	const container = document.createElement("div");
	container.id = "colorSettingContainer";  // âœ… ë°˜ë“œì‹œ ì´ ID í•„ìš”
	modal.appendChild(container);
	for (let i = 0; i < 20; i++) {
		const row = document.createElement("div");
		row.classList.add("color-setting-row");
		row.style = "display: flex; align-items: center; margin-bottom: 8px; gap: 6px;";

		// ê¸ˆì•¡ëŒ€ ì…ë ¥
		const priceInput = document.createElement("input");
		priceInput.type = "number";
		priceInput.value = priceColorSettings[i]?.price || {}; // 3ì–µë¶€í„°
		priceInput.className = "price-input";
		priceInput.style = "width: 50px;";

		// ë°°ê²½ìƒ‰ í”¼ì»¤
		const bgColorPicker = document.createElement("input");
		bgColorPicker.type = "color";
		bgColorPicker.value = priceColorSettings[i]?.bgColor || "#000000";
		bgColorPicker.className = "bg-color-input";

		// ë°°ê²½ìƒ‰ HEX ì…ë ¥
		const bgColorInput = document.createElement("input");
		bgColorInput.type = "text";
		bgColorInput.value = bgColorPicker.value;
		bgColorInput.style = "width: 70px;";
		bgColorInput.className = "bg-color-hex";

		// ë™ê¸°í™”
		bgColorPicker.addEventListener("input", () => bgColorInput.value = bgColorPicker.value);
		bgColorInput.addEventListener("input", () => bgColorPicker.value = bgColorInput.value);

		// ê¸€ììƒ‰ í”¼ì»¤
		const textColorPicker = document.createElement("input");
		textColorPicker.type = "color";
		textColorPicker.value = priceColorSettings[i]?.textColor || "#ffffff";
		textColorPicker.className = "text-color-input";

		// ê¸€ììƒ‰ HEX ì…ë ¥
		const textColorInput = document.createElement("input");
		textColorInput.type = "text";
		textColorInput.value = textColorPicker.value;
		textColorInput.style = "width: 70px;";
		textColorInput.className = "text-color-hex";

		// ë™ê¸°í™”
		textColorPicker.addEventListener("input", () => textColorInput.value = textColorPicker.value);
		textColorInput.addEventListener("input", () => textColorPicker.value = textColorInput.value);

		// append ìˆœì„œ: ê¸ˆì•¡ëŒ€, ë°°ê²½ìƒ‰ í”¼ì»¤ + hex, ê¸€ììƒ‰ í”¼ì»¤ + hex
		row.appendChild(priceInput);
		row.appendChild(bgColorPicker);
		row.appendChild(bgColorInput);
		row.appendChild(textColorPicker);
		row.appendChild(textColorInput);

		modal.appendChild(row);
	}

	const notice = document.createElement("div");
	notice.textContent = "í•´ë‹¹ë˜ëŠ” ì–µëŒ€ì˜ ì„¤ì •ê°’ì´ ì—†ì„ ê²½ìš° ìµœì†Œê°’ê³¼ ìµœëŒ€ê°’ ìƒ‰ìƒìœ¼ë¡œ í‘œí˜„ë©ë‹ˆë‹¤";
	notice.style = "font-size: 14px; color: gray; margin-top: 10px;";

	modal.appendChild(notice);


		document.body.appendChild(modal);
		makeModalDraggable(modal);
	});


let colorDB;

function initColorSettingsDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("hongSiseColor"); // ë²„ì „ ë°˜ë“œì‹œ ì¦ê°€

    request.onupgradeneeded = (event) => {
		  const db = event.target.result;
		  if (!db.objectStoreNames.contains("chartColor")) {
			db.createObjectStore("chartColor", { keyPath: "id" });
			console.log("âœ… chartColor store created");
		  }
		  if (!db.objectStoreNames.contains("yearColor")) {
			db.createObjectStore("yearColor", { keyPath: "id" });
			console.log("âœ… yearColor store created");
		  }
    };

    request.onsuccess = (event) => {
      window.colorDB = event.target.result;
      console.log("âœ… DB opened");
      resolve(window.colorDB);
    };

    request.onerror = (event) => {
      console.error("âŒ DB open failed", event);
      reject(event);
    };
  });
}






function saveColorSettingsToDB(settings) {
    if (!settings || settings.length === 0) {
        console.warn('[ê²½ê³ ] ì €ì¥í•  ìƒ‰ìƒ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    if (!colorDB) {
        console.error("âŒ DBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ");
        return;
    }

    const tx = colorDB.transaction('chartColor', 'readwrite');
    const store = tx.objectStore('chartColor');

    const data = { id: 'priceColorSettings', settings };

    const request = store.put(data);

    request.onsuccess = () => {
        console.log('âœ… ìƒ‰ìƒ ì„¤ì • ì €ì¥ ì™„ë£Œ:', data);
        // ğŸ”„ ì €ì¥í•œ ë°ì´í„°ë¡œ ë©”ëª¨ë¦¬ ìƒíƒœë„ ê°±ì‹ 
        priceColorSettings = [...settings];
    };

    request.onerror = (e) => {
        console.error('âŒ ìƒ‰ìƒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨', e);
    };
}


function applyColorSettings(settings) {
    console.log("ğŸ’¡ ë¶ˆëŸ¬ì˜¨ ìƒ‰ìƒ ì„¤ì •:", settings);
    const rows = document.querySelectorAll(".color-setting-row");

    settings.forEach((setting, index) => {
        const row = rows[index];
        if (!row) return;

        const priceInput = row.querySelector(".price-input");
        const bgColorInput = row.querySelector(".bg-color-input");
        const textColorInput = row.querySelector(".text-color-input");

        if (priceInput) priceInput.value = setting.price;
        if (bgColorInput) bgColorInput.value = setting.bgColor;
        if (textColorInput) textColorInput.value = setting.textColor;
    });
}

//ì–µëŒ€ ìƒ‰ìƒ ì´ˆê¸°ê°’
const defaultPriceColorSettings = [
  { price: 3, bgColor: "#000000", textColor: "#ffffff" },
  { price: 4, bgColor: "#454648", textColor: "#ffffff" },
  { price: 5, bgColor: "#474c4f", textColor: "#ffffff" },
  { price: 6, bgColor: "#ff0000", textColor: "#ffffff" },
  { price: 7, bgColor: "#ff6600", textColor: "#ffffff" },
  { price: 8, bgColor: "#ffff00", textColor: "#000000" },
  { price: 9, bgColor: "#92d050", textColor: "#ffffff" },
  { price: 10, bgColor: "#00b050", textColor: "#ffffff" },
  { price: 11, bgColor: "#00b0f0", textColor: "#ffffff" },
  { price: 12, bgColor: "#0070c0", textColor: "#ffffff" },
  { price: 13, bgColor: "#000099", textColor: "#ffffff" },
  { price: 14, bgColor: "#7030a0", textColor: "#ffffff" },
  { price: 15, bgColor: "#cc3399", textColor: "#ffffff" },
  { price: 16, bgColor: "#ff66cc", textColor: "#ffffff" }
];


function loadColorSettingsFromDB() {
  return new Promise((resolve, reject) => {


    const tx = window.colorDB.transaction("chartColor", "readwrite");  // readwrite í•„ìš”
    const store = tx.objectStore("chartColor");

    const request = store.get("priceColorSettings");

    request.onsuccess = () => {
      const result = request.result;
      if (result) {
        console.log("âœ… ìƒ‰ìƒ ì„¤ì • ë¡œë“œ ì„±ê³µ", result.settings);
        resolve(result.settings);
      } else {
        console.log("â„¹ï¸ ìƒ‰ìƒ ì„¤ì • ì—†ìŒ â†’ ê¸°ë³¸ê°’ ì €ì¥");

        const defaultData = {
          id: "priceColorSettings",
          settings: defaultPriceColorSettings
        };
        store.put(defaultData);  // ê¸°ë³¸ê°’ ì €ì¥

        resolve(defaultPriceColorSettings);  // ê¸°ë³¸ê°’ ë°˜í™˜
      }
    };

    request.onerror = (event) => {
      console.error("âŒ ìƒ‰ìƒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨", event);
      reject(event);
    };
  });
}


function collectColorSettings() {
    const settings = [];
    const rows = document.querySelectorAll(".color-setting-row");

    rows.forEach(row => {
        const priceValue = row.querySelector(".price-input")?.value?.trim();
        const bgColor = row.querySelector(".bg-color-input")?.value;
        const textColor = row.querySelector(".text-color-input")?.value;

        if (priceValue !== "" && bgColor && textColor) {
            const price = parseInt(priceValue);
            if (!isNaN(price)) {
                settings.push({ price, bgColor, textColor });  // âœ… textColor í¬í•¨
            }
        }
    });

    console.log("[ìƒ‰ìƒ ì„¤ì • ìˆ˜ì§‘ë¨]", settings);
    return settings;
}


///////////////////// ì—°ì‹ ìƒ‰ìƒ ì„¤ì • /////////////////////


async function showYearColorSettingsModal() {
    if (document.getElementById("yearColorModal")) {
        document.body.removeChild(document.getElementById("yearColorModal"));
    }

    const modal = document.createElement("div");
    modal.id = "yearColorModal";
    modal.style = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid gray;
        padding: 15px;
        z-index: 10000;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        width: 500px;
        max-height: 70vh;
        overflow-y: auto;
    `;

    const title = document.createElement("h3");
    title.innerText = "ğŸ  ì—°ì‹ë³„ ë§ˆì»¤ ìƒ‰ìƒ ì„¤ì •";
    title.style.marginTop = "10px";
    modal.appendChild(title);

    // í—¤ë”
    const header = document.createElement("div");
header.style = "display: flex; gap: 10px; margin-bottom: 10px; font-weight: bold;";

// ê° ì—´ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì •ì˜ (CSSì ìš©ì´ ë” ì¢‹ì§€ë§Œ, JSë¡œ ì§ì ‘ ì£¼ëŠ” ë°©ì‹)
const columnStyles = [
  "width: 85px;", // From
  "width: 70px;", // To
  "width: 150px;", // ìƒ‰ìƒ í”¼ì»¤
  "width: 130px;", // ìƒ‰ìƒ í”¼ì»¤
  
];

["ì‹œì‘ë…„ë„", "ì¢…ë£Œë…„ë„", "ë°°ê²½ìƒ‰", "ê¸€ììƒ‰"].forEach((text, i) => {
  const span = document.createElement("span");
  span.innerText = text;
  span.style = columnStyles[i] + "text-align: center;"; // ë™ì¼í•œ í­ ë¶€ì—¬
  header.appendChild(span);
});
modal.appendChild(header);


    // ê¸°ì¡´ ì„¤ì • ìµœëŒ€ 10ê°œ
    for (let i = 0; i < 10; i++) {
		const row = document.createElement("div");
		row.classList.add("year-color-setting-row");
		row.style = "display: flex; gap: 5px; margin-bottom: 6px;";

		const fromInput = document.createElement("input");
		fromInput.type = "number";
		fromInput.placeholder = "from";
		fromInput.style = "width: 70px;";
		fromInput.className = "year-from";
		fromInput.style.boxSizing = "border-box";
		fromInput.style.padding = "4px";
		fromInput.style.marginLeft = "2px";
		fromInput.style.border = "1px solid #000";


		const toInput = document.createElement("input");
		toInput.type = "number";
		toInput.placeholder = "to";
		toInput.style = "width: 80px;";
		toInput.className = "year-to";
		toInput.style.boxSizing = "border-box";
		toInput.style.padding = "4px";
		toInput.style.marginLeft = "2px";
		toInput.style.border = "1px solid #000";

		// âœ… ë°°ê²½ìƒ‰
		const colorPicker = document.createElement("input");
		colorPicker.type = "color";
		colorPicker.value = "#000000";
		colorPicker.className = "year-color-picker";

		const colorInput = document.createElement("input");
		colorInput.type = "text";
		colorInput.value = "#000000";
		colorInput.style = "width: 80px;";
		colorInput.className = "year-color-hex";
		colorInput.style.boxSizing = "border-box";
		colorInput.style.padding = "4px";
		colorInput.style.marginLeft = "2px";
		colorInput.style.border = "1px solid #000";


		colorPicker.addEventListener("input", () => colorInput.value = colorPicker.value);
		colorInput.addEventListener("input", () => colorPicker.value = colorInput.value);

		// âœ… ê¸€ììƒ‰ (í…ìŠ¤íŠ¸ ìƒ‰ìƒ)
		const textColorPicker = document.createElement("input");
		textColorPicker.type = "color";
		textColorPicker.value = "#ffffff";
		textColorPicker.className = "year-text-color-picker";

		const textColorInput = document.createElement("input");
		textColorInput.type = "text";
		textColorInput.value = "#ffffff";
		textColorInput.style = "width: 80px;";
		textColorInput.className = "year-text-color-hex";
		textColorInput.style.boxSizing = "border-box";
		textColorInput.style.padding = "4px";
		textColorInput.style.marginLeft = "2px";
		textColorInput.style.border = "1px solid #000";

		textColorPicker.addEventListener("input", () => textColorInput.value = textColorPicker.value);
		textColorInput.addEventListener("input", () => textColorPicker.value = textColorInput.value);

		row.appendChild(fromInput);
		row.appendChild(toInput);
		row.appendChild(colorPicker);
		row.appendChild(colorInput);
		row.appendChild(textColorPicker);   // âœ… ì¶”ê°€
		row.appendChild(textColorInput);   // âœ… ì¶”ê°€

		modal.appendChild(row);
	}


    const saveBtn = document.createElement("button");
    saveBtn.innerText = "ì €ì¥";
    saveBtn.style = "margin-top: 10px;";
    saveBtn.onclick = async () => {
        const settings = [];
        const rows = modal.querySelectorAll(".year-color-setting-row");
		
		for (const row of rows) {
			const from = parseInt(row.querySelector(".year-from")?.value);
			const to = parseInt(row.querySelector(".year-to")?.value);
			const color = row.querySelector(".year-color-hex")?.value;
			const fontColor = row.querySelector(".year-text-color-hex")?.value;

			const hasAnyValue =
			row.querySelector(".year-from")?.value.trim() !== "" ||
			row.querySelector(".year-to")?.value.trim() !== "" 
			;



			if (hasAnyValue && (row.querySelector(".year-from")?.value.trim() == "" || 
								row.querySelector(".year-to")?.value.trim() == "" ||
								row.querySelector(".year-color-hex")?.value.trim() == "" ||
								row.querySelector(".year-text-color-hex")?.value.trim() == "")){

				alert("í•˜ë‚˜ë¼ë„ ê°’ì´ ìˆëŠ” ê²½ìš° í–‰ì˜ ëª¨ë“  í•­ëª©ì„ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤");
				return; // âœ… ì „ì²´ í•¨ìˆ˜ ë¹ ì ¸ë‚˜ì˜´
			}

			if (!isNaN(from) && !isNaN(to) && color && fontColor) {
				settings.push({ from, to, color, fontColor });
			}
		}



		await saveYearColorSettingsToDB(settings);
        
        // ì¶”í›„ DB ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ ê°€ëŠ¥
        document.body.removeChild(modal);
		
		console.log(window.yearColorSettings);
		updateMarkers(window.map.getBounds(), true);
    };

	const closeBtn = document.createElement("button");
    closeBtn.innerText = "ë‹«ê¸°";
    closeBtn.style = "margin-top: 10px;";
    closeBtn.onclick = async () => {
        
        // ì¶”í›„ DB ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ ê°€ëŠ¥
        document.body.removeChild(modal);
		
		
    };

	const resetBtn = document.createElement("button");
	resetBtn.innerText = "ì„¤ì • ì´ˆê¸°í™”";
	resetBtn.style = "padding: 10px 10px;";
	resetBtn.onclick = () => {
	  // IndexedDBì—ì„œ ì—°ì‹ ì„¤ì • ì‚­ì œ
	  const tx = window.colorDB.transaction("yearColor", "readwrite");
	  const store = tx.objectStore("yearColor");
	  const request = store.delete("yearColorSettings");

	  request.onsuccess = async() => {
		const confirmed = confirm("ì—°ì‹ ìƒ‰ìƒ ì„¤ì •ì„ ì´ˆê¸°ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?");
	  if (!confirmed) return;

	  const defaultSettings = [...DEFAULT_YEAR_COLOR_SETTINGS]; // âœ… ê¸°ë³¸ê°’
	  await saveYearColorSettingsToDB(defaultSettings); // âœ… DBì— ì €ì¥ ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼

	  yearColorSettings = defaultSettings; // âœ… ë©”ëª¨ë¦¬ ë°˜ì˜
	  bindYearColorSettingsToModal(defaultSettings); // âœ… ëª¨ë‹¬ì—ë„ ë°˜ì˜

	  // âœ… ë§ˆì»¤ ìƒˆë¡œê³ ì¹¨ (ì™„ì „íˆ ì‚­ì œ í›„ ì¬ìƒì„±)
	  updateMarkers(window.map.getBounds(), true);
	  };
	  request.onerror = () => {
		alert("ì´ˆê¸°í™” ì‹¤íŒ¨");
	  };
	};

    modal.appendChild(saveBtn);
    modal.appendChild(closeBtn);
	modal.appendChild(resetBtn);

    document.body.appendChild(modal);

    makeModalDraggable(modal);


	bindYearColorSettingsToModal();


}




let yearColorSettings = [];

document.getElementById("yearColorSettingsBtn").addEventListener("click", () => {


showYearColorSettingsModal();

});



function saveYearColorSettingsToDB(settings) {
  return new Promise((resolve, reject) => {
    if (!window.colorDB) {
      console.error("âŒ DBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ");
      reject("DB ë¯¸ì´ˆê¸°í™”");
      return;
    }

    const tx = window.colorDB.transaction("yearColor", "readwrite");
    const store = tx.objectStore("yearColor");
    const data = { id: "yearColorSettings", settings };

    const request = store.put(data);
    request.onsuccess = () => {
      console.log("âœ… ì—°ì‹ ìƒ‰ìƒ ì„¤ì • ì €ì¥ ì™„ë£Œ:", [...settings]);
      window.yearColorSettings = [...settings];
      resolve(); // âœ… ì €ì¥ ì™„ë£Œ
    };
    request.onerror = (e) => {
      console.error("âŒ ì—°ì‹ ìƒ‰ìƒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨", e);
      reject(e);
    };
  });
}

const DEFAULT_YEAR_COLOR_SETTINGS = [
  { from: 1900, to: 1999, color: "#5c6267", fontColor: "#ffffff" },
  { from: 2000, to: 2009, color: "#f5ee2e", fontColor: "#000000" },
  { from: 2010, to: 2019, color: "#ee1a24", fontColor: "#ffffff" },
  { from: 2020, to: 2999, color: "#3e24d7", fontColor: "#ffffff" }
];


function loadYearColorSettingsFromDB() {
  return new Promise((resolve, reject) => {
    if (!window.colorDB) {
      console.error("âŒ DB ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ");
      reject("DB ì´ˆê¸°í™” ì•ˆë¨");
      return;
    }

    const tx = window.colorDB.transaction("yearColor", "readwrite");
    const store = tx.objectStore("yearColor");

    const request = store.get("yearColorSettings");

    request.onsuccess = () => {
      const result = request.result;
      if (result) {
        console.log("âœ… ì—°ì‹ ìƒ‰ìƒ ì„¤ì • ë¡œë“œ ì„±ê³µ", result.settings);
        resolve(result.settings);
      } else {
        console.log("â„¹ï¸ ì—°ì‹ ì„¤ì • ì—†ìŒ â†’ ê¸°ë³¸ê°’ ì €ì¥");

        const defaultData = {
          id: "yearColorSettings",
          settings: DEFAULT_YEAR_COLOR_SETTINGS
        };
        store.put(defaultData);
        resolve(DEFAULT_YEAR_COLOR_SETTINGS);
      }
    };

    request.onerror = (event) => {
      console.error("âŒ ì—°ì‹ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨", event);
      reject(event);
    };
  });
}


function bindYearColorSettingsToModal() {
//console.log(window.yearColorSettings);
  const modal = document.getElementById("yearColorModal");
  if (!modal) return;

  const rows = modal.querySelectorAll(".year-color-setting-row");

  rows.forEach((row, index) => {
    const fromInput = row.querySelector(".year-from");
    const toInput = row.querySelector(".year-to");
    const bgColorPicker = row.querySelector(".year-color-picker");
    const bgColorHex = row.querySelector(".year-color-hex");
    const textColorPicker = row.querySelector(".year-text-color-picker");
    const textColorHex = row.querySelector(".year-text-color-hex");

    if (Array.isArray(window.yearColorSettings) && window.yearColorSettings[index]) {
      const setting = window.yearColorSettings[index];
      fromInput.value = setting.from ?? "";
      toInput.value = setting.to ?? "";
      bgColorPicker.value = setting.color ?? "#000000";
      bgColorHex.value = setting.color ?? "#000000";
      textColorPicker.value = setting.fontColor ?? "#FFFFFF";
      textColorHex.value = setting.fontColor ?? "#FFFFFF";
    } else {
      // ê¸°ë³¸ê°’ ì´ˆê¸°í™”
      fromInput.value = "";
      toInput.value = "";
      bgColorPicker.value = "#000000";
      bgColorHex.value = "#000000";
      textColorPicker.value = "#FFFFFF";
      textColorHex.value = "#FFFFFF";
    }
  });
}

let hideNoPrice = false;
document.getElementById("hideNoPriceBtn").addEventListener("click", () => {
  hideNoPrice = true;

  document.querySelectorAll(".marker-wrapper").forEach(wrapper => {
    const chart = wrapper.querySelector(".priceChartContainer");
    const marker = wrapper.querySelector("[data-apartment-id]");
    const absoluteWrapper = wrapper.parentElement;

    const barArea = chart?.querySelector("div");
    const hasVisibleChart = barArea && barArea.children.length > 0 && window.getComputedStyle(chart).display !== "none";

    if (hasVisibleChart) {
      wrapper.style.display = "inline-flex";
      if (marker) marker.style.display = "inline-block";
      if (absoluteWrapper) absoluteWrapper.style.display = "block";
    } else {
      if (absoluteWrapper) absoluteWrapper.style.display = "none";
    }
  });
});




document.getElementById("filterPriceFrom").addEventListener("input", () => {
  updateMarkers(window.map.getBounds(), true);
});

document.getElementById("filterPriceTo").addEventListener("input", () => {
  updateMarkers(window.map.getBounds(), true);
});

document.getElementById("filterLeaseFrom").addEventListener("input", () => {
  updateMarkers(window.map.getBounds(), true);
});

document.getElementById("filterLeaseTo").addEventListener("input", () => {
  updateMarkers(window.map.getBounds(), true);
});
document.getElementById("resetFiltersBtn").addEventListener("click", () => {
  const ids = [
    "filterPyeongFrom", "filterPyeongTo",
    "filterPriceFrom", "filterPriceTo",
    "filterLeaseFrom", "filterLeaseTo"
  ];

  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  updateMarkers(window.map.getBounds(), true); // âœ… ë§ˆì»¤ë„ ìƒˆë¡œê³ ì¹¨
});

//ì§€ë„ ìœ„ì¹˜ ì €ì¥

function openHongSiseDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("hongSise", 4);

    request.onupgradeneeded = function (event) {
      const db = event.target.result;

      if (!db.objectStoreNames.contains("settings")) {
        db.createObjectStore("settings");
      }

      if (!db.objectStoreNames.contains("apartments")) {
        db.createObjectStore("apartments", { keyPath: "idType" });
      }

    };

    request.onsuccess = function (event) {
      resolve(event.target.result); // âœ… ë§¤ë²ˆ ìƒˆë¡œ resolve
    };

    request.onerror = function (event) {
      reject(event.target.error);
    };
  });
}


function setSettingToHongSiseDB(key, value) {
  return new Promise((resolve, reject) => {
    openHongSiseDB().then(db => {
      const tx = db.transaction("settings", "readwrite");
      const store = tx.objectStore("settings");
      store.put(value, key);

      tx.oncomplete = () => {
        db.close(); // âœ… ì™„ë£Œ í›„ ë‹«ê¸°
        resolve();
      };

      tx.onerror = (e) => {
        db.close(); // â— ì—ëŸ¬ê°€ ë‚˜ë„ ë‹«ê¸°
        reject(e);
      };
    }).catch(reject);
  });
}

function getSettingFromHongSiseDB(key) {
  return new Promise((resolve, reject) => {
    openHongSiseDB().then((db) => {
      const tx = db.transaction("settings", "readonly");
      const store = tx.objectStore("settings");
      const request = store.get(key);

      request.onsuccess = () => {
        resolve(request.result); // âœ… ë°”ë¡œ ì—¬ê¸°ê°€ í•µì‹¬!
      };

      request.onerror = (e) => {
        reject(e);
      };
    }).catch(reject);
  });
}


/* ============ DEBUG INSTRUMENTATION: Hong WASD/Focus/IME ============ */
(function () {
  const DEBUG = true;
  const tag = '[DBG]';
  const dlog = (...args) => DEBUG && console.log(tag, ...args);

  // ì•ˆì „í•œ ì—˜ë¦¬ë¨¼íŠ¸ ì„¤ëª…
  function describeEl(el) {
    if (!el) return null;
    return {
      tag: el.tagName,
      id: el.id || null,
      class: el.className || null,
      name: el.name || null,
      contentEditable: !!el.isContentEditable
    };
  }

  // í‚¤ ì´ë²¤íŠ¸ ìš”ì•½
  function keyInfo(e) {
    return {
      key: e.key,
      code: e.code,
      isComposing: e.isComposing,
      repeat: e.repeat,
      defaultPrevented: e.defaultPrevented,
      target: describeEl(e.target),
      activeElt: describeEl(document.activeElement),
      hasActiveMarker: !!window.activeMarker,
      activeMarkerId: window.activeMarker?.apartmentId ?? null
    };
  }

  // ì°½ í¬ì»¤ìŠ¤/ê°€ì‹œì„±/IME ìƒíƒœ ëª¨ë‹ˆí„°ë§
  window.addEventListener('focus', () => dlog('window focus'));
  window.addEventListener('blur', () => dlog('window blur'));
  document.addEventListener('visibilitychange', () => dlog('visibility', document.visibilityState));

  window.addEventListener('compositionstart', (e) => dlog('compositionstart'));
  window.addEventListener('compositionend',   (e) => dlog('compositionend'));

  // í¬ì»¤ìŠ¤ ì´ë™ íë¦„ ì¶”ì  (ì–´ë””ê°€ í‚¤ë¥¼ ë¨¹ëŠ”ì§€ ë³´ê¸°)
  document.addEventListener('focusin',  (e) => dlog('focusin',  describeEl(e.target)));
  document.addEventListener('focusout', (e) => dlog('focusout', describeEl(e.target)));

  // ì§€ë„ ì •ë³´/ì¤Œ/í† ê¸€ ìƒíƒœ ê°„ì´ ì²´í¬
  function snapshotUI(prefix='UI') {
    try {
      const zoom = window.map?.getZoom?.();
      const showApt = document.getElementById('toggleApartments')?.checked;
      const siseOn  = document.getElementById('toggleSiseMap')?.checked;
      dlog(prefix, { zoom, showApartments: showApt, siseMap: siseOn, activeMarker: !!window.activeMarker, activeMarkerId: window.activeMarker?.apartmentId ?? null });
    } catch (e) { /* noop */ }
  }

  // ===== 1) global key logger (capture ë‹¨ê³„) =====
  function globalKeydownLogger(e) {
    dlog('keydown (capture)', keyInfo(e));
  }
  function globalKeyupLogger(e) {
    dlog('keyup (capture)', keyInfo(e));
  }
  window.addEventListener('keydown', globalKeydownLogger, { capture: true });
  window.addEventListener('keyup',   globalKeyupLogger,   { capture: true });
  dlog('Global key loggers registered (capture=true)');

  // ===== 2) handleKeyDown ë˜í•‘(ìˆìœ¼ë©´), ì—†ìœ¼ë©´ ì„ì‹œ í•¸ë“¤ëŸ¬ =====
  if (typeof window.handleKeyDown === 'function') {
    const _orig = window.handleKeyDown;
    window.handleKeyDown = function (e) {
      dlog('handleKeyDown: ENTER', keyInfo(e));
      try {
        return _orig.call(this, e);
      } finally {
        dlog('handleKeyDown: EXIT');
      }
    };
    dlog('handleKeyDown wrapped âœ…');
  } else {
    // í˜¹ì‹œ ì •ì˜ ì „ ë“±ë¡ë˜ì–´ ë¨¹í†µì´ë©´ ì„ì‹œë¡œë¼ë„ ë¡œê¹…
    window.handleKeyDown = function (e) {
      dlog('handleKeyDown (shim): missing original, swallowed', keyInfo(e));
    };
    dlog('handleKeyDown shim installed âš ï¸');
  }

  // ì¤‘ë³µ/ìˆœì„œ ê¼¬ì„ ë°©ì§€ë¡œ capture=trueë¡œ ì¬ë“±ë¡
  try {
    window.removeEventListener('keydown', window.handleKeyDown, { capture: true });
  } catch (e) {}
  window.addEventListener('keydown', window.handleKeyDown, { capture: true });
  dlog('handleKeyDown (re)registered with capture=true');

  // ===== 3) ìš°í´ë¦­ ì„ íƒ ë¡œê¹…(ë§ˆì»¤ ì„ íƒ íë¦„) =====
  // addMarkerRightClickEventê°€ ì´ë¯¸ ë§ˆì»¤ì— ë¦¬ìŠ¤ë„ˆë¥¼ ë¶™ì´ëŠ”ë°, ì—¬ê¸°ì— ë¡œê¹… ì¶”ê°€ í›…ì„ ë§ëŒ‘ë‹ˆë‹¤.
  if (typeof window.addMarkerRightClickEvent === 'function') {
    const _add = window.addMarkerRightClickEvent;
    window.addMarkerRightClickEvent = function (marker, markerElement) {
      // ì›ë˜ ê¸°ëŠ¥ ì‹¤í–‰
      _add(marker, markerElement);

      // ë³„ë„ì˜ ë¡œê±°ë¥¼ ê°™ì€ ë§ˆì»¤ì— ì¶”ê°€ (ì¤‘ë³µ ëŒ€ë¹„í•´ë„ ë¬¸ì œ ì—†ìŒ)
      try {
        naver.maps.Event.addListener(marker, 'rightclick', (e) => {
          dlog('RIGHTCLICK on marker', {
            id: marker?.apartmentId ?? null,
            hasElement: !!markerElement,
            targetInsideTable: !!e?.domEvent?.target?.closest?.('.tableContainer')
          });
          // activeMarker ì„¸íŒ…ì´ ë¹„ë™ê¸°ë¡œ ì´ë¤„ì§€ë©´ ë‹¤ìŒ í‹±ì—ì„œ í™•ì¸
          setTimeout(() => {
            dlog('After rightclick: activeMarker?', {
              has: !!window.activeMarker,
              id: window.activeMarker?.apartmentId ?? null
            });
            snapshotUI('UI after rightclick');
          }, 0);
        });
      } catch (err) {
        dlog('rightclick logger attach error', err);
      }
    };
    dlog('addMarkerRightClickEvent wrapped âœ…');
  } else {
    dlog('addMarkerRightClickEvent not found (no wrap) âš ï¸');
  }

  // ===== 4) updateMarkers ì„±ëŠ¥+ê²°ê³¼ì¹˜ ìŠ¤ëƒ…ìƒ· =====
  if (typeof window.updateMarkers === 'function') {
    const _upd = window.updateMarkers;
    window.updateMarkers = function (bounds, all = false) {
      const t0 = performance.now();
      let beforeCount = 0;
      try {
        beforeCount = Object.keys(window.apartmentMarkers || {}).length;
      } catch (e) {}

      snapshotUI('updateMarkers: ENTER');
      const res = _upd.call(this, bounds, all);

      const ms = (performance.now() - t0).toFixed(1);
      let afterCount = 0;
      try {
        afterCount = Object.keys(window.apartmentMarkers || {}).length;
      } catch (e) {}
      dlog('updateMarkers: EXIT', { all, ms, beforeCount, afterCount });
      return res;
    };
    dlog('updateMarkers wrapped âœ…');
  } else {
    dlog('updateMarkers not found (no wrap) âš ï¸');
  }

  // ===== 5) ì§€ë„ ì´ë²¤íŠ¸(ì´ˆê°„ë‹¨) =====
  try {
    if (window.map && typeof naver !== 'undefined') {
      naver.maps.Event.addListener(window.map, 'idle', () => {
        dlog('map idle', { zoom: window.map.getZoom() });
      });
    } else {
      // ì§€ë„ ì¤€ë¹„ ì „ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì•½ê°„ì˜ í´ë§ í›„ ì—°ê²°
      const iv = setInterval(() => {
        if (window.map && typeof naver !== 'undefined') {
          clearInterval(iv);
          naver.maps.Event.addListener(window.map, 'idle', () => {
            dlog('map idle', { zoom: window.map.getZoom() });
          });
          dlog('Map idle logger attached âœ…');
        }
      }, 200);
    }
  } catch (e) {
    dlog('map idle logger attach error', e);
  }

  // ===== 6) ì˜¤ë²„ë ˆì´ê°€ í‚¤ ë¨¹ëŠ”ì§€ í™•ì¸ (#apartmentInfo ë“±) =====
  const infoEl = document.getElementById('apartmentInfo');
  if (infoEl) {
    ['keydown','keyup','mousedown','click','contextmenu'].forEach((type) => {
      infoEl.addEventListener(type, (e) => {
        dlog(`#apartmentInfo ${type}`, { target: describeEl(e.target) });
      }, true); // captureì—ì„œ ë¨¼ì € ë¡œê¹…
    });
  }

  dlog('ğŸ” Debug instrumentation ready.');
})();



</script>





</body>
</html>



