<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í™ë¶€ ë©”ëª¨ ë°±ì—… (ì§€ì—­ í•„í„° ì§€ì›)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { --bg:#f7f7f9; --card:#fff; --text:#222; --muted:#666; --brand:#4A90E2; --brand2:#357ABD; }
    html, body { height: 100%; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans', Arial, sans-serif; margin:0; padding:24px; background:var(--bg); color:var(--text); }
    h1 { margin:0 0 14px; font-size:24px; }
    p  { margin:6px 0 14px; color:var(--muted) }
    .card { background:var(--card); border:1px solid #e9e9ef; border-radius:12px; padding:16px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    label { font-size:14px; color:#333; }
    select, button, input[type="number"] { font-size:14px; border-radius:8px; border:1px solid #d7d7de; padding:8px 10px; background:#fff; }
    select { min-width: 180px; }
    button { background:var(--brand); color:#fff; border:none; cursor:pointer; padding:10px 16px; font-weight:600; }
    button:hover { background:var(--brand2); }
    button.secondary { background:#fff; color:#333; border:1px solid #d7d7de; }
    .muted { color:var(--muted); font-size:13px; }
    .counter { font-size:13px; color:#333; margin-left:auto; }
    .downloads { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .divider { height:1px; background:#eee; margin:12px 0; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>ğŸ“¦ í™ë¶€ ë©”ëª¨ ë°±ì—…</h1>
  <p>ì‹œë„/ì‹œêµ°êµ¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”. <span class="muted">ëª©ë¡ì—ëŠ” "ë©”ëª¨ê°€ ì¡´ì¬í•˜ëŠ” ì§€ì—­"ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</span></p>

  <div class="card" id="filters">
    <div class="row" style="gap:12px">
      <label>ì‹œë„
        <select id="sidoFilter">
          <option value="">ì „ì²´</option>
        </select>
      </label>
      <label>ì‹œêµ°êµ¬
        <select id="sigunguFilter" disabled>
          <option value="">ì „ì²´</option>
        </select>
      </label>
      <button id="refreshRegions" class="secondary">ğŸ”„ ì§€ì—­ ìƒˆë¡œê³ ì¹¨</button>
      <label class="secondary" style="display:flex;align-items:center;gap:8px">
        <input type="file" id="aptFile" accept="application/json,.json" />
        <span class="muted">apt.json ë¶ˆëŸ¬ì˜¤ê¸°</span>
      </label>
      <span id="aptStatus" class="muted">(ì•„íŒŒíŠ¸ ë°ì´í„° ë¯¸ë¡œë”©)</span>
      <span class="counter">ì„ íƒëœ ë©”ëª¨: <b id="selCount">0</b>ê±´</span>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row">
      <button id="backupBtn">â¬‡ï¸ ì„ íƒ ë©”ëª¨ ë°±ì—…</button>
      <span class="muted">ëŒ€ëŸ‰ì¼ ê²½ìš° ì—¬ëŸ¬ PARTë¡œ ë‚˜ë‰˜ì–´ ìƒì„±ë©ë‹ˆë‹¤.</span>
    </div>
    <div class="divider"></div>
    <div id="downloadContainer" class="downloads"></div>
  </div>

  <script>
    // === IndexedDB ì„¤ì • ===
    const DB_NAME = 'hongbuMemo';
    const DB_VERSION = 4; // memoBackup.htmlê³¼ ë™ì¼ ë²„ì „
    const STORE_NOTES = 'apartmentNotes';

    // === UI ìš”ì†Œ ===
    const els = {
      sido: document.getElementById('sidoFilter'),
      sigungu: document.getElementById('sigunguFilter'),
      refresh: document.getElementById('refreshRegions'),
      backup: document.getElementById('backupBtn'),
      selCount: document.getElementById('selCount'),
      downloads: document.getElementById('downloadContainer'),
      aptFile: document.getElementById('aptFile'),
      aptStatus: document.getElementById('aptStatus'),
    };

    // === ìœ í‹¸: ì˜µì…˜ ì±„ìš°ê¸° (value: ì½”ë“œ, label: ì´ë¦„) ===
    function fillOptions(selectEl, items) {
      const prev = selectEl.value;
      selectEl.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = 'ì „ì²´';
      selectEl.appendChild(optAll);
      (items || []).forEach(({ value, label }) => {
        const opt = document.createElement('option');
        opt.value = String(value ?? '');
        opt.textContent = String(label ?? value ?? '');
        selectEl.appendChild(opt);
      });
      if ([...selectEl.options].some(o => o.value === prev)) selectEl.value = prev;
    }

    // === ì•„íŒŒíŠ¸ ì¸ë±ìŠ¤ (apt.json) ===
    const aptIndex = new Map(); // aptId(string) -> {sido, sidoNm, sigungu, sigunguNm}

    function setAptStatus(text){ if(els.aptStatus) els.aptStatus.textContent = text; }

    // apt.json íŒŒì¼ ì—…ë¡œë“œ íŒŒì„œ
    async function loadAptJsonFromFile(file){
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        ingestAptData(data);
        setAptStatus(`ì•„íŒŒíŠ¸ ${aptIndex.size}ê±´ ë¡œë”©ë¨`);
      }catch(err){
        console.error(err);
        setAptStatus('apt.json íŒŒì‹± ì‹¤íŒ¨');
        alert('apt.jsonì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë‹¤ì–‘í•œ í˜•íƒœì˜ apt.jsonì„ ìˆ˜ìš©í•˜ì—¬ ì¸ë±ì‹±
    function ingestAptData(data){
      aptIndex.clear();
      const arr = Array.isArray(data) ? data : (
        Array.isArray(data?.apartments) ? data.apartments :
        Array.isArray(data?.data) ? data.data : []
      );
      arr.forEach(a => {
        const id = String(a.id ?? a.apartmentId ?? a.aptId ?? '').trim();
        if(!id) return;
        const entry = {
          sido: String(a.sido ?? a.sidoCode ?? '').trim(),
          sidoNm: String(a.sidoNm ?? a.sidoName ?? '').trim(),
          sigungu: String(a.sigungu ?? a.sigunguCode ?? '').trim(),
          sigunguNm: String(a.sigunguNm ?? a.sigunguName ?? '').trim(),
        };
        aptIndex.set(id, entry);
      });
    }

    // === ìœ í‹¸: ë…¸íŠ¸ì—ì„œ ì•„íŒŒíŠ¸ID -> ì§€ì—­ì½”ë“œ/ì´ë¦„ ë§¤í•‘ ì¡°íšŒ ===
    function regionFromNoteViaApt(note){
      const id = String(note?.id ?? note?.aptId ?? note?.apartmentId ?? '').trim();
      if(!id) return null;
      const a = aptIndex.get(id);
      if(!a) return null;
      return {
        sidoCode: a.sido || '',
        sidoName: a.sidoNm || a.sido || '',
        sigunguCode: a.sigungu || '',
        sigunguName: a.sigunguNm || a.sigungu || '',
      };
    }

    // === ìœ í‹¸: ë…¸íŠ¸ì—ì„œ ì§€ì—­ì½”ë“œ/ì´ë¦„ì„ ê´€ëŒ€í•˜ê²Œ ì¶”ì¶œ ===
    function normalizeRegionFromNote(note) {
      // 1) ìš°ì„  apt.json ì¸ë±ìŠ¤ë¡œë¶€í„° ì¡°ì¸
      const viaApt = regionFromNoteViaApt(note);
      if (viaApt) return viaApt;
      // 2) (ë°±ì—… í˜¸í™˜) ë©”ëª¨ ê°ì²´ ìì²´ì— ì§€ì—­ í•„ë“œê°€ ìˆëŠ” ê²½ìš°ë§Œ ë³´ì¡°ë¡œ ì‚¬ìš©
      const sCode = String(note.sido ?? note.sidoCode ?? note.siCode ?? '').trim();
      const sName = String(note.sidoNm ?? note.sidoName ?? note.siName ?? '').trim();
      const gCode = String(note.sigungu ?? note.sigunguCode ?? note.guCode ?? '').trim();
      const gName = String(note.sigunguNm ?? note.sigunguName ?? note.guName ?? '').trim();
      return {
        sidoCode: sCode || (sName ? sName : ''),
        sidoName: sName || (sCode ? sCode : ''),
        sigunguCode: gCode || (gName ? gName : ''),
        sigunguName: gName || (gCode ? gCode : ''),
      };
    }

    // === DB ì—´ê¸° ===
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onsuccess = e => resolve(e.target.result);
        req.onerror = () => reject(new Error('DB ì—´ê¸° ì‹¤íŒ¨'));
      });
    }

    // === ëª¨ë“  ë…¸íŠ¸ ìˆœíšŒ ===
    async function getAllNotes() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction([STORE_NOTES], 'readonly');
        const st = tx.objectStore(STORE_NOTES);
        const out = [];
        const req = st.openCursor();
        req.onsuccess = e => {
          const cur = e.target.result;
          if (cur) { out.push(cur.value); cur.continue(); }
          else { resolve(out); db.close(); }
        };
        req.onerror = () => { reject(new Error('cursor ì‹¤íŒ¨')); db.close(); };
      });
    }

    // === ì§€ì—­ ëª©ë¡ êµ¬ì„± (ë©”ëª¨ê°€ ì¡´ì¬í•˜ëŠ” ì§€ì—­ë§Œ) ===
    async function buildRegionFiltersFromNotes() {
      const notes = await getAllNotes();
      if(aptIndex.size === 0){
        // apt.jsonì´ ë¡œë”©ë˜ì§€ ì•Šì•˜ë‹¤ë©´, ì¼ë‹¨ ì¹´ìš´íŠ¸ë§Œ ê°±ì‹ í•˜ê³  ì¢…ë£Œ
        setAptStatus('(ì•„íŒŒíŠ¸ ë°ì´í„° ë¯¸ë¡œë”©)');
        els.sigungu.disabled = true;
        fillOptions(els.sido, []);
        updateSelectedCount(notes);
        return;
      }

      const bySido = new Map(); // sidoCode -> { name, sigungu: Map(sigCode -> {name,count}), count }

      notes.forEach(n => {
        const r = normalizeRegionFromNote(n); // ë‚´ë¶€ì ìœ¼ë¡œ aptIndex ì‚¬ìš©
        if (!r || !r.sidoCode) return; // ì§€ì—­ ì—†ëŠ” ë©”ëª¨ëŠ” ìŠ¤í‚µ
        if (!bySido.has(r.sidoCode)) bySido.set(r.sidoCode, { name: r.sidoName || r.sidoCode, sigungu: new Map(), count: 0 });
        const node = bySido.get(r.sidoCode);
        node.count++;
        if (r.sigunguCode) {
          const cur = node.sigungu.get(r.sigunguCode) || { name: r.sigunguName || r.sigunguCode, count: 0 };
          cur.count++;
          node.sigungu.set(r.sigunguCode, cur);
        }
      });

      // ì‹œë„ ì˜µì…˜ (ì´ë¦„ + ê±´ìˆ˜)
      const sidoItems = Array.from(bySido.entries())
        .map(([code, { name, count }]) => ({ value: code, label: `${name} (${count}ê±´)` }))
        .sort((a, b) => a.label.localeCompare(b.label, 'ko'));
      fillOptions(els.sido, sidoItems);

      // ì„ íƒëœ ì‹œë„ì˜ ì‹œêµ°êµ¬ ì˜µì…˜ (ì´ë¦„ + ê±´ìˆ˜)
      const selSido = (els.sido.value || '').trim();
      if (selSido && bySido.has(selSido)) {
        const sigItems = Array.from(bySido.get(selSido).sigungu.entries())
          .map(([code, obj]) => ({ value: code, label: `${obj.name} (${obj.count}ê±´)` }))
          .sort((a, b) => a.label.localeCompare(b.label, 'ko'));
        fillOptions(els.sigungu, sigItems);
        els.sigungu.disabled = false;
      } else {
        fillOptions(els.sigungu, []);
        els.sigungu.disabled = true;
      }

      // í˜„ì¬ ì„ íƒ ì¡°ê±´ì— ë§ëŠ” ë©”ëª¨ ìˆ˜ ê°±ì‹ 
      updateSelectedCount(notes);
    }

      notes.forEach(n => {
        const r = normalizeRegionFromNote(n);
        if (!r.sidoCode) return; // ì§€ì—­ ì—†ëŠ” ë©”ëª¨ëŠ” ìŠ¤í‚µ
        if (!bySido.has(r.sidoCode)) bySido.set(r.sidoCode, { name: r.sidoName || r.sidoCode, sigungu: new Map(), count: 0 });
        const node = bySido.get(r.sidoCode);
        node.count++;
        if (r.sigunguCode) node.sigungu.set(r.sigunguCode, r.sigunguName || r.sigunguCode);
      });

      // ì‹œë„ ì˜µì…˜
      const sidoItems = Array.from(bySido.entries())
        .map(([code, { name, count }]) => ({ value: code, label: `${name} (${count}ê±´)` }))
        .sort((a, b) => a.label.localeCompare(b.label, 'ko'));
      fillOptions(els.sido, sidoItems);

      // ì„ íƒëœ ì‹œë„ì˜ ì‹œêµ°êµ¬ ì˜µì…˜
      const selSido = (els.sido.value || '').trim();
      if (selSido && bySido.has(selSido)) {
        const sigItems = Array.from(bySido.get(selSido).sigungu.entries())
          .map(([code, name]) => ({ value: code, label: name }))
          .sort((a, b) => a.label.localeCompare(b.label, 'ko'));
        fillOptions(els.sigungu, sigItems);
        els.sigungu.disabled = false;
      } else {
        fillOptions(els.sigungu, []);
        els.sigungu.disabled = true;
      }

      // í˜„ì¬ ì„ íƒ ì¡°ê±´ì— ë§ëŠ” ë©”ëª¨ ìˆ˜ ê°±ì‹ 
      updateSelectedCount(notes);
    }

    // === í˜„ì¬ ì„ íƒ ì¡°ê±´ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬ ===
    function noteMatchesSelection(note) {
      const r = normalizeRegionFromNote(note);
      const sSel = (els.sido.value || '').trim();
      const gSel = (els.sigungu.value || '').trim();
      if (sSel && String(r.sidoCode).trim() !== sSel) return false;
      if (gSel && String(r.sigunguCode).trim() !== gSel) return false;
      return true;
    }

    // === ì„ íƒëœ ì¡°ê±´ì˜ ë©”ëª¨ ê°œìˆ˜ ì¹´ìš´íŠ¸ ===
    async function updateSelectedCount(preloaded) {
      const notes = preloaded || await getAllNotes();
      const cnt = notes.reduce((acc, n) => acc + (noteMatchesSelection(n) ? 1 : 0), 0);
      els.selCount.textContent = String(cnt);
      return cnt;
    }

    // === ë°±ì—…(ì„ íƒ ì¡°ê±´ë§Œ) ===
    async function backupSelectedNotes() {
      const notes = await getAllNotes();
      const filtered = notes.filter(noteMatchesSelection);

      // ë‹¤ìš´ë¡œë“œ ì˜ì—­ ì´ˆê¸°í™”
      els.downloads.innerHTML = '';

      if (!filtered.length) {
        alert('ì„ íƒí•œ ì§€ì—­ì— í•´ë‹¹í•˜ëŠ” ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const chunkSize = 10; // âœ… ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ í¸ì˜ë¥¼ ìœ„í•´ 10ê°œì”© ë¶„í• 
      let part = 1;
      const now = new Date();
      const koreaTime = new Date(now.getTime() + 9 * 60 * 60 * 1000);
      const ts = koreaTime.toISOString().replace(/T/, '_').replace(/:/g, '-').replace(/\..+/, '');

      for (let i = 0; i < filtered.length; i += chunkSize) {
        const chunk = filtered.slice(i, i + chunkSize);
        createDownloadButton(chunk, part++, ts);
      }

      // í—¤ë” í‘œì‹œ
      const h = document.createElement('div');
      h.innerHTML = `<h3>ğŸ“ ì´ ${part - 1}ê°œì˜ ë°±ì—… íŒŒì¼ Â· ë©”ëª¨ ${filtered.length}ê±´</h3>`;
      els.downloads.prepend(h);
    }

    function createDownloadButton(dataChunk, partNumber, timestamp) {
      const json = JSON.stringify(dataChunk); // âœ… ìš©ëŸ‰ ì ˆê°ì„ ìœ„í•´ pretty-print ì œê±°
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const btn = document.createElement('button');
      btn.textContent = `â¬‡ï¸ PART ${partNumber} ë‹¤ìš´ë¡œë“œ`;
      btn.className = 'secondary';
      btn.onclick = () => {
        const a = document.createElement('a');
        a.href = url;
        a.download = `í™ë¶€_ë©”ëª¨ë°±ì—…_${timestamp}_part${partNumber}.json`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 800);
      };
      els.downloads.appendChild(btn);
    }

    // === ì´ë²¤íŠ¸ ë°”ì¸ë”© ===
    els.refresh.addEventListener('click', buildRegionFiltersFromNotes);

    // apt.json ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    els.aptFile.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      await loadAptJsonFromFile(f);
      // ë¡œë”© ì§í›„ ì§€ì—­ëª©ë¡ ì¬êµ¬ì„±
      await buildRegionFiltersFromNotes();
    });

    els.sido.addEventListener('change', async () => {
      // ì‹œë„ ë°”ë€Œë©´ ì‹œêµ°êµ¬ ì¬êµ¬ì„±
      await buildRegionFiltersFromNotes();
    });

    els.sigungu.addEventListener('change', async () => {
      // ì‹œêµ°êµ¬ ë°”ë€Œë©´ ì¹´ìš´íŠ¸ë§Œ ê°±ì‹ 
      await updateSelectedCount();
    });

    els.backup.addEventListener('click', backupSelectedNotes);

    // === ì´ˆê¸° ë¡œë“œ ===
    (async function init() {
      setAptStatus('(ì•„íŒŒíŠ¸ ë°ì´í„° ë¯¸ë¡œë”©)');
      await buildRegionFiltersFromNotes();
    })();
  </script>
</body>
</html>
