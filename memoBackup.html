<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í™ë¶€ ë©”ëª¨ ë°±ì—… (ëª¨ë°”ì¼ ìµœì í™” Â· 10ê°œ ë¶„í•  Â· ì§€ì—°ìƒì„± Â· ë¡œë”©íŒì—…)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f7f7f9; --card:#fff; --text:#222; --muted:#666; --brand:#4A90E2; --brand2:#357ABD; }
    html, body { height:100%; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans', Arial, sans-serif; margin:0; padding:24px; background:var(--bg); color:var(--text); }
    h1 { margin:0 0 14px; font-size:22px; }
    p  { margin:6px 0 14px; color:var(--muted) }
    .card { background:var(--card); border:1px solid #e9e9ef; border-radius:12px; padding:16px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    label { font-size:14px; color:#333; display:flex; flex-direction:column; gap:6px; }
    select, button { font-size:14px; border-radius:8px; border:1px solid #d7d7de; padding:8px 10px; background:#fff; }
    select { min-width: 180px; }
    button { background:var(--brand); color:#fff; border:none; cursor:pointer; padding:10px 16px; font-weight:600; }
    button:hover { background:var(--brand2); }
    button.secondary { background:#fff; color:#333; border:1px solid #d7d7de; }
    .muted { color:var(--muted); font-size:13px; }
    .counter { font-size:13px; color:#333; margin-left:auto; }
    .downloads { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .divider { height:1px; background:#eee; margin:12px 0; }

    /* ë¡œë”© ëª¨ë‹¬ */
    .modal {
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.35); z-index: 9999;
    }
    .modal.show { display:flex; }
    .modal-card {
      background:#fff; color:#333; padding:18px 20px; border-radius:12px; min-width: 240px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18); text-align:center; font-size:14px;
    }
    .spinner {
      width:26px; height:26px; border-radius:50%;
      border:3px solid #e5e7eb; border-top-color: var(--brand);
      margin:0 auto 10px; animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>ğŸ“¦ í™ë¶€ ë©”ëª¨ ë°±ì—…</h1>
  <p>ì‹œë„/ì‹œêµ°êµ¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”. <span class="muted">ëª©ë¡ì—ëŠ” â€œë©”ëª¨ ë˜ëŠ” ì‚¬ì§„ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ì§€ì—­â€ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</span></p>

  <div class="card" id="filters">
    <div class="row" style="gap:12px">
      <label>ì‹œë„
        <select id="sidoFilter"><option value="">ì „ì²´</option></select>
      </label>
      <label>ì‹œêµ°êµ¬
        <select id="sigunguFilter" disabled><option value="">ì „ì²´</option></select>
      </label>
      <button id="refreshRegions" class="secondary">ğŸ”„ ì§€ì—­ ìƒˆë¡œê³ ì¹¨</button>
      <span id="aptStatus" class="muted">(ì•„íŒŒíŠ¸ ë°ì´í„° ìë™ ë¡œë“œ ëŒ€ê¸°)</span>
      <span class="counter">ì„ íƒëœ ë©”ëª¨: <b id="selCount">0</b>ê±´</span>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row">
      <button id="backupBtn">â¬‡ï¸ ì„ íƒ ë©”ëª¨ ë°±ì—…</button>
      <span class="muted">ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ì„ ìœ„í•´ 10ê°œì”© ë¶„í• Â·ë‹¤ìš´ë¡œë“œ(ì§€ì—° ìƒì„±) í•©ë‹ˆë‹¤.</span>
    </div>
    <div class="divider"></div>
    <div id="downloadContainer" class="downloads"></div>
  </div>

  <!-- ì²˜ë¦¬ì¤‘ ëª¨ë‹¬ -->
  <div id="busyModal" class="modal" role="dialog" aria-modal="true" aria-live="polite">
    <div class="modal-card">
      <div class="spinner" aria-hidden="true"></div>
      <div id="busyText">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤â€¦</div>
    </div>
  </div>

  <script>
  // ==========================
  // IndexedDB
  // ==========================
  const DB_NAME = 'hongbuMemo';
  const DB_VERSION = 4;
  const STORE_NOTES = 'apartmentNotes';

  // ==========================
  // UI
  // ==========================
  const els = {
    sido: document.getElementById('sidoFilter'),
    sigungu: document.getElementById('sigunguFilter'),
    refresh: document.getElementById('refreshRegions'),
    status: document.getElementById('aptStatus'),
    selCount: document.getElementById('selCount'),
    downloads: document.getElementById('downloadContainer'),
    backup: document.getElementById('backupBtn'),
    modal: document.getElementById('busyModal'),
    busyText: document.getElementById('busyText'),
  };
  const setAptStatus = t => { els.status.textContent = t; };

  // ë¡œë”© ëª¨ë‹¬
  function showBusy(msg='ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤â€¦') {
    els.busyText.textContent = msg;
    els.modal.classList.add('show');
  }
  function hideBusy() {
    els.modal.classList.remove('show');
  }

  // ==========================
  // ìœ í‹¸
  // ==========================
  function fillOptions(selectEl, items) {
    const prev = selectEl.value;
    selectEl.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'ì „ì²´';
    selectEl.appendChild(optAll);
    (items || []).forEach(({ value, label }) => {
      const opt = document.createElement('option');
      opt.value = String(value ?? '');
      opt.textContent = String(label ?? value ?? '');
      selectEl.appendChild(opt);
    });
    if ([...selectEl.options].some(o => o.value === prev)) selectEl.value = prev;
  }

  function stripHtmlAndTrim(s) {
    return String(s ?? '')
      .replace(/<[^>]*>/g, '')
      .replace(/&nbsp;/gi, ' ')
      .trim();
  }

  function hasMemoContent(n) {
    const memoText = stripHtmlAndTrim(n?.memo);
    const imgs = Array.isArray(n?.images) ? n.images : [];
    return memoText.length > 0 || imgs.length > 0;
  }

  function noteIdOf(n) {
    return String(n?.id ?? n?.aptId ?? n?.apartmentId ?? '').trim();
  }

  // ë””ë°”ìš´ìŠ¤(ì„ íƒ ë³€ê²½ ì—°íƒ€ ì‹œ ë¶ˆí•„ìš” ë Œë”ë§ ë°©ì§€)
  function debounce(fn, t=120) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), t);
    };
  }

  // ==========================
  // DB ìˆœíšŒ(ìŠ¤íŠ¸ë¦¬ë°)
  // ==========================
  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = () => reject(new Error('DB ì—´ê¸° ì‹¤íŒ¨'));
    });
  }

  async function iterateNotes(visitor) {
    const db = await openDB();
    const tx = db.transaction([STORE_NOTES], 'readonly');
    const st = tx.objectStore(STORE_NOTES);
    await new Promise((resolve, reject) => {
      const req = st.openCursor();
      req.onsuccess = async e => {
        const cur = e.target.result;
        if (cur) {
          try { await visitor(cur.value); } catch (e) { console.error(e); }
          cur.continue();
        } else resolve();
      };
      req.onerror = () => reject(new Error('cursor ì‹¤íŒ¨'));
    });
    db.close();
  }

  // ==========================
  // apt.json ì¸ë±ìŠ¤(í•„ìš”í•œ ê²ƒë§Œ)
  // ==========================
  const aptIndex = new Map(); // aptId -> {sido, sidoNm, sigungu, sigunguNm}

  async function collectUsedAptIds() {
    const set = new Set();
    await iterateNotes(n => {
      if (!hasMemoContent(n)) return;
      const id = noteIdOf(n);
      if (id) set.add(id);
    });
    return set;
  }

  async function loadFilteredAptIndexFromSamePath() {
    showBusy('ì•„íŒŒíŠ¸ ë°ì´í„°(apt.json) ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
    try {
      const usedIds = await collectUsedAptIds(); // ë‚´ìš© ìˆëŠ” ë©”ëª¨ ê¸°ì¤€
      const res = await fetch('apt.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      aptIndex.clear();
      const arr = Array.isArray(data) ? data :
        (Array.isArray(data?.apartments) ? data.apartments :
         Array.isArray(data?.data) ? data.data : []);

      for (const a of arr) {
        const id = String(a.id ?? a.apartmentId ?? a.aptId ?? '').trim();
        if (!id || !usedIds.has(id)) continue;
        aptIndex.set(id, {
          sido: String(a.sido ?? a.sidoCode ?? '').trim(),
          sidoNm: String(a.sidoNm ?? a.sidoName ?? '').trim(),
          sigungu: String(a.sigungu ?? a.sigunguCode ?? '').trim(),
          sigunguNm: String(a.sigunguNm ?? a.sigunguName ?? '').trim(),
        });
      }
      setAptStatus(`ì•„íŒŒíŠ¸ ${aptIndex.size}ê±´ ë¡œë”©ë¨ (í•„ìš” í•­ëª©ë§Œ)`);
      hideBusy();
      return true;
    } catch (e) {
      console.warn('apt.json ìë™ ë¡œë“œ ì‹¤íŒ¨:', e);
      setAptStatus('(ì•„íŒŒíŠ¸ ë°ì´í„° ë¯¸ë¡œë”©: apt.json íŒŒì¼ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ì„¸ìš”)');
      hideBusy();
      return false;
    }
  }

  function regionFromNoteViaApt(note) {
    const id = noteIdOf(note);
    if (!id) return null;
    const a = aptIndex.get(id);
    if (!a) return null;
    return {
      sidoCode: a.sido || '',
      sidoName: a.sidoNm || a.sido || '',
      sigunguCode: a.sigungu || '',
      sigunguName: a.sigunguNm || a.sigungu || '',
    };
  }

  // ==========================
  // âœ… ì†ë„ê°œì„  í•µì‹¬: ì§€ì—­ ìºì‹œ(1íšŒ ìƒì„±)
  // ==========================
  const regionCache = {
    bySido: new Map(),     // sido -> { name, sigungu: Map(sig -> {name,count}), count }
    noteRegion: new Map(), // noteId -> {sidoCode, sigunguCode, ...}
  };

  async function buildRegionCacheOnce() {
    regionCache.bySido.clear();
    regionCache.noteRegion.clear();

    if (aptIndex.size === 0) return;

    await iterateNotes(n => {
      if (!hasMemoContent(n)) return;
      const r = regionFromNoteViaApt(n);
      if (!r || !r.sidoCode) return;

      const id = noteIdOf(n);
      if (!id) return;
      regionCache.noteRegion.set(id, r);

      if (!regionCache.bySido.has(r.sidoCode)) {
        regionCache.bySido.set(r.sidoCode, {
          name: r.sidoName || r.sidoCode,
          sigungu: new Map(),
          count: 0
        });
      }
      const s = regionCache.bySido.get(r.sidoCode);
      s.count++;

      if (r.sigunguCode) {
        const cur = s.sigungu.get(r.sigunguCode) || {
          name: r.sigunguName || r.sigunguCode,
          count: 0
        };
        cur.count++;
        s.sigungu.set(r.sigunguCode, cur);
      }
    });
  }

  function renderSidoOptionsFromCache() {
    const sidoItems = Array.from(regionCache.bySido.entries())
      .map(([code, obj]) => ({ value: code, label: `${obj.name} (${obj.count}ê±´)` }))
      .sort((a, b) => a.label.localeCompare(b.label, 'ko'));
    fillOptions(els.sido, sidoItems);
  }

  function renderSigunguOptionsFromCache() {
    const selSido = (els.sido.value || '').trim();
    if (selSido && regionCache.bySido.has(selSido)) {
      const sigMap = regionCache.bySido.get(selSido).sigungu;
      const sigItems = Array.from(sigMap.entries())
        .map(([code, obj]) => ({ value: code, label: `${obj.name} (${obj.count}ê±´)` }))
        .sort((a, b) => a.label.localeCompare(b.label, 'ko'));
      fillOptions(els.sigungu, sigItems);
      els.sigungu.disabled = false;
    } else {
      fillOptions(els.sigungu, []);
      els.sigungu.disabled = true;
    }
  }

  function updateSelectedCountFast() {
    const sSel = (els.sido.value || '').trim();
    const gSel = (els.sigungu.value || '').trim();
    let cnt = 0;

    for (const r of regionCache.noteRegion.values()) {
      if (sSel && String(r.sidoCode || '').trim() !== sSel) continue;
      if (gSel && String(r.sigunguCode || '').trim() !== gSel) continue;
      cnt++;
    }
    els.selCount.textContent = String(cnt);
    return cnt;
  }

  async function rebuildFiltersFromCache(showModal=true) {
    if (showModal) showBusy('ì§€ì—­ ëª©ë¡ì„ êµ¬ì„±í•˜ëŠ” ì¤‘â€¦');

    if (aptIndex.size === 0) {
      els.sigungu.disabled = true;
      fillOptions(els.sido, []);
      fillOptions(els.sigungu, []);
      els.selCount.textContent = '0';
      if (showModal) hideBusy();
      return;
    }

    renderSidoOptionsFromCache();
    renderSigunguOptionsFromCache();
    updateSelectedCountFast();

    if (showModal) hideBusy();
  }

  // ==========================
  // ë°±ì—… (10ê°œ ë¶„í•  Â· ì§€ì—° ìƒì„±)
  // ==========================
  async function backupSelectedNotes() {
    showBusy('ì„ íƒëœ ë©”ëª¨ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ì¤‘â€¦');

    if (aptIndex.size === 0) {
      hideBusy();
      alert('apt.jsonì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }

    els.downloads.innerHTML = '';

    // âœ… DB ì „ì²´ ìˆœíšŒ ëŒ€ì‹  ìºì‹œì—ì„œ IDë§Œ ì¶”ë¦¼(ì´ˆê³ ì†)
    const sSel = (els.sido.value || '').trim();
    const gSel = (els.sigungu.value || '').trim();
    const selectedIdsSnapshot = [];
    for (const [id, r] of regionCache.noteRegion.entries()) {
      if (sSel && String(r.sidoCode || '').trim() !== sSel) continue;
      if (gSel && String(r.sigunguCode || '').trim() !== gSel) continue;
      selectedIdsSnapshot.push(id);
    }

    if (selectedIdsSnapshot.length === 0) {
      hideBusy();
      alert('ì„ íƒí•œ ì§€ì—­ì— í•´ë‹¹í•˜ëŠ” ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const chunkSize = 10; // PARTë‹¹ ë©”ëª¨ ê°œìˆ˜
    const totalParts = Math.ceil(selectedIdsSnapshot.length / chunkSize);

    const now = new Date();
    const koreaTime = new Date(now.getTime() + 9 * 60 * 60 * 1000);
    const ts = koreaTime.toISOString().replace(/T/, '_').replace(/:/g, '-').replace(/\..+/, '');

    const head = document.createElement('div');
    head.innerHTML = `<h3>ğŸ“ ì´ ${totalParts}ê°œì˜ ë°±ì—… íŒŒì¼ Â· ë©”ëª¨ ${selectedIdsSnapshot.length}ê±´</h3>`;
    els.downloads.appendChild(head);

    for (let p = 1, i = 0; i < selectedIdsSnapshot.length; p++, i += chunkSize) {
      const startIdx = i;
      const endIdx = Math.min(i + chunkSize, selectedIdsSnapshot.length);
      const plannedCount = endIdx - startIdx;

      const btn = document.createElement('button');
      btn.className = 'secondary';
      btn.textContent = `â¬‡ï¸ PART ${p} ë‹¤ìš´ë¡œë“œ (${plannedCount}ê°œ)`;

      const partNo = p, sliceStart = startIdx, sliceEnd = endIdx;

      btn.onclick = async () => {
        showBusy(`PART ${partNo} ìƒì„± ì¤‘â€¦`);
        const db = await openDB();
        const tx = db.transaction([STORE_NOTES], 'readonly');
        const st = tx.objectStore(STORE_NOTES);

        const sliceIds = selectedIdsSnapshot.slice(sliceStart, sliceEnd);
        const out = [];
        await Promise.all(sliceIds.map(id => new Promise(res => {
          const r = st.get(id);
          r.onsuccess = () => { if (r.result) out.push(r.result); res(); };
          r.onerror   = () => res();
        })));
        db.close();

        const json = JSON.stringify(out);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `í™ë¶€_ë©”ëª¨ë°±ì—…_${ts}_part${partNo}_${out.length}ê°œ.json`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 800);
        hideBusy();
      };

      els.downloads.appendChild(btn);
    }

    hideBusy();
  }

  // ==========================
  // ì´ë²¤íŠ¸ & ì´ˆê¸°í™”
  // ==========================
  els.refresh.addEventListener('click', async () => {
    await loadFilteredAptIndexFromSamePath();
    showBusy('ë©”ëª¨ ì¸ë±ìŠ¤ë¥¼ êµ¬ì„±í•˜ëŠ” ì¤‘â€¦');
    await buildRegionCacheOnce();
    hideBusy();
    await rebuildFiltersFromCache(true);
  });

  els.sido.addEventListener('change', debounce(() => {
    // âœ… ì‹œë„ ë³€ê²½: ìºì‹œ ê¸°ë°˜ìœ¼ë¡œ ì‹œêµ°êµ¬ ì˜µì…˜/ì¹´ìš´íŠ¸ë§Œ ê°±ì‹ (ì´ˆê³ ì†)
    renderSigunguOptionsFromCache();
    updateSelectedCountFast();
  }, 80));

  els.sigungu.addEventListener('change', debounce(() => {
    updateSelectedCountFast();
  }, 80));

  els.backup.addEventListener('click', backupSelectedNotes);

  (async function init() {
    await loadFilteredAptIndexFromSamePath(); // apt.json ìë™ ë¡œë“œ(í•„ìš” í•­ëª©ë§Œ)
    showBusy('ë©”ëª¨ ì¸ë±ìŠ¤ë¥¼ êµ¬ì„±í•˜ëŠ” ì¤‘â€¦');
    await buildRegionCacheOnce();             // âœ… DBëŠ” ì—¬ê¸°ì„œ 1ë²ˆë§Œ í›‘ìŒ
    hideBusy();
    await rebuildFiltersFromCache(true);      // âœ… ì´í›„ UIëŠ” ìºì‹œë§Œ ì‚¬ìš©
  })();
</script>
</body>
</html>

